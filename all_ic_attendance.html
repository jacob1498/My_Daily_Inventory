<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All IC Attendance - IMS</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Dark Mode Header */
    body.dark-mode header { background: #1a252f; border-bottom: 1px solid #2c3e50; }
    body.dark-mode header h1 { color: #ecf0f1; }
    body { padding-top: 0 !important; } /* Remove padding since navbar is removed */
    
    /* Card content expand/collapse */
    .card-content.hidden { display: none; }
    .section-content.hidden { display: none !important; }
    /* Resizable box */
    .resizable-box { resize: both; overflow: auto; min-width: 300px; min-height: 200px; }
    /* Ensure modal is on top */
    .modal { z-index: 10001; }
    
    /* Fix tooltips inside modal */
    .modal-content .icon-btn[data-tooltip]::after { top: 100%; bottom: auto; margin-top: 8px; margin-bottom: 0; }
    .modal-content .icon-btn[data-tooltip]::before { top: 100%; bottom: auto; margin-top: 3px; margin-bottom: 0; border-top-color: transparent; border-bottom-color: #2c3e50; }
    .modal-content .icon-btn[data-tooltip]:hover { z-index: 10002; }
    .modal-content .icon-btn[data-tooltip]:hover::after,
    .modal-content .icon-btn[data-tooltip]:hover::before {
        transform: translateX(-50%) translateY(4px);
        z-index: 10003;
    }
    /* Add hover effect for action icons in modal */
    .modal-content .icon-btn:hover {
        background-color: #f0f0f0;
    }
    
    /* Sortable headers */
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background-color: #f1f1f1; }
    .sort-icon { margin-left: 5px; font-size: 10px; }
    body.dark-mode th.sortable:hover { background-color: #333; }
    
    .editable-time { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
    .editable-time:hover { color: #2752a7; }

    /* Excel-like Report Table */
    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px; /* Smaller font */
        border: 1px solid #ccc; table-layout: fixed;
    }
    .report-table th, .report-table td {
        border: 1px solid #ccc; /* Grid lines */
        padding: 4px 6px; /* Compact padding */
        text-align: left;
    }
    .report-table th {
        background-color: #f0f0f0;
        font-weight: 600;
        color: #333;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 0 #ccc;
    }
    .report-table tbody tr:nth-child(even) { background-color: #fafafa; }
    .report-table tr:hover { background-color: #eef6ff; }
    
    /* Dark mode overrides */
    body.dark-mode .report-table { border-color: #444; }
    body.dark-mode .report-table th, body.dark-mode .report-table td { border-color: #444; color: #e0e0e0; }
    body.dark-mode .report-table th { background-color: #2c2c2c; box-shadow: 0 1px 0 #444; }
    body.dark-mode .report-table tbody tr:nth-child(even) { background-color: #1f1f1f; }
    body.dark-mode .report-table tr:hover { background-color: #333; }

    /* Tabs */
    .att-tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
    .att-tab { padding: 8px 16px; cursor: pointer; border: 1px solid transparent; border-bottom: none; background: transparent; color: #666; font-weight: 600; font-size: 13px; }
    .att-tab:hover { color: #2752a7; background: #f9f9f9; }
    .att-tab.active { border-color: #ccc; border-bottom-color: #fff; background: #fff; color: #2752a7; border-radius: 4px 4px 0 0; margin-bottom: -1px; }
    body.dark-mode .att-tab { color: #aaa; }
    body.dark-mode .att-tab:hover { color: #fff; background: #333; }
    body.dark-mode .att-tab.active { border-color: #444; border-bottom-color: #1e1e1e; background: #1e1e1e; color: #fff; }
    body.dark-mode .att-tabs { border-bottom-color: #444; }

    /* Compact Attendance Table Styles */
    #attendance-table { font-size: 11px; }
    #attendance-table th, #attendance-table td { padding: 3px 4px; vertical-align: middle; height: 28px; }
    #attendance-table .icon-btn { padding: 2px; width: 22px; height: 22px; min-width: 22px; font-size: 14px; }
    #attendance-table .icon-btn svg { width: 14px; height: 14px; }
    #attendance-table td:last-child { white-space: nowrap; }

    /* Dashboard Stats Grid (8 Cards) */
    .dashboard-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }
    .stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #eef2f6;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
    .stat-info { flex: 1; min-width: 0; }
    .stat-value { font-size: 24px; font-weight: 700; color: #2c3e50; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stat-label { font-size: 13px; color: #7f8c8d; font-weight: 600; margin-top: 4px; }
    
    /* Dark mode support for new cards */
    body.dark-mode .stat-card { background: #1e1e1e; border-color: #333; }
    body.dark-mode .stat-value { color: #e0e0e0; }

    /* Flip Card Styles */
    .flip-container { perspective: 1000px; position: relative; margin-top: 20px; height: 80vh; min-height: 600px; }
    .flip-inner { transition: transform 0.6s; transform-style: preserve-3d; position: relative; width: 100%; height: 100%; }
    .flip-container.flipped .flip-inner { transform: rotateY(180deg); }
    .flip-front, .flip-back { 
        backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        border-radius: 8px; 
        display: flex; flex-direction: column;
    }
    .flip-front { z-index: 2; transform: rotateY(0deg); }
    .flip-back { transform: rotateY(180deg); }

    /* Floating Action Button */
    .fab-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: #2752a7;
      color: white;
      border: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9999;
      transition: transform 0.2s, background-color 0.2s;
    }
    .fab-btn:hover {
      transform: scale(1.1);
      background-color: #1f4287;
    }

    /* Clickable Summary Cards */
    body.dark-mode .stat-card.selected-summary-card { background-color: #2c3e50; border-color: #64b5f6; box-shadow: inset 0 0 0 1px #64b5f6; }

    @keyframes blink-red {
        0% { background-color: #fff; }
        50% { background-color: #ffebee; box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
        100% { background-color: #fff; }
    }
    .blink-red-card { animation: blink-red 1s infinite ease-in-out; border: 1px solid #e74c3c !important; }

    /* Hover effect for validator view tables */
    #pending-tasks-tbody tr .icon-btn,
    #assigned-tasks-tbody tr .icon-btn,
    #resolved-tasks-tbody tr .icon-btn,
    #unresolved-tasks-tbody tr .icon-btn {
        opacity: 0;
        transition: opacity 0.2s;
    }
    #pending-tasks-tbody tr:hover .icon-btn,
    #assigned-tasks-tbody tr:hover .icon-btn,
    #resolved-tasks-tbody tr:hover .icon-btn,
    #unresolved-tasks-tbody tr:hover .icon-btn {
        opacity: 1;
    }

    /* Analytics Expanded View */
    #val-analytics-card.expanded { flex: 1; }
    #val-analytics-card.expanded .val-analytics-tab-content { max-height: none !important; }
    #val-analytics-card.expanded #tab-val-reason-analysis > div:last-child { max-height: none !important; }

    /* Modal Animation */
    .modal:not(.hidden) {
        animation: fadeIn 0.2s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.98); }
        to { opacity: 1; transform: scale(1); }
    }

    /* Search Preview Styles */
    .search-preview-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        width: 300px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 10000;
        margin-top: 4px;
    }
    .search-preview-item { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; flex-direction: column; gap: 2px; }
    .search-preview-item:hover { background-color: #f5f9ff; }
    .search-preview-item:last-child { border-bottom: none; }
  </style>
</head>
<body class="inventory-mode">
  <script>
    if(localStorage.getItem('ims_sidebar_collapsed') === '1') document.body.classList.add('sidebar-collapsed');
  </script>
  
  <!-- Main App Sidebar -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <img src="Logo.jpg" alt="Logo" class="sidebar-logo" style="height:32px;width:auto;margin-right:8px">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button onclick="window.location.href='homepage.html'" data-tooltip="Homepage">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span class="menu-text">Homepage</span>
        </button>
      </li>
      <li>
        <button onclick="window.location.href='daily_cycle_count.html'" data-tooltip="Daily Cycle Count">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <span class="menu-text">Daily Cycle Count</span>
        </button>

        <ul class="sidebar-submenu">
            <li><button id="sidebar-timestamp-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;margin-right:10px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Timestamp
            </button></li>
            
        </ul>
      </li>
      <li>
        <button class="active" onclick="window.location.href='all_ic_attendance.html'" data-tooltip="All IC Attendance">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          <span class="menu-text">All IC Attendance</span>
        </button>
        <ul class="sidebar-submenu">
            
            <li><button onclick="if(document.getElementById('validators-modal')){ document.getElementById('validators-view-btn').click(); } else { sessionStorage.setItem('ims_open_validators_modal', 'true'); window.location.href='all_ic_attendance.html'; }">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;margin-right:10px;"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                Validators View
            </button></li>
        </ul>
      </li>
    </ul>
  </nav>

  <header>
    <div style="display: flex; align-items: center; gap: 15px;">
        <button onclick="window.location.href='homepage.html'" class="icon-btn" title="Back to Dashboard" style="border:none; background:transparent; font-size:16px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </button>
        <h1>All IC Attendance</h1>
    </div>
    <div style="display: flex; gap: 10px;">
        <button onclick="toggleTheme()" class="icon-btn" title="Toggle Theme" style="background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); border:none; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
        <button onclick="signOut()" class="icon-btn" title="Logout" style="background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); border:none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #e74c3c;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        </button>
    </div>
  </header>

  <main>
    <div class="card" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; padding: 15px;">
      <strong style="color: var(--accent);">Global Date Filter:</strong>
      <label for="global-start-date">From:</label>
      <input type="date" id="global-start-date" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
      <label for="global-end-date">To:</label>
      <input type="date" id="global-end-date" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
      <button id="apply-global-filter" class="icon-btn" title="Apply Filter" style="background: #2752a7; color: white;">Filter</button>
      <button id="clear-global-filter" class="icon-btn" title="Clear Filter" style="border: 1px solid #ccc;">Clear</button>
      
      <button id="reports-menu-btn" class="icon-btn" title="Reports" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Reports
      </button>
      <button id="set-requirements-btn" class="icon-btn" title="Set Requirements" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> Requirements
      </button>
      <button id="ic-master-btn" class="icon-btn" title="IC User ID Master" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> IC Master
      </button>
      <button id="validators-view-btn" class="icon-btn" title="Validators View" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg> IC Validators View
      </button>
      <button onclick="window.location.href='daily_task_tracker.html'" class="icon-btn" title="Daily Task Tracker" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"></path><rect x="9" y="3" width="6" height="4" rx="2"></rect><path d="M9 14l2 2 4-4"></path></svg> Daily Task Tracker
      </button>
      <div style="display:flex; align-items:center; gap:5px; margin-left:10px; border-left:1px solid #ccc; padding-left:10px;">
          <input type="checkbox" id="auto-refresh-check" title="Auto Refresh every 15s">
          <label for="auto-refresh-check" style="font-size:13px; cursor:pointer;">Auto Refresh</label>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 25px;">
        <div class="card" style="margin:0;">
            <h3 style="margin-top:0; padding-bottom:10px; border-bottom:1px solid #eee;">Live Status</h3>
            <div class="dashboard-stats-grid" style="margin-bottom:0;">
                <div class="stat-card" onclick="showStatusModal('active')" style="border-left: 4px solid #2ecc71;">
                    <div class="stat-icon" style="background: rgba(46, 204, 113, 0.1); color: #2ecc71;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="live-status-active">0</div>
                        <div class="stat-label">Active (Present)</div>
                    </div>
                </div>
                <div class="stat-card" onclick="showStatusModal('break')" style="border-left: 4px solid #f1c40f;">
                    <div class="stat-icon" style="background: rgba(241, 196, 15, 0.1); color: #f1c40f;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="live-status-break">0</div>
                        <div class="stat-label">On Break</div>
                    </div>
                </div>
                <div class="stat-card" onclick="showStatusModal('long_break')" style="border-left: 4px solid #e74c3c;">
                    <div class="stat-icon" style="background: rgba(231, 76, 60, 0.1); color: #e74c3c;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="live-status-long-break">0</div>
                        <div class="stat-label">Break > 40mins</div>
                    </div>
                </div>
                <div class="stat-card" onclick="showStatusModal('timeout')" style="border-left: 4px solid #34495e;">
                    <div class="stat-icon" style="background: rgba(52, 73, 94, 0.1); color: #34495e;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="live-status-timeout">0</div>
                        <div class="stat-label">Timed Out Today</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card" style="margin:0;">
            <h3 style="margin-top:0; padding-bottom:10px; border-bottom:1px solid #eee;">Shift Summary</h3>
            <div class="dashboard-stats-grid" style="margin-bottom:0;">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e3f2fd; color: #2752a7;">1st</div>
                    <div class="stat-info">
                        <div class="stat-value" id="summary-1st">0</div>
                        <div class="stat-label">1st Shift</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #fff3e0; color: #f57c00;">2nd</div>
                    <div class="stat-info">
                        <div class="stat-value" id="summary-2nd">0</div>
                        <div class="stat-label">2nd Shift</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e8eaf6; color: #6a1b9a;">3rd</div>
                    <div class="stat-info">
                        <div class="stat-value" id="summary-3rd">0</div>
                        <div class="stat-label">3rd Shift</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f3e5f5; color: #8e24aa;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="summary-total">0</div>
                        <div class="stat-label">Total Attendance</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flip-container" id="attendance-flip-container">
      <div class="flip-inner">
      <div class="flip-front card resizable-box" id="attendance-card" style="padding: 20px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <h2 style="margin:0;">Attendance Sheet</h2>
            <button id="view-chart-btn" class="icon-btn" title="View Analysis" style="background:#6f42c1; color:white; font-size:12px; padding:4px 8px;">View Analysis</button>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <select id="att-filter-role" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
                <option value="">All Roles</option>
                <option value="IC Support">IC Support</option>
                <option value="Warehouse">Warehouse</option>
                <option value="Admin">Admin</option>
                <option value="Management">Management</option>
            </select>
            <select id="att-filter-status" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
                <option value="">All Statuses</option>
                <option value="Full-time">Full-time</option>
                <option value="Full Counter">Full Counter</option>
                <option value="Temporary slide to Other task">Temporary slide to Other task</option>
            </select>
            <div id="att-filter-area-wrapper" style="position:relative; display:inline-block;">
                <button id="att-filter-area-btn" style="padding:6px; border:1px solid #ccc; border-radius:4px; background:#fff; color:black; cursor:pointer; min-width:150px; text-align:left; display:flex; justify-content:space-between; align-items:center;">
                    <span id="att-filter-area-text">All Job Descriptions</span>
                    <span style="font-size:10px; margin-left:5px;">▼</span>
                </button>
                <div id="att-filter-area-dropdown" style="display:none; position:absolute; top:100%; left:0; background:#fff; border:1px solid #ccc; border-radius:4px; padding:10px; z-index:1000; min-width:200px; box-shadow:0 4px 8px rgba(0,0,0,0.1); max-height:300px; overflow-y:auto;">
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="Cycle Counter"> Cycle Counter</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="TL"> TL</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="OIC"> OIC</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="Encoder"> Encoder</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="SBD Checker"> SBD Checker</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="RTV"> RTV</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="Damaged Checker"> Damaged Checker</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="B1T1 Checker"> B1T1 Checker</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="Validator"> Validator</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="HVI Support"> HVI Support</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="Projects"> Projects</label>
                    <label style="display:block; margin-bottom:5px; cursor:pointer;"><input type="checkbox" class="att-area-cb" value="HO-Cancelled"> HO-Cancelled</label>
                    <div style="border-top:1px solid #eee; margin-top:5px; padding-top:5px; text-align:right;">
                        <button id="att-filter-area-clear" style="padding:4px 8px; background:#eee; color:#333; border:none; border-radius:4px; font-size:12px; margin-right:5px;">Clear</button>
                        <button id="att-filter-area-apply" style="padding:4px 8px; background:#2752a7; color:white; border:none; border-radius:4px; font-size:12px;">Apply</button>
                    </div>
                </div>
            </div>
            <input type="text" id="att-search" placeholder="Search name..." style="padding:6px; border:1px solid #ccc; border-radius:4px;">
            <button id="print-att-btn" class="icon-btn" title="Print List">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
            </button>
            <button id="bulk-timeout-btn" class="icon-btn" title="Bulk Time Out" style="color:#34495e; display:none; margin-right:5px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            </button>
            <button id="delete-selected-att-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
            </button>
            <button id="forward-all-btn" class="icon-btn" title="Forward All Cycle Counters" style="background: #e67e22; color: white; margin-right: 5px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg> Forward All
            </button>
            <button id="undo-forward-btn" class="icon-btn" title="Undo Last Forward" style="background: #7f8c8d; color: white; margin-right: 5px; display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg> Undo
            </button>
            <button id="export-excel-btn" class="icon-btn" title="Export Excel (By Status)" style="margin-right:5px; color:#27ae60;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            </button>
            <button id="export-att-btn" class="icon-btn" title="Export CSV" style="margin-right:5px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </button>
            <button id="add-att-btn" class="icon-btn" style="background: #2752a7; color: white; padding: 8px 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:5px"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add Entry
            </button>
        </div>
      </div>
      <div class="card-content" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
      <!-- Quick Time In Toolbar -->
      <div style="background:#f1f5f9; padding:8px 12px; border-bottom:1px solid #e2e8f0; display:flex; gap:10px; align-items:center; margin-bottom:10px; border-radius:4px; flex-wrap: wrap;">
          <div style="display:flex; align-items:center; gap:5px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;color:#2752a7;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              <span id="quick-widget-clock" style="font-size:12px; font-weight:bold; color:#555; min-width:120px;"></span>
          </div>
          <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
          <span style="font-weight:bold; color:#2752a7; font-size:13px;">Quick Time In:</span>
          <input type="text" id="quick-user-id" placeholder="Scan User ID" style="width:120px; padding:5px; border:1px solid #ccc; border-radius:4px; text-transform:uppercase; font-size:12px;">
          <button id="quick-time-in-btn" class="icon-btn" style="background:#2ecc71; color:white; font-weight:bold; padding: 5px 10px; font-size:12px;">GO</button>
          <button id="quick-clear-btn" class="icon-btn" style="background:#fff; color:#333; border:1px solid #ccc; padding: 5px 8px; font-size:12px;" title="Clear">C</button>
          <input type="text" id="quick-user-name" placeholder="Name" readonly style="width:150px; padding:5px; border:1px solid #eee; border-radius:4px; background:#fff; color:#555; font-size:12px;">
          <input type="text" id="quick-user-role" placeholder="Role" readonly style="width:100px; padding:5px; border:1px solid #eee; border-radius:4px; background:#fff; color:#555; font-size:12px;">
      </div>
      <div class="att-tabs">
          <button class="att-tab active" data-shift="">All Shifts</button>
          <button class="att-tab" data-shift="1st Shift-(6am-2pm)">1st Shift</button>
          <button class="att-tab" data-shift="2nd Shift-(2pm-10pm)">2nd Shift</button>
          <button class="att-tab" data-shift="3rd Shift-(10pm-6am)">3rd Shift</button>
      </div>
      <div style="overflow: auto; flex: 1;">
          <table id="attendance-table" class="report-table">
              <thead>
                  <tr>
                      <th style="width: 30px;"><input type="checkbox" id="select-all-att" title="Select All"></th>
                      <th class="sortable" data-sort="date" style="width: 80px;">Date <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="userId" style="width: 60px;">User ID <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="shift" style="width: 100px;">Shift <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="name" style="width: 120px;">Name <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="role" style="width: 80px;">Role <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="area" style="width: 100px;">Job Description <span class="sort-icon"></span></th>
                      <th style="width: 60px;">Time In</th>
                      <th style="width: 60px;">Break Out</th>
                      <th style="width: 60px;">Break In</th>
                      <th style="width: 60px;">Time Out</th>
                      <th class="sortable" data-sort="duration" style="width: 60px;">Duration <span class="sort-icon"></span></th>
                      <th style="width: 80px;">Status</th>
                      <th style="width: 60px;">Action</th>
                  </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                  <tr style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #eef2f6;">
                      <td colspan="14" style="text-align: right; padding: 10px;">Total Records: <span id="att-total-count">0</span></td>
                  </tr>
              </tfoot>
          </table>
      </div>
      <div id="att-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-top: 1px solid #eee;">
        <div style="display:flex; align-items:center; gap:8px;">
            <label for="att-rows-per-page" style="font-size:13px; color:var(--muted);">Rows:</label>
            <select id="att-rows-per-page" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #d6dbe6;"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option><option value="100">100</option></select>
        </div>
        <span id="att-page-info" style="font-size: 13px; font-weight: 600; color: var(--muted);"></span>
        <div style="display:flex; gap:8px;">
            <button id="att-prev-page" class="icon-btn" title="Previous">‹</button>
            <button id="att-next-page" class="icon-btn" title="Next">›</button>
        </div>
      </div>
      </div>
    </div>

    <div class="flip-back card resizable-box" style="padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0;">Sub Role Analysis</h2>
            <button id="view-table-btn" class="icon-btn" title="Back to Table">↩ Back to Table</button>
        </div>
        <div id="sub-role-dashboard" style="flex:1; position:relative; min-height:0; overflow:auto;">
            <!-- Analysis content -->
        </div>
    </div>
    </div>
    </div>
  </main>

  <!-- Active Users Modal -->
  <div id="active-users-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 600px; margin: 50px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Active Users (Present)</h3>
            <div style="display:flex; gap:5px;">
                <button id="modal-export-btn" class="icon-btn" title="Export CSV" style="border:1px solid #ccc;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>
                <button class="icon-btn close-modal">&times;</button>
            </div>
        </div>
        <div style="margin-bottom:10px; display:flex; gap:10px; align-items:center;">
            <input type="text" id="modal-user-search" placeholder="Search name or ID..." style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
            <div id="modal-bulk-actions" style="display:none; gap:5px;"></div>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="report-table" style="width:100%;">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Job Description</th>
                        <th>Time In</th>
                    </tr>
                </thead>
                <tbody id="active-users-tbody"></tbody>
            </table>
        </div>
        <div id="modal-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
            <div style="display:flex; align-items:center; gap:5px;">
                <label style="font-size:12px;">Rows:</label>
                <select id="modal-rows-per-page" style="padding:2px; font-size:12px;">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>
            <span id="modal-page-info" style="font-size:12px; color:#666;"></span>
            <div style="display:flex; gap:5px;">
                <button id="modal-prev-page" class="icon-btn" style="padding:2px 6px;">&lt;</button>
                <button id="modal-next-page" class="icon-btn" style="padding:2px 6px;">&gt;</button>
            </div>
        </div>
        <div style="text-align:right; margin-top:10px;">
             <button class="icon-btn close-modal" style="border: 1px solid #ccc; padding: 8px 16px;">Close</button>
        </div>
    </div>
  </div>

  <!-- Attendance Modal -->
  <div id="att-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 50px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0" id="att-modal-title">Add Attendance</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <form id="att-modal-form" style="display: grid; gap: 15px;">
            <input type="hidden" id="att-edit-id">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-date">Date</label>
                    <input type="date" id="att-date" required style="width:100%">
                </div>
                <div>
                    <label for="att-shift">Shift</label>
                    <select id="att-shift" required style="width:100%">
                        <option value="1st Shift-(6am-2pm)">1st Shift-(6am-2pm)</option>
                        <option value="2nd Shift-(2pm-10pm)">2nd Shift-(2pm-10pm)</option>
                        <option value="3rd Shift-(10pm-6am)">3rd Shift-(10pm-6am)</option>
                    </select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                <div>
                    <label for="att-user-id">User ID</label>
                    <input type="text" id="att-user-id" placeholder="ID" style="width:100%">
                </div>
                <div>
                    <label for="att-name">Name</label>
                    <input type="text" id="att-name" required placeholder="Enter Name" style="width:100%" list="att-name-list" autocomplete="off">
                    <datalist id="att-name-list"></datalist>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-role">Role</label>
                    <select id="att-role" style="width:100%">
                        <option value="IC Support">IC Support</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="Admin">Admin</option>
                        <option value="Management">Management</option>
                    </select>
                </div>
                <div>
                    <label for="att-area">Job Description</label>
                    <select id="att-area" style="width:100%">
                        <option value="TL">TL</option>
                        <option value="OIC">OIC</option>
                        <option value="Encoder">Encoder</option>
                        <option value="SBD Checker">SBD Checker</option>
                        <option value="RTV">RTV</option>
                        <option value="Damaged Checker">Damaged Checker</option>
                        <option value="B1T1 Checker">B1T1 Checker</option>
                        <option value="Validator">Validator</option>
                        <option value="HVI Support">HVI Support</option>
                        <option value="Cycle Counter">Cycle Counter</option>
                        <option value="Projects">Projects</option>
                        <option value="HO-Cancelled">HO-Cancelled</option>
                    </select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-time-in">Time In</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-time-in" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-time-in" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="att-time-out">Time Out</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-time-out" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-time-out" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div>
                <label for="att-status">Status</label>
                <select id="att-status" style="width:100%">
                    <option value="Full-time">Full-time</option>
                    <option value="Full Counter">Full Counter</option>
                    <option value="Temporary slide to Other task">Temporary slide to Other task</option>
                </select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-break-out">Break Out</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-break-out" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-break-out" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="att-break-in">Break In</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-break-in" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-break-in" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div style="text-align:right; margin-top:10px; border-top: 1px solid #eee; padding-top: 15px;">
                <button type="button" class="icon-btn close-modal" style="margin-right:5px; border: 1px solid #ccc; padding: 8px 16px;">Close</button>
                <button type="submit" class="icon-btn" style="background: #2752a7; color: white; padding: 8px 16px;">Save</button>
            </div>
        </form>
    </div>
  </div>

  <!-- Counter Timestamp Modal -->
  <div id="timestamp-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="width: 98vw; max-width: 1800px; height: 90vh; margin: 20px auto; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Counter Timestamp</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        
        <div style="display:flex; gap: 20px; flex:1; overflow:hidden;">
            <!-- Left Column: Controls & Tables -->
            <div style="flex: 2; display:flex; flex-direction:column; gap:10px; overflow-y:auto; padding-right:10px;">
                <!-- Controls -->
                <div>
                    <div style="margin-bottom:10px;">
                    <label for="ts-user-id" style="font-weight:bold;">User ID / Name</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="ts-user-id" placeholder="User ID" style="flex:1; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:4px;">
                        <input type="text" id="ts-user-name-display" placeholder="Name" readonly style="flex:1; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:4px; background:#f9f9f9;">
                    </div>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:5px; margin-bottom:10px;">
                        <button id="btn-break-start-main" class="icon-btn" style="background:#f1c40f; color:white; padding:10px; font-weight:bold; justify-content:center;">Break Out</button>
                        <button id="btn-break-end-main" class="icon-btn" style="background:#f39c12; color:white; padding:10px; font-weight:bold; justify-content:center;">Break In</button>
                        <button id="btn-nsw" class="icon-btn" style="background:#9b59b6; color:white; padding:10px; font-weight:bold; justify-content:center;">Simple Task</button>
                        <button id="btn-end-task" class="icon-btn" style="background:#8e44ad; color:white; padding:10px; font-weight:bold; justify-content:center;">End Task</button>
                        <button id="btn-time-out" class="icon-btn" style="background:#34495e; color:white; padding:10px; font-weight:bold; justify-content:center;">Time Out</button>
                    </div>
                </div>

                <!-- Table 1: Today's Logs -->
                <div class="card" style="margin:0; padding:10px; display:flex; flex-direction:column; max-height:400px;">
                    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <button class="icon-btn toggle-section-btn" title="Toggle Table" style="padding:2px; height:24px; width:24px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                            <h4 style="margin:0;">Today's Logs</h4>
                        </div>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <select id="ts-shift-filter" style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">All Shifts</option>
                                <option value="1st Shift">1st Shift</option>
                                <option value="2nd Shift">2nd Shift</option>
                                <option value="3rd Shift">3rd Shift</option>
                            </select>
                            <input type="text" id="ts-filter-user" placeholder="Search User..." style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; width: 100px;">
                            <label style="font-size:12px; cursor:pointer;"><input type="checkbox" id="ts-show-active"> Active Only</label>
                            <button id="ts-delete-selected-btn" class="icon-btn" title="Delete Selected" style="padding: 2px 6px; font-size: 12px; color:#d9534f; display:none;">Del Sel</button>
                            <button id="ts-purge-all-btn" class="icon-btn" title="Permanently Delete All Shown" style="padding: 2px 6px; font-size: 12px; background:#c0392b; color:white; border-color:#c0392b;">Purge All</button>
                            <button id="ts-export-btn" class="icon-btn" title="Export CSV" style="padding: 2px 6px; font-size: 12px;">Export</button>
                        </div>
                    </div>
                    <div class="section-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
                        <table id="timestamp-table" style="width:100%; border-collapse:collapse; font-size:12px;">
                            <thead>
                                <tr style="background:#f9f9f9; border-bottom:1px solid #eee; position:sticky; top:0;">
                                    <th style="padding:8px; text-align:left; width:30px;"><input type="checkbox" id="ts-select-all"></th>
                                    <th style="padding:8px; text-align:left;">User ID</th>
                                    <th style="padding:8px; text-align:left;">Name</th>
                                    <th style="padding:8px; text-align:left;">Area Type</th>
                                    <th style="padding:8px; text-align:left;">Shift</th>
                                    <th style="padding:8px; text-align:left;">Start Time</th>
                                    <th style="padding:8px; text-align:left;">End Time</th>
                                    <th style="padding:8px; text-align:left;">Duration</th>
                                    <th style="padding:8px; text-align:left;">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="ts-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; padding-top:5px; margin-top:5px; border-top: 1px solid #eee;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <label for="ts-rows-per-page" style="font-size:11px; color:#666;">Rows:</label>
                            <select id="ts-rows-per-page" style="padding: 2px 4px; font-size:11px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <span id="ts-page-info" style="font-size: 11px; font-weight: 600; color: #666;"></span>
                        <div style="display:flex; gap:5px;">
                            <button id="ts-prev-page" class="icon-btn" title="Previous" style="padding:2px 6px; font-size:12px;">‹</button>
                            <button id="ts-next-page" class="icon-btn" title="Next" style="padding:2px 6px; font-size:12px;">›</button>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Table 2: Break Log -->
                <div class="card" style="margin:0; padding:10px; display:flex; flex-direction:column; max-height:300px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <button class="icon-btn toggle-section-btn" title="Toggle Table" style="padding:2px; height:24px; width:24px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                            <h4 style="margin:0;">Break Log</h4>
                        </div>
                        <div style="display:flex; gap:5px;">
                             <select id="break-shift-filter" style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; width: 80px;">
                                <option value="">All Shifts</option>
                                <option value="1st Shift">1st Shift</option>
                                <option value="2nd Shift">2nd Shift</option>
                                <option value="3rd Shift">3rd Shift</option>
                             </select>
                             <label style="font-size:12px; cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="break-show-active"> Active</label>
                             <input type="datetime-local" id="manual-break-time" style="padding:4px; font-size:11px; border:1px solid #ccc; border-radius:4px; width:130px;" title="Manual Break Time">
                             <button id="btn-break-start" class="icon-btn" style="background:#f1c40f; color:white; padding:4px 8px; font-size:12px; font-weight:bold;">Start Break</button>
                             <button id="btn-break-end" class="icon-btn" style="background:#f39c12; color:white; padding:4px 8px; font-size:12px; font-weight:bold;">End Break</button>
                             <button id="break-delete-selected-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; padding:4px 8px; font-size:12px; font-weight:bold; display:none;">Del Sel</button>
                             <button id="break-export-btn" class="icon-btn" title="Export CSV" style="padding:4px 8px; font-size:12px; font-weight:bold;">Export</button>
                             <button id="btn-break-delete-all" class="icon-btn" title="Delete All Breaks" style="color:#d9534f; padding:4px 8px; font-size:12px; font-weight:bold; margin-left:5px;">🗑 All</button>
                        </div>
                    </div>
                    <div class="section-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee;">
                        <table id="break-log-table" style="width:100%; font-size:12px; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f9f9f9; position:sticky; top:0;">
                                    <th style="padding:5px; text-align:left; width:30px;"><input type="checkbox" id="break-select-all"></th>
                                    <th style="padding:5px; text-align:left;">User</th>
                                    <th style="padding:5px; text-align:left;">Name</th>
                                    <th style="padding:5px; text-align:left;">Shift</th>
                                    <th style="padding:5px; text-align:left;">Role</th>
                                    <th style="padding:5px; text-align:left;">Break Out</th>
                                    <th style="padding:5px; text-align:left;">Break In</th>
                                    <th style="padding:5px; text-align:left;">Duration</th>
                                    <th style="padding:5px; text-align:left;">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                </div>

                <!-- Table 3: Inactive Users -->
                <div class="card" style="margin:0; padding:10px; display:flex; flex-direction:column; max-height:300px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <button class="icon-btn toggle-section-btn" title="Toggle Table" style="padding:2px; height:24px; width:24px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                            <h4 style="margin:0;">Inactive Users</h4>
                        </div>
                        <button id="ts-export-inactive-btn" class="icon-btn" title="Export CSV" style="padding: 2px 6px; font-size: 12px;">Export</button>
                    </div>
                    <div class="section-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee;">
                        <table id="inactive-users-table" style="width:100%; font-size:12px; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f9f9f9; position:sticky; top:0;">
                                    <th style="padding:5px; text-align:left; cursor:pointer;" onclick="sortInactiveTable('userId')">User <span class="sort-icon"></span></th>
                                    <th style="padding:5px; text-align:left; cursor:pointer;" onclick="sortInactiveTable('name')">Name <span class="sort-icon"></span></th>
                                    <th style="padding:5px; text-align:left; cursor:pointer;" onclick="sortInactiveTable('shift')">Shift <span class="sort-icon"></span></th>
                                    <th style="padding:5px; text-align:left; cursor:pointer;" onclick="sortInactiveTable('role')">Role <span class="sort-icon"></span></th>
                                    <th style="padding:5px; text-align:left; cursor:pointer;" onclick="sortInactiveTable('lastEnd')">Last End Count <span class="sort-icon"></span></th>
                                    <th style="padding:5px; text-align:center; width:40px;">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>

            <!-- Right Column: Analytics -->
            <div style="flex: 1; display:flex; flex-direction:column; border-left:1px solid #eee; padding-left:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0;">Analytics Overview</h4>
                    <input type="date" id="ts-analytics-date-filter" style="padding:2px 5px; border:1px solid #ccc; border-radius:4px; font-size:12px; color:#333;" title="Filter Analytics Date">
                </div>
                <div id="ts-analytics-content" style="flex: 1; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
  </div>

  <!-- Start Count Area Selection Modal -->
  <div id="start-area-modal" class="modal hidden" style="z-index: 10015;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 150px auto; text-align: center;">
        <h3 style="margin-top:0">Select Area</h3>
        <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
            <div class="card area-card" data-bin-type="Reserved" style="cursor:pointer; padding:20px; border:2px solid #eee; width:120px; transition:all 0.2s;">
                <div style="font-size:30px;">📦</div>
                <div style="font-weight:bold; margin-top:10px;">Reserved Bin</div>
            </div>
            <div class="card area-card" data-bin-type="Pick Bin" style="cursor:pointer; padding:20px; border:2px solid #eee; width:120px; transition:all 0.2s;">
                <div style="font-size:30px;">🛒</div>
                <div style="font-weight:bold; margin-top:10px;">Pick Bin</div>
            </div>
        </div>
        <button id="cancel-start-area-btn" class="icon-btn" style="margin-top:20px; border:1px solid #ccc;">Cancel</button>
    </div>
  </div>

  <!-- Warehouse Area Selection Modal -->
  <div id="warehouse-area-modal" class="modal hidden" style="z-index: 10016;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 150px auto; text-align: center;">
        <h3 style="margin-top:0">Select Warehouse Area</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; justify-content:center; margin-top:20px;">
            <div class="card area-card" data-warehouse-area="Coldroom" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">❄️</div>
                <div style="font-weight:bold; margin-top:10px;">Coldroom</div>
            </div>
            <div class="card area-card" data-warehouse-area="Ecom 2" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">🌐</div>
                <div style="font-weight:bold; margin-top:10px;">Ecom 2</div>
            </div>
            <div class="card area-card" data-warehouse-area="Storage" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">🗄️</div>
                <div style="font-weight:bold; margin-top:10px;">Storage</div>
            </div>
            <div class="card area-card" data-warehouse-area="Pallet Picking" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">🏗️</div>
                <div style="font-weight:bold; margin-top:10px;">Pallet Picking</div>
            </div>
        </div>
        <button id="cancel-warehouse-area-btn" class="icon-btn" style="margin-top:20px; border:1px solid #ccc;">Back</button>
    </div>
  </div>

  <!-- Reports Selection Modal -->
  <div id="reports-modal" class="modal hidden" style="z-index: 10020;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 100px auto; text-align: center;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Select Report</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center; justify-content:center; background:#f9f9f9; padding:10px; border-radius:4px;">
            <div style="text-align:left;">
                <label style="font-size:11px; display:block; font-weight:bold;">From</label>
                <input type="date" id="rep-start-date" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:12px;">
            </div>
            <div style="text-align:left;">
                <label style="font-size:11px; display:block; font-weight:bold;">To</label>
                <input type="date" id="rep-end-date" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:12px;">
            </div>
        </div>
        <div style="display:grid; gap:10px;">
            <button id="rep-sessions-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Counter Sessions (CSV)
            </button>
            <button id="rep-attendance-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Attendance List (CSV)
            </button>
            <button id="rep-breaklog-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Break Logs (CSV)
            </button>
            <button id="rep-inactive-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                Inactive Users (CSV)
            </button>
        </div>
    </div>
  </div>

  <!-- Supervisor Delete Modal -->
  <div id="supervisor-delete-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px;">
      <h3 id="supervisor-modal-title">Confirm Deletion</h3>
      <p>You are about to delete <strong id="supervisor-delete-count">0</strong> records.</p>
      <p class="muted">This action cannot be undone. Please enter Supervisor Code to proceed.</p>
      <div style="margin: 15px 0;">
        <label for="supervisor-code" style="display:block; margin-bottom:5px; font-weight:bold;">Supervisor Code</label>
        <input type="password" id="supervisor-code" style="width:100%;" placeholder="Enter code">
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button type="button" class="icon-btn close-modal">Cancel</button>
        <button type="button" id="confirm-supervisor-delete-btn" class="icon-btn" style="background:#d9534f; color:white;">Confirm Delete</button>
      </div>
    </div>
  </div>

  <!-- Edit Timestamp Modal -->
  <div id="edit-time-modal" class="modal hidden" style="z-index: 10015;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 150px auto;">
        <h3 style="margin-top:0">Edit Timestamp</h3>
        <input type="hidden" id="edit-time-log-id">
        <div style="margin-bottom:15px;">
            <label for="edit-time-input" style="font-weight:bold;">New Date & Time:</label>
            <input type="datetime-local" id="edit-time-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button id="cancel-edit-time-btn" class="icon-btn" style="border:1px solid #ccc;">Cancel</button>
            <button id="save-edit-time-btn" class="icon-btn" style="background:#2752a7; color:white;">Save</button>
        </div>
    </div>
  </div>

  <!-- Requirements Modal -->
  <div id="req-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 800px; margin: 50px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Set Shift Requirements (Daily)</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <div style="margin-bottom:10px;">
            <select id="req-role-filter" style="padding:6px; border:1px solid #ccc; border-radius:4px; width:100%;"><option value="">All Sub Roles</option></select>
        </div>
        <div style="overflow-x:auto; max-height: 60vh;">
            <table class="report-table" id="req-table">
                <thead>
                    <tr>
                        <th>Sub Role</th>
                        <th>1st Shift</th>
                        <th>2nd Shift</th>
                        <th>3rd Shift</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="text-align:right; margin-top:15px;">
            <input type="file" id="import-req-file" accept=".csv" style="display:none;">
            <button id="import-req-btn" class="icon-btn" style="background: #fff; color: #333; border: 1px solid #ccc; padding: 8px 16px; margin-right: 5px;">Import CSV</button>
            <button id="export-req-btn" class="icon-btn" style="background: #fff; color: #333; border: 1px solid #ccc; padding: 8px 16px; margin-right: 5px;">Export CSV</button>
            <button id="save-req-btn" class="icon-btn" style="background: #2752a7; color: white; padding: 8px 16px;">Save Requirements</button>
        </div>
    </div>
  </div>

  <!-- IC Master Modal -->
  <div id="ic-master-modal" class="modal hidden" style="z-index: 10025;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 600px; margin: 50px auto; display:flex; flex-direction:column; max-height:85vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">IC User ID Master (IC Support)</h3>
            <div style="display:flex; gap:5px;">
                <button id="ic-master-template-btn" class="icon-btn" title="Download Template">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>
                <button id="ic-master-upload-btn" class="icon-btn" title="Upload Master List">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                </button>
                <input type="file" id="ic-master-upload-file" accept=".csv" style="display:none;">
                <button class="icon-btn close-modal">&times;</button>
            </div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1.5fr 1fr 1fr auto; gap:5px; align-items:end; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
            <div>
                <label style="font-size:11px; font-weight:bold;">User ID</label>
                <input type="text" id="ic-master-id" style="width:100%; padding:5px; text-transform:uppercase;" placeholder="ID">
            </div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Name</label>
                <input type="text" id="ic-master-name" style="width:100%; padding:5px; text-transform:uppercase;" placeholder="Name">
            </div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Role</label>
                <select id="ic-master-role" style="width:100%; padding:5px;"><option value="IC Support">IC Support</option><option value="IC Back up">IC Back up</option><option value="Warehouse">Warehouse</option><option value="Admin">Admin</option><option value="Management">Management</option></select>
            </div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Job Desc</label>
                <select id="ic-master-job" style="width:100%; padding:5px;"><option value="">-</option></select>
            </div>
            <button id="save-ic-master-btn" class="icon-btn" style="background:#2752a7; color:white; height:28px; padding:0 10px;">Save</button>
        </div>

        <div style="margin-bottom:10px;">
            <input type="text" id="ic-master-search" placeholder="Search..." style="padding:6px; border:1px solid #ccc; border-radius:4px; width: 100%;">
        </div>
        <div style="flex:1; overflow:auto; border:1px solid #eee;">
            <table id="ic-master-table" class="report-table" style="width:100%;">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="userId" style="position:sticky; top:0; z-index:1;">User ID <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort="name" style="position:sticky; top:0; z-index:1;">Name <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort="role" style="position:sticky; top:0; z-index:1;">Role <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort="jobDescription" style="position:sticky; top:0; z-index:1;">Job Description <span class="sort-icon"></span></th>
                        <th style="position:sticky; top:0; z-index:1;">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="ic-master-pagination" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-top:1px solid #eee;">
            <div style="display:flex; align-items:center; gap:5px;">
                <label style="font-size:12px;">Rows:</label>
                <select id="ic-master-rows" style="padding:2px; font-size:12px;">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <span id="ic-master-page-info" style="font-size:12px; color:#666;"></span>
            <div style="display:flex; gap:5px;">
                <button id="ic-master-prev" class="icon-btn" style="padding:2px 6px;">&lt;</button>
                <button id="ic-master-next" class="icon-btn" style="padding:2px 6px;">&gt;</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Ops Validators Modal -->
  <div id="ops-validators-modal" class="modal hidden" style="z-index: 10030;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 50px auto; display:flex; flex-direction:column; max-height:85vh;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h3 style="margin:0">Ops Validators</h3>
          <button class="icon-btn close-modal">&times;</button>
      </div>
      <div style="display:grid; grid-template-columns: 1fr auto; gap:5px; align-items:end; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
          <div>
              <label style="font-size:11px; font-weight:bold;">Validator Name</label>
              <input type="text" id="ops-validator-name" style="width:100%; padding:5px;" placeholder="Name">
              <input type="hidden" id="ops-validator-id">
          </div>
          <button id="save-ops-validator-btn" class="icon-btn" style="background:#2752a7; color:white; height:28px; padding:0 10px;">Save</button>
      </div>
      <div style="margin-bottom:10px;">
          <input type="text" id="ops-validator-search" placeholder="Search..." style="padding:6px; border:1px solid #ccc; border-radius:4px; width: 100%;">
      </div>
      <div style="flex:1; overflow:auto; border:1px solid #eee;">
          <table id="ops-validators-table" class="report-table" style="width:100%;">
              <thead>
                  <tr>
                      <th style="position:sticky; top:0; z-index:1;">Name</th>
                      <th style="position:sticky; top:0; z-index:1; width: 80px; text-align:center;">Action</th>
                  </tr>
              </thead>
              <tbody></tbody>
          </table>
      </div>
    </div>
  </div>

  <!-- Validators Modal -->
  <div id="validators-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="width: 100%; height: 100%; max-width: none; margin: 0; border-radius: 0; display:flex; flex-direction:column; background:#f4f6f8;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:#fff; padding:10px; border-radius:8px; border:1px solid #eef2f6;">
            <div style="display:flex; align-items:center; gap:15px;">
                <h3 style="margin:0">IC Validators View <span id="sku-master-status" style="font-size:11px; font-weight:normal; margin-left:5px;"></span></h3>
                <span id="validator-notification" style="display:none; padding: 4px 12px; border-radius: 4px; font-weight: bold; font-size: 13px; transition: opacity 0.3s;"></span>
            </div>
            <div style="display:flex; align-items:center; gap: 5px;">
                <button id="toggle-add-task-widget-btn" class="icon-btn" title="Open Add Task Widget" style="background:#2752a7; color:white;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                <button id="add-ops-task-btn" class="icon-btn" title="Print Blank Ops Form" style="background:#e67e22; color:white;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg></button>
                <button id="manage-ops-validators-btn" class="icon-btn" title="Manage Ops Validators" style="background:#9b59b6; color:white;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </button>
                <div style="width:1px; height:20px; background:#ddd; margin:0 2px;"></div>
                <div style="display:flex; align-items:center; gap:2px;">
                    <input type="date" id="val-start-date" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px; width:110px;" title="From Date">
                    <span style="font-size:11px;">-</span>
                    <input type="date" id="val-end-date" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px; width:110px;" title="To Date">
                    <select id="val-view-shift" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px; width:80px;">
                        <option value="">All Shifts</option>
                        <option value="1st Shift">1st Shift</option>
                        <option value="2nd Shift">2nd Shift</option>
                        <option value="3rd Shift">3rd Shift</option>
                    </select>
                    <button id="val-date-filter-btn" class="icon-btn" title="Apply Filter" style="padding:4px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg></button>
                    <button id="val-clear-date-btn" class="icon-btn" title="Clear Date Filter" style="padding:4px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
                <div style="width:1px; height:20px; background:#ddd; margin:0 2px;"></div>
                <button onclick="window.openUniversalSearch && window.openUniversalSearch(['Cycle Count', 'Attendance', 'Daily Counter', 'Validation Task'])" class="icon-btn" title="Universal Search (Ctrl+K)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
                <div style="position:relative;">
                    <input type="text" id="val-global-search" placeholder="Search SKU, Desc, Validator..." style="padding:4px 8px; border:1px solid #ccc; border-radius:4px; font-size:12px; width:180px;">
                    <div id="val-search-preview" class="search-preview-dropdown" style="display:none;"></div>
                </div>
                <button id="export-val-all-btn" class="icon-btn" title="Export All (Excel)" style="color:#27ae60; border:1px solid #ccc; background:#fff;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></button>
                <button id="email-val-report-btn" class="icon-btn" title="Email Status Report" style="color:#3498db; border:1px solid #ccc; background:#fff;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></button>
                <button id="val-actions-btn" class="icon-btn" title="Actions" style="margin-right:5px; padding: 4px 12px; font-size: 12px; font-weight: bold; background: #f0f4f8; border: 1px solid #ccc;">Actions</button>
                <button class="icon-btn close-modal">&times;</button>
            </div>
        </div>

        <!-- 1. Top Center: Dashboard -->
        <div id="validation-summary-dashboard" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
        <div class="stat-card" style="padding:15px; border-left: 4px solid #1565c0;" onclick="filterValDashboard('total')">
                <div class="stat-icon" style="background: #e3f2fd; color: #1565c0;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="val-total-tasks">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
            </div>
    
        <div class="stat-card" style="padding:15px; border-left: 4px solid #ef6c00;" onclick="filterValDashboard('pending')">
                <div class="stat-icon" style="background: #fff3e0; color: #ef6c00;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="val-pending-tasks">0</div>
                    <div class="stat-label">Pending</div>
                </div>
            </div>
        <div class="stat-card" style="padding:15px; border-left: 4px solid #3498db;" onclick="filterValDashboard('assigned')">
            <div class="stat-icon" style="background: rgba(52, 152, 219, 0.1); color: #3498db;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>
            </div>
            <div class="stat-info">
                <div class="stat-value" id="val-assigned-tasks">0</div>
                <div class="stat-label">Assigned</div>
            </div>
        </div>
        <div class="stat-card" style="padding:15px; border-left: 4px solid #2e7d32;" onclick="filterValDashboard('resolved')">
                <div class="stat-icon" style="background: #e8f5e9; color: #2e7d32;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="val-completed-tasks">0</div>
                <div class="stat-label">Resolved</div>
                </div>
            </div>
        <div class="stat-card" style="padding:15px; border-left: 4px solid #d9534f;" onclick="filterValDashboard('unresolved')">
                <div class="stat-icon" style="background: #ffebee; color: #d9534f;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="val-unresolved-tasks">0</div>
                    <div class="stat-label">Unresolved</div>
                </div>
            </div>
        <div class="stat-card" style="padding:15px; border-left: 4px solid #7b1fa2;" onclick="filterValDashboard('chart')">
                <div class="stat-icon" style="background: #f3e5f5; color: #7b1fa2;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="val-completion-rate">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
            </div>
        <div class="stat-card" style="padding:15px; border-left: 4px solid #009688;" onclick="filterValDashboard('resolved')">
                <div class="stat-icon" style="background: #e0f2f1; color: #009688;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="val-pct-resolved">0%</div>
                    <div class="stat-label">% by Resolved</div>
                </div>
            </div>
        <div class="stat-card" style="padding:15px; border-left: 4px solid #e91e63;" onclick="filterValDashboard('unresolved')">
                <div class="stat-icon" style="background: #fce4ec; color: #e91e63;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="val-pct-unresolved">0%</div>
                    <div class="stat-label">% by Unresolved</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div style="display:flex; gap:15px; flex:1; overflow:hidden;">
            
            <!-- 2. Left Side (60%) -->
            <div style="flex:6; display:flex; flex-direction:column; gap:15px; overflow:hidden;">
                <!-- Table 1: Pending -->
                <div id="val-tasks-card" class="card" style="flex:1; display:flex; flex-direction:column; margin:0; padding:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div class="att-tabs" style="margin-bottom:0; border-bottom:none;">
                            <button class="att-tab active" onclick="openValTab(event, 'tab-val-pending')">Pending</button>
                            <button class="att-tab" onclick="openValTab(event, 'tab-val-assigned')">Assigned</button>
                            <button class="att-tab" onclick="openValTab(event, 'tab-val-resolved')">Resolved</button>
                            <button class="att-tab" onclick="openValTab(event, 'tab-val-unresolved')">Unresolved</button>
                            <button class="att-tab" onclick="openValTab(event, 'tab-val-history')">History</button>
                        </div>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <input type="text" id="val-filter-sku-1" placeholder="Filter SKU..." style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px; width:100px;">
                            <select id="val-filter-priority-1" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px; width:90px;">
                                <option value="">All Priorities</option>
                                <option value="Normal">Normal</option>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select>
                            <input type="text" id="val-filter-assigned-1" placeholder="Filter Assigned To..." style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px; width:120px;">
                            <button class="icon-btn" id="val-clear-filters-btn-1" title="Clear Filters"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                            <button class="icon-btn" id="val-print-btn-1" title="Print"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg></button>
                            <button class="icon-btn" id="val-export-btn-1" title="Export CSV"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
                            <button class="icon-btn" id="val-bulk-assign-btn-1" title="Bulk Assign" style="color:#3498db; display:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg></button>
                            <button class="icon-btn" id="val-bulk-reassign-btn-1" title="Bulk Reassign" style="color:#f39c12; display:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></button>
                            <button class="icon-btn" id="val-bulk-delete-btn-1" title="Delete Selected" style="color:#d9534f; display:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg></button>
                        </div>
                    </div>

                    <div id="tab-val-pending" class="val-tab-content" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                        <div style="flex:1; overflow:auto; position:relative;">
                        <table class="report-table" style="width:100%; table-layout: auto; white-space: nowrap; font-size: 11px;">
                            <thead>
                                <tr>
                                    <th style="position:sticky; top:0; z-index:10; width:30px; background:#f0f0f0;"><input type="checkbox" id="val-select-all-pending"></th>
                                    <th style="position:sticky; top:0; z-index:1;">Assigned</th>
                                    <th style="position:sticky; top:0; z-index:1;">Priority</th>
                                    <th style="position:sticky; top:0; z-index:1;">SKU</th>
                                    <th style="position:sticky; top:0; z-index:1;">Description</th>
                                    <th style="position:sticky; top:0; z-index:1;">Qty</th>
                                    <th style="position:sticky; top:0; z-index:1;">Reason</th>
                                    <th style="position:sticky; top:0; z-index:1;">Expiry Date</th>
                                    <th style="position:sticky; top:0; z-index:1;">Ops Validator</th>
                                    <th style="position:sticky; top:0; z-index:1;">Assigned To</th>
                                    <th style="position:sticky; top:0; z-index:1;">Duration</th>
                                    <th style="position:sticky; top:0; z-index:1;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="pending-tasks-tbody"></tbody>
                        </table>
                    </div>
                        <div id="val-pending-pagination" style="display:flex; justify-content:space-between; align-items:center; margin-top:5px; padding-top:5px; border-top:1px solid #eee;">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <label style="font-size:11px;">Rows:</label>
                                <select id="val-pending-rows" style="padding:2px; font-size:11px;">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                </select>
                            </div>
                            <span id="val-pending-info" style="font-size:11px; color:#666;"></span>
                            <div style="display:flex; gap:5px;">
                                <button id="val-pending-prev" class="icon-btn" style="padding:2px 6px; font-size:11px;">&lt;</button>
                                <button id="val-pending-next" class="icon-btn" style="padding:2px 6px; font-size:11px;">&gt;</button>
                            </div>
                        </div>
                    </div>

                    <div id="tab-val-assigned" class="val-tab-content" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
                        <div style="flex:1; overflow:auto; position:relative;">
                            <table class="report-table" style="width:100%; table-layout: auto; white-space: nowrap; font-size: 11px;">
                                <thead>
                                    <tr>
                                        <th style="position:sticky; top:0; z-index:10; width:30px; background:#f0f0f0;"><input type="checkbox" id="val-select-all-assigned"></th>
                                        <th style="position:sticky; top:0; z-index:1;">Assigned</th>
                                        <th style="position:sticky; top:0; z-index:1;">Priority</th>
                                        <th style="position:sticky; top:0; z-index:1;">SKU</th>
                                        <th style="position:sticky; top:0; z-index:1;">Description</th>
                                        <th style="position:sticky; top:0; z-index:1;">Qty</th>
                                        <th style="position:sticky; top:0; z-index:1;">Reason</th>
                                        <th style="position:sticky; top:0; z-index:1;">Expiry Date</th>
                                        <th style="position:sticky; top:0; z-index:1;">Ops Validator</th>
                                        <th style="position:sticky; top:0; z-index:1;">Assigned To</th>
                                        <th style="position:sticky; top:0; z-index:1;">Duration</th>
                                        <th style="position:sticky; top:0; z-index:1;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="assigned-tasks-tbody"></tbody>
                            </table>
                        </div>
                        <div id="val-assigned-pagination" style="display:flex; justify-content:space-between; align-items:center; margin-top:5px; padding-top:5px; border-top:1px solid #eee;">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <label style="font-size:11px;">Rows:</label>
                                <select id="val-assigned-rows" style="padding:2px; font-size:11px;">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                </select>
                            </div>
                            <span id="val-assigned-info" style="font-size:11px; color:#666;"></span>
                            <div style="display:flex; gap:5px;">
                                <button id="val-assigned-prev" class="icon-btn" style="padding:2px 6px; font-size:11px;">&lt;</button>
                                <button id="val-assigned-next" class="icon-btn" style="padding:2px 6px; font-size:11px;">&gt;</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resolved Tab -->
                    <div id="tab-val-resolved" class="val-tab-content" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
                        <div style="flex:1; overflow:auto; position:relative;">
                        <table class="report-table" style="width:100%; table-layout: auto; white-space: nowrap; font-size: 11px;">
                            <thead>
                                <tr>
                                    <th style="position:sticky; top:0; z-index:10; width:30px; background:#f0f0f0;"><input type="checkbox" id="val-select-all-resolved"></th>
                                    <th style="position:sticky; top:0; z-index:1;">Resolved</th>
                                    <th style="position:sticky; top:0; z-index:1;">Priority</th>
                                    <th style="position:sticky; top:0; z-index:1;">SKU</th>
                                    <th style="position:sticky; top:0; z-index:1;">Description</th>
                                    <th style="position:sticky; top:0; z-index:1;">Qty</th>
                                    <th style="position:sticky; top:0; z-index:1;">Reason</th>
                                    <th style="position:sticky; top:0; z-index:1;">Expiry Date</th>
                                    <th style="position:sticky; top:0; z-index:1;">Ops Validator</th>
                                    <th style="position:sticky; top:0; z-index:1;">IC Validator</th>
                                    <th style="position:sticky; top:0; z-index:1;">Duration</th>
                                    <th style="position:sticky; top:0; z-index:1;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="resolved-tasks-tbody"></tbody>
                        </table>
                    </div>
                        <div id="val-resolved-pagination" style="display:flex; justify-content:space-between; align-items:center; margin-top:5px; padding-top:5px; border-top:1px solid #eee;">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <label style="font-size:11px;">Rows:</label>
                                <select id="val-resolved-rows" style="padding:2px; font-size:11px;">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                </select>
                            </div>
                            <span id="val-resolved-info" style="font-size:11px; color:#666;"></span>
                            <div style="display:flex; gap:5px;">
                                <button id="val-resolved-prev" class="icon-btn" style="padding:2px 6px; font-size:11px;">&lt;</button>
                                <button id="val-resolved-next" class="icon-btn" style="padding:2px 6px; font-size:11px;">&gt;</button>
                            </div>
                        </div>
                    </div>

                    <!-- Unresolved Tab -->
                    <div id="tab-val-unresolved" class="val-tab-content" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
                        <div style="flex:1; overflow:auto; position:relative;">
                            <table class="report-table" style="width:100%; table-layout: auto; white-space: nowrap; font-size: 11px;">
                                <thead>
                                    <tr>
                                        <th style="position:sticky; top:0; z-index:10; width:30px; background:#f0f0f0;"><input type="checkbox" id="val-select-all-unresolved"></th>
                                        <th style="position:sticky; top:0; z-index:1;">Date</th>
                                        <th style="position:sticky; top:0; z-index:1;">Priority</th>
                                        <th style="position:sticky; top:0; z-index:1;">SKU</th>
                                        <th style="position:sticky; top:0; z-index:1;">Description</th>
                                        <th style="position:sticky; top:0; z-index:1;">Qty</th>
                                        <th style="position:sticky; top:0; z-index:1;">Reason</th>
                                        <th style="position:sticky; top:0; z-index:1;">Expiry Date</th>
                                        <th style="position:sticky; top:0; z-index:1;">Ops Validator</th>
                                        <th style="position:sticky; top:0; z-index:1;">IC Validator</th>
                                        <th style="position:sticky; top:0; z-index:1;">Unresolved Time</th>
                                        <th style="position:sticky; top:0; z-index:1;">Duration</th>
                                        <th style="position:sticky; top:0; z-index:1;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="unresolved-tasks-tbody"></tbody>
                            </table>
                        </div>
                        <div id="val-unresolved-pagination" style="display:flex; justify-content:space-between; align-items:center; margin-top:5px; padding-top:5px; border-top:1px solid #eee;">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <label style="font-size:11px;">Rows:</label>
                                <select id="val-unresolved-rows" style="padding:2px; font-size:11px;">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                </select>
                            </div>
                            <span id="val-unresolved-info" style="font-size:11px; color:#666;"></span>
                            <div style="display:flex; gap:5px;">
                                <button id="val-unresolved-prev" class="icon-btn" style="padding:2px 6px; font-size:11px;">&lt;</button>
                                <button id="val-unresolved-next" class="icon-btn" style="padding:2px 6px; font-size:11px;">&gt;</button>
                            </div>
                        </div>
                    </div>

                    <!-- History Tab -->
                    <div id="tab-val-history" class="val-tab-content" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
                        <div style="flex:1; overflow:auto; position:relative;">
                            <table class="report-table" style="width:100%; table-layout: auto; white-space: nowrap; font-size: 11px;">
                                <thead>
                                    <tr>
                                        <th style="position:sticky; top:0; z-index:10; width:30px; background:#f0f0f0;"><input type="checkbox" id="val-select-all-history"></th>
                                        <th style="position:sticky; top:0; z-index:1;">Date</th>
                                        <th style="position:sticky; top:0; z-index:1;">Priority</th>
                                        <th style="position:sticky; top:0; z-index:1;">SKU</th>
                                        <th style="position:sticky; top:0; z-index:1;">Description</th>
                                        <th style="position:sticky; top:0; z-index:1;">Qty</th>
                                        <th style="position:sticky; top:0; z-index:1;">Reason</th>
                                        <th style="position:sticky; top:0; z-index:1;">Expiry Date</th>
                                        <th style="position:sticky; top:0; z-index:1;">Ops Validator</th>
                                        <th style="position:sticky; top:0; z-index:1;">IC Validator</th>
                                        <th style="position:sticky; top:0; z-index:1;">Status</th>
                                        <th style="position:sticky; top:0; z-index:1;">Sub Status</th>
                                        <th style="position:sticky; top:0; z-index:1;">Reassigned To</th>
                                        <th style="position:sticky; top:0; z-index:1;">Duration</th>
                                        <th style="position:sticky; top:0; z-index:1;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="history-tasks-tbody"></tbody>
                            </table>
                        </div>
                        <div id="val-history-pagination" style="display:flex; justify-content:space-between; align-items:center; margin-top:5px; padding-top:5px; border-top:1px solid #eee;">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <label style="font-size:11px;">Rows:</label>
                                <select id="val-history-rows" style="padding:2px; font-size:11px;"><option value="5">5</option><option value="10" selected>10</option><option value="20">20</option></select>
                            </div>
                            <span id="val-history-info" style="font-size:11px; color:#666;"></span>
                            <div style="display:flex; gap:5px;"><button id="val-history-prev" class="icon-btn" style="padding:2px 6px; font-size:11px;">&lt;</button><button id="val-history-next" class="icon-btn" style="padding:2px 6px; font-size:11px;">&gt;</button></div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Overview -->
                <div id="val-analytics-card" class="card" style="margin:0; padding:10px; min-height: 200px; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0; color:#2752a7;">Analytics Overview</h4>
                        <div style="display:flex; gap:5px;">
                            <button id="toggle-val-analytics-view-btn" class="icon-btn" title="Expand View">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                            </button>
                            <button id="export-val-analytics-btn" class="icon-btn" title="Export Analytics CSV">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div class="att-tabs" style="margin-bottom:5px; border-bottom:1px solid #eee;">
                        <button class="att-tab active" onclick="openValAnalyticsTab(event, 'tab-val-top-sku')" style="padding:4px 8px; font-size:11px;">Top SKUs</button>
                        <button class="att-tab" onclick="openValAnalyticsTab(event, 'tab-val-top-validator')" style="padding:4px 8px; font-size:11px;">Top IC Validators</button>
                        <button class="att-tab" onclick="openValAnalyticsTab(event, 'tab-val-reason-analysis')" style="padding:4px 8px; font-size:11px;">Reason Analysis</button>
                        <button class="att-tab" onclick="openValAnalyticsTab(event, 'tab-val-trend')" style="padding:4px 8px; font-size:11px;">Trend Analysis</button>
                    </div>
                    <div id="tab-val-top-sku" class="val-analytics-tab-content" style="flex:1; overflow:auto; max-height:150px;">
                        <table class="report-table" style="width:100%; font-size:10px;">
                            <thead><tr><th style="width:30px;">#</th><th>Most Tasks</th><th>Most Resolved</th><th>Most Unresolved</th></tr></thead>
                            <tbody id="val-analytics-sku-tbody"></tbody>
                        </table>
                    </div>
                    <div id="tab-val-top-validator" class="val-analytics-tab-content" style="display:none; flex:1; overflow:auto; max-height:150px;">
                        <table class="report-table" style="width:100%; font-size:10px;">
                            <thead><tr><th style="width:30px;">#</th><th>Most Resolved</th><th>Most Unresolved</th><th>Most Total Tasks</th><th>Most Present</th></tr></thead>
                            <tbody id="val-analytics-validator-tbody"></tbody>
                        </table>
                    </div>
                    <div id="tab-val-reason-analysis" class="val-analytics-tab-content" style="display:none; flex:1; overflow:hidden;">
                        <div style="height:120px; margin-bottom:5px; position:relative; width:100%;">
                            <canvas id="val-reason-chart"></canvas>
                        </div>
                        <div style="margin-bottom:5px; text-align:right;">
                            <select id="val-analytics-reason-period" style="font-size:10px; padding:2px; border:1px solid #ccc; border-radius:3px;">
                                <option value="global">Global Filter</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                            </select>
                        </div>
                        <div style="overflow:auto; max-height:120px;">
                            <table class="report-table" style="width:100%; font-size:10px;">
                                <thead><tr><th>SKU</th><th>Desc</th><th>Reason</th><th>Count</th></tr></thead>
                                <tbody id="val-analytics-reason-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="tab-val-trend" class="val-analytics-tab-content" style="display:none; flex:1; overflow:hidden;">
                        <div style="position:relative; height:100%; width:100%; padding:5px;">
                            <canvas id="val-trend-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Right Side (40%) -->
            <div style="flex:4; display:flex; flex-direction:column; gap:15px; overflow:hidden;">
                
                <!-- Middle: Status Chart -->
                <div class="card" style="margin:0; padding:10px; min-height: 220px; display:flex; flex-direction:column;">
                    <div style="display:flex; gap:15px; flex:1;">
                        <div style="flex:1; display:flex; flex-direction:column; min-width:0;">
                            <h4 style="margin:0 0 5px 0; color:#2752a7; font-size:13px;">Task Status</h4>
                            <div style="position:relative; flex:1; min-height:0;">
                                <canvas id="val-status-chart" style="width:100%; height:100%;"></canvas>
                            </div>
                        </div>
                        <div style="width:1px; background:#eee;"></div>
                        <div style="flex:1.2; display:flex; flex-direction:column; min-width:0;">
                            <h4 style="margin:0 0 5px 0; color:#e74c3c; font-size:13px;">Overdue (>1h)</h4>
                            <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px; background:#fff;">
                                <table class="report-table" style="width:100%; font-size:10px;">
                                    <thead style="position:sticky; top:0; background:#f9f9f9; z-index:1;">
                                        <tr><th style="padding:4px;">SKU</th><th style="padding:4px;">Validator</th><th style="padding:4px;">Time</th></tr>
                                    </thead>
                                    <tbody id="val-overdue-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom: Available Validators -->
                <div class="card" style="flex:1; display:flex; flex-direction:column; margin:0; padding:10px;">
                    <h4 style="margin:0 0 10px 0; color:#2752a7;">Available IC Validators</h4>
                    <div style="flex:1; overflow:auto;">
                        <table class="report-table" style="width:100%; table-layout: auto; white-space: nowrap; font-size: 11px;">
                    <thead>
                        <tr>
                            <th style="position:sticky; top:0; z-index:1;">User ID</th>
                            <th style="position:sticky; top:0; z-index:1;">Name</th>
                            <th style="position:sticky; top:0; z-index:1;">Shift</th>
                            <th style="position:sticky; top:0; z-index:1;">Pending</th>
                            <th style="position:sticky; top:0; z-index:1;">Resolved</th>
                            <th style="position:sticky; top:0; z-index:1;">Unresolved</th>
                            <th style="position:sticky; top:0; z-index:1;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="validators-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Bottom: Timeout Validators -->
        <div class="card" style="flex:1; display:flex; flex-direction:column; margin:0; padding:10px;">
            <h4 style="margin:0 0 10px 0; color:#e74c3c;">Timeout IC Validators</h4>
            <div style="flex:1; overflow:auto;">
                <table class="report-table" style="width:100%; table-layout: auto; white-space: nowrap; font-size: 11px;">
                    <thead>
                        <tr>
                            <th style="position:sticky; top:0; z-index:1;">User ID</th>
                            <th style="position:sticky; top:0; z-index:1;">Name</th>
                            <th style="position:sticky; top:0; z-index:1;">Shift</th>
                            <th style="position:sticky; top:0; z-index:1;">Pending</th>
                            <th style="position:sticky; top:0; z-index:1;">Resolved</th>
                            <th style="position:sticky; top:0; z-index:1;">Unresolved</th>
                            <th style="position:sticky; top:0; z-index:1;">Total</th>
                            <th style="position:sticky; top:0; z-index:1;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="timeout-validators-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <button id="fab-add-task-btn" class="fab-btn" title="Open Add Task Widget" style="z-index:10005;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>
  </div>

  <!-- Floating Add Task Widget -->
  <div id="add-task-widget" class="card hidden" style="position:fixed; top:100px; right:20px; width:320px; z-index:10002; box-shadow: 0 4px 12px rgba(0,0,0,0.2); padding:0; border:1px solid #ccc;">
        <div id="add-task-header" style="padding:10px; background:#f1f1f1; cursor:move; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; border-radius: 8px 8px 0 0;">
            <span style="font-weight:bold; font-size:13px; color:#333;">Add Validation Task</span>
            <button class="icon-btn close-widget-btn" style="padding:2px; width:20px; height:20px;">&times;</button>
        </div>
        <div style="padding:10px;">
             <div style="display:grid; grid-template-columns: 1fr 0.6fr; gap:8px; align-items:end; margin-bottom:8px;">
                <div>
                    <label style="font-size:10px; font-weight:bold;">SKU Code</label>
                    <input type="text" id="assign-sku" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px;">
                </div>
                <div>
                    <label style="font-size:10px; font-weight:bold;">Qty</label>
                    <input type="number" id="assign-qty" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px;">
                </div>
            </div>
            <div style="margin-bottom:8px;">
                 <label style="font-size:10px; font-weight:bold;">Description</label>
                 <input type="text" id="assign-desc" readonly style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px; background:#eee; font-size:11px;">
            </div>
            <div style="margin-bottom:8px;">
                <label style="font-size:10px; font-weight:bold;">Reason</label>
                <select id="assign-reason" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px;">
                    <option value="">Select Reason</option>
                    <option value="Missing">Missing</option>
                    <option value="Oversell">Oversell</option>
                    <option value="Damaged">Damaged</option>
                    <option value="Expired">Expired</option>
                    <option value="Near Expiry">Near Expiry</option>
                    <option value="Website Issue">Website Issue</option>
                    <option value="Supplier Issue">Supplier Issue</option>
                    <option value="Others">Others</option>
                </select>
            </div>
            <div id="assign-expiry-container" style="margin-bottom:8px; display:none;">
                 <label style="font-size:10px; font-weight:bold;">Expiry Date</label>
                 <input type="date" id="assign-expiry" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px;">
            </div>
            <div style="margin-bottom:8px;">
                <label style="font-size:10px; font-weight:bold;">Ops Validator</label>
                <select id="assign-ops-validator" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px;"><option value="">Select Ops Validator</option></select>
            </div>
            <div style="margin-bottom:8px;">
                <label style="font-size:10px; font-weight:bold;">Assign To (Opt)</label>
                <select id="assign-validator" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px;"><option value="">Unassigned</option></select>
            </div>
            <div style="margin-bottom:8px;">
                <label style="font-size:10px; font-weight:bold;">Priority</label>
                <select id="assign-priority" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px; font-size:11px;">
                    <option value="Normal">Normal</option>
                    <option value="High">High</option>
                    <option value="Urgent">Urgent</option>
                </select>
            </div>
            <div style="text-align:right;">
                <button id="btn-assign-task" class="icon-btn" style="background:#2752a7; color:white; padding:6px 12px; font-size:11px;">Add Task</button>
            </div>
        </div>
    </div>

  <!-- Validator Actions Modal -->
  <div id="val-actions-modal" class="modal hidden" style="z-index: 10060;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 300px; margin: 100px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Actions</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <div style="display:grid; gap:10px;">
            <div style="font-size:12px; font-weight:bold; color:#666; border-bottom:1px solid #eee; padding-bottom:5px;">SKU Master</div>
            <button id="download-sku-template-btn" class="icon-btn" style="justify-content:flex-start; width:100%; padding:8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px; width:16px; height:16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Download Template
            </button>
            <button id="upload-sku-desc-btn" class="icon-btn" style="justify-content:flex-start; width:100%; padding:8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px; width:16px; height:16px;"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg> Upload Master List
            </button>
            <button id="clear-sku-master-btn" class="icon-btn" style="justify-content:flex-start; width:100%; padding:8px; color:#d9534f;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px; width:16px; height:16px;"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg> Clear Master List
            </button>
            <input type="file" id="upload-sku-desc-file" accept=".csv" style="display:none;">

            <div style="font-size:12px; font-weight:bold; color:#666; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:5px;">Tasks</div>
            <button id="download-task-template-btn" class="icon-btn" style="justify-content:flex-start; width:100%; padding:8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px; width:16px; height:16px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Download Template
            </button>
            <button id="upload-bulk-tasks-btn" class="icon-btn" style="justify-content:flex-start; width:100%; padding:8px; color:#2752a7;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px; width:16px; height:16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> Bulk Assign Tasks
            </button>
            <button id="clear-val-tasks-btn" class="icon-btn" style="justify-content:flex-start; width:100%; padding:8px; color:#d9534f;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px; width:16px; height:16px;"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> Clear Tasks
            </button>
            <button id="reset-all-val-btn" class="icon-btn" style="justify-content:flex-start; width:100%; padding:8px; color:#c0392b;" title="Reset All Tasks">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px; width:16px; height:16px;"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg> Reset All (Supervisor)
            </button>
            <button id="reset-val-date-btn" class="icon-btn" style="justify-content:flex-start; width:100%; padding:8px; color:#e67e22;" title="Reset By Date/Shift">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px; width:16px; height:16px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> Reset By Date/Shift (Supervisor)
            </button>
            <input type="file" id="upload-bulk-tasks-file" accept=".csv" style="display:none;">

            <div style="font-size:12px; font-weight:bold; color:#666; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:5px;">Tools</div>
            <button id="go-to-timestamp-btn" class="icon-btn" style="justify-content:flex-start; width:100%; padding:8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px; width:16px; height:16px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Activity Tracker
            </button>
        </div>
    </div>
  </div>

  <!-- Reset Validation Options Modal -->
  <div id="reset-val-options-modal" class="modal hidden" style="z-index: 10070;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 350px; margin: 150px auto;">
        <h3 style="margin-top:0">Reset By Date/Shift</h3>
        <div style="margin-bottom:10px;">
            <label style="font-size:12px; font-weight:bold;">Date</label>
            <input type="date" id="reset-val-date" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="margin-bottom:15px;">
            <label style="font-size:12px; font-weight:bold;">Shift</label>
            <select id="reset-val-shift" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
                <option value="All">All Shifts</option>
                <option value="1st Shift">1st Shift</option>
                <option value="2nd Shift">2nd Shift</option>
                <option value="3rd Shift">3rd Shift</option>
            </select>
        </div>
        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button class="icon-btn close-modal" style="border:1px solid #ccc;">Cancel</button>
            <button id="confirm-reset-val-date-btn" class="icon-btn" style="background:#d9534f; color:white;">Proceed</button>
        </div>
    </div>
  </div>

  <div id="toast-notification" class="toast"></div>
  <script src="app.js"></script>
  <script>
    if(!sessionStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';

    document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_KEY_ATTENDANCE = 'ims_daily_attendance_v1';
        const STORAGE_KEY_TIMESTAMPS = 'ims_all_ic_timestamps_v1'; // Using the correct key
        
        let attCurrentPage = 1;
        let attItemsPerPage = 20;
        let attSortField = 'date';
        let attSortDirection = 'desc';
        let tsSortField = 'startTime';
        let tsSortDirection = 'desc';
        let currentShiftFilter = '';
        
        // Modal Pagination State
        let modalCurrentPage = 1;
        let modalRowsPerPage = 10;
        let currentModalData = [];
        let currentModalType = '';
        let modalSortField = 'userId';
        let modalSortDirection = 'asc';
        
        // Live Status Filter Globals
        let liveStatusFilter = null;
        let liveStatusActiveUsers = new Set();
        let liveStatusBreakUsers = new Set();
        let liveStatusLongBreakUsers = new Set();
        let liveStatusTimeoutUsers = new Set();
        
        // Elements
        const attendanceTableBody = document.querySelector('#attendance-table tbody');
        const attModal = document.getElementById('att-modal');
        const attForm = document.getElementById('att-modal-form');
        const addAttBtn = document.getElementById('add-att-btn');
        const exportAttBtn = document.getElementById('export-att-btn');
        const printAttBtn = document.getElementById('print-att-btn');
        const attSearchInput = document.getElementById('att-search');
        const attFilterRole = document.getElementById('att-filter-role');
        const deleteSelectedAttBtn = document.getElementById('delete-selected-att-btn');
        const selectAllAtt = document.getElementById('select-all-att');
        const bulkTimeoutBtn = document.getElementById('bulk-timeout-btn');
        
        const globalStartDate = document.getElementById('global-start-date');
        const globalEndDate = document.getElementById('global-end-date');
        const applyGlobalFilterBtn = document.getElementById('apply-global-filter');
        const clearGlobalFilterBtn = document.getElementById('clear-global-filter');
        
        // Timestamp Elements
        const timestampBtn = document.getElementById('counter-timestamp-btn');
        const timestampModal = document.getElementById('timestamp-modal');
        const tsUserIdInput = document.getElementById('ts-user-id');
        const btnStartCount = document.getElementById('btn-start-count');
        const btnBreakStartMain = document.getElementById('btn-break-start-main');
        const btnBreakEndMain = document.getElementById('btn-break-end-main');
        const btnEndCount = document.getElementById('btn-end-count');
        const btnEndTask = document.getElementById('btn-end-task');
        const btnNSW = document.getElementById('btn-nsw');
        const btnBreakStart = document.getElementById('btn-break-start');
        const btnBreakEnd = document.getElementById('btn-break-end');
        const btnTimeOut = document.getElementById('btn-time-out');
        const timestampTableBody = document.querySelector('#timestamp-table tbody');
        const tsExportBtn = document.getElementById('ts-export-btn');
        const tsFilterUser = document.getElementById('ts-filter-user');
        const tsShiftFilter = document.getElementById('ts-shift-filter');
        const tsExportInactiveBtn = document.getElementById('ts-export-inactive-btn');
        const tsPurgeAllBtn = document.getElementById('ts-purge-all-btn');
        const tsDeleteSelectedBtn = document.getElementById('ts-delete-selected-btn');
        const tsSelectAll = document.getElementById('ts-select-all');
        const tsShowActive = document.getElementById('ts-show-active');
        const tsAnalyticsDateFilter = document.getElementById('ts-analytics-date-filter');
        
        // Reports
        const reportsMenuBtn = document.getElementById('reports-menu-btn');
        const reportsModal = document.getElementById('reports-modal');
        const repAttendanceBtn = document.getElementById('rep-attendance-btn');
        const repBreaklogBtn = document.getElementById('rep-breaklog-btn');
        const repInactiveBtn = document.getElementById('rep-inactive-btn');
        const repSessionsBtn = document.getElementById('rep-sessions-btn');
        
        // Requirements
        const reqModal = document.getElementById('req-modal');
        const setReqBtn = document.getElementById('set-requirements-btn');
        const saveReqBtn = document.getElementById('save-req-btn');
        const exportReqBtn = document.getElementById('export-req-btn');
        const importReqBtn = document.getElementById('import-req-btn');
        const importReqFile = document.getElementById('import-req-file');
        const viewChartBtn = document.getElementById('view-chart-btn');
        const viewTableBtn = document.getElementById('view-table-btn');
        const flipContainer = document.getElementById('attendance-flip-container');

        // IC Master
        const icMasterBtn = document.getElementById('ic-master-btn');
        const icMasterModal = document.getElementById('ic-master-modal');
        const icMasterSearch = document.getElementById('ic-master-search');
        
        const manageOpsValidatorsBtn = document.getElementById('manage-ops-validators-btn');
        const opsValidatorsModal = document.getElementById('ops-validators-modal');

        // Start Area Modal
        const startAreaModal = document.getElementById('start-area-modal');
        const warehouseAreaModal = document.getElementById('warehouse-area-modal');
        const cancelStartAreaBtn = document.getElementById('cancel-start-area-btn');
        const cancelWarehouseAreaBtn = document.getElementById('cancel-warehouse-area-btn');
        let selectedBinType = '';
        
        // Supervisor Delete
        const supervisorDeleteModal = document.getElementById('supervisor-delete-modal');
        const confirmSupervisorDeleteBtn = document.getElementById('confirm-supervisor-delete-btn');
        let supervisorDeleteCallback = null;

        // Edit Time
        const editTimeModal = document.getElementById('edit-time-modal');
        const cancelEditTimeBtn = document.getElementById('cancel-edit-time-btn');
        const saveEditTimeBtn = document.getElementById('save-edit-time-btn');

        // Helper to get local YYYY-MM-DD from a date string or object
        function getLocalYMD(dateInput) {
            const d = new Date(dateInput);
            if (isNaN(d.getTime())) return '';
            return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        }

        // Helper Functions
        function getAttendanceData() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_ATTENDANCE) || '[]'); } catch (e) { return []; }
        }
        function saveAttendanceData(data) {
            localStorage.setItem(STORAGE_KEY_ATTENDANCE, JSON.stringify(data));
        }
        function getTimestamps() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_TIMESTAMPS) || '[]'); } catch(e) { return []; }
        }
        function saveTimestamps(data) {
            localStorage.setItem(STORAGE_KEY_TIMESTAMPS, JSON.stringify(data));
        }
        function showToast(message, type = 'success') {
            const validatorsModal = document.getElementById('validators-modal');
            const isValidatorView = validatorsModal && !validatorsModal.classList.contains('hidden');

            if (isValidatorView) {
                const notification = document.getElementById('validator-notification');
                if (notification) {
                    notification.textContent = message;
                    notification.style.backgroundColor = type === 'error' ? '#ffebee' : '#e8f5e9';
                    notification.style.color = type === 'error' ? '#d9534f' : '#2ecc71';
                    notification.style.display = 'inline-block';
                    notification.style.opacity = 1;

                    if (notification.hideTimeout) clearTimeout(notification.hideTimeout);
                    notification.hideTimeout = setTimeout(() => {
                        notification.style.opacity = 0;
                        setTimeout(() => { notification.style.display = 'none'; }, 300);
                    }, 3000);
                }
            } else {
                const toast = document.getElementById('toast-notification');
                if (toast) {
                    toast.textContent = message;
                    toast.style.backgroundColor = type === 'error' ? '#e74c3c' : '#2ecc71';
                    toast.classList.add('show');
                    setTimeout(() => toast.classList.remove('show'), 3000);
                }
            }
        }
        function getDuration(start, end) {
            if (!start || !end) return '-';
            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);
            let minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (minutes < 0) minutes += 24 * 60;
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return (h > 0 ? h + 'h ' : '') + m + 'm';
        }
        function getShiftFromTimestamp(ts) {
            const d = new Date(ts);
            if (isNaN(d.getTime())) return { date: '', shift: '' };
            const h = d.getHours();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            let dateStr = `${year}-${month}-${day}`;
            let shift = '';
            if (h >= 6 && h < 14) shift = '1st Shift-(6am-2pm)';
            else if (h >= 14 && h < 22) shift = '2nd Shift-(2pm-10pm)';
            else {
                shift = '3rd Shift-(10pm-6am)';
                if (h < 6) {
                    const prev = new Date(d);
                    prev.setDate(d.getDate() - 1);
                    const pYear = prev.getFullYear();
                    const pMonth = String(prev.getMonth() + 1).padStart(2, '0');
                    const pDay = String(prev.getDate()).padStart(2, '0');
                    dateStr = `${pYear}-${pMonth}-${pDay}`;
                }
            }
            return { date: dateStr, shift };
        }

        function updateLiveStatusCards() {
            const attendance = getAttendanceData();
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];

            // Reset Sets
            liveStatusActiveUsers.clear();
            liveStatusBreakUsers.clear();
            liveStatusLongBreakUsers.clear();
            liveStatusTimeoutUsers.clear();

            attendance.forEach(att => {
                if (!att.userId) return;

                const attDate = new Date(att.date);
                if (isNaN(attDate.getTime())) return;

                // Check if relevant (Today or Yesterday if not timed out)
                const isToday = (att.date === todayStr);
                let isRelevant = isToday;
                if (!isToday && !att.timeOut) {
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    if (att.date === yesterdayStr) isRelevant = true;
                }

                if (!isRelevant) return;

                if (att.timeOut) {
                    if (isToday) liveStatusTimeoutUsers.add(att.userId);
                } else if (att.timeIn) {
                    if (att.breakOut && !att.breakIn) {
                        liveStatusBreakUsers.add(att.userId);
                        const [h, m] = att.breakOut.split(':').map(Number);
                        if (!isNaN(h) && !isNaN(m)) {
                            const breakStart = new Date();
                            breakStart.setHours(h, m, 0, 0);
                            if (breakStart > now) breakStart.setDate(breakStart.getDate() - 1);
                            const diffMins = (now - breakStart) / 60000;
                            if (diffMins > 40) liveStatusLongBreakUsers.add(att.userId);
                        }
                    } else {
                        liveStatusActiveUsers.add(att.userId);
                    }
                }
            });

            document.getElementById('live-status-active').textContent = liveStatusActiveUsers.size;
            document.getElementById('live-status-break').textContent = liveStatusBreakUsers.size;
            document.getElementById('live-status-long-break').textContent = liveStatusLongBreakUsers.size;
            document.getElementById('live-status-timeout').textContent = liveStatusTimeoutUsers.size;

            const lbCard = document.getElementById('live-status-long-break').closest('.stat-card');
            if (liveStatusLongBreakUsers.size > 0) {
                lbCard.classList.add('blink-red-card');
            } else {
                lbCard.classList.remove('blink-red-card');
            }
        }

        window.filterByLiveStatus = function(status, cardEl) {
            if (liveStatusFilter === status) {
                liveStatusFilter = null;
                document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('selected-summary-card'));
            } else {
                liveStatusFilter = status;
                document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('selected-summary-card'));
                if(cardEl) cardEl.classList.add('selected-summary-card');
            }
            // Ensure sets are up to date before rendering
            updateLiveStatusCards();
            renderAttendanceTable();
        }

        window.showStatusModal = function(type) {
            window.currentStatusModalType = type;
            updateLiveStatusCards();
            const attendance = getAttendanceData();
            let targetSet = new Set();
            let title = 'Users';
            let showDuration = false;
            let showAction = false;

            if (type === 'active') {
                targetSet = liveStatusActiveUsers;
                title = 'Active Users (Present)';
                showAction = true;
            } else if (type === 'break') {
                targetSet = liveStatusBreakUsers;
                title = 'Users On Break';
                showDuration = true;
                showAction = true;
            } else if (type === 'long_break') {
                targetSet = liveStatusLongBreakUsers;
                title = 'Users on Break (> 40mins)';
                showDuration = true;
                showAction = true;
            } else if (type === 'timeout') {
                targetSet = liveStatusTimeoutUsers;
                title = 'Users Timed Out Today';
            }

            const ids = Array.from(targetSet);
            const users = [];
            
            ids.forEach(uid => {
                const userAtt = attendance.filter(a => a.userId === uid).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                if (userAtt) {
                    users.push(userAtt);
                } else {
                    users.push({ userId: uid, name: 'Unknown', role: '-', area: '-', timeIn: '-' });
                }
            });
            
            // Update Modal Title
            const modalTitle = document.querySelector('#active-users-modal h3');
            if(modalTitle) modalTitle.textContent = title;

            // Update Table Header
            const thead = document.querySelector('#active-users-modal thead tr');
            if (thead) {
                let headerHtml = `<th>User ID</th><th>Name</th><th>Role</th><th>Job Description</th><th>Time In</th>`;
                if (showDuration) {
                    headerHtml += `<th>Break Duration</th>`;
                }
                if (showAction) {
                    headerHtml += `<th>Action</th>`;
                }
                thead.innerHTML = headerHtml;
            }

            const tbody = document.getElementById('active-users-tbody');
            if(tbody) {
                tbody.innerHTML = '';
                let colSpan = 5;
                if (showDuration) colSpan++;
                if (showAction) colSpan++;

                if (users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align:center; padding:10px;">No users found.</td></tr>`;
                } else {
                    const now = new Date();
                    users.forEach(u => {
                        const tr = document.createElement('tr');
                        let durationHtml = '';
                        if (showDuration) {
                            let duration = '-';
                            if (u.breakOut) {
                                const [h, m] = u.breakOut.split(':').map(Number);
                                if (!isNaN(h) && !isNaN(m)) {
                                    const breakStart = new Date();
                                    breakStart.setHours(h, m, 0, 0);
                                    if (breakStart > now) breakStart.setDate(breakStart.getDate() - 1);
                                    const diffMins = Math.floor((now - breakStart) / 60000);
                                    duration = `${diffMins} min`;
                                    if (diffMins > 40) duration = `<span style="color:#e74c3c; font-weight:bold;">${duration}</span>`;
                                }
                            }
                            durationHtml = `<td>${duration}</td>`;
                        }
                        
                        let actionHtml = '';
                        if (showAction) {
                            if (type === 'active') {
                                actionHtml = `<td style="white-space:nowrap;">
                                    <button class="icon-btn" onclick="quickBreakOut('${u.userId}')" title="Quick Break Out" style="color:#f39c12; margin-right:5px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg></button>
                                    <button class="icon-btn" onclick="quickTimeout('${u.userId}')" title="Timeout" style="color:#e74c3c;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
                                </td>`;
                            } else if (type === 'break' || type === 'long_break') {
                                actionHtml = `<td><button class="icon-btn" onclick="quickEndBreak('${u.userId}')" title="End Break" style="color:#2ecc71;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button></td>`;
                            }
                        }

                        tr.innerHTML = `<td>${u.userId}</td><td>${u.name}</td><td>${u.role}</td><td>${u.area || '-'}</td><td>${u.timeIn || '-'}</td>${durationHtml}${actionHtml}`;
                        tbody.appendChild(tr);
                    });
                }
            }
            const modal = document.getElementById('active-users-modal');
            if(modal) modal.classList.remove('hidden');
        };

        // Quick Actions for Status Modal
        window.quickBreakOut = function(userId) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
            updateAttendanceStatus(userId, { breakOut: timeStr });
        };

        window.quickEndBreak = function(userId) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
            updateAttendanceStatus(userId, { breakIn: timeStr });
        };

        window.quickTimeout = function(userId) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
            updateAttendanceStatus(userId, { timeOut: timeStr });
        };

        function updateAttendanceStatus(userId, updates) {
            const attendance = getAttendanceData();
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            
            // Find record (Today or Yesterday if not timed out)
            let attIdx = attendance.findIndex(a => a.userId === userId && a.date === todayStr);
            
            if (attIdx === -1) {
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                attIdx = attendance.findIndex(a => a.userId === userId && a.date === yesterdayStr && !a.timeOut);
            }

            if (attIdx > -1) {
                attendance[attIdx] = { ...attendance[attIdx], ...updates };
                saveAttendanceData(attendance);
                renderAttendanceTable();
                
                // Refresh modal if open
                if (window.currentStatusModalType) {
                    showStatusModal(window.currentStatusModalType);
                }
                
                showToast(`Status updated for ${userId}`);
            } else {
                alert('Attendance record not found for today.');
            }
        }

        // --- Attendance Logic ---
        
        function getFilteredAttendanceData(ignoreShift = false) {
            let data = getAttendanceData();
            if (globalStartDate.value || globalEndDate.value) {
                const start = globalStartDate.value;
                const end = globalEndDate.value;
                data = data.filter(item => {
                    return (!start || item.date >= start) && (!end || item.date <= end);
                });
            }
            const searchTerm = attSearchInput ? attSearchInput.value.toLowerCase() : '';
            if (searchTerm) {
                data = data.filter(item => 
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.role && item.role.toLowerCase().includes(searchTerm)) ||
                    (item.area && item.area.toLowerCase().includes(searchTerm))
                );
            }
            if (attFilterRole && attFilterRole.value) data = data.filter(item => item.role === attFilterRole.value);
            const selectedAreas = Array.from(document.querySelectorAll('.att-area-cb:checked')).map(cb => cb.value);
            if (selectedAreas.length > 0) {
                data = data.filter(item => selectedAreas.includes(item.area));
            }
            const statusFilter = document.getElementById('att-filter-status').value;
            if (statusFilter) {
                data = data.filter(item => (item.status || 'Full-time') === statusFilter);
            }
            if (!ignoreShift && currentShiftFilter) data = data.filter(item => item.shift === currentShiftFilter);
            
            // Apply Live Status Filter
            if (liveStatusFilter) {
                let targetSet = null;
                if (liveStatusFilter === 'active') targetSet = liveStatusActiveUsers;
                else if (liveStatusFilter === 'break') targetSet = liveStatusBreakUsers;
                else if (liveStatusFilter === 'long_break') targetSet = liveStatusLongBreakUsers;
                else if (liveStatusFilter === 'timeout') targetSet = liveStatusTimeoutUsers;
                
                if (targetSet) {
                    data = data.filter(item => targetSet.has(item.userId));
                }
            }

            data.sort((a, b) => {
                let valA = a[attSortField] || '';
                let valB = b[attSortField] || '';
                if (attSortField === 'duration') {
                    valA = getDuration(a.breakOut, a.breakIn);
                    valB = getDuration(b.breakOut, b.breakIn);
                }
                if (valA < valB) return attSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return attSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            return data;
        }

        function loadRequirements() {
            try { return JSON.parse(localStorage.getItem('ims_att_requirements_v1') || '{}'); } catch(e) { return {}; }
        }

        function updateSummary() {
            const data = getFilteredAttendanceData(true); // Ignore shift tab filter
            const reqs = loadRequirements();
            const subRolesList = ["Cycle Counter", "TL", "OIC", "Encoder", "SBD Checker", "RTV", "Damaged Checker", "B1T1 Checker", "Validator", "HVI Support", "Projects", "HO-Cancelled"];
            const shiftsList = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];

            const summary = {
                '1st Shift-(6am-2pm)': { act: 0, req: 0 },
                '2nd Shift-(2pm-10pm)': { act: 0, req: 0 },
                '3rd Shift-(10pm-6am)': { act: 0, req: 0 },
                'total': { act: 0, req: 0 }
            };
            
            data.forEach(item => {
                if (summary.hasOwnProperty(item.shift)) summary[item.shift].act++;
                summary.total.act++;
            });
            
            subRolesList.forEach(role => {
                shiftsList.forEach(shift => {
                    const val = parseInt(reqs[`${role}|${shift}`] || 0);
                    if(summary[shift]) summary[shift].req += val;
                    summary.total.req += val;
                });
            });
            
            const getPctHtml = (act, req) => {
                const pct = req > 0 ? Math.round((act / req) * 100) : 0;
                let color = '#e74c3c'; // red
                if (pct >= 100) color = '#2ecc71'; // green
                else if (pct >= 80) color = '#f1c40f'; // yellow
                // Only show percentage if there is a requirement
                if (req === 0 && act === 0) return '';
                return `<span style="font-size:14px; color:${color}; margin-left:5px;">(${pct}%)</span>`;
            };

            document.getElementById('summary-1st').innerHTML = `${summary['1st Shift-(6am-2pm)'].act} <span style="font-size:14px; color:#999;">/ ${summary['1st Shift-(6am-2pm)'].req}</span> ${getPctHtml(summary['1st Shift-(6am-2pm)'].act, summary['1st Shift-(6am-2pm)'].req)}`;
            document.getElementById('summary-2nd').innerHTML = `${summary['2nd Shift-(2pm-10pm)'].act} <span style="font-size:14px; color:#999;">/ ${summary['2nd Shift-(2pm-10pm)'].req}</span> ${getPctHtml(summary['2nd Shift-(2pm-10pm)'].act, summary['2nd Shift-(2pm-10pm)'].req)}`;
            document.getElementById('summary-3rd').innerHTML = `${summary['3rd Shift-(10pm-6am)'].act} <span style="font-size:14px; color:#999;">/ ${summary['3rd Shift-(10pm-6am)'].req}</span> ${getPctHtml(summary['3rd Shift-(10pm-6am)'].act, summary['3rd Shift-(10pm-6am)'].req)}`;
            document.getElementById('summary-total').innerHTML = `${summary.total.act} <span style="font-size:14px; color:#999;">/ ${summary.total.req}</span> ${getPctHtml(summary.total.act, summary.total.req)}`;
        }

        function renderAttendanceTable() {
            if (!attendanceTableBody) return;
            const attRowsPerPageSelect = document.getElementById('att-rows-per-page');
            if (attRowsPerPageSelect) attItemsPerPage = parseInt(attRowsPerPageSelect.value, 10);
            let data = getFilteredAttendanceData();
            const totalItems = data.length;
            const totalPages = Math.ceil(totalItems / attItemsPerPage) || 1;
            if (attCurrentPage > totalPages) attCurrentPage = totalPages;
            const paginatedData = data.slice((attCurrentPage - 1) * attItemsPerPage, attCurrentPage * attItemsPerPage);

            const totalCountSpan = document.getElementById('att-total-count');
            if (totalCountSpan) totalCountSpan.textContent = totalItems;

            attendanceTableBody.innerHTML = '';
            const paginationControls = document.getElementById('att-pagination-controls');
            if (paginationControls) {
                document.getElementById('att-page-info').textContent = `Page ${attCurrentPage} of ${totalPages} (${totalItems} records)`;
                document.getElementById('att-prev-page').disabled = attCurrentPage <= 1;
                document.getElementById('att-next-page').disabled = attCurrentPage >= totalPages;
            }
            
            document.querySelectorAll('#attendance-table th.sortable .sort-icon').forEach(icon => icon.textContent = '');
            const activeHeader = document.querySelector(`#attendance-table th[data-sort="${attSortField}"]`);
            if(activeHeader) activeHeader.querySelector('.sort-icon').textContent = attSortDirection === 'asc' ? '↑' : '↓';

            if (paginatedData.length === 0) {
                attendanceTableBody.innerHTML = `<tr><td colspan="14" class="muted" style="text-align:center; padding: 20px;">No attendance records found.</td></tr>`;
                return;
            }
            paginatedData.forEach(item => {
                const tr = document.createElement('tr');

                let forwardBtnHtml = '';
                let nameHtml = item.name;
                if (item.area === 'Cycle Counter' && item.status === 'Full-time') {
                    forwardBtnHtml = `<button class="icon-btn forward-to-daily-btn" data-id="${item.id}" title="Forward to Daily Counters" style="color:#2752a7; margin-right:5px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>`;
                    nameHtml = `<span style="color:#e74c3c; font-weight:bold; background:#ffebee; padding:2px 5px; border-radius:4px;">${item.name}</span>`;
                }
                tr.innerHTML = `
                    <td><input type="checkbox" class="att-row-checkbox" data-id="${item.id}"></td>
                    <td>${item.date}</td>
                    <td>${item.userId || '-'}</td>
                    <td>${item.shift}</td>
                    <td>${nameHtml}</td>
                    <td>${item.role || '-'}</td>
                    <td>${item.area || '-'}</td>
                    <td>${item.timeIn || '-'}</td>
                    <td>${item.breakOut || '-'}</td>
                    <td>${item.breakIn || '-'}</td>
                    <td>${item.timeOut || '-'}</td>
                    <td style="font-weight:bold; color:#555;">${getDuration(item.breakOut, item.breakIn)}</td>
                    <td>${item.status || '-'}</td>
                    <td>
                        ${forwardBtnHtml}
                        <button class="icon-btn edit-att-btn" data-id="${item.id}" title="Edit" style="margin-right:5px">✎</button>
                        <button class="icon-btn delete-att-btn" data-id="${item.id}" title="Delete" style="color:#d9534f">&times;</button>
                    </td>
                `;
                attendanceTableBody.appendChild(tr);
            });
            updateSummary();
            updateLiveStatusCards();
        }

        // Auto-fill User ID based on Name selection
        const attNameInput = document.getElementById('att-name');
        if (attNameInput) {
            attNameInput.addEventListener('input', () => {
                const val = attNameInput.value.trim();
                if (!val) return;
                const data = getAttendanceData();
                const user = data.slice().reverse().find(d => d.name && d.name.toLowerCase() === val.toLowerCase());
                if (user) {
                    if (user.userId) document.getElementById('att-user-id').value = user.userId;
                    if (user.role) document.getElementById('att-role').value = user.role;
                }
            });
        }

        // Auto-fill Name and Role based on User ID
        const attUserIdInput = document.getElementById('att-user-id');
        if (attUserIdInput) {
            attUserIdInput.addEventListener('input', () => {
                const val = attUserIdInput.value.trim();
                if (!val) return;
                const data = getAttendanceData();
                const user = data.slice().reverse().find(d => d.userId && d.userId.toLowerCase() === val.toLowerCase());
                if (user) {
                    if (user.name) document.getElementById('att-name').value = user.name;
                    if (user.role) document.getElementById('att-role').value = user.role;
                }
            });
        }

        function updateAttNameDatalist() {
            const list = document.getElementById('att-name-list');
            if (!list) return;
            list.innerHTML = '';
            const data = getAttendanceData();
            const uniqueNames = [...new Set(data.map(d => d.name).filter(n => n))].sort();
            uniqueNames.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                list.appendChild(opt);
            });
        }

        if (addAttBtn) {
            addAttBtn.addEventListener('click', () => {
                document.getElementById('att-modal-title').textContent = 'Add Attendance';
                attForm.reset();
                document.getElementById('att-edit-id').value = '';
                document.getElementById('att-date').valueAsDate = new Date();
                const now = new Date();
                const h = now.getHours();
                let shiftVal = '3rd Shift-(10pm-6am)';
                if (h >= 6 && h < 14) shiftVal = '1st Shift-(6am-2pm)';
                else if (h >= 14 && h < 22) shiftVal = '2nd Shift-(2pm-10pm)';
                document.getElementById('att-shift').value = shiftVal;
                
                const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                const letter = letters.charAt(Math.floor(Math.random() * letters.length));
                const num = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                document.getElementById('att-user-id').value = letter + num;
                
                updateAttNameDatalist();
                attModal.classList.remove('hidden');
            });
        }

        if (attForm) {
            attForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('att-edit-id').value;
                const newEntry = {
                    id: editId || Date.now().toString(),
                    date: document.getElementById('att-date').value,
                    shift: document.getElementById('att-shift').value,
                    userId: document.getElementById('att-user-id').value.trim(),
                    name: document.getElementById('att-name').value.trim().toUpperCase(),
                    role: document.getElementById('att-role').value,
                    area: document.getElementById('att-area').value,
                    timeIn: document.getElementById('att-time-in').value,
                    breakIn: document.getElementById('att-break-in').value,
                    breakOut: document.getElementById('att-break-out').value,
                    timeOut: document.getElementById('att-time-out').value,
                    status: document.getElementById('att-status').value
                };
                if(!newEntry.name) return;

                // Duplicate check: User ID and Name must be unique for the same shift
                const attendanceData = getAttendanceData();
                const existingId = attendanceData.find(a => 
                    a.date === newEntry.date && 
                    a.shift === newEntry.shift &&
                    a.userId === newEntry.userId &&
                    a.id !== newEntry.id
                );
                if (existingId) {
                    alert(`User ID ${newEntry.userId} is already assigned to this shift on ${newEntry.date}.`);
                    return;
                }
                const existingName = attendanceData.find(a => 
                    a.date === newEntry.date && 
                    a.shift === newEntry.shift &&
                    a.name === newEntry.name &&
                    a.id !== newEntry.id
                );
                if (existingName) {
                    alert(`Name "${newEntry.name}" is already assigned to this shift on ${newEntry.date}.`);
                    return;
                }

                let data = attendanceData;
                if (editId) {
                    const idx = data.findIndex(x => x.id === editId);
                    if (idx > -1) data[idx] = newEntry;
                } else {
                    data.push(newEntry);
                }
                saveAttendanceData(data);
                showToast('Attendance saved successfully!');
                attModal.classList.add('hidden');
                renderAttendanceTable();
                if(flipContainer.classList.contains('flipped')) renderSubRoleDashboard();
            });
        }

        if (attendanceTableBody) {
            attendanceTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;

                if (btn.classList.contains('forward-to-daily-btn')) {
                    const allAttendance = getAttendanceData();
                    const itemIndex = allAttendance.findIndex(item => item.id === id);
                    if (itemIndex > -1) {
                        const itemToForward = { ...allAttendance[itemIndex] };
                        
                        // 1. Change status
                        itemToForward.status = 'Full Counter';
                        itemToForward.jobDescription = 'Cycle Counter';
                        itemToForward.area = '';
                        allAttendance[itemIndex].status = 'Full Counter';
                        saveAttendanceData(allAttendance); // Save change in current list

                        // 2. Forward to daily_cycle_count attendance
                        const dailyCountersAttendanceKey = 'ims_daily_counters_attendance_v1';
                        let dailyAttendance = [];
                        try {
                            dailyAttendance = JSON.parse(localStorage.getItem(dailyCountersAttendanceKey) || '[]');
                        } catch (err) {
                            console.error('Could not parse daily counters attendance', err);
                            dailyAttendance = [];
                        }

                        // Avoid duplicates in daily counters attendance
                        const alreadyExists = dailyAttendance.some(d => d.date === itemToForward.date && d.shift === itemToForward.shift && d.userId === itemToForward.userId);
                        if (!alreadyExists) {
                            dailyAttendance.push(itemToForward);
                            localStorage.setItem(dailyCountersAttendanceKey, JSON.stringify(dailyAttendance));
                            showToast(`${itemToForward.name} forwarded to Daily Counters.`);
                        }
                        
                        // 3. Re-render table to update status and remove button
                        renderAttendanceTable();
                    }
                    return; // Stop further processing
                }

                if (btn.classList.contains('delete-att-btn')) {
                    showSupervisorDeleteModal(1, () => {
                        let data = getAttendanceData();
                        data = data.filter(item => item.id !== id);
                        saveAttendanceData(data);
                        renderAttendanceTable();
                        showToast('Attendance entry deleted');
                    });
                } else if (btn.classList.contains('edit-att-btn')) {
                    const data = getAttendanceData();
                    const item = data.find(x => x.id === id);
                    if (item) {
                        document.getElementById('att-modal-title').textContent = 'Edit Attendance';
                        document.getElementById('att-edit-id').value = item.id;
                        document.getElementById('att-date').value = item.date;
                        document.getElementById('att-user-id').value = item.userId || '';
                        document.getElementById('att-shift').value = item.shift;
                        document.getElementById('att-name').value = item.name;
                        document.getElementById('att-role').value = item.role;
                        document.getElementById('att-area').value = item.area;
                        document.getElementById('att-time-in').value = item.timeIn || '';
                        document.getElementById('att-break-out').value = item.breakOut;
                        document.getElementById('att-break-in').value = item.breakIn;
                        document.getElementById('att-time-out').value = item.timeOut || '';
                        document.getElementById('att-status').value = item.status || 'Full-time';
                        attModal.classList.remove('hidden');
                    }
                }
            });
        }

        // Mass Delete for Attendance
        function updateAttendanceActionButtons() {
            const selectedCount = document.querySelectorAll('.att-row-checkbox:checked').length;
            if (deleteSelectedAttBtn) {
                deleteSelectedAttBtn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
            }
            if (bulkTimeoutBtn) {
                bulkTimeoutBtn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
            }
        }

        if (selectAllAtt) {
            selectAllAtt.addEventListener('change', (e) => {
                document.querySelectorAll('.att-row-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateAttendanceActionButtons();
            });
        }

        if (attendanceTableBody) {
            attendanceTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('att-row-checkbox')) {
                    updateAttendanceActionButtons();
                }
            });
        }

        if (bulkTimeoutBtn) {
            bulkTimeoutBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.att-row-checkbox:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length === 0) return;

                const now = new Date();
                const defaultTime = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                const timeOutVal = prompt("Enter Time Out (HH:MM):", defaultTime);
                
                if (timeOutVal !== null) {
                    let data = getAttendanceData();
                    const selectedSet = new Set(selectedIds);
                    
                    // Sync to Daily Counters Attendance
                    const dailyCountersAttendanceKey = 'ims_daily_counters_attendance_v1';
                    let dailyAttendance = [];
                    try { dailyAttendance = JSON.parse(localStorage.getItem(dailyCountersAttendanceKey) || '[]'); } catch (err) { dailyAttendance = []; }
                    let dailyModified = false;

                    data.forEach(item => {
                        if (selectedSet.has(item.id)) {
                            item.timeOut = timeOutVal;
                            // Sync if exists in daily attendance (Cycle Counters)
                            dailyAttendance.forEach(dItem => {
                                if (dItem.id === item.id || (dItem.userId === item.userId && dItem.date === item.date && dItem.shift === item.shift)) {
                                    dItem.timeOut = timeOutVal;
                                    dailyModified = true;
                                }
                            });
                        }
                    });

                    saveAttendanceData(data);
                    if (dailyModified) localStorage.setItem(dailyCountersAttendanceKey, JSON.stringify(dailyAttendance));
                    
                    renderAttendanceTable();
                    if(selectAllAtt) selectAllAtt.checked = false;
                    updateAttendanceActionButtons();
                    showToast(`Bulk timeout set for ${selectedIds.length} records.`);
                }
            });
        }

        if (deleteSelectedAttBtn) {
            deleteSelectedAttBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.att-row-checkbox:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length === 0) return;

                showSupervisorDeleteModal(selectedIds.length, () => {
                    const selectedSet = new Set(selectedIds);
                    let data = getAttendanceData();
                    data = data.filter(item => !selectedSet.has(item.id));
                    saveAttendanceData(data);
                    renderAttendanceTable();
                    updateAttendanceActionButtons();
                    showToast(`${selectedIds.length} attendance records deleted`);
                });
            });
        }

        // Forward All Logic
        let undoStack = [];
        const forwardAllBtn = document.getElementById('forward-all-btn');
        const undoForwardBtn = document.getElementById('undo-forward-btn');

        if (forwardAllBtn) {
            forwardAllBtn.addEventListener('click', () => {
                // Use filtered data to respect current view filters
                const candidates = getFilteredAttendanceData().filter(item => item.area === 'Cycle Counter' && item.status === 'Full-time');
                
                if (candidates.length === 0) {
                    alert('No unforwarded Cycle Counters found in current view.');
                    return;
                }

                if (!confirm(`Forward ${candidates.length} Cycle Counters to Daily Count?`)) return;

                const allData = getAttendanceData();
                const candidateIds = new Set(candidates.map(c => c.id));
                
                const dailyCountersAttendanceKey = 'ims_daily_counters_attendance_v1';
                let dailyAttendance = [];
                try { dailyAttendance = JSON.parse(localStorage.getItem(dailyCountersAttendanceKey) || '[]'); } catch (err) { dailyAttendance = []; }

                let count = 0;
                let forwardedIds = [];
                let addedToDailyIds = [];

                // Clear any existing undo timeout
                if (undoTimeout) clearTimeout(undoTimeout);

                allData.forEach(item => {
                    if (candidateIds.has(item.id)) {
                        forwardedIds.push(item.id);
                        item.status = 'Full Counter';
                        const alreadyExists = dailyAttendance.some(d => d.date === item.date && d.shift === item.shift && d.userId === item.userId);
                        if (!alreadyExists) {
                            dailyAttendance.push({ ...item });
                            dailyAttendance.push({ ...item, jobDescription: 'Cycle Counter', area: '' });
                            addedToDailyIds.push(item.id);
                            count++;
                        }
                    }
                });

                saveAttendanceData(allData);
                localStorage.setItem(dailyCountersAttendanceKey, JSON.stringify(dailyAttendance));
                renderAttendanceTable();
                showToast(`${count} Cycle Counters forwarded.`);

                undoStack.push({
                    type: 'forward_all',
                    forwardedIds: forwardedIds,
                    addedToDailyIds: addedToDailyIds
                });
                if (undoForwardBtn) undoForwardBtn.style.display = 'inline-flex';

                // Set a timer to hide the undo button
                undoTimeout = setTimeout(() => {
                    if (undoForwardBtn) undoForwardBtn.style.display = 'none';
                }, 10000); // 10 seconds
            });
        }

        if (undoForwardBtn) {
            undoForwardBtn.addEventListener('click', () => {
                if (undoTimeout) {
                    clearTimeout(undoTimeout);
                    undoTimeout = null;
                }
                const lastAction = undoStack.pop();
                if (!lastAction) return;

                if (lastAction.type === 'forward_all') {
                    const allData = getAttendanceData();
                    let revertedCount = 0;
                    
                    // Revert status in main attendance
                    allData.forEach(item => {
                        if (lastAction.forwardedIds.includes(item.id)) {
                            item.status = 'Full-time';
                            revertedCount++;
                        }
                    });
                    saveAttendanceData(allData);

                    // Remove from daily attendance
                    const dailyCountersAttendanceKey = 'ims_daily_counters_attendance_v1';
                    let dailyAttendance = [];
                    try { dailyAttendance = JSON.parse(localStorage.getItem(dailyCountersAttendanceKey) || '[]'); } catch (err) { dailyAttendance = []; }
                    
                    dailyAttendance = dailyAttendance.filter(item => !lastAction.addedToDailyIds.includes(item.id));
                    localStorage.setItem(dailyCountersAttendanceKey, JSON.stringify(dailyAttendance));

                    renderAttendanceTable();
                    showToast(`Undo successful.`);
                }

                if (undoStack.length === 0) {
                    undoForwardBtn.style.display = 'none';
                }
            });
        }

        function showSupervisorDeleteModal(count, callback) {
            if (!supervisorDeleteModal) return;
            document.getElementById('supervisor-delete-count').textContent = count;
            document.getElementById('supervisor-code').value = '';
            supervisorDeleteCallback = callback;
            supervisorDeleteModal.classList.remove('hidden');
        }

        if (confirmSupervisorDeleteBtn) {
            confirmSupervisorDeleteBtn.addEventListener('click', () => {
                const code = document.getElementById('supervisor-code').value;
                if (code !== '12345' && code !== 'admin') { alert('Invalid Supervisor Code.'); return; }
                if (typeof supervisorDeleteCallback === 'function') supervisorDeleteCallback();
                supervisorDeleteModal.classList.add('hidden');
            });
        }

        // Export Excel (By Status)
        const exportExcelBtn = document.getElementById('export-excel-btn');
        if (exportExcelBtn) {
            exportExcelBtn.addEventListener('click', () => {
                // Pass true to ignore shift tab filter (export all shifts)
                const data = getFilteredAttendanceData(true);
                if (data.length === 0) { alert('No attendance records to export.'); return; }
                
                if (typeof XLSX === 'undefined') {
                    alert('SheetJS library not loaded. Please check internet connection.');
                    return;
                }

                const wb = XLSX.utils.book_new();
                
                // Group by Status
                const grouped = {};
                data.forEach(item => {
                    const status = item.status || 'Unknown';
                    if (!grouped[status]) grouped[status] = [];
                    grouped[status].push(item);
                });

                Object.keys(grouped).forEach(status => {
                    const sheetData = grouped[status];
                    
                    // Format data
                    const rows = sheetData.map(item => ({
                        'Date': item.date,
                        'User ID': item.userId || '',
                        'Shift': item.shift,
                        'Name': item.name,
                        'Role': item.role || '',
                        'Job Description': item.area || '',
                        'Time In': item.timeIn || '',
                        'Break Out': item.breakOut || '',
                        'Break In': item.breakIn || '',
                        'Time Out': item.timeOut || '',
                        'Duration': getDuration(item.breakOut, item.breakIn),
                        'Status': item.status || '',
                        'Notes': item.notes || ''
                    }));

                    const ws = XLSX.utils.json_to_sheet(rows);
                    // Sanitize sheet name
                    let sheetName = status.replace(/[\\/?*\[\]]/g, ' ').substring(0, 31);
                    // Ensure unique sheet names
                    if(wb.SheetNames.includes(sheetName)) {
                        let i = 1;
                        while(wb.SheetNames.includes(sheetName + " " + i)) i++;
                        sheetName += " " + i;
                    }
                    
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                const dateStr = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `attendance_by_status_${dateStr}.xlsx`);
            });
        }

        // Export CSV
        if (exportAttBtn) {
            exportAttBtn.addEventListener('click', () => {
                const data = getFilteredAttendanceData();
                if (data.length === 0) { alert('No attendance records to export.'); return; }
                const headers = ['Date', 'User ID', 'Shift', 'Name', 'Role', 'Job Description', 'Time In', 'Break Out', 'Break In', 'Time Out', 'Duration', 'Status'];
                const rows = [headers.join(',')];
                
                data.forEach(item => {
                    const dur = getDuration(item.breakOut, item.breakIn);
                    const row = [
                        item.date, `"${item.userId||''}"`, `"${item.shift}"`, `"${item.name}"`, item.role || '', item.area || '', item.timeIn || '', item.breakOut || '', item.breakIn || '', item.timeOut || '', dur, `"${item.status||''}"`
                    ];
                    rows.push(row.join(','));
                });
                
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'attendance_sheet.csv';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });
        }

        // Print
        if (printAttBtn) {
            printAttBtn.addEventListener('click', () => {
                const dataToPrint = getFilteredAttendanceData();
                if (dataToPrint.length === 0) {
                    alert('No records to print.');
                    return;
                }

                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Attendance Report</title>');
                printWindow.document.write('<style>@page { size: letter landscape; margin: 0.25in; } body{font-family:sans-serif;font-size:11px;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ccc;padding:4px;text-align:left;} th{background:#f0f0f0;} .sig{height:30px;}</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<h2>Attendance Report</h2>');
                printWindow.document.write(`<p>Generated: ${new Date().toLocaleString()}</p>`);
                printWindow.document.write('<table><thead><tr>');
                const headers = ['Date', 'User ID', 'Shift', 'Name', 'Role', 'Job Description', 'Time In', 'Break Out', 'Break In', 'Time Out', 'Status', 'Signature'];
                headers.forEach(h => printWindow.document.write(`<th>${h}</th>`));
                printWindow.document.write('</tr></thead><tbody>');

                dataToPrint.forEach(item => {
                    printWindow.document.write('<tr>');
                    printWindow.document.write(`<td>${item.date}</td>`);
                    printWindow.document.write(`<td>${item.userId || ''}</td>`);
                    printWindow.document.write(`<td>${item.shift}</td>`);
                    printWindow.document.write(`<td>${item.name}</td>`);
                    printWindow.document.write(`<td>${item.role || '-'}</td>`);
                    printWindow.document.write(`<td>${item.area || '-'}</td>`);
                    printWindow.document.write(`<td>${item.timeIn || ''}</td>`);
                    printWindow.document.write(`<td>${item.breakOut || ''}</td>`);
                    printWindow.document.write(`<td>${item.breakIn || ''}</td>`);
                    printWindow.document.write(`<td>${item.timeOut || ''}</td>`);
                    printWindow.document.write(`<td>${item.status || ''}</td>`);
                    printWindow.document.write('<td class="sig"></td>');
                    printWindow.document.write('</tr>');
                });

                printWindow.document.write('</tbody></table>');
                printWindow.document.write('<script>window.onload=function(){window.print();window.close();}<\/script>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
            });
        }

        // Requirements Modal Logic
        if(setReqBtn) {
            setReqBtn.addEventListener('click', () => {
                const reqs = loadRequirements();
                const tbody = document.querySelector('#req-table tbody');
                const subRolesList = ["Cycle Counter", "TL", "OIC", "Encoder", "SBD Checker", "RTV", "Damaged Checker", "B1T1 Checker", "Validator", "HVI Support", "Projects", "HO-Cancelled"];
                const shiftsList = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
                const roleFilter = document.getElementById('req-role-filter');
                
                // Populate filter
                if(roleFilter && roleFilter.options.length <= 1) {
                    subRolesList.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r;
                        opt.textContent = r;
                        roleFilter.appendChild(opt);
                    });
                }
                
                // Add Total Column Header if missing
                const theadRow = document.querySelector('#req-table thead tr');
                if (theadRow && theadRow.children.length === 4) {
                    const th = document.createElement('th');
                    th.textContent = 'Total';
                    theadRow.appendChild(th);
                }

                tbody.innerHTML = '';
                subRolesList.forEach(role => {
                    const tr = document.createElement('tr');
                    tr.dataset.role = role;
                    let html = `<td>${role}</td>`;
                    let rowTotal = 0;
                    shiftsList.forEach(shift => {
                        const key = `${role}|${shift}`;
                        const val = reqs[key] || 0;
                        rowTotal += val;
                        html += `<td><input type="number" class="req-input" data-key="${key}" value="${val}" style="width:60px; padding:4px; border:1px solid #ccc; border-radius:4px;"></td>`;
                    });
                    html += `<td class="row-total" style="font-weight:bold; text-align:center;">${rowTotal}</td>`;
                    tr.innerHTML = html;
                    tbody.appendChild(tr);
                });

                // Footer for Grand Totals
                let tfoot = document.querySelector('#req-table tfoot');
                if(!tfoot) {
                    tfoot = document.createElement('tfoot');
                    document.getElementById('req-table').appendChild(tfoot);
                }

                const updateTotals = () => {
                    let col1 = 0, col2 = 0, col3 = 0;
                    document.querySelectorAll('.req-input').forEach(inp => {
                        const val = parseInt(inp.value) || 0;
                        const key = inp.dataset.key;
                        if(key.includes('1st Shift')) col1 += val;
                        if(key.includes('2nd Shift')) col2 += val;
                        if(key.includes('3rd Shift')) col3 += val;
                        
                        // Update row total
                        const row = inp.closest('tr');
                        let rTotal = 0;
                        row.querySelectorAll('.req-input').forEach(ri => rTotal += (parseInt(ri.value)||0));
                        row.querySelector('.row-total').textContent = rTotal;
                    });
                    const grand = col1 + col2 + col3;
                    tfoot.innerHTML = `<tr style="background:#f0f0f0; font-weight:bold;"><td>Grand Total</td><td>${col1}</td><td>${col2}</td><td>${col3}</td><td style="text-align:center;">${grand}</td></tr>`;
                };
                
                updateTotals();
                tbody.addEventListener('input', (e) => {
                    if(e.target.classList.contains('req-input')) updateTotals();
                });

                reqModal.classList.remove('hidden');
            });
        }

        const reqRoleFilter = document.getElementById('req-role-filter');
        if(reqRoleFilter) {
            reqRoleFilter.addEventListener('change', () => {
                const val = reqRoleFilter.value;
                const rows = document.querySelectorAll('#req-table tbody tr');
                rows.forEach(r => {
                    if(val === '' || r.dataset.role === val) r.style.display = '';
                    else r.style.display = 'none';
                });
            });
        }

        if(saveReqBtn) {
            saveReqBtn.addEventListener('click', () => {
                const inputs = document.querySelectorAll('.req-input');
                const reqs = {};
                inputs.forEach(inp => {
                    reqs[inp.dataset.key] = parseInt(inp.value) || 0;
                });
                localStorage.setItem('ims_att_requirements_v1', JSON.stringify(reqs));
                reqModal.classList.add('hidden');
                updateSummary();
                showToast('Requirements saved');
            });
        }

        if(exportReqBtn) {
            exportReqBtn.addEventListener('click', () => {
                const reqs = loadRequirements();
                const subRolesList = ["Cycle Counter", "TL", "OIC", "Encoder", "SBD Checker", "RTV", "Damaged Checker", "B1T1 Checker", "Validator", "HVI Support", "Projects", "HO-Cancelled"];
                const shiftsList = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
                
                const headers = ['Sub Role', '1st Shift', '2nd Shift', '3rd Shift'];
                const rows = [headers.join(',')];
                
                subRolesList.forEach(role => {
                    const row = [`"${role}"`];
                    shiftsList.forEach(shift => {
                        const key = `${role}|${shift}`;
                        row.push(reqs[key] || 0);
                    });
                    rows.push(row.join(','));
                });
                
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'attendance_requirements.csv';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });
        }

        if(importReqBtn) importReqBtn.addEventListener('click', () => importReqFile.click());

        if(importReqFile) {
            importReqFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                window.showLoading && window.showLoading();
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const text = ev.target.result;
                        const lines = text.split(/\r?\n/);
                        const reqs = loadRequirements();
                        const shiftsList = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
                        let count = 0;
                        for(let i=1; i<lines.length; i++) {
                            const line = lines[i].trim();
                            if(!line) continue;
                            const parts = line.split(',').map(p => p.replace(/^"|"$/g, '').trim());
                            if(parts.length >= 4) {
                                const role = parts[0];
                                if(role) {
                                    reqs[`${role}|${shiftsList[0]}`] = parseInt(parts[1]) || 0;
                                    reqs[`${role}|${shiftsList[1]}`] = parseInt(parts[2]) || 0;
                                    reqs[`${role}|${shiftsList[2]}`] = parseInt(parts[3]) || 0;
                                    count++;
                                }
                            }
                        }
                        localStorage.setItem('ims_att_requirements_v1', JSON.stringify(reqs));
                        showToast(`Imported requirements for ${count} roles.`);
                        importReqFile.value = '';
                        if(setReqBtn) setReqBtn.click(); // Refresh modal
                    } catch (err) {
                        showToast('Failed to import requirements. Please check file format.', 'error');
                    } finally {
                        window.hideLoading && window.hideLoading();
                    }
                };
                reader.onerror = () => {
                    window.hideLoading && window.hideLoading();
                    showToast('Failed to read the file.', 'error');
                };
                reader.readAsText(file);
            });
        }

        // Analysis Dashboard Logic
        function renderSubRoleDashboard() {
            const container = document.getElementById('sub-role-dashboard');
            if (!container) return;
            
            const data = getFilteredAttendanceData(true); // Ignore shift tab
            const shifts = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
            const subRoles = [...new Set(data.map(d => d.area).filter(Boolean))].sort();
            
            let html = `
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;">
            `;
            
            // Summary Cards for Analysis
            const total = data.length;
            const shiftCounts = {};
            shifts.forEach(s => shiftCounts[s] = data.filter(d => d.shift === s).length);
            
            shifts.forEach(s => {
                const count = shiftCounts[s];
                const pct = total > 0 ? Math.round((count/total)*100) : 0;
                const label = s.split('-')[0];
                html += `
                <div class="stat-card" style="padding:10px; display:block; text-align:center;">
                    <div class="stat-value" style="font-size:20px;">${count} <span style="font-size:14px; color:#999;">(${pct}%)</span></div>
                    <div class="stat-label">${label}</div>
                </div>`;
            });
            
            html += `</div>
            <div style="overflow-x:auto;">
            <table class="report-table" style="width:100%;">
                <thead>
                    <tr>
                        <th>Sub Role</th>
                        <th>1st Shift</th>
                        <th>2nd Shift</th>
                        <th>3rd Shift</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            const shiftTotals = {
                "1st Shift-(6am-2pm)": 0,
                "2nd Shift-(2pm-10pm)": 0,
                "3rd Shift-(10pm-6am)": 0
            };

            subRoles.forEach(role => {
                let roleTotal = 0;
                html += `<tr><td style="font-weight:bold;">${role}</td>`;
                
                shifts.forEach(shift => {
                    const count = data.filter(d => d.shift === shift && d.area === role).length;
                    shiftTotals[shift] += count;
                    roleTotal += count;
                    // Make cell clickable to filter
                    const cursorStyle = count > 0 ? 'cursor:pointer; color:#2752a7; text-decoration:underline;' : '';
                    const clickAttr = count > 0 ? `onclick="filterByAnalysis('${role}', '${shift}')"` : '';
                    html += `<td style="${cursorStyle}" ${clickAttr}>${count}</td>`;
                });
                
                html += `<td style="font-weight:bold;">${roleTotal}</td></tr>`;
            });
            
            // Totals Row
            html += `<tr style="background-color:#f8f9fa; font-weight:bold; border-top:2px solid #ddd;">
                <td>TOTAL</td>`;
            shifts.forEach(shift => {
                html += `<td>${shiftTotals[shift]}</td>`;
            });
            html += `<td>${total}</td></tr>`;
            
            html += `</tbody></table></div>`;
            
            container.innerHTML = html;
        }

        let icMasterSortField = 'name';
        let icMasterSortDir = 'asc';
        let icMasterPage = 1;
        let icMasterRowsPerPage = 20;

        // IC Master Logic
        function renderIcMaster() {
            const tbody = document.querySelector('#ic-master-table tbody');
            const jobSelect = document.getElementById('ic-master-job');
            
            if(!tbody) return;
            
            // Populate Job Desc dropdown if needed
            if(jobSelect && jobSelect.options.length <= 1) {
                const subRolesList = ["Cycle Counter", "TL", "OIC", "Encoder", "SBD Checker", "RTV", "Damaged Checker", "B1T1 Checker", "Validator", "HVI Support", "Projects", "HO-Cancelled"];
                subRolesList.sort().forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r;
                    opt.textContent = r;
                    jobSelect.appendChild(opt);
                });
            }

            tbody.innerHTML = '';
            let users = [];
            try { users = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
            
            // Filter for IC Support
            users = users.filter(u => u.role === 'IC Support');
            
            const term = icMasterSearch ? icMasterSearch.value.toLowerCase() : '';
            if(term) {
                users = users.filter(u => u.userId.toLowerCase().includes(term) || u.name.toLowerCase().includes(term));
            }
            
            // Sorting
            users.sort((a,b) => {
                let valA = (a[icMasterSortField] || '').toLowerCase();
                let valB = (b[icMasterSortField] || '').toLowerCase();
                if(valA < valB) return icMasterSortDir === 'asc' ? -1 : 1;
                if(valA > valB) return icMasterSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Update Sort Icons
            document.querySelectorAll('#ic-master-table th.sortable .sort-icon').forEach(el => el.textContent = '');
            const activeTh = document.querySelector(`#ic-master-table th[data-sort="${icMasterSortField}"] .sort-icon`);
            if(activeTh) activeTh.textContent = icMasterSortDir === 'asc' ? '↑' : '↓';

            // Pagination
            const totalItems = users.length;
            const totalPages = Math.ceil(totalItems / icMasterRowsPerPage) || 1;
            if (icMasterPage > totalPages) icMasterPage = totalPages;
            if (icMasterPage < 1) icMasterPage = 1;
            
            const start = (icMasterPage - 1) * icMasterRowsPerPage;
            const paginatedUsers = users.slice(start, start + icMasterRowsPerPage);

            // Update Pagination Controls
            const pageInfo = document.getElementById('ic-master-page-info');
            const prevBtn = document.getElementById('ic-master-prev');
            const nextBtn = document.getElementById('ic-master-next');
            
            if(pageInfo) pageInfo.textContent = `Page ${icMasterPage} of ${totalPages} (${totalItems} users)`;
            if(prevBtn) prevBtn.disabled = icMasterPage <= 1;
            if(nextBtn) nextBtn.disabled = icMasterPage >= totalPages;
            
            if(paginatedUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px; color:#999;">No IC Support users found.</td></tr>';
                return;
            }
            
            paginatedUsers.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${u.userId}</td><td>${u.name}</td><td>${u.role}</td><td>${u.jobDescription || ''}</td><td><button class="icon-btn edit-ic-master-btn" data-id="${u.userId}" title="Edit" style="padding:2px 6px;">✎</button></td>`;
                tbody.appendChild(tr);
            });
        }

        // Sort headers
        document.querySelectorAll('#ic-master-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if(icMasterSortField === field) {
                    icMasterSortDir = icMasterSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    icMasterSortField = field;
                    icMasterSortDir = 'asc';
                }
                renderIcMaster();
            });
        });

        // Pagination controls
        const icMasterPrev = document.getElementById('ic-master-prev');
        const icMasterNext = document.getElementById('ic-master-next');
        const icMasterRows = document.getElementById('ic-master-rows');

        if(icMasterPrev) icMasterPrev.addEventListener('click', () => {
            if(icMasterPage > 1) { icMasterPage--; renderIcMaster(); }
        });
        if(icMasterNext) icMasterNext.addEventListener('click', () => {
            icMasterPage++; renderIcMaster();
        });
        if(icMasterRows) icMasterRows.addEventListener('change', () => {
            const oldRows = icMasterRowsPerPage;
            icMasterRowsPerPage = parseInt(icMasterRows.value);
            const firstItem = (icMasterPage - 1) * oldRows;
            icMasterPage = Math.floor(firstItem / icMasterRowsPerPage) + 1;
            renderIcMaster();
        });

        const saveIcMasterBtn = document.getElementById('save-ic-master-btn');
        if(saveIcMasterBtn) {
            saveIcMasterBtn.addEventListener('click', () => {
                const idInput = document.getElementById('ic-master-id');
                const nameInput = document.getElementById('ic-master-name');
                const roleInput = document.getElementById('ic-master-role');
                const jobInput = document.getElementById('ic-master-job');
                
                const id = idInput.value.trim().toUpperCase();
                const name = nameInput.value.trim().toUpperCase();
                const role = roleInput.value;
                const job = jobInput.value;
                
                if(!id || !name) { alert('User ID and Name are required.'); return; }
                
                let users = [];
                try { users = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
                
                const existingIdx = users.findIndex(u => u.userId === id);
                if(existingIdx > -1) {
                    users[existingIdx] = { userId: id, name, role, jobDescription: job };
                    showToast('User updated');
                } else {
                    users.push({ userId: id, name, role, jobDescription: job });
                    showToast('User added');
                }
                
                localStorage.setItem('ims_master_users_v1', JSON.stringify(users));
                renderIcMaster();
                
                // Clear inputs
                idInput.value = '';
                nameInput.value = '';
                jobInput.value = '';
                roleInput.value = 'IC Support';
            });
        }

        const icMasterTable = document.getElementById('ic-master-table');
        if(icMasterTable) {
            icMasterTable.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-ic-master-btn');
                if(btn) {
                    const id = btn.dataset.id;
                    let users = [];
                    try { users = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
                    const user = users.find(u => u.userId === id);
                    if(user) {
                        document.getElementById('ic-master-id').value = user.userId;
                        document.getElementById('ic-master-name').value = user.name;
                        document.getElementById('ic-master-role').value = user.role || 'IC Support';
                        document.getElementById('ic-master-job').value = user.jobDescription || '';
                    }
                }
            });
        }

        const validatorsViewBtn = document.getElementById('validators-view-btn');
        const validatorsModal = document.getElementById('validators-modal');
        const validatorsTbody = document.getElementById('validators-tbody');
        const validatorsSearch = document.getElementById('validators-search');
        const assignSku = document.getElementById('assign-sku');
        const assignDesc = document.getElementById('assign-desc');
        const assignQty = document.getElementById('assign-qty');
        const assignPriority = document.getElementById('assign-priority');
        const assignReason = document.getElementById('assign-reason');
        const assignExpiry = document.getElementById('assign-expiry');
        const assignValidator = document.getElementById('assign-validator');
        const assignOpsValidator = document.getElementById('assign-ops-validator');
        const btnAssignTask = document.getElementById('btn-assign-task');
        const pendingTasksTbody = document.getElementById('pending-tasks-tbody');
        const resolvedTasksTbody = document.getElementById('resolved-tasks-tbody');
        const uploadSkuBtn = document.getElementById('upload-sku-desc-btn');
        const uploadSkuFile = document.getElementById('upload-sku-desc-file');

        function printValidatorSignOff(validator, validatorTasks) {
            const printWindow = window.open('', '_blank');
            const dateStr = new Date().toLocaleDateString();
            
            // Stats
            const pending = validatorTasks.filter(t => t.status !== 'Completed' && t.status !== 'Unresolved').length;
            const resolved = validatorTasks.filter(t => t.status === 'Completed').length;
            const unresolved = validatorTasks.filter(t => t.status === 'Unresolved').length;
            const total = validatorTasks.length;

            let tasksHtml = '';
            validatorTasks.forEach(t => {
                tasksHtml += `
                    <tr>
                        <td>${t.sku}</td>
                        <td>${t.desc || ''}</td>
                        <td>${t.qty}</td>
                        <td>${t.reason || ''}</td>
                        <td>${t.status === 'Completed' ? 'Resolved' : t.status}</td>
                        <td>${new Date(t.timestamp).toLocaleTimeString()}</td>
                    </tr>
                `;
            });

            const html = `
                <html>
                <head>
                    <title>Validator Sign-Off - ${validator.name}</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        h2 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .info-section { margin-bottom: 20px; border: 1px solid #000; padding: 10px; }
                        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
                        .stats-table, .tasks-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
                        .stats-table th, .stats-table td, .tasks-table th, .tasks-table td { border: 1px solid #000; padding: 6px; text-align: left; }
                        .stats-table th, .tasks-table th { background-color: #f0f0f0; }
                        .sign-off-section { margin-top: 40px; border-top: 1px solid #000; padding-top: 20px; }
                        .signature-row { display: flex; justify-content: space-between; margin-top: 40px; }
                        .signature-box { width: 45%; border-top: 1px solid #000; text-align: center; padding-top: 5px; }
                    </style>
                </head>
                <body>
                    <h2>Validator Sign-Off Form</h2>
                    
                    <div class="info-section">
                        <div class="info-row"><strong>Validator Name:</strong> ${validator.name}</div>
                        <div class="info-row"><strong>User ID:</strong> ${validator.userId || '-'}</div>
                        <div class="info-row"><strong>Shift:</strong> ${validator.shift}</div>
                        <div class="info-row"><strong>Date:</strong> ${dateStr}</div>
                    </div>

                    <h3>Task Summary</h3>
                    <table class="stats-table">
                        <thead>
                            <tr><th>Total Tasks</th><th>Resolved</th><th>Unresolved</th><th>Pending</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${total}</td>
                                <td>${resolved}</td>
                                <td>${unresolved}</td>
                                <td>${pending}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>Task Details</h3>
                    <table class="tasks-table">
                        <thead>
                            <tr><th>SKU</th><th>Description</th><th>Qty</th><th>Reason</th><th>Status</th><th>Time</th></tr>
                        </thead>
                        <tbody>
                            ${tasksHtml || '<tr><td colspan="6" style="text-align:center">No tasks found</td></tr>'}
                        </tbody>
                    </table>

                    <div class="sign-off-section">
                        <p>I confirm that the validation tasks listed above have been attended to according to the standard operating procedures.</p>
                        
                        <div class="signature-row">
                            <div class="signature-box">
                                <strong>${validator.name}</strong><br>
                                IC Validator
                            </div>
                            <div class="signature-box">
                                <strong>Team Leader</strong><br>
                                Signature
                            </div>
                        </div>
                        <div class="signature-row">
                            <div class="signature-box" style="border-top:0;"></div>
                            <div class="signature-box">
                                <strong>Date</strong>
                            </div>
                        </div>
                    </div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
        }

        async function exportValidatorSignOffPDF(validator, validatorTasks) {
            const container = document.getElementById('pdf-generator-container');
            if (!container) return;
            
            const dateStr = new Date().toLocaleDateString();
            const pending = validatorTasks.filter(t => t.status !== 'Completed' && t.status !== 'Unresolved').length;
            const resolved = validatorTasks.filter(t => t.status === 'Completed').length;
            const unresolved = validatorTasks.filter(t => t.status === 'Unresolved').length;
            const total = validatorTasks.length;

            let tasksHtml = '';
            validatorTasks.forEach(t => {
                tasksHtml += `
                    <tr>
                        <td style="border:1px solid #000; padding:6px;">${t.sku}</td>
                        <td style="border:1px solid #000; padding:6px;">${t.desc || ''}</td>
                        <td style="border:1px solid #000; padding:6px;">${t.qty}</td>
                        <td style="border:1px solid #000; padding:6px;">${t.reason || ''}</td>
                        <td style="border:1px solid #000; padding:6px;">${t.status === 'Completed' ? 'Resolved' : t.status}</td>
                        <td style="border:1px solid #000; padding:6px;">${new Date(t.timestamp).toLocaleTimeString()}</td>
                    </tr>
                `;
            });

            container.innerHTML = `
                <div style="font-family: sans-serif; padding: 20px; color: #000;">
                    <h2 style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px;">Validator Sign-Off Form</h2>
                    
                    <div style="margin-bottom: 20px; border: 1px solid #000; padding: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><strong>Validator Name:</strong> ${validator.name}</div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><strong>User ID:</strong> ${validator.userId || '-'}</div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><strong>Shift:</strong> ${validator.shift}</div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><strong>Date:</strong> ${dateStr}</div>
                    </div>

                    <h3>Task Summary</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                        <thead>
                            <tr><th style="border:1px solid #000; padding:6px; background-color:#f0f0f0;">Total Tasks</th><th style="border:1px solid #000; padding:6px; background-color:#f0f0f0;">Resolved</th><th style="border:1px solid #000; padding:6px; background-color:#f0f0f0;">Unresolved</th><th style="border:1px solid #000; padding:6px; background-color:#f0f0f0;">Pending</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border:1px solid #000; padding:6px;">${total}</td>
                                <td style="border:1px solid #000; padding:6px;">${resolved}</td>
                                <td style="border:1px solid #000; padding:6px;">${unresolved}</td>
                                <td style="border:1px solid #000; padding:6px;">${pending}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>Task Details</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                        <thead>
                            <tr><th style="border:1px solid #000; padding:6px; background-color:#f0f0f0;">SKU</th><th style="border:1px solid #000; padding:6px; background-color:#f0f0f0;">Description</th><th style="border:1px solid #000; padding:6px; background-color:#f0f0f0;">Qty</th><th style="border:1px solid #000; padding:6px; background-color:#f0f0f0;">Reason</th><th style="border:1px solid #000; padding:6px; background-color:#f0f0f0;">Status</th><th style="border:1px solid #000; padding:6px; background-color:#f0f0f0;">Time</th></tr>
                        </thead>
                        <tbody>
                            ${tasksHtml || '<tr><td colspan="6" style="text-align:center; border:1px solid #000; padding:6px;">No tasks found</td></tr>'}
                        </tbody>
                    </table>

                    <div style="margin-top: 40px; border-top: 1px solid #000; padding-top: 20px;">
                        <p>I confirm that the validation tasks listed above have been attended to according to the standard operating procedures.</p>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                            <div style="width: 45%; border-top: 1px solid #000; text-align: center; padding-top: 5px;">
                                <strong>${validator.name}</strong><br>
                                IC Validator
                            </div>
                            <div style="width: 45%; border-top: 1px solid #000; text-align: center; padding-top: 5px;">
                                <strong>Team Leader</strong><br>
                                Signature
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                            <div style="width: 45%; border-top: 0;"></div>
                            <div style="width: 45%; border-top: 1px solid #000; text-align: center; padding-top: 5px;">
                                <strong>Date</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            try {
                const canvas = await html2canvas(container, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                
                if (!window.jspdf) {
                    alert('jsPDF library not loaded.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                
                const safeName = (validator.name || 'Validator').replace(/[^a-z0-9]/gi, '_');
                const safeDate = dateStr.replace(/[^a-z0-9]/gi, '-');
                pdf.save(`Validator_SignOff_${safeName}_${safeDate}.pdf`);
            } catch (err) {
                console.error(err);
                alert('Failed to generate PDF.');
            } finally {
                container.innerHTML = '';
            }
        }

        function renderValidatorsModal() {
            if (!validatorsTbody) return;
            validatorsTbody.innerHTML = '';
            const timeoutTbody = document.getElementById('timeout-validators-tbody');
            if (timeoutTbody) timeoutTbody.innerHTML = '';
            
            const shiftFilter = document.getElementById('val-view-shift') ? document.getElementById('val-view-shift').value : '';
            let data = getAttendanceData();
            const valStart = document.getElementById('val-start-date');
            const valEnd = document.getElementById('val-end-date');
            const startStr = (valStart && valStart.value) || globalStartDate.value;
            const endStr = (valEnd && valEnd.value) || globalEndDate.value;

            if (startStr || endStr) {
                data = data.filter(item => {
                    return (!startStr || item.date >= startStr) && (!endStr || item.date <= endStr);
                });
            }
            let validators = data.filter(item => item.area === 'Validator' && !item.timeOut);
            let timeoutValidators = data.filter(item => item.area === 'Validator' && item.timeOut && item.timeOut !== '');

            if (shiftFilter) {
                validators = validators.filter(v => v.shift && v.shift.includes(shiftFilter));
                timeoutValidators = timeoutValidators.filter(v => v.shift && v.shift.includes(shiftFilter));
            }

            let tasks = getValidationTasks();
            if (startStr || endStr) {
                tasks = tasks.filter(t => {
                    const shiftInfo = getShiftFromTimestamp(t.timestamp);
                    return (!startStr || shiftInfo.date >= startStr) && (!endStr || shiftInfo.date <= endStr);
                });
            }
            if (shiftFilter) {
                tasks = tasks.filter(t => getShiftFromTimestamp(t.timestamp).shift.includes(shiftFilter));
            }

            const sortValidators = (list) => {
                list.sort((a, b) => {
                    if (a.date !== b.date) return new Date(b.date) - new Date(a.date);
                    return a.shift.localeCompare(b.shift);
                });
            };

            sortValidators(validators);
            sortValidators(timeoutValidators);

            updateValidatorDropdown(data);

            const renderRow = (v, tbody, isTimeout = false) => {
                // Calculate stats for this validator
                const pendingCount = tasks.filter(t => t.validator === v.name && t.status !== 'Completed' && t.status !== 'Unresolved').length;
                const completedCount = tasks.filter(t => t.validator === v.name && t.status === 'Completed').length;
                const unresolvedCount = tasks.filter(t => t.validator === v.name && t.status === 'Unresolved').length;
                const totalCount = pendingCount + completedCount + unresolvedCount;

                const tr = document.createElement('tr');
                let actionHtml = '';
                if (isTimeout) {
                    actionHtml = `<td style="white-space:nowrap;">
                        <button class="icon-btn print-signoff-btn" title="Print Sign-off Form" style="color:#2752a7; margin-right:5px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg></button>
                        <button class="icon-btn export-pdf-btn" title="Export PDF" style="color:#e74c3c;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg></button>
                    </td>`;
                }
                tr.innerHTML = `<td>${v.userId || '-'}</td><td>${v.name}</td><td>${v.shift}</td><td>${pendingCount}</td><td>${completedCount}</td><td>${unresolvedCount}</td><td>${totalCount}</td>${actionHtml}`;
                
                if (isTimeout) {
                    const btn = tr.querySelector('.print-signoff-btn');
                    if(btn) {
                        btn.addEventListener('click', () => printValidatorSignOff(v, tasks.filter(t => t.validator === v.name)));
                    }
                    const pdfBtn = tr.querySelector('.export-pdf-btn');
                    if(pdfBtn) {
                        pdfBtn.addEventListener('click', () => exportValidatorSignOffPDF(v, tasks.filter(t => t.validator === v.name)));
                    }
                }
                tbody.appendChild(tr);
            };

            validators.forEach(v => renderRow(v, validatorsTbody));
            if (timeoutTbody) timeoutValidators.forEach(v => renderRow(v, timeoutTbody, true));
        }

        function updateValidatorDropdown(data) {
            if(!assignValidator) return;
            const currentVal = assignValidator.value;
            // Keep first option
            assignValidator.innerHTML = '<option value="">Unassigned</option>';
            
            const validators = data.filter(item => item.area === 'Validator' && !item.timeOut);
            const uniqueValidators = [...new Set(validators.map(v => v.name))].sort();
            
            uniqueValidators.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                assignValidator.appendChild(opt);
            });
            if(currentVal) assignValidator.value = currentVal;
        }

        const STORAGE_KEY_TASKS = 'ims_validation_tasks_v1';

        function getValidationTasks() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_TASKS) || '[]'); } catch(e) { return []; }
        }
        function saveValidationTasks(data) {
            localStorage.setItem(STORAGE_KEY_TASKS, JSON.stringify(data));
        }

        let valPendingPage = 1;
        let valPendingRows = 10;
        let valAssignedPage = 1;
        let valAssignedRows = 10;
        let valResolvedPage = 1;
        let valResolvedRows = 10;
        let valUnresolvedPage = 1;
        let valUnresolvedRows = 10;
        let valHistoryPage = 1;
        let valHistoryRows = 10;
        let valReasonChart = null;
        let valTrendChart = null;
        
        // Filters
        let valFilterAssigned1 = '';
        let valFilterSku1 = '';

        function filterValDashboard(type) {
            if (type === 'total') {
                if(document.getElementById('val-filter-sku-1')) document.getElementById('val-filter-sku-1').value=''; 
                if(document.getElementById('val-filter-assigned-1')) document.getElementById('val-filter-assigned-1').value=''; 
                if(document.getElementById('val-filter-priority-1')) document.getElementById('val-filter-priority-1').value='';
                renderValidationTasks();
            } else if (type === 'resolved') {
                const btn = document.querySelector("button[onclick*='tab-val-resolved']");
                if(btn) btn.click();
            } else if (type === 'pending') {
                const btn = document.querySelector("button[onclick*='tab-val-pending']");
                if(btn) btn.click();
            } else if (type === 'assigned') {
                const btn = document.querySelector("button[onclick*='tab-val-assigned']");
                if(btn) btn.click();
            } else if (type === 'unresolved') {
                const btn = document.querySelector("button[onclick*='tab-val-unresolved']");
                if(btn) btn.click();
            } else if (type === 'history') {
                const btn = document.querySelector("button[onclick*='tab-val-history']");
                if(btn) btn.click();
            } else if (type === 'trend') {
                const btn = document.querySelector("button[onclick*='tab-val-trend']");
                if(btn) btn.click();
            } else if (type === 'chart') {
                const chart = document.getElementById('val-status-chart'); 
                if(chart) chart.scrollIntoView({behavior:'smooth'});
            }
        }

        function renderValidationTasks() {
            const assignedTasksTbody = document.getElementById('assigned-tasks-tbody');
            const historyTasksTbody = document.getElementById('history-tasks-tbody');
            if(!pendingTasksTbody || !resolvedTasksTbody || !document.getElementById('unresolved-tasks-tbody') || !assignedTasksTbody || !historyTasksTbody) return;
            pendingTasksTbody.innerHTML = '';
            assignedTasksTbody.innerHTML = '';
            resolvedTasksTbody.innerHTML = '';
            const unresolvedTasksTbody = document.getElementById('unresolved-tasks-tbody');
            unresolvedTasksTbody.innerHTML = '';
            historyTasksTbody.innerHTML = '';
            
            let tasks = getValidationTasks();

            const shiftFilter = document.getElementById('val-view-shift') ? document.getElementById('val-view-shift').value : '';
            const valStart = document.getElementById('val-start-date');
            const valEnd = document.getElementById('val-end-date');
            const startStr = (valStart && valStart.value) || globalStartDate.value;
            const endStr = (valEnd && valEnd.value) || globalEndDate.value;

            if (startStr || endStr) {
                tasks = tasks.filter(t => {
                    const shiftInfo = getShiftFromTimestamp(t.timestamp);
                    return (!startStr || shiftInfo.date >= startStr) && (!endStr || shiftInfo.date <= endStr);
                });
            }
            if (shiftFilter) {
                tasks = tasks.filter(t => getShiftFromTimestamp(t.timestamp).shift.includes(shiftFilter));
            }

            // Get filter values
            valFilterAssigned1 = document.getElementById('val-filter-assigned-1') ? document.getElementById('val-filter-assigned-1').value.toLowerCase() : '';
            valFilterSku1 = document.getElementById('val-filter-sku-1') ? document.getElementById('val-filter-sku-1').value.toLowerCase() : '';
            const valFilterPriority1 = document.getElementById('val-filter-priority-1') ? document.getElementById('val-filter-priority-1').value : '';
            const valGlobalSearchTerm = document.getElementById('val-global-search') ? document.getElementById('val-global-search').value.toLowerCase() : '';

            if (valGlobalSearchTerm) {
                tasks = tasks.filter(t => 
                    (t.sku || '').toLowerCase().includes(valGlobalSearchTerm) ||
                    (t.desc || '').toLowerCase().includes(valGlobalSearchTerm) ||
                    (t.validator || '').toLowerCase().includes(valGlobalSearchTerm)
                );
            }
            

            // Get validators for dropdown
            let attendanceData = getAttendanceData(); if (globalStartDate.value || globalEndDate.value) {
                const start = globalStartDate.value; const end = globalEndDate.value;
                attendanceData = attendanceData.filter(item => {
                    return (!start || item.date >= start) && (!end || item.date <= end);
                });
            }
            const validators = attendanceData.filter(item => item.area === 'Validator' && !item.timeOut);
            const validatorNames = [...new Set(validators.map(v => v.name))].sort();

            // --- 1. Calculate and Display Summary Stats ---
            const total = tasks.length;
            const resolvedCount = tasks.filter(t => t.status === 'Completed').length;
            const unresolvedCount = tasks.filter(t => t.status === 'Unresolved').length;
            
            const allActive = tasks.filter(t => t.status !== 'Completed' && t.status !== 'Unresolved');
            const assignedCount = allActive.filter(t => t.validator && t.validator !== 'Unassigned').length;
            const pendingCount = allActive.length - assignedCount;

            const rate = total > 0 ? Math.round((resolvedCount / total) * 100) : 0;
            const processedCount = resolvedCount + unresolvedCount;
            const completionRate = total > 0 ? Math.round((processedCount / total) * 100) : 0;
            const pctResolved = total > 0 ? Math.round((resolvedCount / total) * 100) : 0;
            const pctUnresolved = total > 0 ? Math.round((unresolvedCount / total) * 100) : 0;

            if(document.getElementById('val-total-tasks')) document.getElementById('val-total-tasks').textContent = total;
            if(document.getElementById('val-completed-tasks')) document.getElementById('val-completed-tasks').textContent = resolvedCount;
            if(document.getElementById('val-pending-tasks')) document.getElementById('val-pending-tasks').textContent = pendingCount;
            if(document.getElementById('val-assigned-tasks')) document.getElementById('val-assigned-tasks').textContent = assignedCount;
            if(document.getElementById('val-unresolved-tasks')) document.getElementById('val-unresolved-tasks').textContent = unresolvedCount;
            if(document.getElementById('val-completion-rate')) document.getElementById('val-completion-rate').textContent = rate + '%';
            if(document.getElementById('val-completion-rate')) document.getElementById('val-completion-rate').textContent = completionRate + '%';
            if(document.getElementById('val-pct-resolved')) document.getElementById('val-pct-resolved').textContent = pctResolved + '%';
            if(document.getElementById('val-pct-unresolved')) document.getElementById('val-pct-unresolved').textContent = pctUnresolved + '%';

            updateValStatusChart(resolvedCount, pendingCount, unresolvedCount, assignedCount);

            const getShiftBadge = (ts) => {
                const info = getShiftFromTimestamp(ts);
                let color = '#999';
                let label = '';
                if (info.shift.includes('1st')) { color = '#36b9cc'; label = '1st'; }
                else if (info.shift.includes('2nd')) { color = '#f6c23e'; label = '2nd'; }
                else if (info.shift.includes('3rd')) { color = '#4e73df'; label = '3rd'; }
                return label ? `<span style="font-size:9px; background:${color}; color:white; padding:1px 4px; border-radius:3px; margin-left:4px; vertical-align:middle; font-weight:normal;" title="${info.shift}">${label}</span>` : '';
            };
            
            // Populate Overdue Table
            const overdueTbody = document.getElementById('val-overdue-tbody');
            if (overdueTbody) {
                overdueTbody.innerHTML = '';
                const now = new Date();
                const activeAssigned = tasks.filter(t => t.status !== 'Completed' && t.status !== 'Unresolved' && t.validator && t.validator !== 'Unassigned');
                let overdueTasks = activeAssigned.filter(t => {
                    const diffMs = now - new Date(t.timestamp);
                    return diffMs > 3600000; // > 1 hour
                });
                if (valFilterSku1) {
                    overdueTasks = overdueTasks.filter(t => (t.sku || '').toLowerCase().includes(valFilterSku1));
                }
                if (valFilterAssigned1) {
                    overdueTasks = overdueTasks.filter(t => (t.validator || '').toLowerCase().includes(valFilterAssigned1));
                }
                overdueTasks.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                if (overdueTasks.length === 0) {
                    overdueTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999; padding:10px;">No overdue tasks</td></tr>';
                } else {
                    overdueTasks.forEach(t => {
                        const diffMs = now - new Date(t.timestamp);
                        const diffMins = Math.floor(diffMs / 60000);
                        const durStr = `${Math.floor(diffMins/60)}h ${diffMins%60}m`;
                        const tr = document.createElement('tr');
                        tr.style.cursor = 'pointer';
                        tr.title = 'Click to filter by SKU';
                        tr.onclick = () => {
                            const skuInput = document.getElementById('val-filter-sku-1');
                            if(skuInput) {
                                skuInput.value = t.sku;
                                const btn = document.querySelector("button[onclick*='tab-val-assigned']");
                                if(btn) btn.click();
                                renderValidationTasks();
                            }
                        };
                        tr.innerHTML = `<td style="padding:4px;">${t.sku}</td><td style="padding:4px;">${t.validator}</td><td style="padding:4px; color:#e74c3c; font-weight:bold;">${durStr}</td>`;
                        overdueTbody.appendChild(tr);
                    });
                }
            }

            // --- 2. Prepare Data for Tables ---
            tasks.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const allActiveForTables = tasks.filter(t => t.status !== 'Completed' && t.status !== 'Unresolved' && t.status !== 'Reassigned');
            let pendingTasks = allActiveForTables.filter(t => !t.validator || t.validator === 'Unassigned');
            let assignedTasks = allActiveForTables.filter(t => t.validator && t.validator !== 'Unassigned');
            
            let allResolved = tasks.filter(t => t.status === 'Completed');
            let allUnresolved = tasks.filter(t => t.status === 'Unresolved');

            // Distribute tasks to respective arrays based on status
            // Note: tasks are already filtered by date at the start of this function
            let resolvedTasks = allResolved;
            let unresolvedTasks = [];
            let historyTasks = [];
            let reassignedTasks = tasks.filter(t => t.status === 'Reassigned');

            allUnresolved.forEach(t => {
                if (t.subStatus === 'Reassigned') historyTasks.push(t); 
                else unresolvedTasks.push(t);
            });
            historyTasks.push(...reassignedTasks);
            historyTasks.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Apply Filters for Card 1 (Pending/Assigned)
            if (valFilterSku1) {
                pendingTasks = pendingTasks.filter(t => (t.sku || '').toLowerCase().includes(valFilterSku1));
                assignedTasks = assignedTasks.filter(t => (t.sku || '').toLowerCase().includes(valFilterSku1));
            }
            if (valFilterAssigned1) {
                assignedTasks = assignedTasks.filter(t => (t.validator || '').toLowerCase().includes(valFilterAssigned1));
            }
            if (valFilterPriority1) {
                pendingTasks = pendingTasks.filter(t => (t.priority || 'Normal') === valFilterPriority1);
                assignedTasks = assignedTasks.filter(t => (t.priority || 'Normal') === valFilterPriority1);
                resolvedTasks = resolvedTasks.filter(t => (t.priority || 'Normal') === valFilterPriority1);
                unresolvedTasks = unresolvedTasks.filter(t => (t.priority || 'Normal') === valFilterPriority1);
                historyTasks = historyTasks.filter(t => (t.priority || 'Normal') === valFilterPriority1);
            }

            // Apply Filters for Card 2 (Resolved/Unresolved)
            if (valFilterSku1) {
                resolvedTasks = resolvedTasks.filter(t => (t.sku || '').toLowerCase().includes(valFilterSku1));
                unresolvedTasks = unresolvedTasks.filter(t => (t.sku || '').toLowerCase().includes(valFilterSku1));
            }
            if (valFilterAssigned1) {
                resolvedTasks = resolvedTasks.filter(t => (t.validator || '').toLowerCase().includes(valFilterAssigned1));
                unresolvedTasks = unresolvedTasks.filter(t => (t.validator || '').toLowerCase().includes(valFilterAssigned1));
            }

            // Apply Filters for History
            if (valFilterSku1) historyTasks = historyTasks.filter(t => (t.sku || '').toLowerCase().includes(valFilterSku1));
            if (valFilterAssigned1) {
                historyTasks = historyTasks.filter(t => (t.validator || '').toLowerCase().includes(valFilterAssigned1));
            }

            // Pagination for Pending (Unassigned)
            const totalPending = pendingTasks.length;
            const totalPendingPages = Math.ceil(totalPending / valPendingRows) || 1;
            if (valPendingPage > totalPendingPages) valPendingPage = totalPendingPages;
            if (valPendingPage < 1) valPendingPage = 1;
            const startPending = (valPendingPage - 1) * valPendingRows;
            const paginatedPending = pendingTasks.slice(startPending, startPending + valPendingRows);

            // Update Pending Controls
            const pendingInfo = document.getElementById('val-pending-info');
            if(pendingInfo) pendingInfo.textContent = `Page ${valPendingPage}/${totalPendingPages} (${totalPending})`;
            const pendingPrev = document.getElementById('val-pending-prev');
            const pendingNext = document.getElementById('val-pending-next');
            if(pendingPrev) pendingPrev.disabled = valPendingPage <= 1;
            if(pendingNext) pendingNext.disabled = valPendingPage >= totalPendingPages;

            if(paginatedPending.length === 0) {
                pendingTasksTbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:10px; color:#999;">No pending tasks.</td></tr>';
            } else {
                const now = new Date();
                paginatedPending.forEach(t => {
                    const tr = document.createElement('tr');
                    const assignedTime = new Date(t.timestamp).toLocaleString() + getShiftBadge(t.timestamp);
                    
                    const prio = t.priority || 'Normal';
                    let prioColor = '#2ecc71';
                    if(prio === 'High') prioColor = '#f39c12';
                    if(prio === 'Urgent') prioColor = '#e74c3c';
                    const prioHtml = `<span style="color:${prioColor}; font-weight:bold;">${prio}</span>`;
                    
                    const diffMs = now - new Date(t.timestamp);
                    const diffMins = Math.floor(diffMs / 60000);
                    let durationStr = diffMins < 60 ? `${diffMins}m` : `${Math.floor(diffMins/60)}h ${diffMins%60}m`;
                    
                    const expiryStr = t.expiryDate || '-';
                    if (diffMs > 3600000) {
                        tr.style.boxShadow = "inset 4px 0 0 #e74c3c";
                        tr.style.backgroundColor = "#fff5f5";
                    }
                    
                    if(diffMins > 60) durationStr = `<span style="color:#e74c3c; font-weight:bold;">${durationStr}</span>`;
                    else if(diffMins > 30) durationStr = `<span style="color:#f39c12; font-weight:bold;">${durationStr}</span>`;
                    else durationStr = `<span style="color:#2ecc71; font-weight:bold;">${durationStr}</span>`;

                    let options = `<option value="Unassigned">Unassign</option>`;
                    validatorNames.forEach(v => {
                        const selected = (t.validator === v) ? 'selected' : '';
                        options += `<option value="${v}" ${selected}>${v}</option>`;
                    });
                    // If the assigned validator is not in the active list, add them as an option
                    if (t.validator && !validatorNames.includes(t.validator)) {
                        options += `<option value="${t.validator}" selected>${t.validator} (inactive)</option>`;
                    }
                    const validatorInput = `<select class="task-validator-input" data-id="${t.id}" style="width:100%; padding:4px; border:1px solid #e0e0e0; border-radius:4px; font-size:11px; background:#fff; color:#333;">${options}</select>`;

                    const actionHtml = `
                        <button class="icon-btn complete-task-btn" data-id="${t.id}" title="Mark Resolved" style="color:#2ecc71; margin-right:5px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                        <button class="icon-btn mark-unresolved-btn" data-id="${t.id}" title="Mark Unresolved" style="color:#f39c12; margin-right:5px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
                        </button>
                        <button class="icon-btn delete-task-btn" data-id="${t.id}" title="Delete" style="color:#d9534f;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
                        </button>`;
                    tr.innerHTML = `<td><input type="checkbox" class="val-row-checkbox pending-cb" value="${t.id}"></td><td>${assignedTime}</td><td>${prioHtml}</td><td>${t.sku}</td><td>${t.desc}</td><td>${t.qty}</td><td>${t.reason || '-'}</td><td>${expiryStr}</td><td>${t.opsValidator || '-'}</td><td>${validatorInput}</td><td>${durationStr}</td><td>${actionHtml}</td>`;
                    pendingTasksTbody.appendChild(tr);
                });
            }

            // Pagination for Assigned
            const totalAssigned = assignedTasks.length;
            const totalAssignedPages = Math.ceil(totalAssigned / valAssignedRows) || 1;
            if (valAssignedPage > totalAssignedPages) valAssignedPage = totalAssignedPages;
            if (valAssignedPage < 1) valAssignedPage = 1;
            const startAssigned = (valAssignedPage - 1) * valAssignedRows;
            const paginatedAssigned = assignedTasks.slice(startAssigned, startAssigned + valAssignedRows);

            // Update Assigned Controls
            const assignedInfo = document.getElementById('val-assigned-info');
            if(assignedInfo) assignedInfo.textContent = `Page ${valAssignedPage}/${totalAssignedPages} (${totalAssigned})`;
            const assignedPrev = document.getElementById('val-assigned-prev');
            const assignedNext = document.getElementById('val-assigned-next');
            if(assignedPrev) assignedPrev.disabled = valAssignedPage <= 1;
            if(assignedNext) assignedNext.disabled = valAssignedPage >= totalAssignedPages;

            if(paginatedAssigned.length === 0) {
                assignedTasksTbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:10px; color:#999;">No assigned tasks.</td></tr>';
            } else {
                const now = new Date();
                paginatedAssigned.forEach(t => {
                    const tr = document.createElement('tr');
                    const assignedTime = new Date(t.timestamp).toLocaleString() + getShiftBadge(t.timestamp);
                    
                    const prio = t.priority || 'Normal';
                    let prioColor = '#2ecc71';
                    if(prio === 'High') prioColor = '#f39c12';
                    if(prio === 'Urgent') prioColor = '#e74c3c';
                    const prioHtml = `<span style="color:${prioColor}; font-weight:bold;">${prio}</span>`;
                    
                    const diffMs = now - new Date(t.timestamp);
                    const diffMins = Math.floor(diffMs / 60000);
                    let durationStr = diffMins < 60 ? `${diffMins}m` : `${Math.floor(diffMins/60)}h ${diffMins%60}m`;
                    
                    const expiryStr = t.expiryDate || '-';
                    if(diffMins > 60) durationStr = `<span style="color:#e74c3c; font-weight:bold;">${durationStr}</span>`;
                    else if(diffMins > 30) durationStr = `<span style="color:#f39c12; font-weight:bold;">${durationStr}</span>`;
                    else durationStr = `<span style="color:#2ecc71; font-weight:bold;">${durationStr}</span>`;

                    let options = `<option value="Unassigned">Unassign</option>`;
                  
                    validatorNames.forEach(v => {
                        const selected = (t.validator === v) ? 'selected' : '';
                        options += `<option value="${v}" ${selected}>${v}</option>`;
                    });
                    if (t.validator && !validatorNames.includes(t.validator)) {
                        options += `<option value="${t.validator}" selected>${t.validator} (inactive)</option>`;
                    }
                    const validatorInput = `<select class="task-validator-input" data-id="${t.id}" style="width:100%; padding:4px; border:1px solid #e0e0e0; border-radius:4px; font-size:11px; background:#fff; color:#333;">${options}</select>`;

                    const actionHtml = `
                        <button class="icon-btn complete-task-btn" data-id="${t.id}" title="Mark Resolved" style="color:#2ecc71; margin-right:5px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                        <button class="icon-btn mark-unresolved-btn" data-id="${t.id}" title="Mark Unresolved" style="color:#f39c12; margin-right:5px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
                        </button>
                        <button class="icon-btn delete-task-btn" data-id="${t.id}" title="Delete" style="color:#d9534f;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
                        </button>`;
                    tr.innerHTML = `<td><input type="checkbox" class="val-row-checkbox assigned-cb" value="${t.id}"></td><td>${assignedTime}</td><td>${prioHtml}</td><td>${t.sku}</td><td>${t.desc}</td><td>${t.qty}</td><td>${t.reason || '-'}</td><td>${expiryStr}</td><td>${t.opsValidator || '-'}</td><td>${validatorInput}</td><td>${durationStr}</td><td>${actionHtml}</td>`;
                    assignedTasksTbody.appendChild(tr);
                });
            }

            // Pagination for Resolved
            const totalResolved = resolvedTasks.length;
            const totalResolvedPages = Math.ceil(totalResolved / valResolvedRows) || 1;
            if (valResolvedPage > totalResolvedPages) valResolvedPage = totalResolvedPages;
            if (valResolvedPage < 1) valResolvedPage = 1;
            const startResolved = (valResolvedPage - 1) * valResolvedRows;
            const paginatedResolved = resolvedTasks.slice(startResolved, startResolved + valResolvedRows);

            // Update Resolved Controls
            const resolvedInfo = document.getElementById('val-resolved-info');
            if(resolvedInfo) resolvedInfo.textContent = `Page ${valResolvedPage}/${totalResolvedPages} (${totalResolved})`;
            const resolvedPrev = document.getElementById('val-resolved-prev');
            const resolvedNext = document.getElementById('val-resolved-next');
            if(resolvedPrev) resolvedPrev.disabled = valResolvedPage <= 1;
            if(resolvedNext) resolvedNext.disabled = valResolvedPage >= totalResolvedPages;

            if(paginatedResolved.length === 0) {
                resolvedTasksTbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:10px; color:#999;">No resolved tasks.</td></tr>';
                resolvedTasksTbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:10px; color:#999;">No resolved tasks.</td></tr>';
            } else {
                paginatedResolved.forEach(t => {
                    const tr = document.createElement('tr');
                    const resolvedTime = (t.completedAt ? new Date(t.completedAt).toLocaleString() : '-') + getShiftBadge(t.timestamp);
                    
                    const prio = t.priority || 'Normal';
                    let prioColor = '#2ecc71';
                    if(prio === 'High') prioColor = '#f39c12';
                    if(prio === 'Urgent') prioColor = '#e74c3c';
                    const prioHtml = `<span style="color:${prioColor}; font-weight:bold;">${prio}</span>`;
                    const expiryStr = t.expiryDate || '-';
                    
                    let durationStr = '-';
                    if (t.completedAt && t.timestamp) {
                        const diffMs = new Date(t.completedAt) - new Date(t.timestamp);
                        const diffMins = Math.floor(diffMs / 60000);
                        durationStr = diffMins < 60 ? `${diffMins}m` : `${Math.floor(diffMins/60)}h ${diffMins%60}m`;
                    }

                    let options = `<option value="Unassigned">Unassign</option>`;
                    validatorNames.forEach(v => {
                        const selected = (t.validator === v) ? 'selected' : '';
                        options += `<option value="${v}" ${selected}>${v}</option>`;
                    });
                    if (t.validator && !validatorNames.includes(t.validator)) {
                        options += `<option value="${t.validator}" selected>${t.validator} (inactive)</option>`;
                    }
                    const validatorInput = `<select class="task-validator-input" data-id="${t.id}" style="width:100%; padding:4px; border:1px solid #e0e0e0; border-radius:4px; font-size:11px; background:#fff; color:#333;">${options}</select>`;

                    const actionHtml = `
                        <button class="icon-btn reopen-task-btn" data-id="${t.id}" title="Reopen (Move to Pending)" style="color:#f39c12; margin-right:5px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/></svg>
                        </button>
                        <button class="icon-btn delete-task-btn" data-id="${t.id}" title="Delete" style="color:#d9534f;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
                        </button>`;
                    tr.innerHTML = `<td><input type="checkbox" class="val-row-checkbox resolved-cb" value="${t.id}"></td><td>${resolvedTime}</td><td>${prioHtml}</td><td>${t.sku}</td><td>${t.desc}</td><td>${t.qty}</td><td>${t.reason || '-'}</td><td>${expiryStr}</td><td>${t.opsValidator || '-'}</td><td>${validatorInput}</td><td>${durationStr}</td><td>${actionHtml}</td>`;
                    resolvedTasksTbody.appendChild(tr);
                });
            }

            // Pagination for Unresolved
            const totalUnresolved = unresolvedTasks.length;
            const totalUnresolvedPages = Math.ceil(totalUnresolved / valUnresolvedRows) || 1;
            if (valUnresolvedPage > totalUnresolvedPages) valUnresolvedPage = totalUnresolvedPages;
            if (valUnresolvedPage < 1) valUnresolvedPage = 1;
            const startUnresolved = (valUnresolvedPage - 1) * valUnresolvedRows;
            const paginatedUnresolved = unresolvedTasks.slice(startUnresolved, startUnresolved + valUnresolvedRows);

            // Update Unresolved Controls
            const unresolvedInfo = document.getElementById('val-unresolved-info');
            if(unresolvedInfo) unresolvedInfo.textContent = `Page ${valUnresolvedPage}/${totalUnresolvedPages} (${totalUnresolved})`;
            const unresolvedPrev = document.getElementById('val-unresolved-prev');
            const unresolvedNext = document.getElementById('val-unresolved-next');
            if(unresolvedPrev) unresolvedPrev.disabled = valUnresolvedPage <= 1;
            if(unresolvedNext) unresolvedNext.disabled = valUnresolvedPage >= totalUnresolvedPages;

            if(paginatedUnresolved.length === 0) {
                unresolvedTasksTbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:10px; color:#999;">No unresolved tasks.</td></tr>';
            } else {
                const now = new Date();
                paginatedUnresolved.forEach(t => {
                    const tr = document.createElement('tr');
                    const assignedTime = new Date(t.timestamp).toLocaleString() + getShiftBadge(t.timestamp);
                    const unresolvedTime = t.unresolvedAt ? new Date(t.unresolvedAt).toLocaleString() : '-';
                    
                    const prio = t.priority || 'Normal';
                    let prioColor = '#2ecc71';
                    if(prio === 'High') prioColor = '#f39c12';
                    if(prio === 'Urgent') prioColor = '#e74c3c';
                    const prioHtml = `<span style="color:${prioColor}; font-weight:bold;">${prio}</span>`;
                    const expiryStr = t.expiryDate || '-';
                    
                    const endTime = t.unresolvedAt ? new Date(t.unresolvedAt) : now;
                    const diffMs = endTime - new Date(t.timestamp);
                    const diffMins = Math.floor(diffMs / 60000);
                    let durationStr = diffMins < 60 ? `${diffMins}m` : `${Math.floor(diffMins/60)}h ${diffMins%60}m`;
                    
                    if(diffMins > 60) durationStr = `<span style="color:#e74c3c; font-weight:bold;">${durationStr}</span>`;
                    else if(diffMins > 30) durationStr = `<span style="color:#f39c12; font-weight:bold;">${durationStr}</span>`;
                    else durationStr = `<span style="color:#2ecc71; font-weight:bold;">${durationStr}</span>`;

                    let options = `<option value="Unassigned">Unassign</option>`;
                    validatorNames.forEach(v => {
                        const selected = (t.validator === v) ? 'selected' : '';
                        options += `<option value="${v}" ${selected}>${v}</option>`;
                    });
                    if (t.validator && !validatorNames.includes(t.validator)) {
                        options += `<option value="${t.validator}" selected>${t.validator} (inactive)</option>`;
                    }
                    // Dropdown for reassignment
                    const validatorInput = `<select class="task-validator-input" data-id="${t.id}" style="width:100%; padding:4px; border:1px solid #e0e0e0; border-radius:4px; font-size:11px; background:#fff; color:#333;">${options}</select>`;

                    const actionHtml = `
                        <button class="icon-btn complete-task-btn" data-id="${t.id}" title="Mark Resolved" style="color:#2ecc71; margin-right:5px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                        <button class="icon-btn delete-task-btn" data-id="${t.id}" title="Delete" style="color:#d9534f;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
                        </button>`;
                    tr.innerHTML = `<td><input type="checkbox" class="val-row-checkbox unresolved-cb" value="${t.id}"></td><td>${assignedTime}</td><td>${prioHtml}</td><td>${t.sku}</td><td>${t.desc}</td><td>${t.qty}</td><td>${t.reason || '-'}</td><td>${expiryStr}</td><td>${t.opsValidator || '-'}</td><td>${validatorInput}</td><td>${unresolvedTime}</td><td>${durationStr}</td><td>${actionHtml}</td>`;
                    unresolvedTasksTbody.appendChild(tr);
                });
            }

            // Pagination for History
            const totalHistory = historyTasks.length;
            const totalHistoryPages = Math.ceil(totalHistory / valHistoryRows) || 1;
            if (valHistoryPage > totalHistoryPages) valHistoryPage = totalHistoryPages;
            if (valHistoryPage < 1) valHistoryPage = 1;
            const startHistory = (valHistoryPage - 1) * valHistoryRows;
            const paginatedHistory = historyTasks.slice(startHistory, startHistory + valHistoryRows);

            const historyInfo = document.getElementById('val-history-info');
            if(historyInfo) historyInfo.textContent = `Page ${valHistoryPage}/${totalHistoryPages} (${totalHistory})`;
            const historyPrev = document.getElementById('val-history-prev');
            const historyNext = document.getElementById('val-history-next');
            if(historyPrev) historyPrev.disabled = valHistoryPage <= 1;
            if(historyNext) historyNext.disabled = valHistoryPage >= totalHistoryPages;

            if(paginatedHistory.length === 0) {
                historyTasksTbody.innerHTML = '<tr><td colspan="14" style="text-align:center; padding:10px; color:#999;">No history tasks.</td></tr>';
            } else {
                paginatedHistory.forEach(t => {
                    const tr = document.createElement('tr');
                    const dateStr = new Date(t.timestamp).toLocaleString() + getShiftBadge(t.timestamp);
                    
                    const prio = t.priority || 'Normal';
                    let prioColor = '#2ecc71';
                    if(prio === 'High') prioColor = '#f39c12';
                    if(prio === 'Urgent') prioColor = '#e74c3c';
                    const prioHtml = `<span style="color:${prioColor}; font-weight:bold;">${prio}</span>`;
                    const expiryStr = t.expiryDate || '-';
                    
                    let durationStr = '-';
                    const endTime = t.completedAt ? new Date(t.completedAt) : (t.unresolvedAt ? new Date(t.unresolvedAt) : null);
                    if (endTime && t.timestamp) {
                        const diffMs = endTime - new Date(t.timestamp);
                        const diffMins = Math.floor(diffMs / 60000);
                        durationStr = diffMins < 60 ? `${diffMins}m` : `${Math.floor(diffMins/60)}h ${diffMins%60}m`;
                    }

                    let displayStatus = t.status;
                    let displaySubStatus = t.subStatus || '';

                    if (t.status === 'Reassigned') {
                        displayStatus = 'Unresolved';
                        displaySubStatus = 'Reassigned';
                    } else if (t.status === 'Completed') {
                        displayStatus = 'Resolved';
                    }

                    const reassignedTo = t.reassignedTo || '-';

                    tr.innerHTML = `<td><input type="checkbox" class="val-row-checkbox history-cb" value="${t.id}"></td><td>${dateStr}</td><td>${prioHtml}</td><td>${t.sku}</td><td>${t.desc}</td><td>${t.qty}</td><td>${t.reason || '-'}</td><td>${expiryStr}</td><td>${t.opsValidator || '-'}</td><td>${t.validator}</td><td>${displayStatus}</td><td>${displaySubStatus}</td><td>${reassignedTo}</td><td>${durationStr}</td><td><button class="icon-btn delete-task-btn" data-id="${t.id}" title="Delete" style="color:#d9534f;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg></button></td>`;
                    historyTasksTbody.appendChild(tr);
                });
            }

            updateValBulkButtons();
            renderValAnalytics();
        }

        let valStatusChart = null;
        function updateValStatusChart(resolvedCount, pendingCount, unresolvedCount, assignedCount) {
            const ctx = document.getElementById('val-status-chart');
            if (!ctx || typeof Chart === 'undefined') return;
            
            if (valStatusChart) valStatusChart.destroy();

                valStatusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Resolved', 'Pending', 'Assigned', 'Unresolved'],
                        datasets: [{
                            data: [resolvedCount, pendingCount, assignedCount, unresolvedCount],
                            backgroundColor: ['#2e7d32', '#ef6c00', '#3498db', '#d9534f'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        layout: { padding: 20 },
                        plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } },
                        cutout: '75%',
                        onHover: (event, chartElement) => {
                            event.native.target.style.cursor = chartElement.length ? 'pointer' : 'default';
                        },
                        onClick: (evt, elements, chart) => {
                            if (elements.length > 0) {
                                const i = elements[0].index;
                                const label = chart.data.labels[i];
                                let tabId = '';
                                if (label === 'Resolved') tabId = 'tab-val-resolved';
                                else if (label === 'Pending') tabId = 'tab-val-pending';
                                else if (label === 'Assigned') tabId = 'tab-val-assigned';
                                else if (label === 'Unresolved') tabId = 'tab-val-unresolved';
                                
                                if (tabId) {
                                    const btn = document.querySelector(`button[onclick*="'${tabId}'"]`);
                                    if (btn) btn.click();
                                }
                            }
                        }
                    }
                });
        }

        function renderValAnalytics() {
            let tasks = getValidationTasks();
            const rawTasks = [...tasks]; // Keep raw for specific period overrides
            const valStart = document.getElementById('val-start-date');
            const valEnd = document.getElementById('val-end-date');
            const startStr = (valStart && valStart.value) || globalStartDate.value;
            const endStr = (valEnd && valEnd.value) || globalEndDate.value;

            if (startStr || endStr) {
                tasks = tasks.filter(t => {
                    const shiftInfo = getShiftFromTimestamp(t.timestamp);
                    return (!startStr || shiftInfo.date >= startStr) && (!endStr || shiftInfo.date <= endStr);
                });
            }

            // Top SKUs
            const skuTotal = {};
            const skuResolved = {};
            const skuUnresolved = {};

            tasks.forEach(t => {
                const sku = t.sku || 'Unknown';
                skuTotal[sku] = (skuTotal[sku] || 0) + 1;
                if (t.status === 'Completed') skuResolved[sku] = (skuResolved[sku] || 0) + 1;
                if (t.status === 'Unresolved') skuUnresolved[sku] = (skuUnresolved[sku] || 0) + 1;
            });

            const topTotal = Object.entries(skuTotal).sort((a,b) => b[1] - a[1]).slice(0, 10);
            const topResolved = Object.entries(skuResolved).sort((a,b) => b[1] - a[1]).slice(0, 10);
            const topUnresolved = Object.entries(skuUnresolved).sort((a,b) => b[1] - a[1]).slice(0, 10);
            
            // Get Master Descriptions
            let masterMap = {};
            try { masterMap = JSON.parse(localStorage.getItem('ims_master_desc_v1') || '{}'); } catch(e) {}

            const skuTbody = document.getElementById('val-analytics-sku-tbody');
            if(skuTbody) {
                skuTbody.innerHTML = '';
                const maxLen = Math.max(topTotal.length, topResolved.length, topUnresolved.length);
                
                if(maxLen === 0) skuTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No data</td></tr>';
                
                for(let i=0; i<maxLen; i++) {
                    const renderCell = (arr) => {
                        if(!arr[i]) return '-';
                        const [k, v] = arr[i];
                        const desc = masterMap[k] || '';
                        return `<span title="${desc}">${k} - ${desc} - (${v})</span>`;
                    };
                    
                    skuTbody.innerHTML += `<tr>
                        <td>${i+1}</td>
                        <td>${renderCell(topTotal)}</td>
                        <td>${renderCell(topResolved)}</td>
                        <td>${renderCell(topUnresolved)}</td>
                    </tr>`;
                }
            }

            // Top Validators (Resolved count)
            const valResolved = {};
            const valUnresolved = {};
            const valTotal = {};
            
            tasks.forEach(t => {
                if (t.validator && t.validator !== 'Unassigned') {
                    valTotal[t.validator] = (valTotal[t.validator] || 0) + 1;
                    if (t.status === 'Completed') valResolved[t.validator] = (valResolved[t.validator] || 0) + 1;
                    if (t.status === 'Unresolved') valUnresolved[t.validator] = (valUnresolved[t.validator] || 0) + 1;
                }
            });

            // Attendance for "Most Present"
            let attendanceData = getAttendanceData();
            if (globalStartDate.value || globalEndDate.value) {
                const start = globalStartDate.value ? new Date(globalStartDate.value) : null; if(start) start.setHours(0,0,0,0); const end = globalEndDate.value ? new Date(globalEndDate.value) : null; if(end) end.setHours(23,59,59,999);
                attendanceData = attendanceData.filter(item => {
                    const d = new Date(item.date);
                    return (!start || d >= start) && (!end || d <= end);
                });
            }

            const valPresent = {};
            attendanceData.forEach(a => {
                if (a.area === 'Validator' && a.name) {
                    valPresent[a.name] = (valPresent[a.name] || 0) + 1;
                }
            });

            const topResolvedVal = Object.entries(valResolved).sort((a,b) => b[1] - a[1]).slice(0, 10);
            const topUnresolvedVal = Object.entries(valUnresolved).sort((a,b) => b[1] - a[1]).slice(0, 10);
            const topTotalVal = Object.entries(valTotal).sort((a,b) => b[1] - a[1]).slice(0, 10);
            const topPresentVal = Object.entries(valPresent).sort((a,b) => b[1] - a[1]).slice(0, 10);
            
            const valTbody = document.getElementById('val-analytics-validator-tbody');
            if(valTbody) {
                valTbody.innerHTML = '';
                const maxLen = Math.max(topResolvedVal.length, topUnresolvedVal.length, topTotalVal.length, topPresentVal.length);
                
                if(maxLen === 0) valTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No data</td></tr>';
                
                for(let i=0; i<maxLen; i++) {
                    const renderCell = (arr) => {
                        if(!arr[i]) return '-';
                        const [k, v] = arr[i];
                        return `${k} (${v})`;
                    };
                    
                    valTbody.innerHTML += `<tr>
                        <td>${i+1}</td>
                        <td>${renderCell(topResolvedVal)}</td>
                        <td>${renderCell(topUnresolvedVal)}</td>
                        <td>${renderCell(topTotalVal)}</td>
                        <td>${renderCell(topPresentVal)}</td>
                    </tr>`;
                }
            }

            // Reason Analysis
            const reasonTbody = document.getElementById('val-analytics-reason-tbody');
            const reasonPeriod = document.getElementById('val-analytics-reason-period');
            
            if(reasonTbody) {
                reasonTbody.innerHTML = '';
                let reasonTasks = tasks; // Default to global filtered
                
                if (reasonPeriod) {
                    const period = reasonPeriod.value;
                    if (period === 'today') {
                        const today = getShiftFromTimestamp(new Date().toISOString()).date;
                        reasonTasks = rawTasks.filter(t => getShiftFromTimestamp(t.timestamp).date === today);
                    } else if (period === 'week') {
                        const now = new Date();
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
                        startOfWeek.setHours(0,0,0,0);
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endOfWeek.setHours(23,59,59,999);
                        
                        reasonTasks = rawTasks.filter(t => {
                            const d = new Date(t.timestamp);
                            return d >= startOfWeek && d <= endOfWeek;
                        });
                    }
                }

                const skuReasons = {};
                reasonTasks.forEach(t => {
                    const sku = t.sku || 'Unknown';
                    const reason = t.reason || 'Unknown';
                    if(!skuReasons[sku]) skuReasons[sku] = {};
                    skuReasons[sku][reason] = (skuReasons[sku][reason] || 0) + 1;
                });
                
                const skuReasonList = Object.keys(skuReasons).map(sku => {
                    const reasons = skuReasons[sku];
                    const totalCount = Object.values(reasons).reduce((a,b) => a+b, 0);
                    const topReason = Object.keys(reasons).reduce((a, b) => reasons[a] > reasons[b] ? a : b);
                    return { sku, topReason, totalCount };
                });
                
                skuReasonList.sort((a,b) => b.totalCount - a.totalCount);
                const topSkuReasons = skuReasonList.slice(0, 20);
                
                if(topSkuReasons.length === 0) reasonTbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No data</td></tr>';
                
                topSkuReasons.forEach(item => {
                    const desc = masterMap[item.sku] || '-';
                    const shortDesc = desc.length > 15 ? desc.substring(0, 15) + '...' : desc;
                    reasonTbody.innerHTML += `<tr><td>${item.sku}</td><td title="${desc}">${shortDesc}</td><td>${item.topReason}</td><td>${item.totalCount}</td></tr>`;
                });

                // Render Reason Chart
                const reasonCounts = {};
                reasonTasks.forEach(t => {
                    const r = t.reason || 'Unknown';
                    reasonCounts[r] = (reasonCounts[r] || 0) + 1;
                });
                const sortedReasons = Object.entries(reasonCounts).sort((a,b) => b[1] - a[1]).slice(0, 8);
                
                const ctxReason = document.getElementById('val-reason-chart');
                if(ctxReason) {
                    if(valReasonChart) valReasonChart.destroy();
                    valReasonChart = new Chart(ctxReason, {
                        type: 'bar',
                        data: {
                            labels: sortedReasons.map(x => x[0]),
                            datasets: [{
                                label: 'Count',
                                data: sortedReasons.map(x => x[1]),
                                backgroundColor: '#f1c40f',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            indexAxis: 'y',
                            plugins: { legend: { display: false }, title: { display: true, text: 'Top Reasons', font: { size: 10 } } },
                            scales: { x: { beginAtZero: true, ticks: { font: { size: 9 } } }, y: { ticks: { font: { size: 9 } } } }
                        }
                    });
                }
            }

            // Trend Analysis
            const ctxTrend = document.getElementById('val-trend-chart');
            if(ctxTrend) {
                let trendTasks = rawTasks;
                if (globalStartDate.value || globalEndDate.value) {
                    const startStr = globalStartDate.value;
                    const endStr = globalEndDate.value;
                    trendTasks = trendTasks.filter(t => {
                        const shiftInfo = getShiftFromTimestamp(t.timestamp);
                        return (!startStr || shiftInfo.date >= startStr) && (!endStr || shiftInfo.date <= endStr);
                    });
                }

                const trendData = {};
                trendTasks.forEach(t => {
                    const d = getShiftFromTimestamp(t.timestamp).date;
                    if(!trendData[d]) trendData[d] = { total: 0, resolved: 0, unresolved: 0 };
                    trendData[d].total++;
                    if(t.status === 'Completed') trendData[d].resolved++;
                    if(t.status === 'Unresolved') trendData[d].unresolved++;
                });

                const sortedDates = Object.keys(trendData).sort();
                // Limit to last 30 days if too many
                const displayDates = sortedDates.length > 30 ? sortedDates.slice(-30) : sortedDates;

                if(valTrendChart) valTrendChart.destroy();
                valTrendChart = new Chart(ctxTrend, {
                    type: 'line',
                    data: {
                        labels: displayDates,
                        datasets: [
                            { label: 'Total', data: displayDates.map(d => trendData[d].total), borderColor: '#3498db', backgroundColor: 'transparent', tension: 0.1, borderWidth: 2 },
                            { label: 'Resolved', data: displayDates.map(d => trendData[d].resolved), borderColor: '#2ecc71', backgroundColor: 'transparent', tension: 0.1, borderWidth: 2 },
                            { label: 'Unresolved', data: displayDates.map(d => trendData[d].unresolved), borderColor: '#e74c3c', backgroundColor: 'transparent', tension: 0.1, borderWidth: 2 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', labels: { boxWidth: 10, font: { size: 10 } } } },
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { ticks: { font: { size: 10 } } } }
                    }
                });
            }
        }

        function exportValAnalytics() {
            // Determine active tab
            const skuTab = document.getElementById('tab-val-top-sku'); const valTab = document.getElementById('tab-val-top-validator'); const reasonTab = document.getElementById('tab-val-reason-analysis'); const trendTab = document.getElementById('tab-val-trend'); let activeTab = 'sku'; if (valTab && valTab.style.display !== 'none') activeTab = 'validator'; if (reasonTab && reasonTab.style.display !== 'none') activeTab = 'reason'; if (trendTab && trendTab.style.display !== 'none') activeTab = 'trend';

            // Recalculate data
            let tasks = getValidationTasks();
            const valStart = document.getElementById('val-start-date');
            const valEnd = document.getElementById('val-end-date');
            const startStr = (valStart && valStart.value) || globalStartDate.value;
            const endStr = (valEnd && valEnd.value) || globalEndDate.value;

            if (startStr || endStr) {
                tasks = tasks.filter(t => {
                    const shiftInfo = getShiftFromTimestamp(t.timestamp);
                    return (!startStr || shiftInfo.date >= startStr) && (!endStr || shiftInfo.date <= endStr);
                });
            }

            let headers = [];
            let rows = [];
            let filename = 'analytics_export.csv';

            if (activeTab === 'sku') {
                headers = ['SKU', 'Description', 'Count'];
                filename = 'top_skus_analytics.csv';
                const skuCounts = {};
                tasks.forEach(t => {
                    const sku = t.sku || 'Unknown';
                    skuCounts[sku] = (skuCounts[sku] || 0) + 1;
                });
                const sortedSkus = Object.entries(skuCounts).sort((a,b) => b[1] - a[1]);
                let masterMap = {};
                try { masterMap = JSON.parse(localStorage.getItem('ims_master_desc_v1') || '{}'); } catch(e) {}
                
                sortedSkus.forEach(([sku, count]) => {
                    const desc = masterMap[sku] || '-';
                    rows.push([`"${sku}"`, `"${desc.replace(/"/g, '""')}"`, count]);
                });

            } else if (activeTab === 'validator') {
                headers = ['IC Validator', 'Resolved Count'];
                filename = 'top_validators_analytics.csv';
                const valCounts = {};
                tasks.forEach(t => {
                    if(t.status === 'Completed' && t.validator && t.validator !== 'Unassigned') {
                        valCounts[t.validator] = (valCounts[t.validator] || 0) + 1;
                    }
                });
                const sortedVals = Object.entries(valCounts).sort((a,b) => b[1] - a[1]);
                sortedVals.forEach(([val, count]) => {
                    rows.push([`"${val}"`, count]);
                });

            } else if (activeTab === 'reason') {
                headers = ['SKU', 'Description', 'Top Reason', 'Total Count'];
                filename = 'reason_analysis.csv';
                
                const reasonPeriod = document.getElementById('val-analytics-reason-period');
                let reasonTasks = tasks;
                let rawTasks = getValidationTasks();
                
                if (reasonPeriod) {
                    const period = reasonPeriod.value;
                    if (period === 'today') {
                        const today = getShiftFromTimestamp(new Date().toISOString()).date;
                        reasonTasks = rawTasks.filter(t => getShiftFromTimestamp(t.timestamp).date === today);
                    } else if (period === 'week') {
                        const now = new Date();
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay());
                        startOfWeek.setHours(0,0,0,0);
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endOfWeek.setHours(23,59,59,999);
                        
                        reasonTasks = rawTasks.filter(t => {
                            const d = new Date(t.timestamp);
                            return d >= startOfWeek && d <= endOfWeek;
                        });
                    }
                }

                const skuReasons = {};
                reasonTasks.forEach(t => {
                    const sku = t.sku || 'Unknown';
                    const reason = t.reason || 'Unknown';
                    if(!skuReasons[sku]) skuReasons[sku] = {};
                    skuReasons[sku][reason] = (skuReasons[sku][reason] || 0) + 1;
                });
                
                const skuReasonList = Object.keys(skuReasons).map(sku => {
                    const reasons = skuReasons[sku];
                    const totalCount = Object.values(reasons).reduce((a,b) => a+b, 0);
                    const topReason = Object.keys(reasons).reduce((a, b) => reasons[a] > reasons[b] ? a : b);
                    return { sku, topReason, totalCount };
                });
                
                skuReasonList.sort((a,b) => b.totalCount - a.totalCount);
                let masterMap = {};
                try { masterMap = JSON.parse(localStorage.getItem('ims_master_desc_v1') || '{}'); } catch(e) {}

                skuReasonList.forEach(item => {
                    const desc = masterMap[item.sku] || '-';
                    rows.push([`"${item.sku}"`, `"${desc.replace(/"/g, '""')}"`, `"${item.topReason}"`, item.totalCount]);
                });
            } else if (activeTab === 'trend') {
                headers = ['Date', 'Total Tasks', 'Resolved', 'Unresolved'];
                filename = 'trend_analysis.csv';
                
                const trendData = {};
                tasks.forEach(t => {
                    const d = getShiftFromTimestamp(t.timestamp).date;
                    if(!trendData[d]) trendData[d] = { total: 0, resolved: 0, unresolved: 0 };
                    trendData[d].total++;
                    if(t.status === 'Completed') trendData[d].resolved++;
                    if(t.status === 'Unresolved') trendData[d].unresolved++;
                });
                
                const sortedDates = Object.keys(trendData).sort();
                sortedDates.forEach(d => {
                    const item = trendData[d];
                    rows.push([d, item.total, item.resolved, item.unresolved]);
                });
            }

            if (rows.length === 0) {
                alert('No data to export for the current view.');
                return;
            }
            
            // Add Priority to export if exporting tasks
            if (['pending_validation_tasks.csv', 'assigned_validation_tasks.csv', 'resolved_validation_tasks.csv', 'unresolved_validation_tasks.csv', 'history_validation_tasks.csv'].includes(filename)) {
                headers.splice(1, 0, 'Priority'); // Insert Priority after Date
                rows.forEach((r, i) => {
                    // Find the task in dataToExport
                    const t = dataToExport[i];
                    if(t) r.splice(1, 0, `"${t.priority || 'Normal'}"`);
                });
            }
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        window.openValAnalyticsTab = function(evt, tabId) {
            const parent = evt.target.closest('.card');
            parent.querySelectorAll('.val-analytics-tab-content').forEach(c => c.style.display = 'none');
            parent.querySelectorAll('.att-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            evt.target.classList.add('active');
        };

        const reasonPeriodSelect = document.getElementById('val-analytics-reason-period');
        if(reasonPeriodSelect) {
            reasonPeriodSelect.addEventListener('change', renderValAnalytics);
        }

        // Validation Tasks Pagination Listeners
        const valPendingPrev = document.getElementById('val-pending-prev');
        const valPendingNext = document.getElementById('val-pending-next');
        const valPendingRowsSel = document.getElementById('val-pending-rows');

        if(valPendingPrev) valPendingPrev.addEventListener('click', () => { if(valPendingPage > 1) { valPendingPage--; renderValidationTasks(); } });
        if(valPendingNext) valPendingNext.addEventListener('click', () => { valPendingPage++; renderValidationTasks(); });
        if(valPendingRowsSel) valPendingRowsSel.addEventListener('change', () => { 
            const oldRows = valPendingRows;
            valPendingRows = parseInt(valPendingRowsSel.value); 
            const firstItem = (valPendingPage - 1) * oldRows;
            valPendingPage = Math.floor(firstItem / valPendingRows) + 1;
            renderValidationTasks(); 
        });

        const valAssignedPrev = document.getElementById('val-assigned-prev');
        const valAssignedNext = document.getElementById('val-assigned-next');
        const valAssignedRowsSel = document.getElementById('val-assigned-rows');

        if(valAssignedPrev) valAssignedPrev.addEventListener('click', () => { if(valAssignedPage > 1) { valAssignedPage--; renderValidationTasks(); } });
        if(valAssignedNext) valAssignedNext.addEventListener('click', () => { valAssignedPage++; renderValidationTasks(); });
        if(valAssignedRowsSel) valAssignedRowsSel.addEventListener('change', () => { 
            const oldRows = valAssignedRows;
            valAssignedRows = parseInt(valAssignedRowsSel.value); 
            const firstItem = (valAssignedPage - 1) * oldRows;
            valAssignedPage = Math.floor(firstItem / valAssignedRows) + 1;
            renderValidationTasks(); 
        });

        const valResolvedPrev = document.getElementById('val-resolved-prev');
        const valResolvedNext = document.getElementById('val-resolved-next');
        const valResolvedRowsSel = document.getElementById('val-resolved-rows');

        if(valResolvedPrev) valResolvedPrev.addEventListener('click', () => { if(valResolvedPage > 1) { valResolvedPage--; renderValidationTasks(); } });
        if(valResolvedNext) valResolvedNext.addEventListener('click', () => { valResolvedPage++; renderValidationTasks(); });
        if(valResolvedRowsSel) valResolvedRowsSel.addEventListener('change', () => { 
            const oldRows = valResolvedRows;
            valResolvedRows = parseInt(valResolvedRowsSel.value); 
            const firstItem = (valResolvedPage - 1) * oldRows;
            valResolvedPage = Math.floor(firstItem / valResolvedRows) + 1;
            renderValidationTasks(); 
        });

        const valUnresolvedPrev = document.getElementById('val-unresolved-prev');
        const valUnresolvedNext = document.getElementById('val-unresolved-next');
        const valUnresolvedRowsSel = document.getElementById('val-unresolved-rows');

        if(valUnresolvedPrev) valUnresolvedPrev.addEventListener('click', () => { if(valUnresolvedPage > 1) { valUnresolvedPage--; renderValidationTasks(); } });
        if(valUnresolvedNext) valUnresolvedNext.addEventListener('click', () => { valUnresolvedPage++; renderValidationTasks(); });
        if(valUnresolvedRowsSel) valUnresolvedRowsSel.addEventListener('change', () => { 
            const oldRows = valUnresolvedRows;
            valUnresolvedRows = parseInt(valUnresolvedRowsSel.value); 
            const firstItem = (valUnresolvedPage - 1) * oldRows;
            valUnresolvedPage = Math.floor(firstItem / valUnresolvedRows) + 1;
            renderValidationTasks(); 
        });

        const valHistoryPrev = document.getElementById('val-history-prev');
        const valHistoryNext = document.getElementById('val-history-next');
        const valHistoryRowsSel = document.getElementById('val-history-rows');
        if(valHistoryPrev) valHistoryPrev.addEventListener('click', () => { if(valHistoryPage > 1) { valHistoryPage--; renderValidationTasks(); } });
        if(valHistoryNext) valHistoryNext.addEventListener('click', () => { valHistoryPage++; renderValidationTasks(); });
        if(valHistoryRowsSel) valHistoryRowsSel.addEventListener('change', () => { 
            const oldRows = valHistoryRows;
            valHistoryRows = parseInt(valHistoryRowsSel.value); 
            const firstItem = (valHistoryPage - 1) * oldRows;
            valHistoryPage = Math.floor(firstItem / valHistoryRows) + 1;
            renderValidationTasks(); 
        });

        function handleTaskAction(e) {
            const btn = e.target.closest('.icon-btn');
            if (!btn) return;

            if(btn.classList.contains('delete-task-btn')) {
                if(confirm('Delete this task?')) {
                    const id = btn.dataset.id;
                    let tasks = getValidationTasks();
                    tasks = tasks.filter(t => t.id !== id);
                    saveValidationTasks(tasks);
                    renderValidationTasks();
                    showToast('Task deleted');
                }
            } else if(btn.classList.contains('complete-task-btn')) {
                const id = btn.dataset.id;
                let tasks = getValidationTasks();
                const taskIndex = tasks.findIndex(t => t.id === id);
                if(taskIndex > -1) {
                    tasks[taskIndex].status = 'Completed';
                    tasks[taskIndex].completedAt = new Date().toISOString();
                    saveValidationTasks(tasks);
                    renderValidationTasks();
                    showToast('Task completed');
                }
            } else if(btn.classList.contains('mark-unresolved-btn')) {
                if(!confirm('Are you sure you want to mark this task as Unresolved?')) return;
                const id = btn.dataset.id;
                let tasks = getValidationTasks();
                const taskIndex = tasks.findIndex(t => t.id === id);
                if(taskIndex > -1) {
                    tasks[taskIndex].status = 'Unresolved';
                    tasks[taskIndex].unresolvedAt = new Date().toISOString();
                    saveValidationTasks(tasks);
                    renderValidationTasks();
                    showToast('Task marked as Unresolved');
                }
            } else if(btn.classList.contains('reopen-task-btn')) {
                const id = btn.dataset.id;
                let tasks = getValidationTasks();
                const taskIndex = tasks.findIndex(t => t.id === id);
                if(taskIndex > -1) {
                    tasks[taskIndex].status = 'Pending';
                    delete tasks[taskIndex].completedAt;
                    delete tasks[taskIndex].unresolvedAt;
                    saveValidationTasks(tasks);
                    renderValidationTasks();
                    showToast('Task reopened (Pending)');
                }
            }
        }

        if(pendingTasksTbody) {
            pendingTasksTbody.addEventListener('click', handleTaskAction);
            pendingTasksTbody.addEventListener('change', (e) => {
                if(e.target.classList.contains('task-validator-input')) {
                    const id = e.target.dataset.id;
                    const newValidator = e.target.value;
                    let tasks = getValidationTasks();
                    const taskIndex = tasks.findIndex(t => t.id === id);
                    if(taskIndex > -1) {
                        tasks[taskIndex].validator = newValidator;
                        saveValidationTasks(tasks);
                        renderValidationTasks();
                        renderValidatorsModal();
                        showToast(`Task assigned to ${newValidator}`);
                    }
                }
            });
        }
        const assignedTasksTbody = document.getElementById('assigned-tasks-tbody');
        if(assignedTasksTbody) {
            assignedTasksTbody.addEventListener('click', handleTaskAction);
            assignedTasksTbody.addEventListener('change', (e) => {
                if(e.target.classList.contains('task-validator-input')) {
                    const id = e.target.dataset.id;
                    const newValidator = e.target.value;
                    let tasks = getValidationTasks();
                    const taskIndex = tasks.findIndex(t => t.id === id);
                    if(taskIndex > -1) {
                        tasks[taskIndex].validator = newValidator;
                        saveValidationTasks(tasks);
                        renderValidationTasks();
                        renderValidatorsModal();
                        showToast(`Task assigned to ${newValidator}`);
                    }
                }
            });
        }
        if(resolvedTasksTbody) {
            resolvedTasksTbody.addEventListener('click', handleTaskAction);
            resolvedTasksTbody.addEventListener('change', (e) => {
                if(e.target.classList.contains('task-validator-input')) {
                    const id = e.target.dataset.id;
                    const newValidator = e.target.value;
                    if(confirm(`Reassign this resolved task to ${newValidator}? This will create a new task entry with reset duration.`)) {
                        let tasks = getValidationTasks();
                        const taskIndex = tasks.findIndex(t => t.id === id);
                        if(taskIndex > -1) {
                            const oldTask = tasks[taskIndex];
                            const newTask = {
                                ...oldTask,
                                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                                timestamp: new Date().toISOString(),
                                validator: newValidator,
                                status: 'Pending',
                                completedAt: undefined,
                                unresolvedAt: undefined,
                                reassignedTo: undefined,
                                reassignedAt: undefined
                            };
                            tasks.push(newTask);
                            oldTask.subStatus = 'Reassigned';
                            oldTask.reassignedTo = newValidator;
                            oldTask.reassignedAt = new Date().toISOString();
                            saveValidationTasks(tasks);
                            renderValidationTasks();
                            renderValidatorsModal();
                            showToast(`Resolved task reassigned to ${newValidator}`);
                        }
                    } else {
                        renderValidationTasks();
                    }
                }
            });
        }
        const unresolvedTasksTbody = document.getElementById('unresolved-tasks-tbody');
        if(unresolvedTasksTbody) {
            unresolvedTasksTbody.addEventListener('click', handleTaskAction);
            unresolvedTasksTbody.addEventListener('change', (e) => {
                if(e.target.classList.contains('task-validator-input')) {
                    const id = e.target.dataset.id;
                    const newValidator = e.target.value;
                    if(confirm(`Reassign this unresolved task to ${newValidator}? This will create a new task entry with reset duration.`)) {
                        let tasks = getValidationTasks();
                        const taskIndex = tasks.findIndex(t => t.id === id);
                        if(taskIndex > -1) {
                            const oldTask = tasks[taskIndex];
                            // Create new task
                            const newTask = {
                                ...oldTask,
                                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                                timestamp: new Date().toISOString(),
                                validator: newValidator,
                                status: 'Pending', // Will move to Assigned automatically
                                completedAt: undefined,
                                unresolvedAt: undefined,
                                reassignedTo: undefined,
                                reassignedAt: undefined
                            };
                            tasks.push(newTask);

                            // Update old task
                            oldTask.status = 'Unresolved';
                            oldTask.subStatus = 'Reassigned';
                            oldTask.reassignedTo = newValidator;
                            oldTask.reassignedAt = new Date().toISOString();
                            
                            saveValidationTasks(tasks);
                            renderValidationTasks();
                            renderValidatorsModal();
                            showToast(`Task reassigned to ${newValidator}`);
                        }
                    } else {
                        renderValidationTasks(); // Revert selection
                    }
                }
            });
        }
        const historyTasksTbody = document.getElementById('history-tasks-tbody');
        if(historyTasksTbody) historyTasksTbody.addEventListener('click', handleTaskAction);

        // Bulk Actions Logic for Validators
        function updateValBulkButtons() {
            const pCount = document.querySelectorAll('.pending-cb:checked').length;
            const aCount = document.querySelectorAll('.assigned-cb:checked').length;
            const rCount = document.querySelectorAll('.resolved-cb:checked').length;
            const uCount = document.querySelectorAll('.unresolved-cb:checked').length;
            const hCount = document.querySelectorAll('.history-cb:checked').length;
            
            const btn1 = document.getElementById('val-bulk-delete-btn-1');
            if(btn1) btn1.style.display = (pCount + aCount + rCount + uCount + hCount) > 0 ? 'inline-flex' : 'none';

            const btnAssign = document.getElementById('val-bulk-assign-btn-1');
            if(btnAssign) btnAssign.style.display = pCount > 0 ? 'inline-flex' : 'none';

            const btnReassign = document.getElementById('val-bulk-reassign-btn-1');
            if(btnReassign) btnReassign.style.display = uCount > 0 ? 'inline-flex' : 'none';
        }

        // Select All Listeners
        ['pending', 'assigned', 'resolved', 'unresolved', 'history'].forEach(type => {
            const cb = document.getElementById(`val-select-all-${type}`);
            if(cb) {
                cb.addEventListener('change', (e) => {
                    document.querySelectorAll(`.${type}-cb`).forEach(c => c.checked = e.target.checked);
                    updateValBulkButtons();
                });
            }
        });

        // Row Checkbox Listeners
        document.addEventListener('change', (e) => {
            if(e.target.classList.contains('val-row-checkbox')) updateValBulkButtons();
        });

        // Bulk Delete Handlers
        const handleBulkDelete = (selector) => {
            const selected = Array.from(document.querySelectorAll(selector + ':checked')).map(cb => cb.value);
            if(selected.length === 0) return;
            if(confirm(`Delete ${selected.length} tasks?`)) {
                let tasks = getValidationTasks();
                tasks = tasks.filter(t => !selected.includes(t.id));
                saveValidationTasks(tasks);
                renderValidationTasks();
                showToast(`${selected.length} tasks deleted`);
            }
        };

        const btnBulkDel1 = document.getElementById('val-bulk-delete-btn-1');
        if(btnBulkDel1) btnBulkDel1.addEventListener('click', () => handleBulkDelete('.pending-cb, .assigned-cb, .resolved-cb, .unresolved-cb, .history-cb'));

        const btnBulkAssign = document.getElementById('val-bulk-assign-btn-1');
        if(btnBulkAssign) {
            btnBulkAssign.addEventListener('click', () => {
                const selected = Array.from(document.querySelectorAll('.pending-cb:checked')).map(cb => cb.value);
                if(selected.length === 0) return;
                
                let attendanceData = getAttendanceData();
                const validators = attendanceData.filter(item => item.area === 'Validator' && !item.timeOut).map(v => v.name);
                const uniqueValidators = [...new Set(validators)].sort();
                
                const newValidator = prompt(`Assign ${selected.length} tasks to validator:\n(Available: ${uniqueValidators.join(', ')})`);
                if(!newValidator) return;

                if(confirm(`Confirm assigning ${selected.length} tasks to "${newValidator}"?`)) {
                    let tasks = getValidationTasks();
                    let count = 0;
                    selected.forEach(id => {
                        const taskIndex = tasks.findIndex(t => t.id === id);
                        if(taskIndex > -1) {
                            tasks[taskIndex].validator = newValidator;
                            count++;
                        }
                    });
                    saveValidationTasks(tasks);
                    renderValidationTasks();
                    renderValidatorsModal();
                    showToast(`${count} tasks assigned to ${newValidator}`);
                }
            });
        }

        const btnBulkReassign = document.getElementById('val-bulk-reassign-btn-1');
        if(btnBulkReassign) {
            btnBulkReassign.addEventListener('click', () => {
                const selected = Array.from(document.querySelectorAll('.unresolved-cb:checked')).map(cb => cb.value);
                if(selected.length === 0) return;
                
                const newValidator = prompt(`Reassign ${selected.length} tasks to validator:`);
                if(!newValidator) return;

                if(confirm(`Confirm reassigning ${selected.length} tasks to "${newValidator}"?`)) {
                    let tasks = getValidationTasks();
                    let count = 0;
                    
                    selected.forEach(id => {
                        const taskIndex = tasks.findIndex(t => t.id === id);
                        if(taskIndex > -1) {
                            const oldTask = tasks[taskIndex];
                            if(oldTask.status === 'Unresolved') {
                                const newTask = { ...oldTask, id: Date.now().toString() + Math.random().toString(36).substr(2, 5), timestamp: new Date().toISOString(), validator: newValidator, status: 'Pending', completedAt: undefined, unresolvedAt: undefined, reassignedTo: undefined, reassignedAt: undefined };
                                tasks.push(newTask);

                                oldTask.status = 'Unresolved';
                                oldTask.subStatus = 'Reassigned';
                                oldTask.reassignedTo = newValidator;
                                oldTask.reassignedAt = new Date().toISOString();
                                count++;
                            }
                        }
                    });
                    
                    saveValidationTasks(tasks);
                    renderValidationTasks();
                    renderValidatorsModal();
                    showToast(`${count} tasks reassigned to ${newValidator}`);
                }
            });
        }

        // Filter Inputs
        const filterInput1 = document.getElementById('val-filter-assigned-1');
        if(filterInput1) filterInput1.addEventListener('input', renderValidationTasks);
        const filterSku1 = document.getElementById('val-filter-sku-1');
        if(filterSku1) filterSku1.addEventListener('input', renderValidationTasks);
        const filterPriority1 = document.getElementById('val-filter-priority-1');
        if(filterPriority1) filterPriority1.addEventListener('change', renderValidationTasks);

        const clearFiltersBtn1 = document.getElementById('val-clear-filters-btn-1');
        if(clearFiltersBtn1) {
            clearFiltersBtn1.addEventListener('click', () => {
                if(document.getElementById('val-filter-sku-1')) document.getElementById('val-filter-sku-1').value = '';
                if(document.getElementById('val-filter-priority-1')) document.getElementById('val-filter-priority-1').value = '';
                if(document.getElementById('val-filter-assigned-1')) document.getElementById('val-filter-assigned-1').value = '';
                renderValidationTasks();
            });
        }

        // Export CSV
        const exportValCSV = () => {
            let tasks = getValidationTasks();
            
            // Apply Date Filter (Modal or Global)
            const valStart = document.getElementById('val-start-date');
            const valEnd = document.getElementById('val-end-date');
            const startStr = (valStart && valStart.value) || globalStartDate.value;
            const endStr = (valEnd && valEnd.value) || globalEndDate.value;

            if (startStr || endStr) {
                tasks = tasks.filter(t => {
                    const shiftInfo = getShiftFromTimestamp(t.timestamp);
                    return (!startStr || shiftInfo.date >= startStr) && (!endStr || shiftInfo.date <= endStr);
                });
            }
            
            // Sort by timestamp desc
            tasks.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            let dataToExport = [];
            let filename = 'validation_tasks.csv';
            
            // Determine which tab is active
                const isPendingTab = document.getElementById('tab-val-pending').style.display !== 'none';
                const isAssignedTab = document.getElementById('tab-val-assigned').style.display !== 'none';
                const isResolvedTab = document.getElementById('tab-val-resolved').style.display !== 'none';
                const isHistoryTab = document.getElementById('tab-val-history').style.display !== 'none';
                
                const skuFilter = document.getElementById('val-filter-sku-1').value.toLowerCase();
                const assignedFilter = document.getElementById('val-filter-assigned-1').value.toLowerCase();
                const priorityFilter = document.getElementById('val-filter-priority-1') ? document.getElementById('val-filter-priority-1').value : '';
                
                let filtered = tasks.filter(t => t.status !== 'Completed' && t.status !== 'Unresolved');
                if (skuFilter) filtered = filtered.filter(t => (t.sku || '').toLowerCase().includes(skuFilter));
                if (priorityFilter) filtered = filtered.filter(t => (t.priority || 'Normal') === priorityFilter);
                
                if (isPendingTab) {
                    dataToExport = filtered.filter(t => !t.validator || t.validator === 'Unassigned');
                    filename = 'pending_validation_tasks.csv';
                } else if (isAssignedTab) {
                    dataToExport = filtered.filter(t => t.validator && t.validator !== 'Unassigned');
                    if (assignedFilter) dataToExport = dataToExport.filter(t => (t.validator || '').toLowerCase().includes(assignedFilter));
                    filename = 'assigned_validation_tasks.csv';
                } else if (isResolvedTab) {
                    let filteredRes = tasks.filter(t => t.status === 'Completed');
                    if (skuFilter) filteredRes = filteredRes.filter(t => (t.sku || '').toLowerCase().includes(skuFilter));
                    if (assignedFilter) filteredRes = filteredRes.filter(t => (t.validator || '').toLowerCase().includes(assignedFilter));
                    if (priorityFilter) filteredRes = filteredRes.filter(t => (t.priority || 'Normal') === priorityFilter);
                    dataToExport = filteredRes;
                    filename = 'resolved_validation_tasks.csv';
                } else if (isHistoryTab) {
                    // Re-calculate history logic for export
                    const now = new Date();
                    let cutoff = new Date(now);
                    if (now.getHours() < 6) cutoff.setDate(cutoff.getDate() - 1);
                    cutoff.setHours(6, 0, 0, 0);
                    
                    let hist = tasks.filter(t => t.status === 'Reassigned' || (t.status === 'Completed' && new Date(t.completedAt || t.timestamp) < cutoff) || (t.status === 'Unresolved' && new Date(t.unresolvedAt || t.timestamp) < cutoff));
                    if (skuFilter) hist = hist.filter(t => (t.sku || '').toLowerCase().includes(skuFilter));
                    if (assignedFilter) hist = hist.filter(t => (t.validator || '').toLowerCase().includes(assignedFilter));
                    if (priorityFilter) hist = hist.filter(t => (t.priority || 'Normal') === priorityFilter);
                    dataToExport = hist;
                    filename = 'history_validation_tasks.csv';
                } else { // Unresolved
                    let filteredUnres = tasks.filter(t => t.status === 'Unresolved');
                    if (skuFilter) filteredUnres = filteredUnres.filter(t => (t.sku || '').toLowerCase().includes(skuFilter));
                    if (assignedFilter) filteredUnres = filteredUnres.filter(t => (t.validator || '').toLowerCase().includes(assignedFilter));
                    if (priorityFilter) filteredUnres = filteredUnres.filter(t => (t.priority || 'Normal') === priorityFilter);
                    dataToExport = filteredUnres;
                    filename = 'unresolved_validation_tasks.csv';
                }
            
            if (dataToExport.length === 0) { alert('No data to export'); return; }
            
           
            const headers = ['Date', 'SKU', 'Description', 'Qty', 'Reason', 'Ops Validator', 'IC Validator', 'Status', 'Completed At'];
            const csv = [headers.join(',')];
            
            dataToExport.forEach(t => {
                const date = new Date(t.timestamp).toLocaleString().replace(',', '');
                const completedAt = t.completedAt ? new Date(t.completedAt).toLocaleString().replace(',', '') : '';
                const row = [
                    `"${date}"`, `"${t.sku || ''}"`, `"${(t.desc || '').replace(/"/g, '""')}"`,
                    `"${t.qty || ''}"`, `"${(t.reason || '').replace(/"/g, '""')}"`,
                    `"${t.validator || ''}"`, `"${t.status || ''}"`, `"${completedAt}"`
                    `"${t.opsValidator || ''}"`, `"${t.validator || ''}"`, `"${t.status || ''}"`, `"${completedAt}"`
                ];
                csv.push(row.join(','));
            });
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        if(document.getElementById('val-export-btn-1')) document.getElementById('val-export-btn-1').addEventListener('click', () => exportValCSV());
        // Print buttons can just call window.print() or a specific print function, for now simple alert or print
        if(document.getElementById('val-print-btn-1')) document.getElementById('val-print-btn-1').addEventListener('click', () => window.print());

        // Tab switching for Validator View
        window.openValTab = function(evt, tabId) {
            const card = evt.target.closest('.card');
            const tabContents = card.querySelectorAll('.val-tab-content');
            tabContents.forEach(tc => tc.style.display = 'none');
            const tabBtns = card.querySelectorAll('.att-tab');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            const target = document.getElementById(tabId);
            if(target) target.style.display = 'flex';
            evt.target.classList.add('active');
        };

        // IC Master Logic
        const icMasterTemplateBtn = document.getElementById('ic-master-template-btn');
        const icMasterUploadBtn = document.getElementById('ic-master-upload-btn');
        const icMasterUploadFile = document.getElementById('ic-master-upload-file');

        if(icMasterTemplateBtn) {
            icMasterTemplateBtn.addEventListener('click', () => {
                const headers = ['User ID', 'Name', 'Role', 'Job Description'];
                const sample = ['A01', 'JOHN DOE', 'IC Support', 'Cycle Counter'];
                const csvContent = headers.join(',') + '\n' + sample.join(',');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'ic_master_template.csv';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });
        }

        if(icMasterUploadBtn) icMasterUploadBtn.addEventListener('click', () => icMasterUploadFile.click());

        if(icMasterUploadFile) {
            icMasterUploadFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                window.showLoading && window.showLoading();
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const text = ev.target.result;
                        const lines = text.split(/\r?\n/);
                        let users = [];
                        try { users = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
                        let count = 0;
                        // Skip header if present (simple check)
                        const startIdx = lines[0].toLowerCase().includes('user id') ? 1 : 0;
                        
                        for(let i=startIdx; i<lines.length; i++) {
                            const line = lines[i].trim();
                            if(!line) continue;
                            const parts = line.split(',').map(p => p.replace(/^"|"$/g, '').trim());
                            if(parts.length >= 2) {
                                const id = parts[0].toUpperCase();
                                const name = parts[1].toUpperCase();
                                const role = parts[2] || 'IC Support';
                                const job = parts[3] || '';
                                
                                const existingIdx = users.findIndex(u => u.userId === id);
                                if(existingIdx > -1) users[existingIdx] = { userId: id, name, role, jobDescription: job };
                                else users.push({ userId: id, name, role, jobDescription: job });
                                count++;
                            }
                        }
                        localStorage.setItem('ims_master_users_v1', JSON.stringify(users));
                        showToast(`Imported/Updated ${count} users.`);
                        renderIcMaster();
                        icMasterUploadFile.value = '';
                    } catch (err) {
                        showToast('Failed to import master list. Please check file format.', 'error');
                    } finally {
                        window.hideLoading && window.hideLoading();
                    }
                };
                reader.onerror = () => {
                    window.hideLoading && window.hideLoading();
                    showToast('Failed to read the file.', 'error');
                };
                reader.readAsText(file);
            });
        }

        function updateSkuMasterStatus() {
            const statusEl = document.getElementById('sku-master-status');
            if(!statusEl) return;
            let count = 0;
            try {
                const masterMap = JSON.parse(localStorage.getItem('ims_master_desc_v1') || '{}');
                count = Object.keys(masterMap).length;
            } catch(e) {}
            
            if(count > 0) {
                statusEl.textContent = `(Master List: ${count} items loaded)`;
                statusEl.style.color = '#2ecc71';
            } else {
                statusEl.textContent = '(No Master List loaded)';
                statusEl.style.color = '#e74c3c';
            }
        }

        // SKU Master Template & Clear
        const downloadSkuTemplateBtn = document.getElementById('download-sku-template-btn');
        const clearSkuMasterBtn = document.getElementById('clear-sku-master-btn');

        if(downloadSkuTemplateBtn) {
            downloadSkuTemplateBtn.addEventListener('click', () => {
                const headers = ['Item Code', 'Description'];
                const sample = ['10000001', 'Sample Item Description'];
                const csvContent = headers.join(',') + '\n' + sample.join(',');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sku_master_template.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        if(clearSkuMasterBtn) {
            clearSkuMasterBtn.addEventListener('click', () => {
                if(confirm('Are you sure you want to clear the SKU Master List?')) {
                    localStorage.removeItem('ims_master_desc_v1');
                    showToast('SKU Master List cleared.');
                    updateSkuMasterStatus();
                }
            });
        }

        if(uploadSkuBtn) uploadSkuBtn.addEventListener('click', () => uploadSkuFile.click());

        if(uploadSkuFile) {
            uploadSkuFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                window.showLoading && window.showLoading();
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        let text = ev.target.result;
                        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
                        const lines = text.split(/\r\n|\n/);
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
                        
                        let skuIdx = headers.indexOf('item code');
                        if (skuIdx === -1) skuIdx = headers.indexOf('sku');
                        const descIdx = headers.indexOf('description');
                        
                        if(skuIdx === -1 || descIdx === -1) {
                            showToast('CSV must contain "Item Code" (or "SKU") and "Description" columns.', 'error');
                            window.hideLoading && window.hideLoading();
                            return;
                        }

                        let masterMap = {};
                        try { masterMap = JSON.parse(localStorage.getItem('ims_master_desc_v1') || '{}'); } catch(e) {}
                        
                        let count = 0;
                        for(let i=1; i<lines.length; i++) {
                            if(!lines[i].trim()) continue;
                            const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
                            const sku = cols[skuIdx];
                            const desc = cols[descIdx];
                            
                            if(sku) {
                                masterMap[sku] = desc || '';
                                count++;
                            }
                        }
                        localStorage.setItem('ims_master_desc_v1', JSON.stringify(masterMap));
                        showToast(`SKU Master List updated with ${count} items.`);
                        updateSkuMasterStatus();
                        uploadSkuFile.value = '';
                    } catch (err) {
                        showToast('Failed to import SKU master list. Please check file format.', 'error');
                    } finally {
                        window.hideLoading && window.hideLoading();
                    }
                };
                reader.onerror = () => {
                    window.hideLoading && window.hideLoading();
                    showToast('Failed to read the file.', 'error');
                };
                reader.readAsText(file);
            });
        }

        // Bulk Task Assignment
        const downloadTaskTemplateBtn = document.getElementById('download-task-template-btn');
        const uploadBulkTasksBtn = document.getElementById('upload-bulk-tasks-btn');
        const uploadBulkTasksFile = document.getElementById('upload-bulk-tasks-file');

        if(downloadTaskTemplateBtn) {
            downloadTaskTemplateBtn.addEventListener('click', () => {
                
                const headers = ['SKU', 'Description', 'Qty', 'Reason', 'Priority', 'Ops Validator', 'IC Validator'];
                const sample = ['10000001', 'Sample Item', '10', 'Variance Check', 'Normal', 'Jane Ops', 'John Doe'];
                const csvContent = headers.join(',') + '\n' + sample.join(',');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bulk_task_template.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        if(uploadBulkTasksBtn && uploadBulkTasksFile) {
            uploadBulkTasksBtn.addEventListener('click', () => uploadBulkTasksFile.click());

            uploadBulkTasksFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                window.showLoading && window.showLoading();
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        let text = ev.target.result;
                        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
                        const lines = text.split(/\r\n|\n/);
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
                        
                        const skuIdx = headers.indexOf('sku');
                        const descIdx = headers.indexOf('description');
                        const qtyIdx = headers.indexOf('qty');
                        const reasonIdx = headers.indexOf('reason');
                        let valIdx = headers.indexOf('validator');
                        if (valIdx === -1) valIdx = headers.indexOf('ic validator');
                        const prioIdx = headers.indexOf('priority');
                        const opsValIdx = headers.indexOf('ops validator');
                        
                        if(skuIdx === -1 || qtyIdx === -1) {
                            showToast('CSV must contain "SKU" and "Qty" columns.', 'error');
                            window.hideLoading && window.hideLoading();
                            return;
                        }

                        const tasks = getValidationTasks();
                        let count = 0;
                        
                        // Get SKU Master for description lookup if missing
                        let masterMap = {};
                        try { masterMap = JSON.parse(localStorage.getItem('ims_master_desc_v1') || '{}'); } catch(e) {}

                        for(let i=1; i<lines.length; i++) {
                            if(!lines[i].trim()) continue;
                            // Simple CSV split
                            const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
                            
                            const sku = cols[skuIdx];
                            const qty = cols[qtyIdx];
                            let desc = (descIdx > -1) ? cols[descIdx] : '';
                            const reason = (reasonIdx > -1) ? cols[reasonIdx] : '';
                            const validator = (valIdx > -1) ? cols[valIdx] : '';
                            const priority = (prioIdx > -1) ? cols[prioIdx] : 'Normal';
                            const opsValidator = (opsValIdx > -1) ? cols[opsValIdx] : '';
                            
                            if(sku && qty) {
                                if(!desc && masterMap[sku]) desc = masterMap[sku];
                                
                                tasks.push({
                                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                                    timestamp: new Date().toISOString(),
                                    sku: sku,
                                    desc: desc,
                                    qty: qty,
                                    reason: reason,
                                    priority: priority || 'Normal',
                                    validator: validator || 'Unassigned',
                                    opsValidator: opsValidator || '',
                                    status: 'Pending'
                                });
                                count++;
                            }
                        }
                        saveValidationTasks(tasks);
                        renderValidationTasks();
                        showToast(`${count} tasks assigned.`);
                        uploadBulkTasksFile.value = '';
                    } catch (err) {
                        showToast('Failed to import tasks. Please check file format.', 'error');
                    } finally {
                        window.hideLoading && window.hideLoading();
                    }
                };
                reader.onerror = () => {
                    window.hideLoading && window.hideLoading();
                    showToast('Failed to read the file.', 'error');
                };
                reader.readAsText(file);
            });
        }

        const clearValTasksBtn = document.getElementById('clear-val-tasks-btn');
        if(clearValTasksBtn) {
            clearValTasksBtn.addEventListener('click', () => {
                const dateVal = document.getElementById('val-view-date').value;
                let msg = 'Are you sure you want to clear ALL validation tasks? This cannot be undone.';
                if (dateVal) {
                    msg = `Are you sure you want to clear validation tasks for ${dateVal}? This cannot be undone.`;
                }
                
                if(confirm(msg)) {
                    let tasks = getValidationTasks();
                    if (dateVal) tasks = tasks.filter(t => !t.timestamp.startsWith(dateVal));
                    else tasks = [];
                    saveValidationTasks(tasks);
                    renderValidationTasks();
                    renderValidatorsModal();
                    showToast('Validation tasks cleared.');
                }
            });
        }

        // Reset All Validation Tasks (Supervisor)
        const resetAllValBtn = document.getElementById('reset-all-val-btn');
        if (resetAllValBtn) {
            resetAllValBtn.addEventListener('click', () => {
                const tasks = getValidationTasks();
                if (tasks.length === 0) { alert('No tasks to reset.'); return; }
                
                showSupervisorDeleteModal(tasks.length, () => {
                    saveValidationTasks([]);
                    renderValidationTasks();
                    renderValidatorsModal();
                    showToast('All validation tasks reset.');
                });
            });
        }

        // Reset Validation Tasks By Date/Shift (Supervisor)
        const resetValDateBtn = document.getElementById('reset-val-date-btn');
        const resetValOptionsModal = document.getElementById('reset-val-options-modal');
        const confirmResetValDateBtn = document.getElementById('confirm-reset-val-date-btn');

        if (resetValDateBtn) {
            resetValDateBtn.addEventListener('click', () => {
                if (resetValOptionsModal) {
                    document.getElementById('reset-val-date').value = new Date().toISOString().split('T')[0];
                    resetValOptionsModal.classList.remove('hidden');
                }
            });
        }

        if (confirmResetValDateBtn) {
            confirmResetValDateBtn.addEventListener('click', () => {
                const dateVal = document.getElementById('reset-val-date').value;
                const shiftVal = document.getElementById('reset-val-shift').value;
                
                if (!dateVal) { alert('Please select a date.'); return; }
                
                const tasks = getValidationTasks();
                const tasksToDelete = tasks.filter(t => {
                    const info = getShiftFromTimestamp(t.timestamp);
                    if (info.date !== dateVal) return false;
                    if (shiftVal !== 'All' && !info.shift.includes(shiftVal)) return false;
                    return true;
                });
                
                if (tasksToDelete.length === 0) { alert('No tasks found for selected date/shift.'); return; }
                
                resetValOptionsModal.classList.add('hidden');
                
                showSupervisorDeleteModal(tasksToDelete.length, () => {
                    const newTasks = tasks.filter(t => {
                        const info = getShiftFromTimestamp(t.timestamp);
                        if (info.date !== dateVal) return true;
                        if (shiftVal !== 'All' && !info.shift.includes(shiftVal)) return true;
                        return false;
                    });
                    saveValidationTasks(newTasks);
                    renderValidationTasks();
                    renderValidatorsModal();
                    showToast(`Reset ${tasksToDelete.length} tasks.`);
                });
            });
        }

        // Email Validator Status Report
        const emailValReportBtn = document.getElementById('email-val-report-btn');
        if (emailValReportBtn) {
            emailValReportBtn.addEventListener('click', () => {
                const tasks = getValidationTasks();
                let filteredTasks = tasks;
                const valStart = document.getElementById('val-start-date');
                const valEnd = document.getElementById('val-end-date');
                const startStr = (valStart && valStart.value) || document.getElementById('global-start-date').value;
                const endStr = (valEnd && valEnd.value) || document.getElementById('global-end-date').value;
                const shiftFilter = document.getElementById('val-view-shift') ? document.getElementById('val-view-shift').value : '';
                
                if (startStr || endStr || shiftFilter) {
                    filteredTasks = tasks.filter(t => {
                        const shiftInfo = getShiftFromTimestamp(t.timestamp);
                        const dateMatch = (!startStr || shiftInfo.date >= startStr) && (!endStr || shiftInfo.date <= endStr);
                        const shiftMatch = !shiftFilter || shiftInfo.shift.includes(shiftFilter);
                        return dateMatch && shiftMatch;
                    });
                }
                
                const total = filteredTasks.length;
                const resolved = filteredTasks.filter(t => t.status === 'Completed').length;
                const unresolved = filteredTasks.filter(t => t.status === 'Unresolved').length;
                const pending = filteredTasks.filter(t => t.status !== 'Completed' && t.status !== 'Unresolved' && (!t.validator || t.validator === 'Unassigned')).length;
                const assigned = filteredTasks.filter(t => t.status !== 'Completed' && t.status !== 'Unresolved' && t.validator && t.validator !== 'Unassigned').length;
                const completionRate = total > 0 ? Math.round(((resolved + unresolved) / total) * 100) : 0;
                
                const dateRange = (startStr || endStr) ? `(${startStr || 'Start'} to ${endStr || 'End'})` : (shiftFilter ? `(${shiftFilter})` : 'All Time');
                
                let body = `Validator Status Report ${dateRange}\n\n`;
                body += `Summary:\n`;
                body += `Total Tasks: ${total}\n`;
                body += `Resolved: ${resolved}\n`;
                body += `Unresolved: ${unresolved}\n`;
                body += `Pending: ${pending}\n`;
                body += `Assigned: ${assigned}\n`;
                body += `Completion Rate: ${completionRate}%\n\n`;
                
                const recipient = prompt('Enter recipient email (optional):', localStorage.getItem('ims_val_email_recipient') || '');
                if (recipient !== null) {
                    localStorage.setItem('ims_val_email_recipient', recipient);
                    const subject = `Validator Status Report - ${new Date().toLocaleDateString()}`;
                    window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                }
            });
        }

        if(assignSku && assignDesc){
            assignSku.addEventListener('input', () => {
                const code = assignSku.value.trim();
                try {
                    const masterMap = JSON.parse(localStorage.getItem('ims_master_desc_v1') || '{}');
                    if(masterMap[code]) assignDesc.value = masterMap[code];
                    else assignDesc.value = '';
                } catch(e) {}
            });
        }

        if(assignReason && document.getElementById('assign-expiry-container')) {
            assignReason.addEventListener('change', () => {
                const val = assignReason.value;
                const container = document.getElementById('assign-expiry-container');
                if(val === 'Expired' || val === 'Near Expiry') {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                    if(assignExpiry) assignExpiry.value = '';
                }
            });
        }

        if(btnAssignTask) {
            btnAssignTask.addEventListener('click', () => {
                const sku = assignSku.value.trim();
                const qty = assignQty.value.trim();
                const reason = assignReason.value.trim();
                const priority = assignPriority ? assignPriority.value : 'Normal';
                const opsVal = assignOpsValidator ? assignOpsValidator.value : '';
                
                if(!sku || !qty) { showToast('Please fill in SKU and Qty.', 'error'); return; }
                if(!reason) { showToast('Please select a Reason.', 'error'); return; }

                if ((reason === 'Expired' || reason === 'Near Expiry') && (!assignExpiry || !assignExpiry.value)) {
                    showToast('Please enter Expiry Date.', 'error');
                    return;
                }
                
                // Validate SKU against Master List
                let masterMap = {};
                try { masterMap = JSON.parse(localStorage.getItem('ims_master_desc_v1') || '{}'); } catch(e) {}
                
                if (Object.keys(masterMap).length > 0 && !masterMap[sku]) {
                    showToast('Invalid SKU: Not found in Master List.', 'error');
                    return;
                }
                
                // Check for duplicates within the same day
                const tasks = getValidationTasks();
                const today = new Date().toISOString().split('T')[0]; // "YYYY-MM-DD"
                const isDuplicate = tasks.some(task => {
                    const taskDate = new Date(task.timestamp).toISOString().split('T')[0];
                    return task.sku === sku && taskDate === today;
                });

                if (isDuplicate) {
                    showToast(`SKU ${sku} has already been added for validation today.`, 'error');
                    return;
                }

                const newTask = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    sku: sku,
                    desc: assignDesc.value,
                    qty: qty,
                    reason: reason,
                    priority: priority,
                    expiryDate: assignExpiry ? assignExpiry.value : '',
                    validator: assignValidator.value || 'Unassigned',
                    opsValidator: opsVal,
                    status: 'Pending'
                };
                tasks.push(newTask);
                saveValidationTasks(tasks);
                renderValidationTasks();
                showToast('Task successfully assigned!');
                
                if(assignPriority) assignPriority.value = 'Normal';
                assignSku.value = ''; assignDesc.value = ''; assignQty.value = ''; assignReason.value = ''; assignValidator.value = '';
                if(assignOpsValidator) assignOpsValidator.value = '';
                if(assignExpiry) assignExpiry.value = '';
                if(document.getElementById('assign-expiry-container')) document.getElementById('assign-expiry-container').style.display = 'none';
            });
        }

        if (validatorsViewBtn) {
            validatorsViewBtn.addEventListener('click', () => {
                if (validatorsModal) {
                    const valStart = document.getElementById('val-start-date');
                    const valEnd = document.getElementById('val-end-date');
                    
                    if(valStart && valEnd && globalStartDate && globalEndDate) {
                        if(valStart.value || valEnd.value) {
                            globalStartDate.value = valStart.value;
                            globalEndDate.value = valEnd.value;
                        } else {
                            valStart.value = globalStartDate.value;
                            valEnd.value = globalEndDate.value;
                        }
                    }
                    
                    validatorsModal.classList.remove('hidden');
                    renderValidatorsModal();
                    renderValidationTasks();
                    updateSkuMasterStatus();
                }
            });
        }

        const valDateFilterBtn = document.getElementById('val-date-filter-btn');
        const valStartDate = document.getElementById('val-start-date');
        const valEndDate = document.getElementById('val-end-date');
        
        const syncValDates = () => {
            if(globalStartDate && valStartDate) globalStartDate.value = valStartDate.value;
            if(globalEndDate && valEndDate) globalEndDate.value = valEndDate.value;
            renderValidatorsModal();
            renderValidationTasks();
            renderAttendanceTable();
        };

        if(valDateFilterBtn) valDateFilterBtn.addEventListener('click', syncValDates);
        if(valStartDate) valStartDate.addEventListener('change', syncValDates);
        if(valEndDate) valEndDate.addEventListener('change', syncValDates);

        const valViewShift = document.getElementById('val-view-shift');
        if(valViewShift) {
            valViewShift.addEventListener('change', () => {
                renderValidatorsModal();
                renderValidationTasks();
            });
        }

        const valClearDateBtn = document.getElementById('val-clear-date-btn');
        if(valClearDateBtn) {
            valClearDateBtn.addEventListener('click', () => {
                if(valStartDate) valStartDate.value = '';
                if(valEndDate) valEndDate.value = '';
                if(valViewShift) valViewShift.value = '';
                syncValDates();
            });
        }

        if (validatorsSearch) {
            validatorsSearch.addEventListener('input', renderValidatorsModal);
        }

        if(icMasterBtn) {
            icMasterBtn.addEventListener('click', () => {
                icMasterModal.classList.remove('hidden');
                renderIcMaster();
            });
        }

        if(icMasterSearch) {
            icMasterSearch.addEventListener('input', () => {
                icMasterPage = 1;
                renderIcMaster();
            });
        }

        // Quick Time In Logic
        const quickTimeInBtn = document.getElementById('quick-time-in-btn');
        const quickUserIdInput = document.getElementById('quick-user-id');
        const quickUserNameInput = document.getElementById('quick-user-name');
        const quickUserRoleInput = document.getElementById('quick-user-role');
        const quickClearBtn = document.getElementById('quick-clear-btn');
        const manualAddBtn = document.getElementById('manual-add-btn');

        if (manualAddBtn) {
            manualAddBtn.addEventListener('click', () => {
                if(addAttBtn) addAttBtn.click();
            });
        }

        if (quickTimeInBtn && quickUserIdInput) {
            quickUserIdInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') quickTimeInBtn.click();
            });

            if(quickClearBtn) {
                quickClearBtn.addEventListener('click', () => {
                    quickUserIdInput.value = '';
                    if(quickUserNameInput) quickUserNameInput.value = '';
                    if(quickUserRoleInput) quickUserRoleInput.value = '';
                    quickUserIdInput.focus();
                });
            }

            // Update Clock
            function updateQuickClock() {
                const el = document.getElementById('quick-widget-clock');
                if(el) el.textContent = new Date().toLocaleString();
            }
            setInterval(updateQuickClock, 1000);
            updateQuickClock();

            // Auto-populate Name/Role
            quickUserIdInput.addEventListener('input', () => {
                const val = quickUserIdInput.value.trim().toUpperCase();
                if (val) {
                    let masterUsers = [];
                    try { masterUsers = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
                    const user = masterUsers.find(u => u.userId === val);
                    if (user) {
                        if(quickUserNameInput) quickUserNameInput.value = user.name || '';
                        if(quickUserRoleInput) quickUserRoleInput.value = user.role || '';
                    } else {
                        if(quickUserNameInput) quickUserNameInput.value = '';
                        if(quickUserRoleInput) quickUserRoleInput.value = '';
                    }
                } else {
                    if(quickUserNameInput) quickUserNameInput.value = '';
                    if(quickUserRoleInput) quickUserRoleInput.value = '';
                }
            });

            quickTimeInBtn.addEventListener('click', () => {
                const userId = quickUserIdInput.value.trim().toUpperCase();
                if (!userId) { showToast('Please enter User ID'); return; }

                let masterUsers = [];
                try { masterUsers = JSON.parse(localStorage.getItem('ims_master_users_v1') || '[]'); } catch(e) {}
                const user = masterUsers.find(u => u.userId === userId);

                if (!user) {
                    alert(`User ID ${userId} not found in IC Master List.`);
                    return;
                }

                const now = new Date();
                const shiftInfo = getShiftFromTimestamp(now.getTime());
                const date = shiftInfo.date;
                const shift = shiftInfo.shift;
                const timeIn = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});

                const attendance = getAttendanceData();
                const exists = attendance.find(a => a.date === date && a.shift === shift && a.userId === userId);

                if (exists) {
                    alert(`User ${user.name} is already timed in for ${shift} on ${date}.`);
                    quickUserIdInput.value = '';
                    return;
                }

                const newEntry = {
                    id: Date.now().toString(),
                    date: date,
                    shift: shift,
                    userId: user.userId,
                    name: user.name,
                    role: user.role || 'IC Support',
                    area: user.jobDescription || '', // Auto-fill Job Description from master
                    timeIn: timeIn,
                    breakOut: '',
                    breakIn: '',
                    timeOut: '',
                    status: 'Full-time',
                    notes: 'Quick Time In'
                };

                attendance.push(newEntry);
                saveAttendanceData(attendance);
                
                showToast(`Timed in: ${user.name}`);
                quickUserIdInput.value = '';
                if(quickUserNameInput) quickUserNameInput.value = '';
                if(quickUserRoleInput) quickUserRoleInput.value = '';
                
                renderAttendanceTable();
                if(flipContainer.classList.contains('flipped')) renderSubRoleDashboard();
            });
            
            // Make Widget Draggable
            const quickWidget = document.getElementById('quick-time-in-widget');
            const quickHeader = document.getElementById('quick-widget-header');
            if(quickWidget && quickHeader) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                quickHeader.onmousedown = dragMouseDown;

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    quickWidget.style.top = (quickWidget.offsetTop - pos2) + "px";
                    quickWidget.style.left = (quickWidget.offsetLeft - pos1) + "px";
                    quickWidget.style.bottom = "auto"; 
                    quickWidget.style.right = "auto";
                }

                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }
        }

        // Helper for click interaction
        window.filterByAnalysis = function(role, shift) {
             // Apply Shift Filter
             const shiftTab = document.querySelector(`.att-tab[data-shift="${shift}"]`);
             if(shiftTab) shiftTab.click();
             
             // Apply Sub Role Filter (Multi-select)
             const checkboxes = document.querySelectorAll('.att-area-cb');
             let matched = false;
             checkboxes.forEach(cb => {
                 cb.checked = (cb.value === role);
                 if(cb.checked) matched = true;
             });
             
             // Update Dropdown Text
             const areaText = document.getElementById('att-filter-area-text');
             if(areaText) areaText.textContent = matched ? role : 'All Job Descriptions';
             
             // Trigger Render
             renderAttendanceTable();
             
             // Flip back to table
             const flipContainer = document.getElementById('attendance-flip-container');
             if(flipContainer) flipContainer.classList.remove('flipped');
        }

        // Event Listeners for Filters
        if (applyGlobalFilterBtn) applyGlobalFilterBtn.addEventListener('click', renderAttendanceTable);
        if (clearGlobalFilterBtn) clearGlobalFilterBtn.addEventListener('click', () => { globalStartDate.value = ''; globalEndDate.value = ''; renderAttendanceTable(); });
        if (attSearchInput) attSearchInput.addEventListener('input', renderAttendanceTable);
        if (document.getElementById('att-filter-status')) document.getElementById('att-filter-status').addEventListener('change', renderAttendanceTable);
        if (attFilterRole) attFilterRole.addEventListener('change', renderAttendanceTable);
        
        // Sub Role Multi-Select Logic
        const areaBtn = document.getElementById('att-filter-area-btn');
        const areaDropdown = document.getElementById('att-filter-area-dropdown');
        const areaApplyBtn = document.getElementById('att-filter-area-apply');
        const areaClearBtn = document.getElementById('att-filter-area-clear');
        const areaText = document.getElementById('att-filter-area-text');

        if(areaBtn && areaDropdown) {
            areaBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                areaDropdown.style.display = areaDropdown.style.display === 'block' ? 'none' : 'block';
            });
            
            document.addEventListener('click', (e) => {
                if (!areaBtn.contains(e.target) && !areaDropdown.contains(e.target)) {
                    areaDropdown.style.display = 'none';
                }
            });

            areaApplyBtn.addEventListener('click', () => {
                const checked = Array.from(document.querySelectorAll('.att-area-cb:checked')).map(cb => cb.value);
                areaText.textContent = checked.length === 0 ? 'All Job Descriptions' : (checked.length <= 2 ? checked.join(', ') : `${checked.length} Selected`);
                areaDropdown.style.display = 'none';
                renderAttendanceTable();
            });

            areaClearBtn.addEventListener('click', () => {
                document.querySelectorAll('.att-area-cb').forEach(cb => cb.checked = false);
                areaText.textContent = 'All Job Descriptions';
                areaDropdown.style.display = 'none';
                renderAttendanceTable();
            });
        }

        // Flip Card Listeners
        if(viewChartBtn && flipContainer) {
            viewChartBtn.addEventListener('click', () => {
                flipContainer.classList.add('flipped');
                renderSubRoleDashboard();
            });
        }
        if(viewTableBtn && flipContainer) {
            viewTableBtn.addEventListener('click', () => flipContainer.classList.remove('flipped'));
        }
        
        // Tab Listeners
        document.querySelectorAll('.att-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.att-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentShiftFilter = tab.dataset.shift;
                renderAttendanceTable();
            });
        });

        // Attendance Sorting Listeners
        document.querySelectorAll('#attendance-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (attSortField === field) {
                    attSortDirection = attSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    attSortField = field;
                    attSortDirection = 'asc';
                }
                renderAttendanceTable();
            });
        });

        // Pagination Listeners
        const attPaginationControls = document.getElementById('att-pagination-controls');
        if (attPaginationControls) {
            attPaginationControls.addEventListener('click', (e) => {
                if (e.target.id === 'att-prev-page' && !e.target.disabled) {
                    attCurrentPage--;
                    renderAttendanceTable();
                } else if (e.target.id === 'att-next-page' && !e.target.disabled) {
                    attCurrentPage++;
                    renderAttendanceTable();
                }
            });
            const attRowsPerPageSelect = document.getElementById('att-rows-per-page');
            if (attRowsPerPageSelect) {
                attRowsPerPageSelect.addEventListener('change', () => {
                    const oldPerPage = attItemsPerPage;
                    const newPerPage = parseInt(attRowsPerPageSelect.value, 10);
                    const firstItem = (attCurrentPage - 1) * oldPerPage;
                    attCurrentPage = Math.floor(firstItem / newPerPage) + 1;
                    renderAttendanceTable();
                });
            }
        }

        // Modal Close
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                if (modal) modal.classList.add('hidden');
            });
        });
        
        // Set Current Time Button
        if (attModal) {
            attModal.addEventListener('click', (e) => {
                const btn = e.target.closest('.set-current-time');
                if (btn) {
                    const targetId = btn.dataset.target;
                    const targetInput = document.getElementById(targetId);
                    if (targetInput) {
                        const now = new Date();
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        targetInput.value = `${hours}:${minutes}`;
                    }
                }
            });
        }

        // Auto Refresh
        setInterval(() => {
            const check = document.getElementById('auto-refresh-check');
            if(check && check.checked) {
                if(document.querySelector('.modal:not(.hidden)')) return;
                renderAttendanceTable(); // This calls updateLiveStatusCards
            } else {
                // If table isn't refreshing, refresh the cards independently
                updateLiveStatusCards();
            }
        }, 15000);

        // Auto Refresh Validators View (5s)
        setInterval(() => {
            const valModal = document.getElementById('validators-modal');
            if (valModal && !valModal.classList.contains('hidden')) {
                if (document.activeElement && valModal.contains(document.activeElement) && 
                   (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT' || document.activeElement.tagName === 'TEXTAREA')) {
                    return;
                }
                renderValidatorsModal();
                renderValidationTasks();
            }
        }, 5000);

        // Floating Widget Logic
        const addTaskWidget = document.getElementById('add-task-widget');
        const toggleAddTaskBtn = document.getElementById('toggle-add-task-widget-btn');
        const fabAddTaskBtn = document.getElementById('fab-add-task-btn');
        const mainAssignTaskBtn = document.getElementById('main-assign-task-btn');
        const closeWidgetBtn = document.querySelector('.close-widget-btn');
        const widgetHeader = document.getElementById('add-task-header');

        if(toggleAddTaskBtn && addTaskWidget) {
            toggleAddTaskBtn.addEventListener('click', () => {
                addTaskWidget.classList.toggle('hidden');
                if (!addTaskWidget.classList.contains('hidden')) updateOpsValidatorDropdown();
            });
        }
        if(fabAddTaskBtn && addTaskWidget) {
            fabAddTaskBtn.addEventListener('click', () => {
                addTaskWidget.classList.toggle('hidden');
                if (!addTaskWidget.classList.contains('hidden')) updateOpsValidatorDropdown();
            });
        }
        if(mainAssignTaskBtn && addTaskWidget) {
            mainAssignTaskBtn.addEventListener('click', () => {
                addTaskWidget.classList.remove('hidden');
                const input = document.getElementById('assign-sku');
                if (input) input.focus();
                updateOpsValidatorDropdown();
            });
        }
        if(closeWidgetBtn && addTaskWidget) {
            closeWidgetBtn.addEventListener('click', () => {
                addTaskWidget.classList.add('hidden');
            });
        }

        
        document.addEventListener('keydown', (e) => {
            if (e.altKey && (e.key === 'n' || e.key === 'N')) {
                e.preventDefault();
                const widget = document.getElementById('add-task-widget');
                if (widget) {
                    widget.classList.toggle('hidden');
                    if (!widget.classList.contains('hidden')) {
                        const input = document.getElementById('assign-sku');
                        if (input) input.focus();
                    }
                }
            }
        });

        // Global Search Preview Logic
        const valGlobalSearchInput = document.getElementById('val-global-search');
        const valSearchPreview = document.getElementById('val-search-preview');

        if (valGlobalSearchInput && valSearchPreview) {
            valGlobalSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();
                if (!query) {
                    valSearchPreview.style.display = 'none';
                    renderValidationTasks();
                    return;
                }

                // Get current view tasks (filtered by date)
                let tasks = getValidationTasks();
                const valStart = document.getElementById('val-start-date');
                const valEnd = document.getElementById('val-end-date');
                const startStr = (valStart && valStart.value) || globalStartDate.value;
                const endStr = (valEnd && valEnd.value) || globalEndDate.value;

                if (startStr || endStr) {
                    tasks = tasks.filter(t => {
                        const shiftInfo = getShiftFromTimestamp(t.timestamp);
                        return (!startStr || shiftInfo.date >= startStr) && (!endStr || shiftInfo.date <= endStr);
                    });
                }

                const matches = tasks.filter(t => 
                    (t.sku || '').toLowerCase().includes(query) ||
                    (t.desc || '').toLowerCase().includes(query) ||
                    (t.validator || '').toLowerCase().includes(query)
                ).slice(0, 10);

                if (matches.length > 0) {
                    valSearchPreview.innerHTML = '';
                    matches.forEach(t => {
                        const div = document.createElement('div');
                        div.className = 'search-preview-item';
                        div.innerHTML = `<div style="font-weight:bold; font-size:12px;">${t.sku}</div><div style="color:#666; font-size:11px;">${t.desc || 'No Desc'}</div><div style="font-size:10px; color:#999;">${t.validator || 'Unassigned'} • ${t.status}</div>`;
                        div.addEventListener('click', () => {
                            valGlobalSearchInput.value = t.sku;
                            valSearchPreview.style.display = 'none';
                            renderValidationTasks();
                        });
                        valSearchPreview.appendChild(div);
                    });
                    valSearchPreview.style.display = 'block';
                } else {
                    valSearchPreview.style.display = 'none';
                }
                renderValidationTasks();
            });
            document.addEventListener('click', (e) => { if (!valGlobalSearchInput.contains(e.target) && !valSearchPreview.contains(e.target)) valSearchPreview.style.display = 'none'; });
        }

        // Drag Logic
        if(addTaskWidget && widgetHeader) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            widgetHeader.onmousedown = dragMouseDown;
            function dragMouseDown(e) {
                e = e || window.event; e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = closeDragElement; document.onmousemove = elementDrag;
            }
            function elementDrag(e) {
                e = e || window.event; e.preventDefault();
                pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                pos3 = e.clientX; pos4 = e.clientY;
                addTaskWidget.style.top = (addTaskWidget.offsetTop - pos2) + "px";
                addTaskWidget.style.left = (addTaskWidget.offsetLeft - pos1) + "px";
            }
            function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
        }

        // Initial Render
        // Set default date filter to current operational day (6am-6am cycle)
        const currentOpDate = getShiftFromTimestamp(new Date()).date;
        if (globalStartDate) globalStartDate.value = currentOpDate;
        if (globalEndDate) globalEndDate.value = currentOpDate;

        renderAttendanceTable();

        // Modal Search Logic
        const modalSearch = document.getElementById('modal-user-search');
        if(modalSearch) {
            modalSearch.addEventListener('input', () => {
                modalCurrentPage = 1;
                renderModalTable();
            });
        }
        
        const modalPrevBtn = document.getElementById('modal-prev-page');
        const modalNextBtn = document.getElementById('modal-next-page');
        const modalRowsSelect = document.getElementById('modal-rows-per-page');

        if(modalPrevBtn) modalPrevBtn.addEventListener('click', () => {
            if(modalCurrentPage > 1) { modalCurrentPage--; renderModalTable(); }
        });
        if(modalNextBtn) modalNextBtn.addEventListener('click', () => {
            modalCurrentPage++; renderModalTable();
        });
        if(modalRowsSelect) modalRowsSelect.addEventListener('change', () => {
            const oldRows = modalRowsPerPage;
            modalRowsPerPage = parseInt(modalRowsSelect.value);
            const firstItem = (modalCurrentPage - 1) * oldRows;
            modalCurrentPage = Math.floor(firstItem / modalRowsPerPage) + 1;
            renderModalTable();
        });

        const modalTbody = document.getElementById('active-users-tbody');
        if(modalTbody) {
            modalTbody.addEventListener('change', (e) => {
                if(e.target.classList.contains('modal-row-checkbox')) {
                    updateModalBulkActionsUI();
                }
            });
        }

        const modalExportBtn = document.getElementById('modal-export-btn');
        if(modalExportBtn) {
            modalExportBtn.addEventListener('click', () => {
                const searchTerm = document.getElementById('modal-user-search') ? document.getElementById('modal-user-search').value.toLowerCase() : '';
                let dataToExport = currentModalData;
                
                if (searchTerm) {
                    dataToExport = currentModalData.filter(u => {
                        return (u.userId && u.userId.toLowerCase().includes(searchTerm)) ||
                               (u.name && u.name.toLowerCase().includes(searchTerm));
                    });
                }

                if (dataToExport.length === 0) {
                    alert('No data to export.');
                    return;
                }
                
                const headers = ['User ID', 'Name', 'Role', 'Job Description', 'Time In'];
                if (currentModalType === 'break' || currentModalType === 'long_break') {
                    headers.push('Break Out');
                    headers.push('Break Duration (min)');
                }
                
                const rows = [headers.join(',')];
                const now = new Date();
                
                dataToExport.forEach(u => {
                    const row = [`"${u.userId}"`, `"${u.name}"`, `"${u.role}"`, `"${u.area || '-'}"`, `"${u.timeIn || '-'}"`];
                    if (currentModalType === 'break' || currentModalType === 'long_break') {
                        row.push(`"${u.breakOut || '-'}"`);
                        let duration = 0;
                        if (u.breakOut) {
                            const [h, m] = u.breakOut.split(':').map(Number);
                            if (!isNaN(h) && !isNaN(m)) {
                                const breakStart = new Date();
                                breakStart.setHours(h, m, 0, 0);
                                if (breakStart > now) breakStart.setDate(breakStart.getDate() - 1);
                                duration = Math.floor((now - breakStart) / 60000);
                            }
                        }
                        row.push(duration);
                    }
                    rows.push(row.join(','));
                });
                
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                let filename = 'users_list.csv';
                if (currentModalType === 'active') filename = 'active_users.csv';
                else if (currentModalType === 'break') filename = 'users_on_break.csv';
                else if (currentModalType === 'long_break') filename = 'long_break_users.csv';
                else if (currentModalType === 'timeout') filename = 'timed_out_users.csv';
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }

        // Shortcut to Timestamp
        const goToTimestampBtn = document.getElementById('go-to-timestamp-btn');
        if(goToTimestampBtn) {
            goToTimestampBtn.addEventListener('click', () => {
                timestampModal.style.zIndex = '10005';
                timestampModal.classList.remove('hidden');
                renderTimestamps();
            });
        }

        // Ops Task - Print Blank Form Logic
        const addOpsTaskBtn = document.getElementById('add-ops-task-btn');

        if(addOpsTaskBtn) {
            addOpsTaskBtn.addEventListener('click', () => {
                const printWindow = window.open('', '_blank');
                const rows = 20;
                let rowsHtml = '';
                for(let i=0; i<rows; i++) {
                    rowsHtml += '<tr><td></td><td></td><td></td><td></td><td></td></tr>';
                }
                
                const html = `
                    <html>
                    <head>
                        <title>Ops Validator Task Form</title>
                        <style>
                            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; font-size: 12px; }
                            h2 { text-align: center; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; font-size: 24px; }
                            .header { display: flex; justify-content: space-between; margin-bottom: 20px; border: 1px solid #000; padding: 10px; }
                            .header div { flex: 1; }
                            table { width: 100%; border-collapse: collapse; border: 1px solid #000; }
                            th, td { border: 1px solid #000; padding: 8px; }
                            th { background-color: #f2f2f2; text-align: center; font-weight: bold; }
                            td { height: 25px; }
                            .footer { margin-top: 40px; display: flex; justify-content: space-between; padding: 0 50px; }
                            .sig-line { width: 200px; border-top: 1px solid #000; text-align: center; padding-top: 5px; }
                        </style>
                    </head>
                    <body>
                        <h2>Ops Validator Task Form</h2>
                        <div class="header">
                            <div><strong>Date:</strong> __________________</div>
                            <div style="text-align:center;"><strong>Shift:</strong> __________________</div>
                            <div style="text-align:right;"><strong>Requested By:</strong> __________________</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 15%;">SKU</th>
                                    <th style="width: 35%;">Description</th>
                                    <th style="width: 10%;">Qty</th>
                                    <th style="width: 25%;">Reason</th>
                                    <th style="width: 15%;">Status / Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                        </table>
                        <div class="footer">
                            <div class="sig-line">Ops Validator Signature</div>
                            <div class="sig-line">Received By (Validator)</div>
                        </div>
                        <script>
                            window.onload = function() { window.print(); }
                        <\/script>
                    </body>
                    </html>
                `;
                printWindow.document.write(html);
                printWindow.document.close();
            });
        }

        // Validator Actions Modal
        const valActionsBtn = document.getElementById('val-actions-btn');
        const valActionsModal = document.getElementById('val-actions-modal');
        if(valActionsBtn && valActionsModal){
            valActionsBtn.addEventListener('click', () => {
                valActionsModal.classList.remove('hidden');
            });
        }

        // Ops Validators Logic
        const STORAGE_KEY_OPS_VALIDATORS = 'ims_ops_validators_v1';

        function getOpsValidators() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_OPS_VALIDATORS) || '[]'); } catch(e) { return []; }
        }
        function saveOpsValidators(data) {
            localStorage.setItem(STORAGE_KEY_OPS_VALIDATORS, JSON.stringify(data));
        }

        function updateOpsValidatorDropdown() {
            if (!assignOpsValidator) return;
            const validators = getOpsValidators();
            validators.sort((a, b) => a.name.localeCompare(b.name));
            const current = assignOpsValidator.value;
            assignOpsValidator.innerHTML = '<option value="">Select Ops Validator</option>';
            validators.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.name;
                opt.textContent = v.name;
                assignOpsValidator.appendChild(opt);
            });
            if (current) assignOpsValidator.value = current;
        }

        function renderOpsValidators() {
            const tbody = document.querySelector('#ops-validators-table tbody');
            if (!tbody) return;

            let validators = getOpsValidators();
            const searchInput = document.getElementById('ops-validator-search');
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            if (search) {
                validators = validators.filter(v => v.name.toLowerCase().includes(search));
            }

            validators.sort((a, b) => a.name.localeCompare(b.name));

            tbody.innerHTML = '';
            if (validators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:10px; color:#999;">No validators found.</td></tr>';
                return;
            }

            validators.forEach(v => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${v.name}</td>
                    <td style="text-align:center;">
                        <button class="icon-btn edit-ops-validator-btn" data-id="${v.id}" title="Edit" style="padding:2px 6px;">✎</button>
                        <button class="icon-btn delete-ops-validator-btn" data-id="${v.id}" title="Delete" style="padding:2px 6px; color:#d9534f;">&times;</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        if (manageOpsValidatorsBtn) {
            manageOpsValidatorsBtn.addEventListener('click', () => {
                if (opsValidatorsModal) {
                    opsValidatorsModal.classList.remove('hidden');
                    renderOpsValidators();
                }
            });
        }

        const saveOpsValidatorBtn = document.getElementById('save-ops-validator-btn');
        if (saveOpsValidatorBtn) {
            saveOpsValidatorBtn.addEventListener('click', () => {
                const nameInput = document.getElementById('ops-validator-name');
                const idInput = document.getElementById('ops-validator-id');
                const name = nameInput.value.trim();
                const id = idInput.value;

                if (!name) { alert('Validator name is required.'); return; }

                let validators = getOpsValidators();
                if (id) { // Editing
                    const index = validators.findIndex(v => v.id == id);
                    if (index > -1) { validators[index].name = name; }
                } else { // Adding
                    if (validators.some(v => v.name.toLowerCase() === name.toLowerCase())) { alert('Validator with this name already exists.'); return; }
                    validators.push({ id: Date.now(), name: name });
                }
                saveOpsValidators(validators);
                renderOpsValidators();
                nameInput.value = ''; idInput.value = '';
                updateOpsValidatorDropdown();
            });
        }

        // Check for auto-open validators modal
        if (sessionStorage.getItem('ims_open_validators_modal') === 'true') {
            sessionStorage.removeItem('ims_open_validators_modal');
            if(validatorsViewBtn) validatorsViewBtn.click();
        }

            const exportValAnalyticsBtn = document.getElementById('export-val-analytics-btn');
            if(exportValAnalyticsBtn) {
                exportValAnalyticsBtn.addEventListener('click', exportValAnalytics);
            }

            const toggleValAnalyticsBtn = document.getElementById('toggle-val-analytics-view-btn');
            if (toggleValAnalyticsBtn) {
                toggleValAnalyticsBtn.addEventListener('click', () => {
                    const tasksCard = document.getElementById('val-tasks-card');
                    const analyticsCard = document.getElementById('val-analytics-card');
                    
                    if (tasksCard && analyticsCard) {
                        const isExpanded = analyticsCard.classList.contains('expanded');
                        
                        if (isExpanded) {
                            // Collapse
                            tasksCard.style.display = 'flex';
                            analyticsCard.classList.remove('expanded');
                            toggleValAnalyticsBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>';
                            toggleValAnalyticsBtn.title = "Expand View";
                        } else {
                            // Expand
                            tasksCard.style.display = 'none';
                            analyticsCard.classList.add('expanded');
                            toggleValAnalyticsBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>';
                            toggleValAnalyticsBtn.title = "Collapse View";
                        }
                    }
                });
            }

            // Export All Validation Tasks (Excel with Sheets)
            const exportValAllBtn = document.getElementById('export-val-all-btn');
            if (exportValAllBtn) {
                exportValAllBtn.addEventListener('click', () => {
                    let tasks = getValidationTasks();
                    
                    // Date Filtering
                    const valStart = document.getElementById('val-start-date');
                    const valEnd = document.getElementById('val-end-date');
                    const startStr = (valStart && valStart.value) || globalStartDate.value;
                    const endStr = (valEnd && valEnd.value) || globalEndDate.value;

                    if (startStr || endStr) {
                        tasks = tasks.filter(t => {
                            const shiftInfo = getShiftFromTimestamp(t.timestamp);
                            return (!startStr || shiftInfo.date >= startStr) && (!endStr || shiftInfo.date <= endStr);
                        });
                    }

                    if (tasks.length === 0) { alert('No data to export for selected date.'); return; }
                    if (typeof XLSX === 'undefined') { alert('SheetJS library not loaded.'); return; }

                    const wb = XLSX.utils.book_new();
                    const groups = { 'Pending': [], 'Assigned': [], 'Resolved': [], 'Unresolved': [], 'Reassigned': [] };

                    tasks.forEach(t => {
                        if (t.status === 'Completed') groups['Resolved'].push(t);
                        else if (t.status === 'Unresolved') groups['Unresolved'].push(t);
                        else if (t.status === 'Reassigned') groups['Reassigned'].push(t);
                        else if (t.status === 'Pending') {
                            if (t.validator && t.validator !== 'Unassigned') groups['Assigned'].push(t);
                            else groups['Pending'].push(t);
                        }
                    });

                    Object.keys(groups).forEach(status => {
                        if (groups[status].length === 0) return;
                        const rows = groups[status].map(t => ({
                            'Date': new Date(t.timestamp).toLocaleString(),
                            'SKU': t.sku, 'Description': t.desc, 'Qty': t.qty, 'Reason': t.reason,
                            'Priority': t.priority || 'Normal', 'Ops Validator': t.opsValidator || '', 'IC Validator': t.validator || '',
                            'Status': t.status,
                            'Completed At': t.completedAt ? new Date(t.completedAt).toLocaleString() : '',
                            'Unresolved At': t.unresolvedAt ? new Date(t.unresolvedAt).toLocaleString() : '',
                            'Reassigned To': t.reassignedTo || ''
                        }));
                        const ws = XLSX.utils.json_to_sheet(rows);
                        XLSX.utils.book_append_sheet(wb, ws, status);
                    });

                    const dateStr = valViewDate && valViewDate.value ? valViewDate.value : new Date().toISOString().split('T')[0];
                    XLSX.writeFile(wb, `validation_tasks_all_${dateStr}.xlsx`);
                });
            }
    });
  </script>
</body>
</html>
            
            
