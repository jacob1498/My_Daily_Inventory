<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Cycle Counters - IMS</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* Dark Mode Header */
    body.dark-mode header { background: #1a252f; border-bottom: 1px solid #2c3e50; }
    body.dark-mode header h1 { color: #ecf0f1; }
    body { padding-top: 0 !important; } /* Remove padding since navbar is removed */
    .completion-high { color: #2ecc71; font-weight: bold; }
    .completion-med { color: #f1c40f; font-weight: bold; }
    .completion-low { color: #e74c3c; font-weight: bold; }
    
    /* Flip Card Styles */
    .flip-container { perspective: 1000px; position: relative; margin-bottom: 20px; }
    .flip-inner { transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
    .flip-container.flipped .flip-inner { transform: rotateY(180deg); }
    .flip-front, .flip-back { 
        backface-visibility: hidden; width: 100%; top: 0; left: 0; 
        background: var(--card); border-radius: 8px; 
    }
    .flip-front { z-index: 2; transform: rotateY(0deg); position: relative; }
    .flip-back { transform: rotateY(180deg); position: absolute; height: 100%; top: 0; overflow-y: auto; }
    
    /* Sticky Header for Attendance Table */
    .sticky-table-container { overflow: auto; max-height: 500px; border: 1px solid #ccc; border-top: none; }
    .sticky-table-container thead th { position: sticky; top: 0; z-index: 10; background-color: #f0f0f0; box-shadow: 0 1px 0 #ccc; }

    @keyframes blink-red {
        0% { background-color: #ffebee; border-color: #ffcdd2; }
        50% { background-color: #ffcdd2; border-color: #e57373; box-shadow: 0 0 8px rgba(229, 115, 115, 0.6); }
        100% { background-color: #ffebee; border-color: #ffcdd2; }
    }
    .blink-red-card { animation: blink-red 1s infinite ease-in-out; }

    @keyframes blink-orange {
        0% { background-color: #fff8e1; border-color: #ffecb3; }
        50% { background-color: #ffe0b2; border-color: #ffb300; box-shadow: 0 0 8px rgba(255, 179, 0, 0.6); }
        100% { background-color: #fff8e1; border-color: #ffecb3; }
    }
    .blink-orange-card { animation: blink-orange 1s infinite ease-in-out; }
    
    /* Dashboard Stats Grid */
    .dashboard-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #eef2f6;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        text-align: center;
    }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .stat-value { font-size: 24px; font-weight: 700; color: #2c3e50; line-height: 1.2; }
    .stat-label { font-size: 12px; color: #7f8c8d; font-weight: 600; margin-top: 4px; }
    body.dark-mode .stat-card { background: #1e1e1e; border-color: #333; }
    body.dark-mode .stat-value { color: #e0e0e0; }
  </style>
  <style>
    /* Tab Styles */
    .tab-header { display: flex; background: #f9f9f9; border-bottom: 1px solid #eee; border-radius: 8px 8px 0 0; }
    .tab-btn { padding: 10px 15px; border: none; background: #f9f9f9; border-right: 1px solid #eee; cursor: pointer; color: #666; font-size: 13px; font-weight: 600; transition: all 0.2s; outline: none; }
    .tab-btn:first-child { border-radius: 8px 0 0 0; }
    .tab-btn.active { background: #fff; color: #2752a7; border-bottom: 2px solid #2752a7; margin-bottom: -1px; }
    .tab-btn:hover:not(.active) { background: #eee; color: #333; }
  </style>
  <style>
    /* Card content expand/collapse */
    .card-content.hidden { display: none; }
    .section-content.hidden { display: none !important; }
    /* Resizable box */
    .resizable-box {
        resize: both; overflow: auto; min-width: 300px; min-height: 200px;
    }
    /* Full height chart container for back card */
    .chart-container-back {
        flex: 1; position: relative; width: 100%; min-height: 0;
    }
    /* Ensure modal is on top of navbar (z-index 9999) */
    .modal { z-index: 10001; }
    
    /* Fix tooltips inside modal to appear below buttons */
    .modal-content .icon-btn[data-tooltip]::after {
        top: 100%;
        bottom: auto;
        margin-top: 8px;
        margin-bottom: 0;
    }
    .modal-content .icon-btn[data-tooltip]::before {
        top: 100%;
        bottom: auto;
        margin-top: 3px;
        margin-bottom: 0;
        border-top-color: transparent;
        border-bottom-color: #2c3e50;
    }
    /* Sortable headers */
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background-color: #f1f1f1; }
    .sort-icon { margin-left: 5px; font-size: 10px; }
    body.dark-mode th.sortable:hover { background-color: #333; }
    
    /* Full View Styles */
    main.full-view-counters #attendance-card { display: none; }
    main.full-view-attendance #counters-flip-container { display: none; }
    main.full-view-attendance #attendance-card { min-height: 80vh; }
    
    .badge-target-met {
        background-color: #2ecc71;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        vertical-align: middle;
    }
    .shift-summary-content {
        padding: 8px;
        border-radius: 6px;
        transition: background-color 0.2s;
        cursor: help;
    }
    .shift-summary-content:hover {
        background-color: rgba(39, 82, 167, 0.08);
    }
    /* Racking Grid Styles */
    .rack-cell {
        width: 100%;
        aspect-ratio: 1.6;
        background-color: #f0f2f5;
        border: 1px solid #d9d9d9;
        border-radius: 2px;
        cursor: pointer;
        transition: transform 0.1s;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .rack-cell:hover {
        transform: scale(1.1);
        z-index: 1;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .rack-cell.selected {
        border-color: #2752a7;
        box-shadow: inset 0 0 0 3px #2752a7;
        z-index: 2;
    }
    .rack-cell .pallet-icon {
        width: 80%;
        height: 80%;
        fill: #7f8c8d;
        opacity: 0.5;
        transition: fill 0.3s;
    }
    .rack-cell.counted {
        background-color: #e8f5e9;
        border-color: #a5d6a7;
    }
    .rack-cell.uncounted {
        background-color: #ffebee;
        border-color: #ef9a9a;
    }
    .rack-cell.empty {
        background-color: #e1f5fe;
        border-color: #81d4fa;
    }
    .rack-cell.not-part {
        background-color: #cfd8dc;
        border-color: #b0bec5;
    }
    .rack-cell.ongoing {
        background-color: #fff9c4;
        border-color: #fbc02d;
    }
    .rack-cell.counted .pallet-icon {
        fill: #7f8c8d;
        opacity: 0.5;
    }
    .rack-cell .cell-name {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 10px;
        font-weight: bold;
        color: #333;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 2px 4px;
        border-radius: 3px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        width: 100%;
        text-align: center;
        word-break: break-word;
        line-height: 1;
        pointer-events: none;
        white-space: nowrap;
        overflow: hidden;
        max-width: 98%;
    }
    .rack-spacer {
        pointer-events: none;
    }
    .rack-cell[draggable="true"] {
        cursor: grab;
    }
    .rack-cell.dragging {
        opacity: 0.5;
        border: 2px dashed #666;
    }
    .rack-cell.over {
        border: 2px dashed #2752a7;
        background-color: rgba(39, 82, 167, 0.1);
        transform: scale(1.05);
        z-index: 10;
    }
    .cell-checkbox {
        position: absolute;
        top: 5px;
        left: 5px;
        z-index: 5;
        cursor: pointer;
        width: 14px;
        height: 14px;
        opacity: 0;
    }
    .cell-checkbox:checked {
        opacity: 1;
    }
    .rack-cell:hover .cell-checkbox {
        opacity: 1;
    }
    /* Archive Button Hover Effect */
    .btn-archive-row { color: #f39c12; border-color: #f39c12; }
    .btn-archive-row:hover { background-color: #f39c12; color: white; }
    
    /* Row Checkbox Hover */
    .row-select-label:hover { background-color: #f0f0f0; border-radius: 4px; }
    
    /* Toast Notification Styles */
    .toast {
        visibility: hidden;
        min-width: 250px;
        transform: translateX(-50%);
        background-color: #2ecc71;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 16px;
        position: fixed;
        z-index: 20000;
        left: 50%;
        top: 30px;
        font-size: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        opacity: 0;
        transition: opacity 0.3s, top 0.3s;
    }
    .toast.show {
        visibility: visible;
        opacity: 1;
        top: 50px;
    }
    /* Excel-like Table Styles */
    .excel-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        border: 1px solid #ccc;
    }
    .excel-table th, .excel-table td {
        border: 1px solid #ccc;
        padding: 6px 8px;
        text-align: center;
    }
    .excel-table th {
        background-color: #f2f2f2;
        font-weight: bold;
        color: #333;
    }
    .excel-table input {
        width: 100%; border: none; background: transparent; text-align: center; font-family: inherit; font-size: inherit; padding: 4px;
    }
    .excel-table input:focus { background-color: #fff; outline: 2px solid #2752a7; border-radius: 2px; }
    .excel-table tr:hover td { background-color: #f9f9f9; }
    body.dark-mode .excel-table th { background-color: #333; color: #eee; border-color: #555; }
    body.dark-mode .excel-table td { border-color: #555; color: #eee; }
    body.dark-mode .excel-table input { color: #eee; }
    body.dark-mode .excel-table input:focus { background-color: #444; }
    body.dark-mode .excel-table tr:hover td { background-color: #333; }
    
    /* Column Resizer */
    .excel-table th { position: relative; }
    .resizer { position: absolute; top: 0; right: 0; width: 5px; cursor: col-resize; user-select: none; height: 100%; z-index: 1; }
    .resizer:hover, .resizing { background-color: #2752a7; opacity: 0.5; }
    .area-card:hover { border-color: #2752a7 !important; background-color: #f0f4f8; transform: translateY(-2px); }
    .editable-time { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
    .editable-time:hover { color: #2752a7; }
    
    /* Sand Timer Animation */
    .sand-timer {
        width: 40px; height: 70px;
        position: relative;
        margin: 0 auto;
        animation: hourglass-rotate 4s ease-in-out infinite;
    }
    .sand-timer-top, .sand-timer-bottom {
        width: 40px; height: 35px;
        position: absolute; left: 0;
        overflow: hidden;
        border: 3px solid #7f8c8d; /* Glass Frame */
        background: rgba(236, 240, 241, 0.3); /* Glass tint */
        box-sizing: border-box;
    }
    .sand-timer-top { top: 0; border-radius: 5px 5px 20px 20px; border-bottom: none; }
    .sand-timer-bottom { bottom: 0; border-radius: 20px 20px 5px 5px; border-top: none; }
    .sand-timer-sand-top {
        position: absolute; left: 50%; transform: translateX(-50%); bottom: 0;
        width: 30px; height: 30px; background: #f39c12; border-radius: 50%;
        animation: sand-drain-top 4s ease-in-out infinite;
    }
    .sand-timer-sand-bottom {
        position: absolute; left: 50%; transform: translateX(-50%); bottom: 0;
        width: 30px; height: 0; background: #f39c12; border-radius: 50% 50% 0 0;
        animation: sand-fill-bottom 4s ease-in-out infinite;
    }
    .sand-timer-stream {
        position: absolute; left: 50%; transform: translateX(-50%); top: 34px;
        width: 2px; height: 0; background: #f39c12;
        animation: sand-stream 4s ease-in-out infinite; z-index: 1;
    }
    @keyframes hourglass-rotate {
        0% { transform: rotate(0deg); } 40% { transform: rotate(0deg); }
        50% { transform: rotate(180deg); } 90% { transform: rotate(180deg); }
        100% { transform: rotate(360deg); }
    }
    @keyframes sand-drain-top {
        0% { height: 30px; width: 30px; } 40% { height: 0; width: 0; }
        50% { height: 0; width: 0; } 50.1% { height: 30px; width: 30px; }
        90% { height: 0; width: 0; } 100% { height: 0; width: 0; }
    }
    @keyframes sand-fill-bottom {
        0% { height: 0; width: 0; } 40% { height: 30px; width: 30px; }
        50% { height: 30px; width: 30px; } 50.1% { height: 0; width: 0; }
        90% { height: 30px; width: 30px; } 100% { height: 30px; width: 30px; }
    }
    @keyframes sand-stream {
        0% { height: 0; } 5% { height: 35px; } 40% { height: 35px; }
        45% { height: 0; } 50% { height: 0; } 55% { height: 35px; }
        90% { height: 35px; } 95% { height: 0; } 100% { height: 0; }
    }

    /* Excel-like Report Table */
    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px; /* Smaller font */
        border: 1px solid #ccc;
    }
    .report-table th, .report-table td {
        border: 1px solid #ccc; /* Grid lines */
        padding: 4px 6px; /* Compact padding */
        text-align: left;
    }
    .report-table th {
        background-color: #f0f0f0;
        font-weight: 600;
        color: #333;
        white-space: nowrap;
    }
    .report-table tbody tr:nth-child(even) { background-color: #fafafa; }
    .report-table tr:hover { background-color: #eef6ff; }
    
    /* Dark mode overrides */
    body.dark-mode .report-table { border-color: #444; }
    body.dark-mode .report-table th, body.dark-mode .report-table td { border-color: #444; color: #e0e0e0; }
    body.dark-mode .report-table th { background-color: #2c2c2c; }
    body.dark-mode .report-table tbody tr:nth-child(even) { background-color: #1f1f1f; }
    body.dark-mode .report-table tr:hover { background-color: #333; }
  </style>
</head>
<body class="inventory-mode">
  <script>
    if(localStorage.getItem('ims_sidebar_collapsed') === '1') document.body.classList.add('sidebar-collapsed');
  </script>
  
  <!-- Reuse existing sidebar structure -->
  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <img src="Logo.jpg" alt="Logo" class="sidebar-logo" style="height:32px;width:auto;margin-right:8px">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button onclick="window.location.href='homepage.html'" data-tooltip="Homepage">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span class="menu-text">Homepage</span>
        </button>
      </li>
      <li>
        <button class="active" onclick="window.location.href='daily_cycle_count.html'" data-tooltip="Daily Cycle Count">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <span class="menu-text">Daily Cycle Count</span>
        </button>
        <ul class="sidebar-submenu">
            <li><button id="sidebar-timestamp-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;margin-right:10px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Timestamp
            </button></li>
            
        </ul>
      </li>
      <li>
        <button onclick="window.location.href='all_ic_attendance.html'" data-tooltip="All IC Attendance">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          <span class="menu-text">All IC Attendance</span>
        </button>
        <ul class="sidebar-submenu">
            
            <li><button onclick="sessionStorage.setItem('ims_open_validators_modal', 'true'); window.location.href='all_ic_attendance.html'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;margin-right:10px;"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                Validators View
            </button></li>
        </ul>
      </li>
      <li>
        <button onclick="window.location.href='dashboard_analytics.html'" data-tooltip="Analytics & Reports">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
          <span class="menu-text">Analytics & Reports</span>
        </button>
      </li>
      <li>
        <button onclick="window.location.href='settings.html'" data-tooltip="Settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          <span class="menu-text">Settings</span>
        </button>
      </li>
    </ul>
  </nav>

  <header>
    <div style="display: flex; align-items: center; gap: 15px;">
        <button onclick="window.location.href='homepage.html'" class="icon-btn" title="Back to Dashboard" style="border:none; background:transparent; font-size:16px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </button>
        <h1>Daily Cycle Count</h1>
    </div>
    <div style="display: flex; gap: 10px;">
        <button onclick="toggleTheme()" class="icon-btn" title="Toggle Theme" style="background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); border:none; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
        <button onclick="signOut()" class="icon-btn" title="Logout" style="background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); border:none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #e74c3c;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        </button>
    </div>
  </header>

  <main>
    <div class="card" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; padding: 15px;">
      <strong style="color: var(--accent);">Global Date Filter:</strong>
      <label for="global-start-date">From:</label>
      <input type="date" id="global-start-date" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
      <label for="global-end-date">To:</label>
      <input type="date" id="global-end-date" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
      <button id="apply-global-filter" class="icon-btn" title="Apply Filter" style="background: #2752a7; color: white;">Filter</button>
      <button id="clear-global-filter" class="icon-btn" title="Clear Filter">Clear</button>
      <button id="sub-area-filter-btn" class="icon-btn" title="Sub Area Filter" style="margin-left: 10px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg> Sub Area
      </button>
      <button id="monitor-sub-area-btn" class="icon-btn" title="Monitor Sub Area" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg> Monitor
      </button>
      <button id="counter-timestamp-btn" class="icon-btn" title="Counter Timestamp" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Timestamp
      </button>
      <button id="user-master-btn" class="icon-btn" title="User Master Data" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> User Master
      </button>
      <button id="reports-menu-btn" class="icon-btn" title="Reports" style="margin-left: 5px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Reports
      </button>
      <div style="display:flex; align-items:center; gap:5px; margin-left:10px; border-left:1px solid #ccc; padding-left:10px;">
          <input type="checkbox" id="auto-refresh-check" title="Auto Refresh every 3s">
          <label for="auto-refresh-check" style="font-size:13px; cursor:pointer;">Auto Refresh</label>
      </div>
    </div>
    <div class="card resizable-box" id="manage-counters-card" style="min-height: 600px; margin-bottom: 20px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <h2 style="margin:0;">Manage Daily Counters</h2>
            <button id="counters-flip-to-summary" class="icon-btn" title="View Statistics" style="background:#6f42c1; color:white; font-size:12px; padding:4px 8px;">View Stats</button>
            <button class="icon-btn expand-toggle-btn" title="Collapse" style="padding:4px; border:none; background:transparent; color:var(--muted);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg></button>
        </div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="counters-search" placeholder="Search date or shift..." style="padding:6px; border:1px solid #ccc; border-radius:4px;">
            <button id="delete-selected-counters-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
            </button>
            <button id="clear-counters-filters-btn" class="icon-btn" title="Clear Filters">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
            </button>
            <button id="export-counters-btn" class="icon-btn" title="Export CSV">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </button>
            <button id="daily-output-btn" class="icon-btn" title="Daily Output Report">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
            </button>
            <button id="archive-btn" class="icon-btn" title="Toggle Archive View" style="min-width: 100px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
            </button>
        </div>
      </div>
      <div class="card-content">
      <div id="counters-flip-container" class="flip-container">
        <div class="flip-inner">
            <div class="flip-front">

      <!-- Form -->
      <form id="daily-counters-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eef2f6;">
          <input type="hidden" id="counter-edit-id">
          <div>
              <label for="counter-date">Date</label>
              <input type="date" id="counter-date" required style="width:100%">
          </div>
          <div>
              <label for="counter-shift">Shift</label>
              <select id="counter-shift" required style="width:100%">
                  <option value="1st Shift-(6am-2pm)">1st Shift-(6am-2pm)</option>
                  <option value="2nd Shift-(2pm-10pm)">2nd Shift-(2pm-10pm)</option>
                  <option value="3rd Shift-(10pm-6am)">3rd Shift-(10pm-6am)</option>
              </select>
          </div>
          <div>
              <label for="counter-required">Required Counters</label>
              <input type="number" id="counter-required" required min="1" style="width:100%">
          </div>
          <div>
              <label for="counter-rate">Standard Rate</label>
              <input type="number" id="counter-rate" min="1" placeholder="Per Person" style="width:100%" title="Items per person. Used to calculate Target Output (Required * Rate).">
          </div>
          <div>
              <label for="counter-target">Target Output</label>
              <input type="number" id="counter-target" min="0" placeholder="Optional" style="width:100%" title="Total items target. Auto-calculated if Rate is set, or enter manually.">
          </div>
          <div>
              <label for="counter-note">Note (Optional)</label>
              <input type="text" id="counter-note" placeholder="Shift notes..." style="width:100%">
          </div>
          <div style="display:flex; gap:5px;">
              <button type="submit" id="save-counter-btn" class="icon-btn" title="Save" style="background: #2752a7; color: white; height: 38px; width: 100%; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save
              </button>
              <button type="button" id="cancel-counter-edit-btn" class="icon-btn" title="Cancel Edit" style="background: #6c757d; color: white; height: 38px; display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
          </div>
      </form>

      <!-- Table -->
      <div style="overflow-x: auto;">
          <table id="daily-counters-table" style="width:100%; border-collapse: collapse;">
              <thead>
                  <tr style="background: #f9fbfd; border-bottom: 1px solid #eee;">
                      <th style="padding: 12px; text-align: left; width: 40px;"><input type="checkbox" id="select-all-counters" title="Select All"></th>
                      <th style="padding: 12px; text-align: left;">Date</th>
                      <th style="padding: 12px; text-align: left;">1st Shift (6am-2pm)</th>
                      <th style="padding: 12px; text-align: left;">2nd Shift (2pm-10pm)</th>
                      <th style="padding: 12px; text-align: left;">3rd Shift (10pm-6am)</th>
                      <th style="padding: 12px; text-align: left;">Actions</th>
                  </tr>
              </thead>
              <tbody></tbody>
          </table>
      </div>
      <div id="counters-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-top: 1px solid #eee;">
        <div style="display:flex; align-items:center; gap:8px;">
            <label for="counters-rows-per-page" style="font-size:13px; color:var(--muted);">Rows:</label>
            <select id="counters-rows-per-page" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #d6dbe6;"><option value="3">3</option><option value="7" selected>7</option><option value="14">14</option></select>
        </div>
        <span id="counters-page-info" style="font-size: 13px; font-weight: 600; color: var(--muted);"></span>
        <div style="display:flex; gap:8px;">
            <button id="counters-prev-page" class="icon-btn" title="Previous">‹</button>
            <button id="counters-next-page" class="icon-btn" title="Next">›</button>
        </div>
      </div>
            </div>
            <div class="flip-back" style="padding:20px; background:#fff; border:1px solid #eee; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0; color:#2752a7;">Performance Statistics</h3>
                    <button id="counters-flip-to-table" class="icon-btn" title="Back to Table">↩ Back to Table</button>
                </div>
                <div id="counters-summary-content"></div>
            </div>
        </div>
      </div>
    </div>

    <div class="card resizable-box" id="attendance-card" style="margin-top: 20px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <h2 style="margin:0;">Attendance Sheet</h2>
            <button class="icon-btn expand-toggle-btn" title="Collapse" style="padding:4px; border:none; background:transparent; color:var(--muted);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg></button>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <select id="att-filter-role" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
                <option value="">All Roles</option>
                <option value="IC Support">IC Support</option>
                <option value="IC Back up">IC Back up</option>
            </select>
            <select id="att-filter-area" style="padding:6px; border:1px solid #ccc; border-radius:4px;"><option value="">All Areas</option></select>
            <input type="text" id="att-search" placeholder="Search name..." style="padding:6px; border:1px solid #ccc; border-radius:4px;">
            <button id="print-att-btn" class="icon-btn" title="Print List">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
            </button>
            <button id="bulk-timeout-btn" class="icon-btn" title="Bulk Time Out" style="color:#34495e; display:none; margin-right:5px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            </button>
            <button id="delete-selected-att-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
            </button>
            <button id="export-att-btn" class="icon-btn" title="Export CSV" style="margin-right:5px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </button>
            <button id="add-att-btn" class="icon-btn" style="background: #2752a7; color: white; padding: 8px 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:5px"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add Entry
            </button>
        </div>
      </div>
      <div class="card-content">
      <!-- Quick Time In Toolbar -->
      <div style="background:#f1f5f9; padding:8px 12px; border-bottom:1px solid #e2e8f0; display:flex; gap:10px; align-items:center; margin-bottom:10px; border-radius:4px; flex-wrap: wrap;">
          <div style="display:flex; align-items:center; gap:5px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;color:#2752a7;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              <span id="quick-widget-clock" style="font-size:12px; font-weight:bold; color:#555; min-width:120px;"></span>
          </div>
          <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
          <span style="font-weight:bold; color:#2752a7; font-size:13px;">Quick Time In:</span>
          <input type="text" id="quick-user-id" placeholder="Scan User ID" style="width:120px; padding:5px; border:1px solid #ccc; border-radius:4px; text-transform:uppercase; font-size:12px;">
          <button id="quick-time-in-btn" class="icon-btn" style="background:#2ecc71; color:white; font-weight:bold; padding: 5px 10px; font-size:12px;">GO</button>
          <button id="quick-clear-btn" class="icon-btn" style="background:#fff; color:#333; border:1px solid #ccc; padding: 5px 8px; font-size:12px;" title="Clear">C</button>
          <input type="text" id="quick-user-name" placeholder="Name" readonly style="width:150px; padding:5px; border:1px solid #eee; border-radius:4px; background:#fff; color:#555; font-size:12px;">
          <input type="text" id="quick-user-role" placeholder="Role" readonly style="width:100px; padding:5px; border:1px solid #eee; border-radius:4px; background:#fff; color:#555; font-size:12px;">
      </div>
      <div class="tab-header">
          <button class="tab-btn active att-shift-tab" data-shift="1st Shift-(6am-2pm)">1st Shift</button>
          <button class="tab-btn att-shift-tab" data-shift="2nd Shift-(2pm-10pm)">2nd Shift</button>
          <button class="tab-btn att-shift-tab" data-shift="3rd Shift-(10pm-6am)">3rd Shift</button>
          <button class="tab-btn att-shift-tab" data-shift="">All Shifts</button>
      </div>
      <div class="sticky-table-container">
          <table id="attendance-table" class="report-table">
              <thead>
                  <tr>
                      <th style="width: 40px;"><input type="checkbox" id="select-all-att" title="Select All"></th>
                      <th class="sortable" data-sort="date">Date <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="userId">User ID <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="shift">Shift <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="name">Name <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="role">Role <span class="sort-icon"></span></th>
                      <th class="sortable" data-sort="jobDescription">Job Description <span class="sort-icon"></span></th>
                      <th>Time In</th>
                      <th>Break Out</th>
                      <th>Break In</th>
                      <th>Time Out</th>
                      <th class="sortable" data-sort="duration">Duration <span class="sort-icon"></span></th>
                      <th>Status</th>
                      <th>Action</th>
                  </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                  <tr style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #eef2f6;">
                      <td colspan="13" style="text-align: right; padding: 10px;">Total People: <span id="att-total-count">0</span></td>
                  </tr>
              </tfoot>
          </table>
      </div>
      <div id="att-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-top: 1px solid #eee;">
        <div style="display:flex; align-items:center; gap:8px;">
            <label for="att-rows-per-page" style="font-size:13px; color:var(--muted);">Rows:</label>
            <select id="att-rows-per-page" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #d6dbe6;"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option><option value="100">100</option></select>
        </div>
        <span id="att-page-info" style="font-size: 13px; font-weight: 600; color: var(--muted);"></span>
        <div style="display:flex; gap:8px;">
            <button id="att-prev-page" class="icon-btn" title="Previous">‹</button>
            <button id="att-next-page" class="icon-btn" title="Next">›</button>
        </div>
      </div>
      </div>
    </div>
  </main>

  <!-- Attendance Modal -->
  <div id="att-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 50px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0" id="att-modal-title">Add Attendance</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <form id="att-modal-form" style="display: grid; gap: 15px;">
            <input type="hidden" id="att-edit-id">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-date">Date</label>
                    <input type="date" id="att-date" required style="width:100%">
                </div>
                <div>
                    <label for="att-shift">Shift</label>
                    <select id="att-shift" required style="width:100%">
                        <option value="1st Shift-(6am-2pm)">1st Shift-(6am-2pm)</option>
                        <option value="2nd Shift-(2pm-10pm)">2nd Shift-(2pm-10pm)</option>
                        <option value="3rd Shift-(10pm-6am)">3rd Shift-(10pm-6am)</option>
                    </select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                <div>
                    <label for="att-user-id">User ID</label>
                    <input type="text" id="att-user-id" placeholder="ID" style="width:100%">
                </div>
                <div>
                    <label for="att-name">Counter Name</label>
                    <input type="text" id="att-name" required placeholder="Enter Name" style="width:100%" list="att-name-list" autocomplete="off">
                    <datalist id="att-name-list"></datalist>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-role">Role</label>
                    <select id="att-role" style="width:100%">
                        <option value="IC Support">IC Support</option>
                        <option value="IC Back up">IC Back up</option>
                    </select>
                </div>
                <div>
                    <label for="att-job-desc">Job Description</label>
                    <select id="att-job-desc" style="width:100%">
                        <option value="">-</option>
                        <option value="Cycle Counter">Cycle Counter</option>
                        <option value="TL">TL</option>
                        <option value="OIC">OIC</option>
                        <option value="Encoder">Encoder</option>
                        <option value="SBD Checker">SBD Checker</option>
                        <option value="RTV">RTV</option>
                        <option value="Damaged Checker">Damaged Checker</option>
                        <option value="B1T1 Checker">B1T1 Checker</option>
                        <option value="Validator">Validator</option>
                        <option value="HVI Support">HVI Support</option>
                    </select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-time-in">Time In</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-time-in" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-time-in" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="att-time-out">Time Out</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-time-out" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-time-out" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div>
                <label for="att-status">Status</label>
                <select id="att-status" style="width:100%">
                    <option value="Full counter">Full counter</option>
                    <option value="Temporary slide to Other task">Temporary slide to Other task</option>
                </select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="att-break-out">Break Out</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-break-out" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-break-out" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="att-break-in">Break In</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="time" id="att-break-in" style="width:100%">
                        <button type="button" class="icon-btn set-current-time" data-target="att-break-in" title="Set Current Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div style="text-align:right; margin-top:10px; border-top: 1px solid #eee; padding-top: 15px;">
                <button type="button" class="icon-btn close-modal" style="margin-right:5px; border: 1px solid #ccc; padding: 8px 16px;">Close</button>
                <button type="submit" class="icon-btn" style="background: #2752a7; color: white; padding: 8px 16px;">Save</button>
            </div>
        </form>
    </div>
  </div>

  <!-- Hourly Monitor Modal -->
  <div id="hourly-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card resizable-box" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70vw; max-width: 900px; height: 85vh; display: flex; flex-direction: column; margin: 0;">
        <input type="hidden" id="hourly-date-val">
        <input type="hidden" id="hourly-shift-val">
        <div id="hourly-header-bar" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <button id="hourly-prev-shift-btn" class="icon-btn" title="Previous Shift" style="font-weight:bold; font-size:16px; padding:2px 8px;">&lt;</button>
                <h3 style="margin:0" id="hourly-modal-title">Hourly Output</h3>
                <button id="hourly-next-shift-btn" class="icon-btn" title="Next Shift" style="font-weight:bold; font-size:16px; padding:2px 8px;">&gt;</button>
            </div>
            <div>
                <button id="hourly-back-timestamp-btn" class="icon-btn" title="Back to Timestamp" style="margin-right:5px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                </button>
                <button id="hourly-chart-toggle-btn" class="icon-btn" title="Toggle View" style="font-size:12px; padding:2px 8px; margin-right:5px; border:1px solid #ccc; background:#f9f9f9;">View: Hourly</button>
                <button id="email-hourly-btn" class="icon-btn" title="Email Report (Text)" style="margin-right:5px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                </button>
                <button id="clear-hourly-btn" class="icon-btn" title="Clear Actuals" style="margin-right:5px; color:#e74c3c;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
                <button id="share-hourly-btn" class="icon-btn" title="Visualize & Share" style="margin-right:5px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                </button>
                <button id="export-hourly-btn" class="icon-btn" title="Export CSV" style="margin-right:5px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>
                <button id="save-hourly-targets-btn" class="icon-btn" title="Save Hourly Data" style="background:#2752a7; color:white;">Save Data</button>
                <button class="icon-btn close-modal">&times;</button>
            </div>
        </div>
        <div id="hourly-report-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
        <div style="position:relative; flex: 1; min-height: 0; width:100%;">
            <canvas id="hourly-chart"></canvas>
        </div>
        <div id="hourly-details" style="margin-top:10px; flex: 1; overflow-y: auto;">
            <!-- Hourly input fields will be generated here -->
        </div>
        </div>
    </div>
  </div>

  <!-- Daily Output Modal -->
  <div id="daily-output-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card resizable-box" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70vw; max-width: 900px; height: 85vh; display: flex; flex-direction: column; margin: 0;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Total Output per Day</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
            <div style="flex:1; min-height:0; position:relative;">
                <canvas id="daily-output-chart"></canvas>
            </div>
            <div style="flex:1; overflow-y:auto; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                <table class="excel-table" id="daily-output-table">
                    <thead>
                        <tr>
                            <th style="text-align:left;">Date</th>
                            <th>Total Output</th>
                            <th>Target</th>
                            <th>Variance</th>
                            <th>Completion %</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
  </div>

  <!-- Snapshot Modal -->
  <div id="snapshot-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 900px; margin: 50px auto; text-align:center;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Report Snapshot</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <div id="snapshot-container" style="overflow:auto; max-height:60vh; border:1px solid #eee; margin-bottom:15px;"></div>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button id="snapshot-share-btn" class="icon-btn" style="background:#2752a7; color:white; padding:8px 16px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:5px"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg> Share Image
            </button>
            <button id="snapshot-download-btn" class="icon-btn" style="background:#fff; color:#333; border:1px solid #ccc; padding:8px 16px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:5px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Download
            </button>
        </div>
    </div>
  </div>

  <!-- Supervisor Delete Modal -->
  <div id="supervisor-delete-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px;">
      <h3 id="supervisor-modal-title">Confirm Deletion</h3>
      <p>You are about to delete <strong id="supervisor-delete-count">0</strong> records.</p>
      <p class="muted">This action cannot be undone. Please enter Supervisor Code to proceed.</p>
      <div style="margin: 15px 0;">
        <label for="supervisor-code" style="display:block; margin-bottom:5px; font-weight:bold;">Supervisor Code</label>
        <input type="password" id="supervisor-code" style="width:100%;" placeholder="Enter code">
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button type="button" class="icon-btn close-modal">Cancel</button>
        <button type="button" id="confirm-supervisor-delete-btn" class="icon-btn" style="background:#d9534f; color:white;">Confirm Delete</button>
      </div>
    </div>
  </div>

  <!-- Edit Timestamp Modal -->
  <div id="edit-time-modal" class="modal hidden" style="z-index: 10015;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 150px auto;">
        <h3 style="margin-top:0">Edit Timestamp</h3>
        <input type="hidden" id="edit-time-log-id">
        <div style="margin-bottom:15px;">
            <label for="edit-time-input" style="font-weight:bold;">New Date & Time:</label>
            <input type="datetime-local" id="edit-time-input" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button id="cancel-edit-time-btn" class="icon-btn" style="border:1px solid #ccc;">Cancel</button>
            <button id="save-edit-time-btn" class="icon-btn" style="background:#2752a7; color:white;">Save</button>
        </div>
    </div>
  </div>

  <!-- Hover Summary Popup -->
  <div id="summary-hover-popup" class="card" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1.3); z-index: 10002; display: none; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); min-width: 350px; max-width: 500px; background: #fff; border: 1px solid #ccc; pointer-events: none;">
    <h3 style="margin-top:0; color:var(--accent); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">Shift Summary</h3>
    <div id="summary-popup-content" style="font-size: 1.2em; line-height: 1.5;"></div>
  </div>

  <!-- Sub Area Filter Modal -->
  <div id="sub-area-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 100px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Select Sub Area</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <div id="sub-area-list" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:15px;">
            <!-- Checkboxes generated by JS -->
        </div>
        <div style="text-align:right;">
            <button id="apply-sub-area-filter" class="icon-btn" style="background:#2752a7; color:white;">Apply Filter</button>
        </div>
    </div>
  </div>

  <!-- Sub Area Monitor Modal -->
  <div id="sub-area-monitor-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="width: 95%; max-width: 1400px; height: 85vh; display:flex; flex-direction:column; margin: 40px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Sub Area Monitor</h3>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="monitor-filter-status" style="padding:6px; border-radius:4px; border:1px solid #ccc;">
                    <option value="all">All Status</option>
                    <option value="counted">Counted</option>
                    <option value="uncounted">Not Counted</option>
                    <option value="ongoing">On-going</option>
                    <option value="empty">Empty</option>
                </select>
                <input type="text" id="monitor-search-input" placeholder="Search cell..." style="padding:6px; border-radius:4px; border:1px solid #ccc; width: 120px;">
                <button id="monitor-print-btn" class="icon-btn" title="Print View"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg></button>
                <button id="monitor-export-btn" class="icon-btn" title="Export CSV (All/Filtered)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
                <button id="monitor-snapshot-btn" class="icon-btn" title="Export Image"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg></button>
                <div id="monitor-bulk-actions" style="display:none; gap:5px;">
                    <button id="bulk-copy-names-btn" class="icon-btn" style="background:#3498db; color:white; width:auto; padding: 6px 12px; font-size:12px;">Copy Names</button>
                    <button id="bulk-paste-names-btn" class="icon-btn" style="background:#9b59b6; color:white; width:auto; padding: 6px 12px; font-size:12px;">Paste Names</button>
                    <button id="bulk-counted-btn" class="icon-btn" style="background:#2ecc71; color:white; width:auto; padding: 6px 12px; font-size:12px;">Mark Counted</button>
                    <button id="bulk-ongoing-btn" class="icon-btn" style="background:#f1c40f; color:white; width:auto; padding: 6px 12px; font-size:12px;">Mark On-going</button>
                    <button id="bulk-empty-btn" class="icon-btn" style="background:#03a9f4; color:white; width:auto; padding: 6px 12px; font-size:12px;">Mark Empty</button>
                    <button id="bulk-edit-btn" class="icon-btn" style="background:#607d8b; color:white; width:auto; padding: 6px 12px; font-size:12px;">Edit</button>
                    <button id="bulk-uncounted-btn" class="icon-btn" style="background:#e74c3c; color:white; width:auto; padding: 6px 12px; font-size:12px;">Mark Not Counted</button>
                </div>
                <div id="monitor-file-actions" style="display:none; gap:5px; align-items: center;">
                    <button id="monitor-template-btn" class="icon-btn" title="Download Template/Export" style="background:#fff; border:1px solid #ccc;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    </button>
                    <button id="monitor-upload-btn" class="icon-btn" title="Upload CSV" style="background:#fff; border:1px solid #ccc;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    </button>
                    <input type="file" id="monitor-file-input" accept=".csv" style="display:none;">
                    <div id="upload-progress-container" style="display:none; width: 100px; height: 20px; background: #eee; border-radius: 4px; overflow: hidden; border: 1px solid #ccc;">
                        <div id="upload-progress-bar" style="height: 100%; width: 0%; background: #2ecc71; color: white; font-size: 10px; display: flex; align-items: center; justify-content: center;">0%</div>
                    </div>
                </div>
                <select id="monitor-sub-area-select" style="padding:6px; border-radius:4px; border:1px solid #ccc; min-width: 150px;"></select>
                <span id="monitor-capacity-info" style="font-size:13px; color:#666; font-weight:bold;"></span>
                <button class="icon-btn close-modal">&times;</button>
            </div>
        </div>
        <div style="flex:1; overflow:auto; padding:20px; border:1px solid #eee; border-radius:4px; background:#f9f9f9; display: flex; justify-content: center; align-items: flex-start;">
            <div id="racking-grid" style="display:grid; gap:2px;"></div>
        </div>
        <div id="monitor-stats" style="margin-top:10px; font-weight:bold; text-align: right;"></div>
    </div>
  </div>

  <!-- Cell Edit Modal -->
  <div id="cell-edit-modal" class="modal hidden" style="z-index: 10005;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 300px; margin: 150px auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Edit Grid Name</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <input type="hidden" id="cell-edit-id">
        <div id="cell-name-group" style="margin-bottom:15px;">
            <label for="cell-custom-name" style="font-weight:bold;">Grid Name:</label>
            <input type="text" id="cell-custom-name" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="Enter name">
        </div>
        <div style="margin-bottom:15px;">
            <label for="cell-status" style="font-weight:bold;">Status:</label>
            <select id="cell-status" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                <option value="auto">Auto (Default)</option>
                <option value="counted">Counted</option>
                <option value="ongoing">On-going count</option>
                <option value="empty">Empty</option>
                <option value="not-part">Not Part</option>
                <option value="uncounted">Not Counted</option>
            </select>
        </div>
        <div style="text-align:right;">
            <button id="save-cell-btn" class="icon-btn" style="background:#2752a7; color:white; padding:8px 16px;">Save</button>
        </div>
    </div>
  </div>

  <!-- Counter Timestamp Modal -->
  <div id="timestamp-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="width: 100%; height: 100%; max-width: none; margin: 0; border-radius: 0; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0">Counter Timestamp</h3>
            <div>
                <button id="go-to-validators-btn" class="icon-btn" title="Go to Validators View (All IC Attendance)" style="margin-right:5px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></button>
                <button class="icon-btn close-modal">&times;</button>
            </div>
        </div>
        
        <div class="dashboard-stats-grid" style="margin-bottom:15px;">
            <div class="stat-card" onclick="resetTsFilters(); activateTsTab('tab-active'); renderTimestamps();" style="padding:15px; border-left: 4px solid #2ecc71;">
                <div style="margin-bottom:4px; color:#2ecc71;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                <div class="stat-value" id="card-active-sessions" style="font-size:24px;">0</div>
                <div class="stat-label" style="font-size:12px;">Active Session</div>
            </div>
            <div class="stat-card" onclick="resetTsFilters(); activateTsTab('tab-active'); document.getElementById('ts-show-long-active').checked = true; renderTimestamps();" style="padding:15px; border-left: 4px solid #e74c3c;">
                <div style="margin-bottom:4px; color:#e74c3c;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div>
                <div class="stat-value" id="card-long-sessions" style="font-size:24px;">0</div>
                <div class="stat-label" style="font-size:12px;">Active > 1hr</div>
            </div>
            <div class="stat-card" onclick="resetTsFilters(); activateTsTab('tab-inactive');" style="padding:15px; border-left: 4px solid #8e24aa;">
                <div style="margin-bottom:4px; color:#8e24aa;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="18" y1="8" x2="23" y2="13"></line><line x1="23" y1="8" x2="18" y2="13"></line></svg></div>
                <div class="stat-value" id="card-inactive-users" style="font-size:24px;">0</div>
                <div class="stat-label" style="font-size:12px;">Inactive User</div>
            </div>
            <div class="stat-card" onclick="resetTsFilters(); activateTsTab('tab-active-breaks'); renderTimestamps();" style="padding:15px; border-left: 4px solid #f57c00;">
                <div style="margin-bottom:4px; color:#f57c00;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg></div>
                <div class="stat-value" id="card-active-breaks" style="font-size:24px;">0</div>
                <div class="stat-label" style="font-size:12px;">Active Breaks</div>
            </div>
            <div class="stat-card" onclick="resetTsFilters(); tsBreakFilterLong = true; activateTsTab('tab-active-breaks'); renderTimestamps();" style="padding:15px; border-left: 4px solid #ffb300;">
                <div style="margin-bottom:4px; color:#ffb300;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div>
                <div class="stat-value" id="card-long-breaks" style="font-size:24px;">0</div>
                <div class="stat-label" style="font-size:12px;">Breaks > 40m</div>
            </div>
        </div>
        
        <div style="display:flex; gap: 20px; flex:1; overflow:hidden;">
            <!-- Left Column: Controls & Tables -->
            <div style="width: 50%; display:flex; flex-direction:column; gap:10px; padding-right:10px;">
                <!-- Controls -->
                <div>
                    <div style="margin-bottom:10px;">
                    <label for="ts-user-id" style="font-weight:bold;">User ID / Name</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="ts-user-id" placeholder="User ID" style="flex:1; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:4px;">
                        <input type="text" id="ts-user-name-display" placeholder="Name" readonly style="flex:1; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:4px; background:#f9f9f9;">
                    </div>
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button id="btn-start-count" class="icon-btn" style="flex:1; background:#2ecc71; color:white; padding:10px; font-weight:bold; justify-content:center;">Start Counting</button>
                        <button id="btn-end-count" class="icon-btn" style="flex:1; background:#e74c3c; color:white; padding:10px; font-weight:bold; justify-content:center;">End Counting</button>
                        <button id="btn-time-out" class="icon-btn" style="flex:1; background:#34495e; color:white; padding:10px; font-weight:bold; justify-content:center;">Time Out</button>
                    </div>
                </div>

                <!-- Table 1: Sessions (Active & History) -->
                <div class="card" style="margin:0; padding:0; display:flex; flex-direction:column; flex: 1; min-height: 0; border:1px solid #eee; box-shadow:none;">
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="openTsTab(event, 'tab-active')">Active Sessions</button>
                        <button class="tab-btn" onclick="openTsTab(event, 'tab-history')">Session History</button>
                        <button class="tab-btn" onclick="openTsTab(event, 'tab-area-dashboard')">Area Dashboard</button>
                        <button class="tab-btn" onclick="openTsTab(event, 'tab-user-dashboard')">User Dashboard</button>
                    </div>
                    
                    <div id="tab-active" class="tab-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                        <div style="display:flex; gap:5px; align-items:center;">
                            <select id="ts-shift-filter" style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">All Shifts</option>
                                <option value="1st Shift">1st Shift</option>
                                <option value="2nd Shift">2nd Shift</option>
                                <option value="3rd Shift">3rd Shift</option>
                            </select>
                            <input type="text" id="ts-filter-user" placeholder="Search User..." style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; width: 100px;">
                            <label style="font-size:12px; cursor:pointer; margin-left:5px;"><input type="checkbox" id="ts-show-long-active"> > 1hr</label>
                        </div>
                        <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px; margin-top:5px;">
                            <table id="active-table" class="report-table">
                                <thead>
                                    <tr style="position:sticky; top:0;">
                                        <th class="sortable" data-sort="userId">User ID <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="resolvedName">Name <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="resolvedArea">Area Type <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="resolvedShift">Shift <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="startTime">Start Time <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort="durationVal">Duration <span class="sort-icon"></span></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tab-history" class="tab-content" style="display:none; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                        <div style="display:flex; gap:5px; align-items:center; justify-content:flex-end; margin-bottom:5px;">
                            <button id="ts-delete-selected-btn" class="icon-btn" title="Delete Selected" style="padding: 2px 6px; font-size: 12px; color:#d9534f; display:none;">Del Sel</button>
                            <button id="ts-purge-all-btn" class="icon-btn" title="Permanently Delete All Shown" style="padding: 2px 6px; font-size: 12px; background:#c0392b; color:white; border-color:#c0392b;">Purge All</button>
                            <button id="ts-export-btn" class="icon-btn" title="Export CSV" style="padding: 2px 6px; font-size: 12px;">Export</button>
                        </div>
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
                        <table id="history-table" class="report-table">
                            <thead>
                                <tr style="position:sticky; top:0;">
                                    <th style="width:30px;"><input type="checkbox" id="ts-select-all"></th>
                                    <th class="sortable" data-sort="userId">User ID <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="resolvedName">Name <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="resolvedArea">Area Type <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="resolvedShift">Shift <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="startTime">Start Time <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="endTime">End Time <span class="sort-icon"></span></th>
                                    <th class="sortable" data-sort="durationVal">Duration <span class="sort-icon"></span></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="ts-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; padding-top:5px; margin-top:5px; border-top: 1px solid #eee;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <label for="ts-rows-per-page" style="font-size:11px; color:#666;">Rows:</label>
                            <select id="ts-rows-per-page" style="padding: 2px 4px; font-size:11px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <span id="ts-page-info" style="font-size: 11px; font-weight: 600; color: #666;"></span>
                        <div style="display:flex; gap:5px;">
                            <button id="ts-prev-page" class="icon-btn" title="Previous" style="padding:2px 6px; font-size:12px;">‹</button>
                            <button id="ts-next-page" class="icon-btn" title="Next" style="padding:2px 6px; font-size:12px;">›</button>
                        </div>
                    </div>
                </div>

                <div id="tab-area-dashboard" class="tab-content" style="display:none; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                    <div id="area-dashboard-grid" style="display:flex; flex-direction:column; gap:15px; overflow-y:auto; height:100%;">
                        <!-- Cards will be injected here -->
                    </div>
                </div>

                <div id="tab-user-dashboard" class="tab-content" style="display:none; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                    <div id="user-dashboard-content" style="overflow-y:auto; height:100%;"></div>
                </div>

                <!-- Table 2: Inactive Users & Breaks -->
                <div class="card" style="margin:0; padding:0; display:flex; flex-direction:column; flex: 1; min-height: 0; border:1px solid #eee; box-shadow:none;">
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="openTsTab(event, 'tab-inactive')">Inactive Users</button>
                        <button class="tab-btn" onclick="openTsTab(event, 'tab-active-breaks')">Active Breaks</button>
                        <button class="tab-btn" onclick="openTsTab(event, 'tab-break-history')">Break History</button>
                    </div>

                    <div id="tab-inactive" class="tab-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                        <div style="display:flex; justify-content:flex-end; margin-bottom:5px;">
                            <button id="ts-export-inactive-btn" class="icon-btn" title="Export CSV" style="padding: 2px 6px; font-size: 12px;">Export</button>
                        </div>
                        <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
                            <table id="inactive-users-table" class="report-table">
                                <thead>
                                    <tr style="position:sticky; top:0;">
                                        <th style="cursor:pointer;" onclick="sortInactiveTable('userId')">User <span class="sort-icon"></span></th>
                                        <th style="cursor:pointer;" onclick="sortInactiveTable('name')">Name <span class="sort-icon"></span></th>
                                        <th style="cursor:pointer;" onclick="sortInactiveTable('shift')">Shift <span class="sort-icon"></span></th>
                                        <th style="cursor:pointer;" onclick="sortInactiveTable('role')">Role <span class="sort-icon"></span></th>
                                        <th style="cursor:pointer;" onclick="sortInactiveTable('lastEnd')">Last End Count <span class="sort-icon"></span></th>
                                        <th style="text-align:center; width:40px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tab-active-breaks" class="tab-content" style="display:none; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                        <div style="display:flex; gap:5px; align-items:center; margin-bottom:5px;">
                             <select id="break-shift-filter" style="padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; width: 80px;">
                                <option value="">All Shifts</option>
                                <option value="1st Shift">1st Shift</option>
                                <option value="2nd Shift">2nd Shift</option>
                                <option value="3rd Shift">3rd Shift</option>
                             </select>
                             <input type="datetime-local" id="manual-break-time" style="padding:4px; font-size:11px; border:1px solid #ccc; border-radius:4px; width:130px;" title="Manual Break Time">
                             <button id="btn-break-start" class="icon-btn" style="background:#f1c40f; color:white; padding:4px 8px; font-size:12px; font-weight:bold;">Start Break</button>
                             <button id="btn-break-end" class="icon-btn" style="background:#f39c12; color:white; padding:4px 8px; font-size:12px; font-weight:bold;">End Break</button>
                        </div>
                        <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
                            <table id="active-break-table" class="report-table">
                                <thead>
                                    <tr style="position:sticky; top:0;">
                                        <th>User</th>
                                        <th>Name</th>
                                        <th>Shift</th>
                                        <th>Role</th>
                                        <th>Break Out</th>
                                        <th>Duration</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tab-break-history" class="tab-content" style="display:none; flex-direction:column; flex:1; overflow:hidden; padding:10px;">
                        <div style="display:flex; gap:5px; align-items:center; justify-content:flex-end; margin-bottom:5px;">
                             <button id="break-delete-selected-btn" class="icon-btn" title="Delete Selected" style="color:#d9534f; padding:4px 8px; font-size:12px; font-weight:bold; display:none;">Del Sel</button>
                             <button id="break-export-btn" class="icon-btn" title="Export CSV" style="padding:4px 8px; font-size:12px; font-weight:bold;">Export</button>
                             <button id="btn-break-delete-all" class="icon-btn" title="Delete All Breaks" style="color:#d9534f; padding:4px 8px; font-size:12px; font-weight:bold; margin-left:5px;">🗑 All</button>
                        </div>
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee;">
                        <table id="history-break-table" class="report-table">
                            <thead>
                                <tr style="position:sticky; top:0;">
                                    <th style="width:30px;"><input type="checkbox" id="break-select-all"></th>
                                    <th>User</th>
                                    <th>Name</th>
                                    <th>Shift</th>
                                    <th>Role</th>
                                    <th>Break Out</th>
                                    <th>Break In</th>
                                    <th>Duration</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>

           
        </div>

         <!-- Right Column: Hourly Output Chart + Analytics -->
            <div style="width: 50%; display:flex; flex-direction:column; border-left:1px solid #eee; padding-left:15px; padding-right:10px; gap:12px; overflow:hidden; min-width:350px;">
                
                <div style="display:flex; gap:10px; margin-left:10px;">
                    <button id="ts-open-user-master-btn" class="icon-btn" title="User Master" style="font-size:12px; padding:4px 8px; background:#f0f4f8; border:1px solid #ccc;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;margin-right:4px;vertical-align:text-bottom;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> User Master
                    </button>
                    <button id="ts-clear-logs-btn" class="icon-btn" title="Clear All Logs" style="font-size:12px; padding:4px 8px; background:#ffebee; color:#c62828; border:1px solid #ffcdd2;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;margin-right:4px;vertical-align:text-bottom;"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> Clear Logs
                    </button>
                </div>
                <!-- Hourly Output Chart Section -->
                <div class="card" style="margin:0; padding:10px; display:flex; flex-direction:column; border:1px solid #eee; box-shadow:none; flex-shrink:0; max-height:380px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <h4 style="margin:0; font-size:13px; color:#2752a7;" id="ts-hourly-chart-title">Hourly Output (Today)</h4>
                        <div style="display:flex; gap:5px;">
                            <button id="ts-hourly-chart-toggle-btn" class="icon-btn" title="Toggle View" style="font-size:10px; padding:3px 6px; border-radius:3px; cursor:pointer; border:1px solid #ccc; background:#f9f9f9;">View: Hourly</button>
                            <button id="ts-view-hourly-full-btn" class="icon-btn" title="View Full Report" style="background:#2752a7; color:white; font-size:10px; padding:3px 6px; border-radius:3px; cursor:pointer;">Full Report</button>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:5px; font-size:10px;">
                        <div style="display:flex; align-items:center;"><span style="width:8px; height:8px; background:rgba(54, 185, 204, 0.8); display:inline-block; margin-right:3px;"></span> 1st Shift</div>
                        <div style="display:flex; align-items:center;"><span style="width:8px; height:8px; background:rgba(246, 194, 62, 0.8); display:inline-block; margin-right:3px;"></span> 2nd Shift</div>
                        <div style="display:flex; align-items:center;"><span style="width:8px; height:8px; background:rgba(78, 115, 223, 0.8); display:inline-block; margin-right:3px;"></span> 3rd Shift</div>
                    </div>
                    <div style="flex:1; position:relative; width:100%; min-height:240px; border:1px solid #ddd; border-radius:4px; padding:5px; background:#fff; overflow:hidden;">
                        <canvas id="ts-hourly-chart" style="max-width:100%; max-height:100%;"></canvas>
                    </div>
                </div>

                <!-- Analytics Overview -->
                <div style="display:flex; flex-direction:column; flex:1; min-height:150px; padding:10px; background:#f9f9f9; border:1px solid #ddd; border-radius:6px; overflow:hidden;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; flex-shrink:0;">
                        <h4 style="margin:0; font-size:13px; color:#2752a7;">Analytics Overview</h4>
                        <input type="date" id="ts-analytics-date-filter" style="padding:3px 5px; border:1px solid #ccc; border-radius:3px; font-size:11px; color:#333; cursor:pointer;" title="Filter by Date">
                    </div>
                    <div id="ts-analytics-content" style="overflow-y:auto; flex:1; padding:8px; background:#fff; border:1px solid #ddd; border-radius:4px; font-size:12px;"></div>
                </div>
            </div>
    </div>
  </div>

  <!-- Start Count Area Selection Modal -->
  <div id="start-area-modal" class="modal hidden" style="z-index: 10015;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 150px auto; text-align: center;">
        <h3 style="margin-top:0">Select Area</h3>
        <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
            <div class="card area-card" data-bin-type="Reserved" style="cursor:pointer; padding:20px; border:2px solid #eee; width:120px; transition:all 0.2s;">
                <div style="font-size:30px;">📦</div>
                <div style="font-weight:bold; margin-top:10px;">Reserved Bin</div>
            </div>
            <div class="card area-card" data-bin-type="Pick Bin" style="cursor:pointer; padding:20px; border:2px solid #eee; width:120px; transition:all 0.2s;">
                <div style="font-size:30px;">🛒</div>
                <div style="font-weight:bold; margin-top:10px;">Pick Bin</div>
            </div>
        </div>
        <button id="cancel-start-area-btn" class="icon-btn" style="margin-top:20px; border:1px solid #ccc;">Cancel</button>
    </div>
  </div>

  <!-- Warehouse Area Selection Modal -->
  <div id="warehouse-area-modal" class="modal hidden" style="z-index: 10016;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 150px auto; text-align: center;">
        <h3 style="margin-top:0">Select Warehouse Area</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; justify-content:center; margin-top:20px;">
            <div class="card area-card" data-warehouse-area="Coldroom" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">❄️</div>
                <div style="font-weight:bold; margin-top:10px;">Coldroom</div>
            </div>
            <div class="card area-card" data-warehouse-area="Ecom 2" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">🌐</div>
                <div style="font-weight:bold; margin-top:10px;">Ecom 2</div>
            </div>
            <div class="card area-card" data-warehouse-area="Storage" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">🗄️</div>
                <div style="font-weight:bold; margin-top:10px;">Storage</div>
            </div>
            <div class="card area-card" data-warehouse-area="Pallet Picking" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">🏗️</div>
                <div style="font-weight:bold; margin-top:10px;">Pallet Picking</div>
            </div>
        </div>
        <button id="cancel-warehouse-area-btn" class="icon-btn" style="margin-top:20px; border:1px solid #ccc;">Back</button>
    </div>
  </div>

  <!-- Clear Logs Modal -->
  <div id="clear-logs-modal" class="modal hidden" style="z-index: 10030;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 150px auto;">
        <h3 style="margin-top:0">Clear Logs</h3>
        <p class="muted">Select Date and Shift to clear logs.</p>
        <div style="margin-bottom:15px;">
            <label for="clear-logs-date" style="font-weight:bold; display:block; margin-bottom:5px;">Date</label>
            <input type="date" id="clear-logs-date" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="margin-bottom:15px;">
            <label for="clear-logs-shift" style="font-weight:bold; display:block; margin-bottom:5px;">Shift</label>
            <select id="clear-logs-shift" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                <option value="All">All Shifts</option>
                <option value="1st Shift">1st Shift</option>
                <option value="2nd Shift">2nd Shift</option>
                <option value="3rd Shift">3rd Shift</option>
            </select>
        </div>
        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button id="cancel-clear-logs-btn" class="icon-btn" style="border:1px solid #ccc;">Cancel</button>
            <button id="confirm-clear-logs-btn" class="icon-btn" style="background:#d9534f; color:white;">Clear</button>
        </div>
    </div>
  </div>

  <!-- End Count Details Modal -->
  <div id="end-count-modal" class="modal hidden" style="z-index: 10010;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 300px; margin: 150px auto;">
        <h3 style="margin-top:0">End Count Details</h3>
        <div style="margin-bottom:10px;">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">Area Type:</label>
            <input type="text" id="ec-area-type" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; background-color: #f9f9f9;" readonly>
        </div>
        <div id="ec-pallet-group" style="margin-bottom:10px;">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">Pallets Completed:</label>
            <input type="number" id="ec-pallets" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="0" min="0">
        </div>
        <div style="margin-bottom:15px;">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">SKUs (Items) Counted:</label>
            <input type="number" id="ec-skus" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" placeholder="0" min="0">
        </div>
        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button id="ec-cancel-btn" class="icon-btn" style="border:1px solid #ccc;">Cancel</button>
            <button id="ec-save-btn" class="icon-btn" style="background:#2752a7; color:white;">Submit</button>
        </div>
    </div>
  </div>

  <!-- Warehouse Area Selection Modal -->
  <div id="warehouse-area-modal" class="modal hidden" style="z-index: 10016;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 500px; margin: 150px auto; text-align: center;">
        <h3 style="margin-top:0">Select Warehouse Area</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; justify-content:center; margin-top:20px;">
            <div class="card area-card" data-warehouse-area="Coldroom" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">🌡️</div>
                <div style="font-weight:bold; margin-top:10px;">Coldroom</div>
            </div>
            <div class="card area-card" data-warehouse-area="Ecom 2" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">🏢</div>
                <div style="font-weight:bold; margin-top:10px;">Ecom 2</div>
            </div>
            <div class="card area-card" data-warehouse-area="Storage" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">🏭</div>
                <div style="font-weight:bold; margin-top:10px;">Storage</div>
            </div>
            <div class="card area-card" data-warehouse-area="Pallet Picking" style="cursor:pointer; padding:20px; border:2px solid #eee; transition:all 0.2s;">
                <div style="font-size:30px;">🪵</div>
                <div style="font-weight:bold; margin-top:10px;">Pallet Picking</div>
            </div>
        </div>
        <button id="cancel-warehouse-area-btn" class="icon-btn" style="margin-top:20px; border:1px solid #ccc;">Back</button>
    </div>
  </div>

  <!-- Reports Selection Modal -->
  <div id="reports-modal" class="modal hidden" style="z-index: 10020;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 400px; margin: 100px auto; text-align: center;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">Select Report</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center; justify-content:center; background:#f9f9f9; padding:10px; border-radius:4px;">
            <div style="text-align:left;">
                <label style="font-size:11px; display:block; font-weight:bold;">From</label>
                <input type="date" id="rep-start-date" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:12px;">
            </div>
            <div style="text-align:left;">
                <label style="font-size:11px; display:block; font-weight:bold;">To</label>
                <input type="date" id="rep-end-date" style="padding:4px; border:1px solid #ccc; border-radius:4px; font-size:12px;">
            </div>
        </div>
        <div style="display:grid; gap:10px;">
            <button id="rep-sessions-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Counter Sessions (CSV)
            </button>
            <button id="rep-attendance-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Attendance List (CSV)
            </button>
            <button id="rep-breaklog-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Break Logs (CSV)
            </button>
            <button id="rep-daily-output-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                Daily Output Report (View)
            </button>
            <button id="rep-inactive-btn" class="icon-btn" style="justify-content:flex-start; padding:10px; width:100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:10px; width:18px; height:18px;"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                Inactive Users (CSV)
            </button>
        </div>
    </div>
  </div>

  <!-- User Master Modal -->
  <div id="user-master-modal" class="modal hidden" style="z-index: 10025;">
    <div class="modal-overlay"></div>
    <div class="modal-content card" style="max-width: 700px; margin: 50px auto; display:flex; flex-direction:column; max-height:85vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">User ID Master Data</h3>
            <button class="icon-btn close-modal">&times;</button>
        </div>
        
        <div class="tab-header" style="margin-bottom:15px;">
            <button class="tab-btn active master-role-tab" data-role="IC Support">IC Support</button>
            <button class="tab-btn master-role-tab" data-role="IC Back up">IC Back up</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 2fr 1fr auto; gap:10px; align-items:end; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
            <div>
                <label style="font-size:12px; font-weight:bold;">User ID</label>
                <input type="text" id="master-user-id" style="width:100%; padding:6px; text-transform:uppercase;" placeholder="ID">
            </div>
            <div>
                <label style="font-size:12px; font-weight:bold;">Name</label>
                <input type="text" id="master-user-name" style="width:100%; padding:6px; text-transform:uppercase;" placeholder="Name">
            </div>
            <div>
                <label style="font-size:12px; font-weight:bold;">Role</label>
                <select id="master-user-role" style="width:100%; padding:6px;">
                    <option value="IC Support">IC Support</option>
                    <option value="IC Back up">IC Back up</option>
                </select>
            </div>
            <button id="save-master-user-btn" class="icon-btn" style="background:#2752a7; color:white; height:32px;">Save</button>
        </div>

        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <input type="text" id="master-user-search" placeholder="Search..." style="padding:6px; border:1px solid #ccc; border-radius:4px;">
            <div style="display:flex; gap:5px;">
                <button id="print-master-users-btn" class="icon-btn" title="Print List">Print</button>
                <button id="import-master-users-btn" class="icon-btn" title="Import CSV">Import</button>
                <input type="file" id="import-master-users-file" accept=".csv" style="display:none;">
                <button id="export-master-users-btn" class="icon-btn" title="Export CSV">Export</button>
                <button id="delete-selected-master-users-btn" class="icon-btn" style="color:#d9534f; display:none;">Delete</button>
            </div>
        </div>

        <div class="sticky-table-container" style="flex:1; min-height:0;">
            <table id="master-users-table" class="report-table" style="width:100%;">
                <thead>
                    <tr>
                        <th style="width:30px;"><input type="checkbox" id="select-all-master-users"></th>
                        <th class="sortable" data-sort="userId">User ID <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort="name">Name <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort="role">Role <span class="sort-icon"></span></th>
                        <th style="width:60px;">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="master-users-pagination" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-top:1px solid #eee;">
            <div style="display:flex; align-items:center; gap:5px;">
                <label style="font-size:12px;">Rows:</label>
                <select id="master-users-rows" style="padding:2px; font-size:12px;">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <span id="master-users-page-info" style="font-size:12px; color:#666;"></span>
            <div style="display:flex; gap:5px;">
                <button id="master-users-prev" class="icon-btn" style="padding:2px 6px;">&lt;</button>
                <button id="master-users-next" class="icon-btn" style="padding:2px 6px;">&gt;</button>
            </div>
        </div>
    </div>
  </div>

  <div id="toast-notification" class="toast"></div>
  <script src="app.js"></script>
  <script>
    if(!sessionStorage.getItem('dms_auth_v1')) window.location.href = 'index.html';

    document.addEventListener('DOMContentLoaded', () => {
        let tsCurrentPage = 1;
        let tsItemsPerPage = 20;
        const countersForm = document.getElementById('daily-counters-form');
        const countersTableBody = document.querySelector('#daily-counters-table tbody');
        const cancelCounterEditBtn = document.getElementById('cancel-counter-edit-btn');
        const saveCounterBtn = document.getElementById('save-counter-btn');
        const archiveBtn = document.getElementById('archive-btn');
        const exportCountersBtn = document.getElementById('export-counters-btn');
        const dateInput = document.getElementById('counter-date');
        const rateInput = document.getElementById('counter-rate');
        const reqInput = document.getElementById('counter-required');
        const targetInput = document.getElementById('counter-target');
        const noteInput = document.getElementById('counter-note');
        
        const attendanceTableBody = document.querySelector('#attendance-table tbody');
        
        // Modal elements
        const attModal = document.getElementById('att-modal');
        const attForm = document.getElementById('att-modal-form');
        const addAttBtn = document.getElementById('add-att-btn');
        const exportAttBtn = document.getElementById('export-att-btn');
        const printAttBtn = document.getElementById('print-att-btn');
        const attSearchInput = document.getElementById('att-search');
        const attFilterRole = document.getElementById('att-filter-role');
        const attFilterArea = document.getElementById('att-filter-area');
        const countersSearchInput = document.getElementById('counters-search');
        const deleteSelectedCountersBtn = document.getElementById('delete-selected-counters-btn');
        const clearCountersFiltersBtn = document.getElementById('clear-counters-filters-btn');
        const globalStartDate = document.getElementById('global-start-date');
        const globalEndDate = document.getElementById('global-end-date');

        // Set default date filter to current operational day (6am-6am cycle)
        const currentOpDate = getShiftFromTimestamp(new Date()).date;
        if (globalStartDate && !globalStartDate.value) globalStartDate.value = currentOpDate;
        if (globalEndDate && !globalEndDate.value) globalEndDate.value = currentOpDate;

        
        // Sub Area elements
        const subAreaFilterBtn = document.getElementById('sub-area-filter-btn');
        const subAreaModal = document.getElementById('sub-area-modal');
        const subAreaList = document.getElementById('sub-area-list');
        const applySubAreaFilterBtn = document.getElementById('apply-sub-area-filter');
        
        // Monitor elements
        const monitorSubAreaBtn = document.getElementById('monitor-sub-area-btn');
        const subAreaMonitorModal = document.getElementById('sub-area-monitor-modal');
        const monitorSubAreaSelect = document.getElementById('monitor-sub-area-select');
        const rackingGrid = document.getElementById('racking-grid');
        const monitorBulkActions = document.getElementById('monitor-bulk-actions');
        const monitorFileActions = document.getElementById('monitor-file-actions');
        const monitorTemplateBtn = document.getElementById('monitor-template-btn');
        const monitorUploadBtn = document.getElementById('monitor-upload-btn');
        const monitorFileInput = document.getElementById('monitor-file-input');
        const bulkCountedBtn = document.getElementById('bulk-counted-btn');
        const bulkOngoingBtn = document.getElementById('bulk-ongoing-btn');
        const bulkUncountedBtn = document.getElementById('bulk-uncounted-btn');
        const bulkCopyNamesBtn = document.getElementById('bulk-copy-names-btn');
        const bulkPasteNamesBtn = document.getElementById('bulk-paste-names-btn');
        const bulkEmptyBtn = document.getElementById('bulk-empty-btn');
        const bulkEditBtn = document.getElementById('bulk-edit-btn');
        const monitorFilterStatus = document.getElementById('monitor-filter-status');
        const monitorSearchInput = document.getElementById('monitor-search-input');
        const monitorPrintBtn = document.getElementById('monitor-print-btn');
        const monitorExportBtn = document.getElementById('monitor-export-btn');
        const monitorSnapshotBtn = document.getElementById('monitor-snapshot-btn');
        
        const dailyOutputBtn = document.getElementById('daily-output-btn');
        const hourlyPrevBtn = document.getElementById('hourly-prev-shift-btn');
        const hourlyNextBtn = document.getElementById('hourly-next-shift-btn');
        const hourlyBackTimestampBtn = document.getElementById('hourly-back-timestamp-btn');
        
        // Reports Modal
        const reportsMenuBtn = document.getElementById('reports-menu-btn');
        const reportsModal = document.getElementById('reports-modal');
        const repAttendanceBtn = document.getElementById('rep-attendance-btn');
        const repBreaklogBtn = document.getElementById('rep-breaklog-btn');
        const repDailyOutputBtn = document.getElementById('rep-daily-output-btn');
        const repInactiveBtn = document.getElementById('rep-inactive-btn');
        const repSessionsBtn = document.getElementById('rep-sessions-btn');

        // User Master Logic
        const STORAGE_KEY_MASTER_USERS = 'ims_master_users_v1';
        const userMasterBtn = document.getElementById('user-master-btn');
        const userMasterModal = document.getElementById('user-master-modal');
        const masterUserTableBody = document.querySelector('#master-users-table tbody');
        const saveMasterUserBtn = document.getElementById('save-master-user-btn');
        const masterUserIdInput = document.getElementById('master-user-id');
        const masterUserNameInput = document.getElementById('master-user-name');
        const masterUserRoleInput = document.getElementById('master-user-role');
        const masterUserSearch = document.getElementById('master-user-search');
        const deleteSelectedMasterUsersBtn = document.getElementById('delete-selected-master-users-btn');
        const selectAllMasterUsers = document.getElementById('select-all-master-users');
        const importMasterUsersBtn = document.getElementById('import-master-users-btn');
        const importMasterUsersFile = document.getElementById('import-master-users-file');
        const exportMasterUsersBtn = document.getElementById('export-master-users-btn');
        const printMasterUsersBtn = document.getElementById('print-master-users-btn');
        
        let currentMasterRole = 'IC Support';
        let masterSortField = 'name';
        let masterSortDir = 'asc';
        let masterCurrentPage = 1;
        let masterRowsPerPage = 20;

        function getMasterUsers() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_MASTER_USERS) || '[]'); } catch(e) { return []; } }
        function saveMasterUsers(data) { localStorage.setItem(STORAGE_KEY_MASTER_USERS, JSON.stringify(data)); }

        function renderMasterUsers() {
            if(!masterUserTableBody) return;
            masterUserTableBody.innerHTML = '';
            let users = getMasterUsers();
            
            // Filter by Role Tab
            users = users.filter(u => u.role === currentMasterRole);

            const term = masterUserSearch ? masterUserSearch.value.toLowerCase() : '';
            if(term) {
                users = users.filter(u => u.userId.toLowerCase().includes(term) || u.name.toLowerCase().includes(term) || (u.role && u.role.toLowerCase().includes(term)));
            }
            
            // Sort
            users.sort((a,b) => {
                let valA = (a[masterSortField] || '').toLowerCase();
                let valB = (b[masterSortField] || '').toLowerCase();
                if (valA < valB) return masterSortDir === 'asc' ? -1 : 1;
                if (valA > valB) return masterSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Pagination
            const totalItems = users.length;
            const totalPages = Math.ceil(totalItems / masterRowsPerPage) || 1;
            if (masterCurrentPage > totalPages) masterCurrentPage = totalPages;
            if (masterCurrentPage < 1) masterCurrentPage = 1;
            
            const start = (masterCurrentPage - 1) * masterRowsPerPage;
            const paginatedUsers = users.slice(start, start + masterRowsPerPage);

            // Update Controls
            const pageInfo = document.getElementById('master-users-page-info');
            const prevBtn = document.getElementById('master-users-prev');
            const nextBtn = document.getElementById('master-users-next');
            
            if(pageInfo) pageInfo.textContent = `Page ${masterCurrentPage} of ${totalPages} (${totalItems} users)`;
            if(prevBtn) prevBtn.disabled = masterCurrentPage <= 1;
            if(nextBtn) nextBtn.disabled = masterCurrentPage >= totalPages;

            if(paginatedUsers.length === 0) {
                masterUserTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px; color:#999;">No users found.</td></tr>';
                return;
            }
            paginatedUsers.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input type="checkbox" class="master-user-checkbox" value="${u.userId}"></td><td>${u.userId}</td><td>${u.name}</td><td>${u.role || ''}</td><td><button class="icon-btn edit-master-user-btn" data-id="${u.userId}" title="Edit" style="padding:2px 6px;">✎</button></td>`;
                masterUserTableBody.appendChild(tr);
            });
            updateMasterUserDeleteBtn();
            
            // Update sort icons
            document.querySelectorAll('#master-users-table th.sortable .sort-icon').forEach(icon => icon.textContent = '');
            const activeHeader = document.querySelector(`#master-users-table th[data-sort="${masterSortField}"]`);
            if(activeHeader) {
                activeHeader.querySelector('.sort-icon').textContent = masterSortDir === 'asc' ? '↑' : '↓';
            }
        }

        function updateMasterUserDeleteBtn() {
            const count = document.querySelectorAll('.master-user-checkbox:checked').length;
            if(deleteSelectedMasterUsersBtn) deleteSelectedMasterUsersBtn.style.display = count > 0 ? 'inline-flex' : 'none';
        }

        if(userMasterBtn) {
            userMasterBtn.addEventListener('click', () => {
                userMasterModal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    setTimeout(renderMasterUsers, 10);
                });
            });
        }

        if(saveMasterUserBtn) {
            saveMasterUserBtn.addEventListener('click', () => {
                const id = masterUserIdInput.value.trim().toUpperCase();
                const name = masterUserNameInput.value.trim().toUpperCase();
                const role = masterUserRoleInput.value;
                if(!id || !name) { alert('User ID and Name are required.'); return; }
                let users = getMasterUsers();
                const existingIdx = users.findIndex(u => u.userId === id);
                if(existingIdx > -1) { users[existingIdx] = { userId: id, name, role }; showToast('User updated'); }
                else { users.push({ userId: id, name, role }); showToast('User added'); }
                saveMasterUsers(users);
                renderMasterUsers();
                masterUserIdInput.value = ''; masterUserNameInput.value = '';
            });
        }

        if(masterUserTableBody) {
            masterUserTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-master-user-btn');
                if(btn) {
                    const id = btn.dataset.id;
                    const users = getMasterUsers();
                    const user = users.find(u => u.userId === id);
                    if(user) { masterUserIdInput.value = user.userId; masterUserNameInput.value = user.name; masterUserRoleInput.value = user.role || 'IC Support'; }
                }
            });
            masterUserTableBody.addEventListener('change', (e) => { if(e.target.classList.contains('master-user-checkbox')) updateMasterUserDeleteBtn(); });
        }

        if(selectAllMasterUsers) {
            selectAllMasterUsers.addEventListener('change', (e) => {
                document.querySelectorAll('.master-user-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateMasterUserDeleteBtn();
            });
        }

        if(deleteSelectedMasterUsersBtn) {
            deleteSelectedMasterUsersBtn.addEventListener('click', () => {
                if(!confirm('Delete selected users?')) return;
                const selected = Array.from(document.querySelectorAll('.master-user-checkbox:checked')).map(cb => cb.value);
                let users = getMasterUsers();
                users = users.filter(u => !selected.includes(u.userId));
                saveMasterUsers(users);
                renderMasterUsers();
                showToast(`${selected.length} users deleted`);
            });
        }

        if(masterUserSearch) masterUserSearch.addEventListener('input', () => {
            masterCurrentPage = 1;
            renderMasterUsers();
        });

        if(exportMasterUsersBtn) {
            exportMasterUsersBtn.addEventListener('click', () => {
                const users = getMasterUsers();
                if(users.length === 0) { alert('No users to export'); return; }
                const rows = [['User ID', 'Name', 'Role']];
                users.forEach(u => rows.push([`"${u.userId}"`, `"${u.name}"`, `"${u.role||''}"`].join(',')));
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'master_users.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });
        }

        if(printMasterUsersBtn) {
            printMasterUsersBtn.addEventListener('click', () => {
                const users = getMasterUsers().filter(u => u.role === currentMasterRole);
                users.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                
                const now = new Date();
                const shiftInfo = getShiftFromTimestamp(now.toISOString());
                
                const printWindow = window.open('', '_blank');
                let html = `<html><head><title>User Master List</title>`;
                html += `<style>body{font-family:sans-serif; font-size:12px;} table{width:100%;border-collapse:collapse;margin-top:10px;} th,td{border:1px solid #ccc;padding:6px;text-align:left;} th{background:#f0f0f0;} h2{margin-bottom:5px;}</style>`;
                html += `</head><body>`;
                html += `<h2>User Master List - ${currentMasterRole}</h2>`;
                html += `<p><strong>Date:</strong> ${now.toLocaleDateString()} &nbsp;&nbsp; <strong>Time:</strong> ${now.toLocaleTimeString()} &nbsp;&nbsp; <strong>Shift:</strong> ${shiftInfo.shift}</p>`;
                html += `<table><thead><tr><th>User ID</th><th>Name</th><th>Role</th><th style="width:150px;">Signature</th></tr></thead><tbody>`;
                
                users.forEach(u => {
                    html += `<tr><td>${u.userId}</td><td>${u.name}</td><td>${u.role || ''}</td><td></td></tr>`;
                });
                
                html += `</tbody></table>`;
                html += `<script>window.onload = function() { window.print(); window.close(); }<\/script>`;
                html += `</body></html>`;
                
                printWindow.document.write(html);
                printWindow.document.close();
            });
        }

        if(importMasterUsersBtn) importMasterUsersBtn.addEventListener('click', () => importMasterUsersFile.click());

        if(importMasterUsersFile) {
            importMasterUsersFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                window.showLoading && window.showLoading();
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const text = ev.target.result;
                        const lines = text.split(/\r?\n/);
                        if(lines.length < 2) { showToast('Invalid CSV file.', 'error'); window.hideLoading && window.hideLoading(); return; }
                        let users = getMasterUsers();
                        let count = 0;
                        for(let i=1; i<lines.length; i++) {
                            const line = lines[i].trim();
                            if(!line) continue;
                            const parts = line.split(',').map(p => p.replace(/^"|"$/g, '').trim());
                            if(parts.length >= 2) {
                                const id = parts[0]; const name = parts[1]; const role = parts[2] || '';
                                if(id && name) {
                                    const idx = users.findIndex(u => u.userId === id);
                                    if(idx > -1) users[idx] = { userId: id, name, role };
                                    else users.push({ userId: id, name, role });
                                    count++;
                                }
                            }
                        }
                        saveMasterUsers(users);
                        renderMasterUsers();
                        showToast(`Imported/Updated ${count} users.`);
                        importMasterUsersFile.value = '';
                    } catch (err) {
                        showToast('Failed to import users. Please check file format.', 'error');
                    } finally {
                        window.hideLoading && window.hideLoading();
                    }
                };
                reader.onerror = () => {
                    window.hideLoading && window.hideLoading();
                    showToast('Failed to read the file.', 'error');
                };
                reader.readAsText(file);
            });
        }

        // User Master Tabs
        document.querySelectorAll('.master-role-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.master-role-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentMasterRole = tab.dataset.role;
                masterCurrentPage = 1;
                renderMasterUsers();
            });
        });

        // Master User Sorting
        document.querySelectorAll('#master-users-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (masterSortField === field) {
                    masterSortDir = masterSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    masterSortField = field;
                    masterSortDir = 'asc';
                }
                renderMasterUsers();
            });
        });

        // Pagination Listeners
        const masterPrevBtn = document.getElementById('master-users-prev');
        const masterNextBtn = document.getElementById('master-users-next');
        const masterRowsSelect = document.getElementById('master-users-rows');

        if(masterPrevBtn) masterPrevBtn.addEventListener('click', () => {
            if(masterCurrentPage > 1) { masterCurrentPage--; renderMasterUsers(); }
        });
        if(masterNextBtn) masterNextBtn.addEventListener('click', () => {
            masterCurrentPage++; renderMasterUsers();
        });
        if(masterRowsSelect) masterRowsSelect.addEventListener('change', () => {
            masterRowsPerPage = parseInt(masterRowsSelect.value);
            masterCurrentPage = 1;
            renderMasterUsers();
        });

        // Timestamp Modal
        let cachedInactiveArgs = null;
        let inactiveSort = { field: 'status', dir: 'asc' };

        window.sortInactiveTable = function(field) {
            if (inactiveSort.field === field) {
                inactiveSort.dir = inactiveSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                inactiveSort.field = field;
                inactiveSort.dir = 'asc';
            }
            if (cachedInactiveArgs) renderInactiveUsersTable(...cachedInactiveArgs);
        };

        const timestampBtn = document.getElementById('counter-timestamp-btn');
        const timestampModal = document.getElementById('timestamp-modal');
        const tsUserIdInput = document.getElementById('ts-user-id');
        const btnStartCount = document.getElementById('btn-start-count');
        const btnBreakStart = document.getElementById('btn-break-start');
        const btnBreakEnd = document.getElementById('btn-break-end');
        const btnTimeOut = document.getElementById('btn-time-out');
        const btnEndCount = document.getElementById('btn-end-count');
        const tsExportBtn = document.getElementById('ts-export-btn');
        const tsFilterUser = document.getElementById('ts-filter-user');
        const tsShiftFilter = document.getElementById('ts-shift-filter');
        const tsExportInactiveBtn = document.getElementById('ts-export-inactive-btn');
        const tsPurgeAllBtn = document.getElementById('ts-purge-all-btn');
        const tsDeleteSelectedBtn = document.getElementById('ts-delete-selected-btn');
        const tsSelectAll = document.getElementById('ts-select-all');
        const tsShowLongActive = document.getElementById('ts-show-long-active');
        const tsAnalyticsDateFilter = document.getElementById('ts-analytics-date-filter');

        const tsOpenUserMasterBtn = document.getElementById('ts-open-user-master-btn');
        if(tsOpenUserMasterBtn) {
            tsOpenUserMasterBtn.addEventListener('click', () => {
                userMasterModal.classList.remove('hidden');
                requestAnimationFrame(() => setTimeout(renderMasterUsers, 10));
            });
        }

        const tsClearLogsBtn = document.getElementById('ts-clear-logs-btn');
        const clearLogsModal = document.getElementById('clear-logs-modal');
        const cancelClearLogsBtn = document.getElementById('cancel-clear-logs-btn');
        const confirmClearLogsBtn = document.getElementById('confirm-clear-logs-btn');
        const clearLogsDateInput = document.getElementById('clear-logs-date');
        const clearLogsShiftSelect = document.getElementById('clear-logs-shift');

        if(tsClearLogsBtn) {
            tsClearLogsBtn.addEventListener('click', () => {
                if (clearLogsModal) {
                    clearLogsDateInput.value = new Date().toISOString().split('T')[0];
                    clearLogsModal.classList.remove('hidden');
                }
            });
        }

        if (cancelClearLogsBtn) {
            cancelClearLogsBtn.addEventListener('click', () => {
                clearLogsModal.classList.add('hidden');
            });
        }

        if (confirmClearLogsBtn) {
            confirmClearLogsBtn.addEventListener('click', () => {
                const dateVal = clearLogsDateInput.value;
                const shiftVal = clearLogsShiftSelect.value;
                if (!dateVal) { alert('Please select a date.'); return; }
                if (!confirm(`Are you sure you want to clear logs for ${dateVal} (${shiftVal})? This cannot be undone.`)) return;

                let data = getTimestamps();
                const initialCount = data.length;
                data = data.filter(log => {
                    const info = getShiftFromTimestamp(log.timestamp);
                    if (info.date !== dateVal) return true;
                    if (shiftVal !== 'All' && !info.shift.includes(shiftVal)) return true;
                    return false;
                });
                const deletedCount = initialCount - data.length;
                saveTimestamps(data);
                renderTimestamps();
                showToast(`Cleared ${deletedCount} logs.`);
                clearLogsModal.classList.add('hidden');
            });
        }

        const tsViewHourlyFullBtn = document.getElementById('ts-view-hourly-full-btn');
        if (tsViewHourlyFullBtn) {
            tsViewHourlyFullBtn.addEventListener('click', () => {
                const date = document.getElementById('ts-analytics-date-filter').value || new Date().toISOString().split('T')[0];
                openHourlyModal(date, "1st Shift-(6am-2pm)");
            });
        }

        const tsHourlyChartToggleBtn = document.getElementById('ts-hourly-chart-toggle-btn');
        if (tsHourlyChartToggleBtn) {
            tsHourlyChartToggleBtn.addEventListener('click', () => {
                tsHourlyChartViewMode = tsHourlyChartViewMode === 'hourly' ? 'cumulative' : 'hourly';
                tsHourlyChartToggleBtn.textContent = tsHourlyChartViewMode === 'hourly' ? 'View: Hourly' : 'View: Cumulative';
                const date = document.getElementById('ts-analytics-date-filter').value || new Date().toISOString().split('T')[0];
                renderTsHourlyChart(date);
            });
        }
        
       

        // End Count Modal Elements
        const endCountModal = document.getElementById('end-count-modal');
        const ecAreaType = document.getElementById('ec-area-type');
        const ecPalletGroup = document.getElementById('ec-pallet-group');
        const ecSaveBtn = document.getElementById('ec-save-btn');
        const ecCancelBtn = document.getElementById('ec-cancel-btn');

        const breakDeleteSelectedBtn = document.getElementById('break-delete-selected-btn');
        const breakExportBtn = document.getElementById('break-export-btn');
        const breakSelectAll = document.getElementById('break-select-all');
        const breakShiftFilter = document.getElementById('break-shift-filter');

        const editTimeModal = document.getElementById('edit-time-modal');
        const cancelEditTimeBtn = document.getElementById('cancel-edit-time-btn');
        const saveEditTimeBtn = document.getElementById('save-edit-time-btn');

        if (cancelEditTimeBtn) cancelEditTimeBtn.addEventListener('click', () => editTimeModal.classList.add('hidden'));

        if (saveEditTimeBtn) {
            saveEditTimeBtn.addEventListener('click', () => {
                const logId = document.getElementById('edit-time-log-id').value;
                const newTimeValue = document.getElementById('edit-time-input').value;
                if (!logId || !newTimeValue) return;

                const newTimestamp = new Date(newTimeValue).toISOString();
                const data = getTimestamps();
                const logIndex = data.findIndex(d => d.id === logId);
                if (logIndex > -1) {
                    data[logIndex].timestamp = newTimestamp;
                    saveTimestamps(data);
                    renderTimestamps();
                    showToast('Timestamp updated successfully!');
                    editTimeModal.classList.add('hidden');
                }
            });
        }

        const activeTableBody = document.querySelector('#active-table tbody');
        const historyTableBody = document.querySelector('#history-table tbody');

        if (activeTableBody) {
            activeTableBody.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('editable-time')) {
                    openEditTimeModal(target.dataset.logId);
                }
            });
        }
        if (historyTableBody) {
            historyTableBody.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('editable-time')) {
                    openEditTimeModal(target.dataset.logId);
                }
            });
        }
        // Start Area Modal Logic
        const startAreaModal = document.getElementById('start-area-modal');
        const warehouseAreaModal = document.getElementById('warehouse-area-modal');
        const cancelStartAreaBtn = document.getElementById('cancel-start-area-btn');
        const cancelWarehouseAreaBtn = document.getElementById('cancel-warehouse-area-btn');
        let selectedBinType = '';
        
        document.querySelectorAll('#start-area-modal .area-card').forEach(card => {
            card.addEventListener('click', () => {
                selectedBinType = card.dataset.binType;
                startAreaModal.classList.add('hidden');
                
                // Hide Pallet Picking if Reserved Bin is selected
                const palletCard = document.querySelector('#warehouse-area-modal .area-card[data-warehouse-area="Pallet Picking"]');
                if(palletCard) {
                    palletCard.style.display = (selectedBinType === 'Reserved') ? 'none' : 'block';
                }

                if(warehouseAreaModal) warehouseAreaModal.classList.remove('hidden');
                else logTimestamp('Start', selectedBinType);
            });
        });

        document.querySelectorAll('#warehouse-area-modal .area-card').forEach(card => {
            card.addEventListener('click', () => {
                const warehouseArea = card.dataset.warehouseArea;
                const finalArea = `${selectedBinType} - ${warehouseArea}`;
                warehouseAreaModal.classList.add('hidden');
                logTimestamp('Start', finalArea);
            });
        });
        
        if(cancelStartAreaBtn) cancelStartAreaBtn.addEventListener('click', () => startAreaModal.classList.add('hidden'));
        if(cancelWarehouseAreaBtn) cancelWarehouseAreaBtn.addEventListener('click', () => {
            warehouseAreaModal.classList.add('hidden');
            startAreaModal.classList.remove('hidden');
        });

        // Reports Modal Logic
        if(reportsMenuBtn) {
            reportsMenuBtn.addEventListener('click', () => {
                reportsModal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        // Set default dates if empty
                        if(!document.getElementById('rep-start-date').value) {
                            document.getElementById('rep-start-date').value = new Date().toISOString().split('T')[0];
                        }
                        if(!document.getElementById('rep-end-date').value) {
                            document.getElementById('rep-end-date').value = new Date().toISOString().split('T')[0];
                        }
                    }, 10);
                });
            });
        }
        
        if(repAttendanceBtn) {
            repAttendanceBtn.addEventListener('click', () => {
                const startVal = document.getElementById('rep-start-date').value;
                const endVal = document.getElementById('rep-end-date').value;
                const start = startVal ? new Date(startVal) : null;
                if(start) start.setHours(0,0,0,0);
                const end = endVal ? new Date(endVal) : null;
                if(end) end.setHours(23,59,59,999);

                let data = getAttendanceData();
                if(start || end) {
                    data = data.filter(item => {
                        const d = new Date(item.date);
                        return (!start || d >= start) && (!end || d <= end);
                    });
                }
                exportAttendanceCSV(data);
                reportsModal.classList.add('hidden');
            });
        }
        
        if(repDailyOutputBtn) {
            repDailyOutputBtn.addEventListener('click', () => {
                if(dailyOutputBtn) dailyOutputBtn.click();
                reportsModal.classList.add('hidden');
            });
        }
        
        if(repInactiveBtn) {
            repInactiveBtn.addEventListener('click', () => {
                if(tsExportInactiveBtn) tsExportInactiveBtn.click();
                reportsModal.classList.add('hidden');
            });
        }
        
        if(repBreaklogBtn) {
            repBreaklogBtn.addEventListener('click', () => {
                const startVal = document.getElementById('rep-start-date').value;
                const endVal = document.getElementById('rep-end-date').value;
                const start = startVal ? new Date(startVal) : null;
                if(start) start.setHours(0,0,0,0);
                const end = endVal ? new Date(endVal) : null;
                if(end) end.setHours(23,59,59,999);

                const logs = getTimestamps();
                const attendance = getAttendanceData();
                // Filter logs for breaks
                const breaks = [];
                const openBreaks = {};
                logs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                logs.forEach(log => {
                    const d = new Date(log.timestamp);
                    if(start && d < start) return;
                    if(end && d > end) return;

                    if (log.userId && !log.deleted) {
                        if (log.action === 'Start Break') openBreaks[log.userId] = log;
                        else if (log.action === 'End Break' && openBreaks[log.userId]) {
                            breaks.push({ userId: log.userId, start: openBreaks[log.userId].timestamp, end: log.timestamp });
                            delete openBreaks[log.userId];
                        }
                    }
                });
                // Add open breaks
                Object.keys(openBreaks).forEach(uid => {
                     breaks.push({ userId: uid, start: openBreaks[uid].timestamp, end: null });
                });
                
                if(breaks.length === 0) { alert('No breaks to export.'); return; }
                
                const csvRows = [['User', 'Name', 'Shift', 'Role', 'Break Out', 'Break In', 'Duration']];
                breaks.forEach(b => {
                    const att = attendance.find(a => a.userId === b.userId) || {};
                    const name = att.name || '-';
                    const shift = att.shift ? att.shift.split('-')[0] : '-';
                    const role = att.role || '-';
                    const start = new Date(b.start).toLocaleTimeString();
                    const end = b.end ? new Date(b.end).toLocaleTimeString() : '-';
                    
                    let duration = '-';
                    if(b.end) {
                        const diff = new Date(b.end) - new Date(b.start);
                        duration = Math.floor(diff/60000) + ' min';
                    }
                    
                    csvRows.push([
                        `"${b.userId}"`, `"${name}"`, `"${shift}"`, `"${role}"`, `"${start}"`, `"${end}"`, `"${duration}"`
                    ].join(','));
                });
                
                const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'break_log_report.csv';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                
                reportsModal.classList.add('hidden');
            });
        }

        if(repSessionsBtn) {
            repSessionsBtn.addEventListener('click', () => {
                const startVal = document.getElementById('rep-start-date').value;
                const endVal = document.getElementById('rep-end-date').value;
                const start = startVal ? new Date(startVal) : null;
                if(start) start.setHours(0,0,0,0);
                const end = endVal ? new Date(endVal) : null;
                if(end) end.setHours(23,59,59,999);

                let data = getTimestamps();
                const attendance = getAttendanceData();

                // Reconstruct sessions
                data.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                const sessions = [];
                const openSessions = {};
                
                data.forEach(log => {
                    if (log.deleted) return;
                    // Filter by date range based on log timestamp
                    const d = new Date(log.timestamp);
                    if(start && d < start) return;
                    if(end && d > end) return;

                    if (log.action === 'Start') {
                        if (openSessions[log.userId]) sessions.push(openSessions[log.userId]);
                        openSessions[log.userId] = { userId: log.userId, startLog: log, endLog: null, breaks: [] };
                    } else if (log.action === 'Start Break') {
                        if (openSessions[log.userId]) openSessions[log.userId].currentBreakStart = log;
                    } else if (log.action === 'End Break') {
                        if (openSessions[log.userId] && openSessions[log.userId].currentBreakStart) {
                            const bStart = new Date(openSessions[log.userId].currentBreakStart.timestamp);
                            const bEnd = new Date(log.timestamp);
                            openSessions[log.userId].breaks.push({ duration: (bEnd - bStart)/60000 });
                            openSessions[log.userId].currentBreakStart = null;
                        }
                    } else if (log.action === 'End') {
                        if (openSessions[log.userId]) {
                            const session = openSessions[log.userId];
                            session.endLog = log;
                            sessions.push(session);
                            delete openSessions[log.userId];
                        } else {
                            sessions.push({ userId: log.userId, startLog: null, endLog: log, breaks: [] });
                        }
                    }
                });
                Object.values(openSessions).forEach(s => sessions.push(s));

                if(sessions.length === 0) { alert('No sessions found in selected range.'); return; }
                
                const headers = ['User ID', 'Name', 'Area Type', 'Shift', 'Start Time', 'End Time', 'Duration', 'Status', 'Pallets', 'SKUs'];
                const rows = [headers.join(',')];
                
                sessions.forEach(s => {
                    const ts = s.startLog ? s.startLog.timestamp : (s.endLog ? s.endLog.timestamp : null);
                    let sessionDate = ts ? new Date(ts).toISOString().split('T')[0] : '';
                    let attRecord = attendance.find(a => a.userId === s.userId && a.date === sessionDate);
                    if (!attRecord) attRecord = attendance.find(a => a.userId === s.userId);
                    
                    const name = attRecord ? attRecord.name : '';
                    let shift = attRecord ? attRecord.shift : (s.startLog ? getShiftFromTimestamp(s.startLog.timestamp).shift : '');
                    const area = s.startLog ? (s.startLog.areaType || '-') : '-';

                    const startStr = s.startLog ? new Date(s.startLog.timestamp).toLocaleString() : '-';
                    const endStr = s.endLog ? new Date(s.endLog.timestamp).toLocaleString() : '-';
                    const pallets = s.endLog ? (s.endLog.pallets || 0) : 0;
                    const skus = s.endLog ? (s.endLog.skus || 0) : 0;
                    
                    let duration = '-';
                    const totalBreakMins = s.breaks ? s.breaks.reduce((acc, b) => acc + b.duration, 0) : 0;
                    if (s.startLog && s.endLog) {
                        const diff = new Date(s.endLog.timestamp) - new Date(s.startLog.timestamp);
                        const mins = Math.round((diff / 60000) - totalBreakMins);
                        duration = `${mins} min`;
                    } else if (s.startLog) {
                        const diff = new Date() - new Date(s.startLog.timestamp);
                        duration = `Active (${Math.floor(diff/60000)}m)`;
                    }

                    rows.push([`"${s.userId}"`, `"${name}"`, `"${area}"`, `"${shift}"`, `"${startStr}"`, `"${endStr}"`, `"${duration}"`, s.endLog ? 'Completed' : 'Active', pallets, skus].join(','));
                });
                
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url; link.download = 'counter_sessions_report.csv';
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                reportsModal.classList.add('hidden');
            });
        }

        // Counters Flip Logic
        const countersFlipContainer = document.getElementById('counters-flip-container');
        if(countersFlipContainer) {
            document.getElementById('counters-flip-to-summary').addEventListener('click', () => { countersFlipContainer.classList.add('flipped'); renderCountersSummary(); });
            document.getElementById('counters-flip-to-table').addEventListener('click', () => countersFlipContainer.classList.remove('flipped'));
        }
        
        // Hourly Modal
        const hourlyModal = document.getElementById('hourly-modal');
        const snapshotModal = document.getElementById('snapshot-modal');
        const snapshotContainer = document.getElementById('snapshot-container');
        const snapshotShareBtn = document.getElementById('snapshot-share-btn');
        const snapshotDownloadBtn = document.getElementById('snapshot-download-btn');
        let currentSnapshotBlob = null;
        const supervisorDeleteModal = document.getElementById('supervisor-delete-modal');
        const confirmSupervisorDeleteBtn = document.getElementById('confirm-supervisor-delete-btn');
        let supervisorDeleteCallback = null;
        let hourlyChart = null;
        let monitorDashboardChart = null;
        let timestampChart = null;
        let tsHourlyChart = null;

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            if (toast) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }

        const STORAGE_KEY_COUNTERS = 'ims_daily_counters_v1';
        const STORAGE_KEY_ATTENDANCE = 'ims_daily_counters_attendance_v1';
        const STORAGE_KEY_CC = 'ims_cycle_count_v1';
        const STORAGE_KEY_TIMESTAMPS = 'ims_counter_timestamps_v1';

        
        // State Persistence: Load saved state or defaults
        const UI_STATE_KEY = 'ims_daily_counters_ui_state_v1';
        let uiState = {};
        try { uiState = JSON.parse(sessionStorage.getItem(UI_STATE_KEY) || '{}'); } catch(e) {}

        let showArchiveOnly = uiState.showArchiveOnly || false;
        let attCurrentPage = uiState.attCurrentPage || 1;
        let attItemsPerPage = 20;
        let countersCurrentPage = uiState.countersCurrentPage || 1;
        let countersItemsPerPage = 7;
        let attSortField = 'date';
        let attSortDirection = 'desc';
        let tsSortField = 'startTime';
        let tsSortDirection = 'desc';
        let tsFilterArea = null;
        let tsBreakFilterLong = false;

        // Restore Filters & Button State
        if(uiState.globalStartDate && globalStartDate) globalStartDate.value = uiState.globalStartDate;
        if(uiState.globalEndDate && globalEndDate) globalEndDate.value = uiState.globalEndDate;
        if(showArchiveOnly && archiveBtn) {
            archiveBtn.classList.add('active-filter');
            archiveBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 14 4 9 9 4"></polyline><path d="M20 20v-7a4 4 0 0 0-4-4H4"></path></svg> Back to Active`;
        }

        // Save State on Unload/Refresh
        window.addEventListener('beforeunload', () => {
            const state = {
                showArchiveOnly,
                attCurrentPage,
                countersCurrentPage,
                globalStartDate: globalStartDate ? globalStartDate.value : '',
                globalEndDate: globalEndDate ? globalEndDate.value : ''
            };
            sessionStorage.setItem(UI_STATE_KEY, JSON.stringify(state));
        });
        
        let globalSubAreas = []; // Selected sub areas for filtering
        const subAreaOptions = ['DCI', 'DCJ', 'DCK', 'DCL', 'DCM', 'DCN', 'DCO'];
        
        // Sub Area Configurations (Width x Levels)
        const subAreaConfigs = {
            'DCI': { 
                type: 'multi',
                blocks: [
                    { width: 23, levels: 6, prefix: 'DCI002', rowBase: 20, rowStep: 10 },
                    { width: 23, levels: 6, prefix: 'DCI004', rowBase: 20, rowStep: 10 }
                ],
                floor: { width: 23, levels: 2, prefix: 'DCI-FLOOR' }
            },
            'DCJ': { 
                type: 'multi',
                blocks: [
                    { width: 23, levels: 6, prefix: 'DCJ002', rowBase: 20, rowStep: 10 },
                    { width: 23, levels: 6, prefix: 'DCJ004', rowBase: 20, rowStep: 10 }
                ],
                floor: { width: 23, levels: 2, prefix: 'DCJ-FLOOR' }
            },
            'DCK': { 
                type: 'multi',
                blocks: [
                    { width: 23, levels: 6, prefix: 'DCK002', rowBase: 20, rowStep: 10 },
                    { width: 23, levels: 6, prefix: 'DCK004', rowBase: 20, rowStep: 10 }
                ],
                floor: { width: 23, levels: 2, prefix: 'DCK-FLOOR' }
            },
            'DCL': { 
                type: 'multi',
                blocks: [
                    { width: 23, levels: 6, prefix: 'DCL002', rowBase: 20, rowStep: 10 },
                    { width: 23, levels: 6, prefix: 'DCL004', rowBase: 20, rowStep: 10 }
                ],
                floor: { width: 23, levels: 2, prefix: 'DCL-FLOOR' }
            },
            'DCM': { 
                type: 'multi',
                blocks: [
                    { width: 23, levels: 6, prefix: 'DCM002', rowBase: 20, rowStep: 10 },
                    { width: 23, levels: 6, prefix: 'DCM004', rowBase: 20, rowStep: 10 }
                ],
                floor: { width: 23, levels: 2, prefix: 'DCM-FLOOR' }
            },
            'DCN': { 
                type: 'multi',
                blocks: [
                    { width: 23, levels: 6, prefix: 'DCN002', rowBase: 20, rowStep: 10 },
                    { width: 23, levels: 6, prefix: 'DCN004', rowBase: 20, rowStep: 10 }
                ],
                floor: { width: 23, levels: 2, prefix: 'DCN-FLOOR' }
            },
            'DCO': { 
                type: 'multi',
                blocks: [
                    { width: 23, levels: 6, prefix: 'DCO002', rowBase: 20, rowStep: 10 },
                    { width: 23, levels: 6, prefix: 'DCO004', rowBase: 20, rowStep: 10 }
                ],
                floor: { width: 23, levels: 2, prefix: 'DCO-FLOOR' }
            }
        };
        
        const monitorSelectedCells = new Set();

        // Helper to set local date
        function setLocalDate(input) {
            if (!input) return;
            const now = new Date();
            const local = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
            input.value = local.toISOString().split('T')[0];
        }

        // Set default date
        setLocalDate(dateInput);

        // Auto-calc logic (Bidirectional)
        let lastEditedField = 'req'; // default

        if (reqInput) reqInput.addEventListener('focus', () => lastEditedField = 'req');
        if (targetInput) targetInput.addEventListener('focus', () => lastEditedField = 'target');

        function performAutoCalc(source) {
            const req = parseInt(reqInput.value) || 0;
            const rate = parseInt(rateInput.value) || 0;
            const target = parseInt(targetInput.value) || 0;

            if (source === 'req') {
                if (req > 0 && rate > 0) targetInput.value = req * rate;
                lastEditedField = 'req';
            } else if (source === 'target') {
                if (target > 0 && rate > 0) reqInput.value = Math.ceil(target / rate);
                lastEditedField = 'target';
            } else if (source === 'rate') {
                if (lastEditedField === 'target') {
                    if (target > 0 && rate > 0) reqInput.value = Math.ceil(target / rate);
                } else {
                    if (req > 0 && rate > 0) targetInput.value = req * rate;
                }
            }
        }

        if(reqInput) reqInput.addEventListener('input', () => performAutoCalc('req'));
        if(targetInput) targetInput.addEventListener('input', () => performAutoCalc('target'));
        if(rateInput) rateInput.addEventListener('input', () => performAutoCalc('rate'));

        // Global functions for hover popup
        window.showSummaryPopup = function(el) {
            const popup = document.getElementById('summary-hover-popup');
            const content = document.getElementById('summary-popup-content');
            if(popup && content) {
                content.innerHTML = el.innerHTML;
                popup.style.display = 'block';
            }
        };
        window.hideSummaryPopup = function() {
            const popup = document.getElementById('summary-hover-popup');
            if(popup) popup.style.display = 'none';
        };

        function getCountersData() {
            try {
                const d = JSON.parse(localStorage.getItem(STORAGE_KEY_COUNTERS) || '[]');
                return Array.isArray(d) ? d : [];
            } catch (e) {
                console.error('Error parsing daily counters data', e);
                return [];
            }
        }

        function saveCountersData(data) {
            localStorage.setItem(STORAGE_KEY_COUNTERS, JSON.stringify(data));
        }

        function getAttendanceData() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY_ATTENDANCE) || '[]');
            } catch (e) {
                return [];
            }
        }

        function getMasterUsers() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_MASTER_USERS) || '[]'); } catch(e) { return []; }
        }

        function saveAttendanceData(data) {
            localStorage.setItem(STORAGE_KEY_ATTENDANCE, JSON.stringify(data));
        }

        function renderCountersTable() {
            if (!countersTableBody) return;
            let data = getCountersData();
            const attendance = getAttendanceData();
            
            // Load actuals for badge calculation
            let cycleCounts = [];
            try { cycleCounts = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]'); } catch(e){}
            const actualsMap = {};
            cycleCounts.forEach(c => {
                const ts = c.createdDate || c.date;
                if(ts) {
                    const info = getShiftFromTimestamp(ts);
                    if (!info.date || !info.shift) return;
                    const key = `${info.date}|${info.shift}`;
                    actualsMap[key] = (actualsMap[key] || 0) + 1;
                }
            });
            
            if (showArchiveOnly) {
                const today = new Date().toISOString().split('T')[0];
                data = data.filter(d => d.date < today);
                data = data.filter(d => d.archived === true || d.date < today);
            } else {
                // Show active (not archived)
                // But wait, user wants to manually archive.
                data = data.filter(d => !d.archived);
            }
            
            const searchTerm = countersSearchInput ? countersSearchInput.value.toLowerCase() : '';
            if (searchTerm) {
                const userIdsWithMatch = new Set(
                    attendance
                        .filter(a => a.userId && a.userId.toLowerCase().includes(searchTerm))
                        .map(a => `${a.date}|${a.shift}`)
                );

                data = data.filter(item => 
                    (item.date && item.date.toLowerCase().includes(searchTerm)) || 
                    (item.shift && item.shift.toLowerCase().includes(searchTerm)) ||
                    (item.note && item.note.toLowerCase().includes(searchTerm)) ||
                    userIdsWithMatch.has(`${item.date}|${item.shift}`)
                );
            }

            // Global Date Filter
            if (globalStartDate.value || globalEndDate.value) {
                const start = globalStartDate.value ? new Date(globalStartDate.value) : null;
                if (start) start.setHours(0,0,0,0);
                const end = globalEndDate.value ? new Date(globalEndDate.value) : null;
                if (end) end.setHours(23,59,59,999);

                data = data.filter(item => {
                    const itemDate = new Date(item.date);
                    return (!start || itemDate >= start) && (!end || itemDate <= end);
                });
            }
            
            // Group by Date
            const grouped = {};
            data.forEach(item => {
                if (!grouped[item.date]) grouped[item.date] = {};
                grouped[item.date][item.shift] = item;
            });
            
            const dates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            
            // Pagination for Counters
            const totalItems = dates.length;
            const totalPages = Math.ceil(totalItems / countersItemsPerPage) || 1;
            if (countersCurrentPage > totalPages) countersCurrentPage = totalPages;
            
            const paginatedDates = dates.slice((countersCurrentPage - 1) * countersItemsPerPage, countersCurrentPage * countersItemsPerPage);
            
            const countersPageInfo = document.getElementById('counters-page-info');
            if(countersPageInfo) {
                countersPageInfo.textContent = `Page ${countersCurrentPage} of ${totalPages} (${totalItems} dates)`;
                document.getElementById('counters-prev-page').disabled = countersCurrentPage <= 1;
                document.getElementById('counters-next-page').disabled = countersCurrentPage >= totalPages;
            }

            countersTableBody.innerHTML = '';
            if (paginatedDates.length === 0) {
                countersTableBody.innerHTML = `<tr><td colspan="5" class="muted" style="text-align:center; padding: 20px;">No daily counter records found.</td></tr>`;
                return;
            }
            
            const shifts = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
            
            paginatedDates.forEach(date => {
                const tr = document.createElement('tr');
                const isPast = new Date(date) < new Date(new Date().toISOString().split('T')[0]);
                const archiveAction = isPast && !showArchiveOnly ? `<button class="icon-btn btn-archive-row" onclick="archiveDate('${date}')" title="Archive Date" style="margin-left:5px; padding:2px 6px; font-size:10px;">Archive</button>` : '';
                
                let html = `<td style="padding:12px;border-bottom:1px solid #eee;"><input type="checkbox" class="counter-row-checkbox" data-date="${date}"></td><td style="padding:12px;border-bottom:1px solid #eee; font-weight:bold;">${date}</td>`;
                
                shifts.forEach(shift => {
                    const item = grouped[date][shift];
                    if (item) {
                        const req = Number(item.required) || 1;
                        // Automatically count only "Cycle Counter" attendance for daily counters
                        // let shiftAtt = attendance.filter(a => a.date === date && a.shift === shift && a.area === 'Cycle Counter');
                        // Automatically count all attendance for daily counters
                        let shiftAtt = attendance.filter(a => a.date === date && a.shift === shift);
                        
                        // Exclude 'Temporary slide to Other task' from Actual count
                        shiftAtt = shiftAtt.filter(a => a.status !== 'Temporary slide to Other task');
                        
                        const act = shiftAtt.length;
                        const pct = Math.round((act / req) * 100);
                        
                        // Calculate dynamic target based on active counters if rate exists
                        const rate = item.standardRate || 0;
                        const activeTarget = rate > 0 ? (act * rate) : (item.targetOutput || 0);
                        
                        // Calculate actual output for this shift
                        let actualOutput = 0;
                        if (item.hourlyActuals) {
                            actualOutput = Object.values(item.hourlyActuals).reduce((a, b) => a + (Number(b)||0), 0);
                        } else {
                            actualOutput = actualsMap[`${date}|${shift}`] || 0;
                        }
                        
                        let effectiveTarget = activeTarget;
                        let isCustomTarget = false;
                        if (item.hourlyTargets && Object.keys(item.hourlyTargets).length > 0) {
                            effectiveTarget = Object.values(item.hourlyTargets).reduce((a, b) => a + (Number(b)||0), 0);
                            isCustomTarget = true;
                        }
                        
                        let varianceHtml = '';
                        if (effectiveTarget > 0 || isCustomTarget) {
                            const customIcon = isCustomTarget ? `<span class="hourly-btn" data-date="${date}" data-shift="${shift}" title="Custom Hourly Targets Active - Click to Edit" style="font-size:12px; margin-left:3px; cursor:pointer;">⚙️</span>` : '';
                            varianceHtml = customIcon;
                        }
                        
                        // Visual indicator for shortage
                        const isShort = act < req;
                        const shortIndicator = isShort ? `<span title="Shortage: ${req - act}" style="color:#e74c3c; margin-left:5px; cursor:help;">⚠️</span>` : '';
                        
                        // Breakdowns
                        const areaCounts = {};
                        const roleCounts = {};
                        shiftAtt.forEach(a => {
                            if(a.area) areaCounts[a.area] = (areaCounts[a.area] || 0) + 1;
                            if(a.role) roleCounts[a.role] = (roleCounts[a.role] || 0) + 1;
                        });
                        const areaStr = Object.entries(areaCounts).map(([k,v]) => `${k}: ${v}`).join(', ');
                        const roleStr = Object.entries(roleCounts).map(([k,v]) => `${k}: ${v}`).join(', ');

                        let pctClass = 'completion-low';
                        if(pct >= 100) pctClass = 'completion-high';
                        else if(pct >= 80) pctClass = 'completion-med';
                        
                        html += `
                        <td style="padding:12px;border-bottom:1px solid #eee; vertical-align:top;">
                            <div class="shift-summary-content" onmouseenter="window.showSummaryPopup(this)" onmouseleave="window.hideSummaryPopup()">
                                <div style="font-size:13px; margin-bottom:4px;">Req: <strong>${req}</strong> | Act: <strong>${act}</strong> ${shortIndicator} ${varianceHtml}</div>
                                ${rate > 0 ? `<div style="font-size:12px; color:#2752a7; margin-bottom:4px;">Target (Act): <strong>${activeTarget}</strong> <span class="muted" style="font-size:11px">(@${rate}/p)</span></div>` : ''}
                                <div class="${pctClass}" style="margin-top:4px; margin-bottom:6px;">${pct}% Completed</div>
                                ${item.note ? `<div style="font-size:11px; color:#555; margin-bottom:4px; font-style:italic; background:#f8f9fa; padding:2px 4px; border-radius:3px;">Note: ${item.note}</div>` : ''}
                                ${areaStr ? `<div style="font-size:11px; color:#666; margin-bottom:2px;"><strong>Area:</strong> ${areaStr}</div>` : ''}
                                ${roleStr ? `<div style="font-size:11px; color:#666; margin-bottom:4px;"><strong>Role:</strong> ${roleStr}</div>` : ''}
                            </div>
                            <div class="action-buttons-container" style="margin-top:6px;">
                                <button class="icon-btn edit-counter-btn" data-id="${item.id}" title="Edit" style="padding:2px 6px; font-size:12px;">✎</button>
                                <button class="icon-btn duplicate-counter-btn" data-id="${item.id}" title="Duplicate to Next Day" style="padding:2px 6px; font-size:12px;">📋</button>
                                <button class="icon-btn hourly-btn" data-date="${date}" data-shift="${shift}" title="Hourly Monitor" style="padding:2px 6px; font-size:12px; background:#6f42c1; color:white; border:none;">Hourly</button>
                                <button class="icon-btn duplicate-all-shifts-btn" data-id="${item.id}" title="Copy to All Shifts" style="padding:2px 6px; font-size:12px; background:#17a2b8; color:white; border:none;">📑</button>
                                <button class="icon-btn delete-counter-btn" data-id="${item.id}" title="Delete" style="padding:2px 6px; font-size:12px; color:#d9534f;">&times;</button>
                            </div>
                        </td>`;
                    } else {
                        html += `<td style="padding:12px;border-bottom:1px solid #eee; color:#ccc;">-</td>`;
                    }
                });
                html += `<td style="padding:12px;border-bottom:1px solid #eee;">${archiveAction}</td>`;
                tr.innerHTML = html;
                countersTableBody.appendChild(tr);
            });
            setTimeout(fixTooltips, 0);
        }

        window.archiveDate = function(date) {
            if(!confirm(`Archive all counters for ${date}?`)) return;
            let data = getCountersData();
            data.forEach(d => {
                if(d.date === date) d.archived = true;
            });
            saveCountersData(data);
            renderCountersTable();
            renderAttendanceTable(); // Refresh attendance if needed
        }

        if (countersTableBody) {
            countersTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('counter-row-checkbox')) {
                    const selectedCount = document.querySelectorAll('.counter-row-checkbox:checked').length;
                    if (deleteSelectedCountersBtn) {
                        deleteSelectedCountersBtn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
                    }
                }
            });
        }

        // Counters Pagination Listeners
        const countersPaginationControls = document.getElementById('counters-pagination-controls');
        if (countersPaginationControls) {
            countersPaginationControls.addEventListener('click', (e) => {
                if (e.target.id === 'counters-prev-page' && !e.target.disabled) {
                    countersCurrentPage--;
                    renderCountersTable();
                } else if (e.target.id === 'counters-next-page' && !e.target.disabled) {
                    countersCurrentPage++;
                    renderCountersTable();
                }
            });
            const countersRowsPerPageSelect = document.getElementById('counters-rows-per-page');
            if (countersRowsPerPageSelect) {
                countersRowsPerPageSelect.addEventListener('change', () => {
                    countersItemsPerPage = parseInt(countersRowsPerPageSelect.value, 10);
                    countersCurrentPage = 1;
                    renderCountersTable();
                });
            }
        }

        if (countersSearchInput) {
            countersSearchInput.addEventListener('input', () => {
                countersCurrentPage = 1;
                renderCountersTable();
            });
        }

        const selectAllCounters = document.getElementById('select-all-counters');
        if (selectAllCounters) {
            selectAllCounters.addEventListener('change', (e) => {
                document.querySelectorAll('.counter-row-checkbox').forEach(cb => cb.checked = e.target.checked);
                if (deleteSelectedCountersBtn) deleteSelectedCountersBtn.style.display = e.target.checked ? 'inline-flex' : 'none';
            });
        }

        if (clearCountersFiltersBtn) {
            clearCountersFiltersBtn.addEventListener('click', () => {
                if (countersSearchInput) countersSearchInput.value = '';
                showArchiveOnly = false;
                if (archiveBtn) archiveBtn.classList.remove('active-filter');
                countersCurrentPage = 1;
                renderCountersTable();
            });
        }

        // Daily Counters Actions (Edit, Delete, Duplicate)
        if (countersTableBody) {
            countersTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;

                if (btn.classList.contains('delete-counter-btn')) {
                    if(confirm('Delete this record?')) {
                        let data = getCountersData();
                        data = data.filter(item => item.id !== id);
                        saveCountersData(data);
                        renderCountersTable();
                    }
                } else if (btn.classList.contains('edit-counter-btn')) {
                    const data = getCountersData();
                    const item = data.find(i => i.id === id);
                    if (item) {
                        document.getElementById('counter-edit-id').value = item.id;
                        document.getElementById('counter-date').value = item.date;
                        document.getElementById('counter-shift').value = item.shift;
                        document.getElementById('counter-required').value = item.required;
                        document.getElementById('counter-rate').value = item.standardRate || '';
                        document.getElementById('counter-target').value = item.targetOutput || '';
                        document.getElementById('counter-note').value = item.note || '';
                        
                        saveCounterBtn.innerHTML = 'Update';
                        cancelCounterEditBtn.style.display = 'inline-flex';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                } else if (btn.classList.contains('duplicate-counter-btn')) {
                    const data = getCountersData();
                    const item = data.find(i => i.id === id);
                    if (item) {
                        const d = new Date(item.date);
                        d.setDate(d.getDate() + 1);
                        const nextDate = d.toISOString().split('T')[0];
                        
                        const exists = data.find(x => x.date === nextDate && x.shift === item.shift);
                        if (exists) {
                            alert(`An entry for ${nextDate} - ${item.shift} already exists. Duplicate skipped.`);
                            return;
                        }
                        
                        const newItem = { ...item, id: Date.now().toString(), date: nextDate, hourlyActuals: {} };
                        data.push(newItem);
                        saveCountersData(data);
                        renderCountersTable();
                        alert(`Duplicated entry to ${nextDate}`);
                    }
                } else if (btn.classList.contains('duplicate-all-shifts-btn')) {
                    const data = getCountersData();
                    const item = data.find(i => i.id === id);
                    if (item) {
                        if(!confirm('Copy this entry to all other shifts for ' + item.date + '?')) return;
                        const shifts = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
                        let added = false;
                        shifts.forEach(s => {
                            if (s !== item.shift) {
                                const exists = data.find(x => x.date === item.date && x.shift === s);
                                if (!exists) {
                                    const newItem = { ...item, id: Date.now().toString() + Math.random(), shift: s, hourlyActuals: {}, hourlyTargets: {}, hourlyPallets: {}, hourlyNotes: {} };
                                    data.push(newItem);
                                    added = true;
                                }
                            }
                        });
                        if (added) {
                            saveCountersData(data);
                            renderCountersTable();
                            showToast('Copied to all shifts');
                        } else {
                            alert('All shifts already exist for this date.');
                        }
                    }
                }
            });
        }

        // Hourly Monitor Logic
        if (countersTableBody) {
            countersTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('.hourly-btn');
                if (btn) {
                    const date = btn.dataset.date;
                    const shift = btn.dataset.shift;
                    openHourlyModal(date, shift);
                }
            });
        }

        let hourlyChartViewMode = 'hourly';

        function openHourlyModal(dateStr, shift) {
             const tsModal = document.getElementById('timestamp-modal');
             if(tsModal) {
                 tsModal.classList.add('hidden');
                 sessionStorage.removeItem('ims_timestamp_modal_open');
             }

             document.getElementById('hourly-modal-title').textContent = `Hourly Output: ${dateStr} (${shift.split('-')[0]})`;
             hourlyModal.classList.remove('hidden');
             document.getElementById('hourly-date-val').value = dateStr;
             document.getElementById('hourly-shift-val').value = shift;

             // Update toggle button text
             const toggleBtn = document.getElementById('hourly-chart-toggle-btn');
             if(toggleBtn) toggleBtn.textContent = hourlyChartViewMode === 'hourly' ? 'View: Hourly' : 'View: Cumulative';
             
             // Find the counter entry to get the main target
             const counters = getCountersData();
             const counterEntry = counters.find(c => c.date === dateStr && c.shift === shift);
             
             // Determine time range
             const start = new Date(dateStr);
             const end = new Date(dateStr);
             
             if (shift.includes('1st Shift')) {
                 start.setHours(6,0,0,0); end.setHours(14,0,0,0);
             } else if (shift.includes('2nd Shift')) {
                 start.setHours(14,0,0,0); end.setHours(22,0,0,0);
             } else { // 3rd Shift
                 start.setHours(22,0,0,0); 
                 end.setDate(end.getDate() + 1); end.setHours(6,0,0,0);
             }
 
             // Fetch and filter data
             let cycleCounts = [];
             try { cycleCounts = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]'); } catch(e){}
             
             const hourlyDetailsContainer = document.getElementById('hourly-details');
             hourlyDetailsContainer.innerHTML = '';
             let hourlyDetailsHtml = `
             <table class="excel-table" id="hourly-table">
                <thead>
                    <tr>
                        <th style="text-align:left;">Hour</th>
                        <th>Pallet Act</th>
                        <th>Actual (Items)</th>
                        <th>Target</th>
                        <th>Variance</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>`;

             const hourlyData = {};
             const hourlyTargets = {};
             
             // Calculate default hourly target based on active target (rate * attendance or targetOutput)
             const attendance = getAttendanceData();
             const shiftAtt = attendance.filter(a => a.date === dateStr && a.shift === shift);
             const act = shiftAtt.length;
             const rate = (counterEntry && counterEntry.standardRate) || 0;
             const activeTarget = rate > 0 ? (act * rate) : ((counterEntry && counterEntry.targetOutput) || 0);
             const defaultHourlyTarget = activeTarget > 0 ? Math.round(activeTarget / 8) : 0;
             
             const savedActuals = counterEntry && counterEntry.hourlyActuals ? counterEntry.hourlyActuals : null;
             let totalAct = 0;
             let totalTgt = 0;
             let totalPallet = 0;
             const savedPallets = counterEntry && counterEntry.hourlyPallets ? counterEntry.hourlyPallets : {};
             const savedNotes = counterEntry && counterEntry.hourlyNotes ? counterEntry.hourlyNotes : {};

             // Initialize hours
             for (let d = new Date(start); d < end; d.setHours(d.getHours() + 1)) {
                 const h = d.getHours();
                 const label = `${h}:00 - ${h+1}:00`;
                 
                 if (savedActuals && savedActuals[label] !== undefined) {
                     hourlyData[label] = savedActuals[label];
                 } else {
                     hourlyData[label] = 0;
                 }
                 
                 // Use saved hourly target or default
                 const savedTarget = counterEntry && counterEntry.hourlyTargets && counterEntry.hourlyTargets[label];
                 
                 // Dynamic Target Calculation based on attendance time
                 let activeCount = 0;
                 if (savedTarget !== undefined) {
                     hourlyTargets[label] = savedTarget;
                 } else if (rate > 0) {
                     shiftAtt.forEach(p => {
                         if (!p.timeIn) { activeCount++; } 
                         else {
                             const [ph, pm] = p.timeIn.split(':').map(Number);
                             // Simple check: if they clocked in before the end of this hour slot
                             let pDate = new Date(start);
                             if (shift.includes('3rd') && ph < 12) pDate.setDate(pDate.getDate() + 1);
                             pDate.setHours(ph, pm, 0, 0);
                             
                             // If they arrived before or during this hour (e.g. before next hour starts)
                             const nextHour = new Date(d); nextHour.setHours(d.getHours() + 1);
                             if (pDate < nextHour) activeCount++;
                         }
                     });
                     hourlyTargets[label] = activeCount * rate;
                 } else {
                     hourlyTargets[label] = defaultHourlyTarget;
                 }
             }
 
             // Only calculate from cycleCounts if no manual actuals are saved
             if (!savedActuals) {
                 cycleCounts.forEach(c => {
                     const ts = c.createdDate || c.date;
                     if (ts) {
                         const d = new Date(ts);
                         if (d >= start && d < end) {
                             const h = d.getHours();
                             const label = `${h}:00 - ${h+1}:00`;
                             if (hourlyData.hasOwnProperty(label)) hourlyData[label]++;
                         }
                     }
                 });
             }
 
             // Build details table and populate targets
             Object.keys(hourlyData).forEach(label => {
                const act = hourlyData[label] || 0;
                const tgt = hourlyTargets[label] || 0;
                const pallet = savedPallets[label] || 0;
                const note = savedNotes[label] || '';
                const variance = act - tgt;
                const varColor = variance >= 0 ? '#2ecc71' : '#e74c3c';
                const rowBg = variance < 0 ? 'background-color: #fff5f5;' : '';
                
                totalAct += act;
                totalTgt += tgt;
                totalPallet += (Number(pallet) || 0);

                hourlyDetailsHtml += `<tr class="hourly-row" style="${rowBg}">
                    <td style="text-align:left; font-weight:bold;">${label}</td>
                    <td><input type="number" class="hourly-pallet-input" data-hour="${label}" value="${pallet}"></td>
                    <td><input type="number" class="hourly-actual-input" data-hour="${label}" value="${act}"></td>
                    <td><input type="number" class="hourly-target-input" data-hour="${label}" value="${tgt}"></td>
                    <td class="hourly-variance" style="font-weight:bold; color:${varColor}">${(variance > 0 ? '+' : '') + variance}</td>
                    <td><input type="text" class="hourly-note-input" data-hour="${label}" value="${note}" placeholder="Notes"></td>
                </tr>`;
             });
             
             const totalVar = totalAct - totalTgt;
             const totalVarColor = totalVar >= 0 ? '#2ecc71' : '#e74c3c';
             hourlyDetailsHtml += `</tbody>
             <tfoot>
                <tr style="background-color:#f0f0f0; font-weight:bold;">
                    <td style="text-align:left;">Total</td>
                    <td id="hourly-total-pallet">${totalPallet}</td>
                    <td id="hourly-total-act">${totalAct}</td>
                    <td id="hourly-total-tgt">${totalTgt}</td>
                    <td id="hourly-total-var" style="color:${totalVarColor}">${(totalVar > 0 ? '+' : '') + totalVar}</td>
                    <td></td>
                </tr>
             </tfoot>
             </table>`;
             
             hourlyDetailsContainer.innerHTML = hourlyDetailsHtml;
             makeTableResizable(document.getElementById('hourly-table'));

             // Calculate cumulative data
             const hourlyValues = Object.values(hourlyData);
             const cumulativeData = [];
             let sum = 0;
             for (const value of hourlyValues) {
                 sum += value;
                 cumulativeData.push(sum);
             }

             const targetLineData = Object.values(hourlyTargets);

             // Calculate Glide Path (Cumulative Target)
             const glidePathData = [];
             let targetSum = 0;
             for (const val of targetLineData) {
                 targetSum += val;
                 glidePathData.push(targetSum);
             }
 
             const ctx = document.getElementById('hourly-chart');
             if (typeof Chart !== 'undefined') {
             if (hourlyChart) hourlyChart.destroy();
             hourlyChart = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: Object.keys(hourlyData),
                    datasets: [
                        { label: 'Hourly Output', data: hourlyValues, backgroundColor: '#36b9cc', order: 3, hidden: hourlyChartViewMode !== 'hourly' },
                        { label: 'Total Output', data: cumulativeData, type: 'line', borderColor: '#e74c3c', backgroundColor: 'transparent', tension: 0.1, yAxisID: 'y', order: 1, hidden: hourlyChartViewMode !== 'cumulative' },
                        { label: 'Glide Path', data: glidePathData, type: 'line', borderColor: '#27ae60', backgroundColor: 'transparent', tension: 0.1, yAxisID: 'y', borderDash: [5, 5], order: 2, hidden: hourlyChartViewMode !== 'cumulative' },
                        { label: 'Hourly Target', data: targetLineData, type: 'line', borderColor: '#3498db', backgroundColor: 'transparent', tension: 0.1, yAxisID: 'y', borderDash: [2, 2], borderWidth: 1, order: 4, hidden: hourlyChartViewMode !== 'hourly' }
                    ]
                 },
                 options: { 
                     responsive: true, maintainAspectRatio: false, 
                     scales: { y: { beginAtZero: true, title: { display: true, text: 'Items Counted' } } } 
                 }
             });
             }
        }
        window.openHourlyModal = openHourlyModal;

        const hourlyChartToggleBtn = document.getElementById('hourly-chart-toggle-btn');
        if (hourlyChartToggleBtn) {
            hourlyChartToggleBtn.addEventListener('click', () => {
                hourlyChartViewMode = hourlyChartViewMode === 'hourly' ? 'cumulative' : 'hourly';
                hourlyChartToggleBtn.textContent = hourlyChartViewMode === 'hourly' ? 'View: Hourly' : 'View: Cumulative';
                
                if (hourlyChart) {
                    // Toggle visibility based on mode
                    // 0: Hourly Output, 1: Total Output, 2: Glide Path, 3: Hourly Target
                    hourlyChart.getDatasetMeta(0).hidden = hourlyChartViewMode !== 'hourly';
                    hourlyChart.getDatasetMeta(3).hidden = hourlyChartViewMode !== 'hourly';
                    hourlyChart.getDatasetMeta(1).hidden = hourlyChartViewMode !== 'cumulative';
                    hourlyChart.getDatasetMeta(2).hidden = hourlyChartViewMode !== 'cumulative';
                    hourlyChart.update();
                }
            });
        }

        // Daily Output Modal Logic
        const dailyOutputModal = document.getElementById('daily-output-modal');
        let dailyOutputChart = null;

        if (dailyOutputBtn) {
            dailyOutputBtn.addEventListener('click', () => {
                dailyOutputModal.classList.remove('hidden');
                renderDailyOutput();
            });
        }

        function renderDailyOutput() {
            const counters = getCountersData();
            const attendance = getAttendanceData();
            
            // Load actuals map for fallback
            let cycleCounts = [];
            try { cycleCounts = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]'); } catch(e){}
            const actualsMap = {};
            cycleCounts.forEach(c => {
                const ts = c.createdDate || c.date;
                if(ts) {
                    const info = getShiftFromTimestamp(ts);
                    if (!info.date || !info.shift) return;
                    const key = `${info.date}|${info.shift}`;
                    actualsMap[key] = (actualsMap[key] || 0) + 1;
                }
            });

            // Aggregate by Date
            const dailyData = {};

            counters.forEach(item => {
                const date = item.date;
                if (!dailyData[date]) dailyData[date] = { output: 0, target: 0 };

                // Calculate Actual
                let act = 0;
                if (item.hourlyActuals) {
                    act = Object.values(item.hourlyActuals).reduce((a, b) => a + (Number(b)||0), 0);
                } else {
                    act = actualsMap[`${date}|${item.shift}`] || 0;
                }
                dailyData[date].output += act;

                // Calculate Target
                // Automatically count only "Cycle Counter" attendance for daily counters
                // let shiftAtt = attendance.filter(a => a.date === item.date && a.shift === item.shift && a.area === 'Cycle Counter');
                // Automatically count all attendance for daily counters
                let shiftAtt = attendance.filter(a => a.date === item.date && a.shift === item.shift);
                shiftAtt = shiftAtt.filter(a => a.status !== 'Temporary slide to Other task');
                const headcount = shiftAtt.length;
                
                const rate = Number(item.standardRate) || 0;
                let target = 0;
                
                if (item.hourlyTargets && Object.keys(item.hourlyTargets).length > 0) {
                    target = Object.values(item.hourlyTargets).reduce((a, b) => a + (Number(b)||0), 0);
                } else {
                    target = rate > 0 ? (headcount * rate) : (Number(item.targetOutput) || 0);
                }
                
                dailyData[date].target += target;
            });

            const sortedDates = Object.keys(dailyData).sort();
            const labels = [];
            const outputs = [];
            const targets = [];

            const tbody = document.querySelector('#daily-output-table tbody');
            tbody.innerHTML = '';

            sortedDates.forEach(date => {
                const d = dailyData[date];
                labels.push(date);
                outputs.push(d.output);
                targets.push(d.target);

                const variance = d.output - d.target;
                const varColor = variance >= 0 ? '#2ecc71' : '#e74c3c';
                const pct = d.target > 0 ? Math.round((d.output / d.target) * 100) : (d.output > 0 ? 100 : 0);

                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="text-align:left;">${date}</td><td>${d.output}</td><td>${d.target}</td><td style="color:${varColor}; font-weight:bold;">${(variance > 0 ? '+' : '') + variance}</td><td>${pct}%</td>`;
                tbody.appendChild(tr);
            });

            const ctx = document.getElementById('daily-output-chart');
            if (dailyOutputChart) dailyOutputChart.destroy();
            
            dailyOutputChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Total Output', data: outputs, backgroundColor: '#3498db', order: 2 },
                        { label: 'Target', data: targets, type: 'line', borderColor: '#e74c3c', backgroundColor: 'transparent', borderDash: [5, 5], tension: 0.1, order: 1 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        // Hourly Navigation Logic
        const shiftOrder = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
        if(hourlyPrevBtn) {
            hourlyPrevBtn.addEventListener('click', () => {
                const date = document.getElementById('hourly-date-val').value;
                const currentShift = document.getElementById('hourly-shift-val').value;
                let idx = shiftOrder.indexOf(currentShift);
                if(idx === -1) return;
                let prevIdx = idx - 1;
                if(prevIdx < 0) prevIdx = shiftOrder.length - 1;
                openHourlyModal(date, shiftOrder[prevIdx]);
            });
        }
        if(hourlyNextBtn) {
            hourlyNextBtn.addEventListener('click', () => {
                const date = document.getElementById('hourly-date-val').value;
                const currentShift = document.getElementById('hourly-shift-val').value;
                let idx = shiftOrder.indexOf(currentShift);
                if(idx === -1) return;
                let nextIdx = idx + 1;
                if(nextIdx >= shiftOrder.length) nextIdx = 0;
                openHourlyModal(date, shiftOrder[nextIdx]);
            });
        }

        if(hourlyBackTimestampBtn) {
            hourlyBackTimestampBtn.addEventListener('click', () => {
                hourlyModal.classList.add('hidden');
                timestampModal.classList.remove('hidden');
                sessionStorage.setItem('ims_timestamp_modal_open', 'true');
            });
        }

        // Table Column Resizing Logic
        function makeTableResizable(table) {
            if(!table) return;
            const cols = table.querySelectorAll('th');
            cols.forEach(col => {
                const resizer = document.createElement('div');
                resizer.classList.add('resizer');
                col.appendChild(resizer);
                createResizableColumn(col, resizer);
            });
        }

        function createResizableColumn(col, resizer) {
            let x = 0;
            let w = 0;
            const mouseDownHandler = function(e) {
                x = e.clientX;
                const styles = window.getComputedStyle(col);
                w = parseInt(styles.width, 10);
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                resizer.classList.add('resizing');
            };
            const mouseMoveHandler = function(e) {
                const dx = e.clientX - x;
                col.style.width = `${w + dx}px`;
            };
            const mouseUpHandler = function() {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                resizer.classList.remove('resizing');
            };
            resizer.addEventListener('mousedown', mouseDownHandler);
        }

        // Make Hourly Modal Draggable
        const hourlyModalContent = document.querySelector('#hourly-modal .modal-content');
        const hourlyModalHeader = document.getElementById('hourly-header-bar'); // The header div
        if(hourlyModalContent && hourlyModalHeader) {
            hourlyModalHeader.style.cursor = 'move';
            hourlyModalHeader.addEventListener('mousedown', function(e) {
                // Only drag if clicking the header background or title, not buttons
                if(e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                
                e.preventDefault();
                const startX = e.clientX;
                const startY = e.clientY;
                const rect = hourlyModalContent.getBoundingClientRect();
                
                // Remove transform centering to allow absolute positioning
                hourlyModalContent.style.transform = 'none';
                hourlyModalContent.style.left = rect.left + 'px';
                hourlyModalContent.style.top = rect.top + 'px';
                hourlyModalContent.style.margin = '0';
                
                const onMouseMove = (e) => {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    hourlyModalContent.style.left = (rect.left + dx) + 'px';
                    hourlyModalContent.style.top = (rect.top + dy) + 'px';
                };
                
                const onMouseUp = () => {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        // Dynamic Variance Calculation
        const hourlyDetailsDiv = document.getElementById('hourly-details');
        if (hourlyDetailsDiv) {
            hourlyDetailsDiv.addEventListener('input', (e) => {
                if (e.target.classList.contains('hourly-actual-input') || e.target.classList.contains('hourly-target-input') || e.target.classList.contains('hourly-pallet-input')) {
                    const row = e.target.closest('tr');
                    const act = parseInt(row.querySelector('.hourly-actual-input').value) || 0;
                    const tgt = parseInt(row.querySelector('.hourly-target-input').value) || 0;
                    const variance = act - tgt;
                    const varDiv = row.querySelector('.hourly-variance');
                    varDiv.textContent = (variance > 0 ? '+' : '') + variance;
                    varDiv.style.color = variance >= 0 ? '#2ecc71' : '#e74c3c';
                    
                    // Update row highlight
                    row.style.backgroundColor = variance < 0 ? '#fff5f5' : '';
                    
                    // Update totals
                    let tAct = 0, tTgt = 0, tPallet = 0;
                    hourlyDetailsDiv.querySelectorAll('.hourly-actual-input').forEach(i => tAct += (parseInt(i.value)||0));
                    hourlyDetailsDiv.querySelectorAll('.hourly-target-input').forEach(i => tTgt += (parseInt(i.value)||0));
                    hourlyDetailsDiv.querySelectorAll('.hourly-pallet-input').forEach(i => tPallet += (parseInt(i.value)||0));
                    const tVar = tAct - tTgt;
                    
                    document.getElementById('hourly-total-act').textContent = tAct;
                    document.getElementById('hourly-total-tgt').textContent = tTgt;
                    const tPalletDiv = document.getElementById('hourly-total-pallet');
                    if(tPalletDiv) tPalletDiv.textContent = tPallet;
                    const tVarDiv = document.getElementById('hourly-total-var');
                    if(tVarDiv) {
                        tVarDiv.textContent = (tVar > 0 ? '+' : '') + tVar;
                        tVarDiv.style.color = tVar >= 0 ? '#2ecc71' : '#e74c3c';
                    }
                    
                    // Update Chart Real-time
                    if (hourlyChart) {
                        const rows = document.querySelectorAll('#hourly-details .hourly-row');
                        const actuals = [];
                        const targets = [];
                        const cumulative = [];
                        const glidePath = [];
                        let actSum = 0;
                        let tgtSum = 0;
                        
                        rows.forEach(r => {
                            const aIn = r.querySelector('.hourly-actual-input');
                            const tIn = r.querySelector('.hourly-target-input');
                            if (aIn && tIn) {
                                const aVal = parseInt(aIn.value) || 0;
                                const tVal = parseInt(tIn.value) || 0;
                                actuals.push(aVal);
                                targets.push(tVal);
                                actSum += aVal;
                                tgtSum += tVal;
                                cumulative.push(actSum);
                                glidePath.push(tgtSum);
                            }
                        });
                        
                        if (hourlyChart.data.datasets[0]) hourlyChart.data.datasets[0].data = actuals;
                        if (hourlyChart.data.datasets[1]) hourlyChart.data.datasets[1].data = cumulative;
                        if (hourlyChart.data.datasets[2]) hourlyChart.data.datasets[2].data = glidePath;
                        if (hourlyChart.data.datasets[3]) hourlyChart.data.datasets[3].data = targets;
                        hourlyChart.update('none');
                    }
                }
            });
        }

        // Save Hourly Targets
        const saveHourlyTargetsBtn = document.getElementById('save-hourly-targets-btn');
        if (saveHourlyTargetsBtn) {
            saveHourlyTargetsBtn.addEventListener('click', () => {
                const dateStr = document.getElementById('hourly-date-val').value;
                const shift = document.getElementById('hourly-shift-val').value;

                const counters = getCountersData();
                const counterIndex = counters.findIndex(c => c.date === dateStr && c.shift === shift);

                if (counterIndex > -1) {
                    if (!counters[counterIndex].hourlyTargets) counters[counterIndex].hourlyTargets = {};
                    if (!counters[counterIndex].hourlyActuals) counters[counterIndex].hourlyActuals = {};
                    if (!counters[counterIndex].hourlyPallets) counters[counterIndex].hourlyPallets = {};
                    if (!counters[counterIndex].hourlyNotes) counters[counterIndex].hourlyNotes = {};
                    
                    document.querySelectorAll('.hourly-target-input').forEach(input => {
                        const hour = input.dataset.hour;
                        const value = parseInt(input.value, 10);
                        if (!isNaN(value) && value >= 0) {
                            counters[counterIndex].hourlyTargets[hour] = value;
                        }
                    });
                    document.querySelectorAll('.hourly-actual-input').forEach(input => {
                        const hour = input.dataset.hour;
                        const value = parseInt(input.value, 10);
                        if (!isNaN(value) && value >= 0) {
                            counters[counterIndex].hourlyActuals[hour] = value;
                        }
                    });
                    document.querySelectorAll('.hourly-pallet-input').forEach(input => {
                        const hour = input.dataset.hour;
                        const value = parseInt(input.value, 10);
                        if (!isNaN(value) && value >= 0) counters[counterIndex].hourlyPallets[hour] = value;
                    });
                    document.querySelectorAll('.hourly-note-input').forEach(input => {
                        const hour = input.dataset.hour;
                        counters[counterIndex].hourlyNotes[hour] = input.value;
                    });
                    
                    saveCountersData(counters);
                    showToast('Hourly data saved successfully!');
                    // Refresh chart in modal
                    openHourlyModal(dateStr, shift);
                    // Refresh main productivity chart if visible
                    if (document.getElementById('counters-flip-container').classList.contains('flipped')) {
                        renderProductivityChart();
                    }
                }
            });
        }

        // Export Hourly Data
        const exportHourlyBtn = document.getElementById('export-hourly-btn');
        if (exportHourlyBtn) {
            exportHourlyBtn.addEventListener('click', () => {
                const rows = [];
                rows.push(['Hour', 'Pallet Act', 'Actual (Items)', 'Target', 'Variance', 'Notes']);
                
                // Data rows
                const inputs = document.querySelectorAll('#hourly-details .hourly-actual-input');
                inputs.forEach(input => {
                    const rowDiv = input.closest('tr');
                    const hour = rowDiv.children[0].textContent.trim();
                    const pallet = rowDiv.querySelector('.hourly-pallet-input').value;
                    const act = input.value;
                    const tgt = rowDiv.querySelector('.hourly-target-input').value;
                    const variance = rowDiv.querySelector('.hourly-variance').textContent;
                    const note = rowDiv.querySelector('.hourly-note-input').value;
                    rows.push([`"${hour}"`, pallet, act, tgt, variance, `"${note}"`]);
                });
                
                // Total row
                const tAct = document.getElementById('hourly-total-act') ? document.getElementById('hourly-total-act').textContent : '0';
                const tTgt = document.getElementById('hourly-total-tgt') ? document.getElementById('hourly-total-tgt').textContent : '0';
                const tVar = document.getElementById('hourly-total-var') ? document.getElementById('hourly-total-var').textContent : '0';
                const tPallet = document.getElementById('hourly-total-pallet') ? document.getElementById('hourly-total-pallet').textContent : '0';
                rows.push(['Total', tPallet, tAct, tTgt, tVar, '']);
                
                const csvContent = rows.map(e => e.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `hourly_output_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        function getHourlyReportText() {
            const dateStr = document.getElementById('hourly-date-val').value;
            const shift = document.getElementById('hourly-shift-val').value;
            const tAct = document.getElementById('hourly-total-act') ? document.getElementById('hourly-total-act').textContent : '0';
            const tTgt = document.getElementById('hourly-total-tgt') ? document.getElementById('hourly-total-tgt').textContent : '0';
            const tVar = document.getElementById('hourly-total-var') ? document.getElementById('hourly-total-var').textContent : '0';
            const tPallet = document.getElementById('hourly-total-pallet') ? document.getElementById('hourly-total-pallet').textContent : '0';
            
            let text = `Hourly Output Report\nDate: ${dateStr}\nShift: ${shift}\n\nTotal Pallets: ${tPallet}\nTotal Actual: ${tAct}\nTotal Target: ${tTgt}\nVariance: ${tVar}\n\nDetails:\nHour | Pallet | Act | Tgt | Var | Notes\n---|---|---|---|---|---\n`;
            
            document.querySelectorAll('#hourly-details .hourly-actual-input').forEach(input => {
                const row = input.closest('tr');
                const hour = row.children[0].textContent.trim();
                const pallet = row.querySelector('.hourly-pallet-input').value;
                const tgt = row.querySelector('.hourly-target-input').value;
                const variance = row.querySelector('.hourly-variance').textContent;
                const note = row.querySelector('.hourly-note-input').value;
                text += `${hour} | ${pallet} | ${input.value} | ${tgt} | ${variance} | ${note}\n`;
            });
            return text;
        }

        // Share Hourly Report (Visualize)
        const shareHourlyBtn = document.getElementById('share-hourly-btn');
        if (shareHourlyBtn) {
            shareHourlyBtn.addEventListener('click', async () => {
                const content = document.getElementById('hourly-report-content');
                const details = document.getElementById('hourly-details');
                
                // Temporarily expand details for full capture
                const originalOverflow = details.style.overflow;
                const originalHeight = details.style.height;
                const originalFlex = details.style.flex;
                
                details.style.overflow = 'visible';
                details.style.height = 'auto';
                details.style.flex = 'none';
                
                // Add watermark/timestamp
                const watermark = document.createElement('div');
                watermark.innerText = `Generated: ${new Date().toLocaleString()}`;
                watermark.style.cssText = 'position:absolute; bottom:5px; right:10px; color:#888; font-size:10px; opacity:0.7; z-index:100; pointer-events:none;';
                
                const prevPos = content.style.position;
                content.style.position = 'relative';
                content.appendChild(watermark);

                try {
                    const canvas = await html2canvas(content, { scale: 2, backgroundColor: '#ffffff' });
                    
                    // Restore styles
                    details.style.overflow = originalOverflow;
                    details.style.height = originalHeight;
                    details.style.flex = originalFlex;
                    content.style.position = prevPos;
                    if(watermark.parentNode) watermark.parentNode.removeChild(watermark);
                    
                    snapshotContainer.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL('image/png');
                    img.style.maxWidth = '100%';
                    snapshotContainer.appendChild(img);
                    
                    canvas.toBlob(blob => {
                        currentSnapshotBlob = blob;
                        snapshotModal.classList.remove('hidden');
                    });
                } catch (err) {
                    console.error(err);
                    alert('Failed to generate image snapshot.');
                    // Restore styles in case of error
                    details.style.overflow = originalOverflow;
                    details.style.height = originalHeight;
                    details.style.flex = originalFlex;
                    content.style.position = prevPos;
                    if(watermark.parentNode) watermark.parentNode.removeChild(watermark);
                }
            });
        }

        if (snapshotShareBtn) {
            snapshotShareBtn.addEventListener('click', async () => {
                if (!currentSnapshotBlob) return;
                const file = new File([currentSnapshotBlob], "hourly_report.png", { type: "image/png" });
                
                if (navigator.canShare && navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Hourly Output Report',
                            text: 'Here is the hourly output report.',
                            files: [file]
                        });
                    } catch (err) {
                        console.error(err);
                        alert('Sharing failed or cancelled.');
                    }
                } else {
                    alert('Web Share API not supported on this browser. Please use Download.');
                }
            });
        }

        if (snapshotDownloadBtn) {
            snapshotDownloadBtn.addEventListener('click', () => {
                if (!currentSnapshotBlob) return;
                const url = URL.createObjectURL(currentSnapshotBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hourly_report_${new Date().toISOString().slice(0,10)}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        // Email Hourly Report
        const emailHourlyBtn = document.getElementById('email-hourly-btn');
        if (emailHourlyBtn) {
            emailHourlyBtn.addEventListener('click', () => {
                const text = getHourlyReportText();
                const subject = `Hourly Output Report - ${document.getElementById('hourly-date-val').value}`;
                const recipient = prompt("Enter recipient email (optional):", "") || "";
                window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
            });
        }

        // Clear Hourly Actuals
        const clearHourlyBtn = document.getElementById('clear-hourly-btn');
        if (clearHourlyBtn) {
            clearHourlyBtn.addEventListener('click', () => {
                if(confirm('Are you sure you want to clear all actual values for this shift?')){
                    document.querySelectorAll('#hourly-details .hourly-actual-input').forEach(input => {
                        input.value = 0;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                }
            });
        }

        if (exportCountersBtn) {
            exportCountersBtn.addEventListener('click', () => {
                const counters = getCountersData();
                const attendance = getAttendanceData();
                
                if (counters.length === 0) {
                    alert('No data to export.');
                    return;
                }

                // Sort by date desc, then shift
                counters.sort((a, b) => {
                    if (a.date !== b.date) return new Date(b.date) - new Date(a.date);
                    return a.shift.localeCompare(b.shift);
                });

                const headers = ['Date', 'Shift', 'Required', 'Active', 'Target', 'Completion %'];
                const rows = [headers.join(',')];

                counters.forEach(item => {
                    const req = Number(item.required) || 1;
                    const act = attendance.filter(a => a.date === item.date && a.shift === item.shift).length;
                    const pct = Math.round((act / req) * 100);
                    
                    rows.push([
                        item.date,
                        `"${item.shift}"`,
                        req,
                        act,
                        item.targetOutput || 0,
                        `${pct}%`
                    ].join(','));
                });

                const csvContent = rows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'daily_counters_summary.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        if (archiveBtn) {
            archiveBtn.addEventListener('click', () => {
                showArchiveOnly = !showArchiveOnly;
                archiveBtn.classList.toggle('active-filter', showArchiveOnly);
                archiveBtn.innerHTML = showArchiveOnly 
                    ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 14 4 9 9 4"></polyline><path d="M20 20v-7a4 4 0 0 0-4-4H4"></path></svg> Back to Active`
                    : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg> View Archived`;
                
                renderCountersTable();
                renderAttendanceTable();
            });
        }

        function getDuration(start, end) {
            if (!start || !end) return '-';
            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);
            let minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (minutes < 0) minutes += 24 * 60;
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return (h > 0 ? h + 'h ' : '') + m + 'm';
        }

        function getFilteredAttendanceData() {
            let data = getAttendanceData();

            // Global date filter
            if (globalStartDate.value || globalEndDate.value) {
                const start = globalStartDate.value ? new Date(globalStartDate.value) : null;
                if (start) start.setHours(0,0,0,0);
                const end = globalEndDate.value ? new Date(globalEndDate.value) : null;
                if (end) end.setHours(23,59,59,999);

                data = data.filter(item => {
                    const itemDate = new Date(item.date);
                    return (!start || itemDate >= start) && (!end || itemDate <= end);
                });
            }
            
            // Global Sub Area Filter
            if (globalSubAreas.length > 0) {
                data = data.filter(item => globalSubAreas.includes(item.area));
            }

            // Archived filter (hide archived dates unless in archive mode)
            if (!showArchiveOnly) {
                const counters = getCountersData();
                // If date is archived in counters, hide attendance?
                // Let's assume yes.
                const archivedDates = new Set(counters.filter(c => c.archived).map(c => c.date));
                data = data.filter(item => !archivedDates.has(item.date));
            } else {
                // In archive mode, maybe show all? Or only archived?
                // Let's show only archived dates
                const counters = getCountersData();
                const archivedDates = new Set(counters.filter(c => c.archived).map(c => c.date));
                data = data.filter(item => archivedDates.has(item.date));
            }

            // Search filter
            const searchTerm = attSearchInput ? attSearchInput.value.toLowerCase() : '';
            if (searchTerm) {
                data = data.filter(item => 
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.userId && item.userId.toLowerCase().includes(searchTerm)) ||
                    (item.role && item.role.toLowerCase().includes(searchTerm)) ||
                    (item.jobDescription && item.jobDescription.toLowerCase().includes(searchTerm)) ||
                    (item.area && item.area.toLowerCase().includes(searchTerm))
                );
            }
            
            // Role and Area filters
            const roleFilter = attFilterRole ? attFilterRole.value : '';
            if (roleFilter) {
                data = data.filter(item => item.role === roleFilter);
            }
            const areaFilter = attFilterArea ? attFilterArea.value : '';
            if (areaFilter) {
                data = data.filter(item => item.area === areaFilter);
            }
            // Use active tab for shift filter
            const activeTab = document.querySelector('.att-shift-tab.active');
            const shiftFilter = activeTab ? activeTab.dataset.shift : '1st Shift-(6am-2pm)'; // Default to 1st if none active
            if (shiftFilter) {
                data = data.filter(item => item.shift === shiftFilter);
            }
            
            // Sorting
            data.sort((a, b) => {
                let valA = a[attSortField] || '';
                let valB = b[attSortField] || '';
                
                if (attSortField === 'duration') {
                    valA = getDuration(a.breakOut, a.breakIn);
                    valB = getDuration(b.breakOut, b.breakIn);
                }
                
                if (valA < valB) return attSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return attSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            return data;
        }

        function renderAttendanceTable() {
            if (!attendanceTableBody) return;
            const attRowsPerPageSelect = document.getElementById('att-rows-per-page');
            if (attRowsPerPageSelect) attItemsPerPage = parseInt(attRowsPerPageSelect.value, 10);

            let data = getFilteredAttendanceData();

            const totalCountSpan = document.getElementById('att-total-count');
            if (totalCountSpan) totalCountSpan.textContent = data.length;

            // Pagination
            const totalItems = data.length;
            const totalPages = Math.ceil(totalItems / attItemsPerPage) || 1;
            if (attCurrentPage > totalPages) attCurrentPage = totalPages;

            const paginatedData = data.slice((attCurrentPage - 1) * attItemsPerPage, attCurrentPage * attItemsPerPage);

            attendanceTableBody.innerHTML = '';
            const paginationControls = document.getElementById('att-pagination-controls');
            if (paginationControls) {
                if (totalItems === 0) {
                    paginationControls.style.display = 'none';
                } else {
                    paginationControls.style.display = 'flex';
                    document.getElementById('att-page-info').textContent = `Page ${attCurrentPage} of ${totalPages} (${totalItems} records)`;
                    document.getElementById('att-prev-page').disabled = attCurrentPage <= 1;
                    document.getElementById('att-next-page').disabled = attCurrentPage >= totalPages;
                }
            }
            
            // Update sort icons
            document.querySelectorAll('#attendance-table th.sortable .sort-icon').forEach(icon => icon.textContent = '');
            const activeHeader = document.querySelector(`#attendance-table th[data-sort="${attSortField}"]`);
            if(activeHeader) {
                activeHeader.querySelector('.sort-icon').textContent = attSortDirection === 'asc' ? '↑' : '↓';
            }

            if (paginatedData.length === 0) {
                attendanceTableBody.innerHTML = `<tr><td colspan="10" class="muted" style="text-align:center; padding: 20px;">No attendance records found.</td></tr>`;
                return;
            }
            paginatedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="att-row-checkbox" data-id="${item.id}"></td>
                    <td>${item.date}</td>
                    <td>${item.userId || '-'}</td>
                    <td>${item.shift}</td>
                    <td>${item.name}</td>
                    <td>${item.role || '-'}</td>
                    <td>${item.jobDescription || '-'}</td>
                    <td>${item.timeIn || '-'}</td>
                    <td>${item.breakOut || '-'}</td>
                    <td>${item.breakIn || '-'}</td>
                    <td>${item.timeOut || '-'}</td>
                    <td style="font-weight:bold; color:#555;">${getDuration(item.breakOut, item.breakIn)}</td>
                    <td>${item.status || '-'}</td>
                    <td>
                        <button class="icon-btn edit-att-btn" data-id="${item.id}" title="Edit" style="margin-right:5px">✎</button>
                        <button class="icon-btn delete-att-btn" data-id="${item.id}" title="Delete" style="color:#d9534f">&times;</button>
                    </td>
                `;
                attendanceTableBody.appendChild(tr);
            });
            setTimeout(fixTooltips, 0);
        }

        if (printAttBtn) {
            printAttBtn.addEventListener('click', () => {
                const dataToPrint = getFilteredAttendanceData();
                if (dataToPrint.length === 0) {
                    alert('No records to print.');
                    return;
                }

                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Attendance Report</title>');
                printWindow.document.write('<style>@page { size: letter; margin: 0.25in; } body{font-family:sans-serif;font-size:11px;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ccc;padding:4px;text-align:left;} th{background:#f0f0f0;} .sig{height:30px;}</style>');
                printWindow.document.write('<style>@page { size: letter landscape; margin: 0.25in; } body{font-family:sans-serif;font-size:11px;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ccc;padding:4px;text-align:left;} th{background:#f0f0f0;} .sig{height:30px;}</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<h2>Attendance Report</h2>');
                printWindow.document.write(`<p>Generated: ${new Date().toLocaleString()}</p>`);
                printWindow.document.write('<table><thead><tr>');
                const headers = ['Date', 'User ID', 'Shift', 'Name', 'Role', 'Job Description', 'Time In', 'Break Out', 'Break In', 'Time Out', 'Status', 'Notes', 'Signature'];
                headers.forEach(h => printWindow.document.write(`<th>${h}</th>`));
                printWindow.document.write('</tr></thead><tbody>');

                dataToPrint.forEach(item => {
                    printWindow.document.write('<tr>');
                    printWindow.document.write(`<td>${item.date}</td>`);
                    printWindow.document.write(`<td>${item.userId || ''}</td>`);
                    printWindow.document.write(`<td>${item.shift}</td>`);
                    printWindow.document.write(`<td>${item.name}</td>`);
                    printWindow.document.write(`<td>${item.role || '-'}</td>`);
                    printWindow.document.write(`<td>${item.jobDescription || '-'}</td>`);
                    printWindow.document.write(`<td>${item.timeIn || ''}</td>`);
                    printWindow.document.write(`<td>${item.breakOut || ''}</td>`);
                    printWindow.document.write(`<td>${item.breakIn || ''}</td>`);
                    printWindow.document.write(`<td>${item.timeOut || ''}</td>`);
                    printWindow.document.write(`<td>${item.status || ''}</td>`);
                    printWindow.document.write(`<td>${item.notes || ''}</td>`);
                    printWindow.document.write('<td class="sig"></td>'); // Empty signature cell
                    printWindow.document.write('</tr>');
                });

                printWindow.document.write('</tbody></table>');
                printWindow.document.write('<script>window.onload=function(){window.print();window.close();}<\/script>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
            });
        }

        // Mass Delete for Attendance
        const selectAllAtt = document.getElementById('select-all-att');
        const deleteSelectedAttBtn = document.getElementById('delete-selected-att-btn');
        const bulkTimeoutBtn = document.getElementById('bulk-timeout-btn');

        function updateAttendanceActionButtons() {
            const selectedCount = document.querySelectorAll('.att-row-checkbox:checked').length;
            if (deleteSelectedAttBtn) {
                deleteSelectedAttBtn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
            }
            if (bulkTimeoutBtn) {
                bulkTimeoutBtn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
            }
        }

        if (selectAllAtt) {
            selectAllAtt.addEventListener('change', (e) => {
                document.querySelectorAll('.att-row-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateAttendanceActionButtons();
            });
        }

        if (attendanceTableBody) {
            attendanceTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('att-row-checkbox')) {
                    updateAttendanceActionButtons();
                }
            });
        }

        if (bulkTimeoutBtn) {
            bulkTimeoutBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.att-row-checkbox:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length === 0) return;

                const now = new Date();
                const defaultTime = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                const timeOutVal = prompt("Enter Time Out (HH:MM):", defaultTime);
                
                if (timeOutVal !== null) {
                    let data = getAttendanceData();
                    const selectedSet = new Set(selectedIds);
                    
                    // Sync to All IC Attendance
                    const allIcKey = 'ims_daily_attendance_v1';
                    let allIcData = [];
                    try { allIcData = JSON.parse(localStorage.getItem(allIcKey) || '[]'); } catch (err) { allIcData = []; }
                    let allIcModified = false;

                    data.forEach(item => {
                        if (selectedSet.has(item.id)) {
                            item.timeOut = timeOutVal;
                            // Sync if exists in all ic attendance
                            const allIcIdx = allIcData.findIndex(a => a.id === item.id || (a.userId === item.userId && a.date === item.date && a.shift === item.shift));
                            if (allIcIdx > -1 && (allIcData[allIcIdx].area === 'Cycle Counter' || allIcData[allIcIdx].jobDescription === 'Cycle Counter')) {
                                allIcData[allIcIdx].timeOut = timeOutVal;
                                allIcModified = true;
                            }
                        }
                    });

                    saveAttendanceData(data);
                    if (allIcModified) localStorage.setItem(allIcKey, JSON.stringify(allIcData));
                    
                    renderAttendanceTable();
                    if(selectAllAtt) selectAllAtt.checked = false;
                    updateAttendanceActionButtons();
                    showToast(`Bulk timeout set for ${selectedIds.length} records.`);
                }
            });
        }

        if (deleteSelectedAttBtn) {
            deleteSelectedAttBtn.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.att-row-checkbox:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length === 0) return;

                showSupervisorDeleteModal(selectedIds.length, () => {
                    const selectedSet = new Set(selectedIds);
                    
                    // Revert status in All IC Attendance (restore forward button)
                    const allIcKey = 'ims_daily_attendance_v1';
                    let allIcData = [];
                    try { allIcData = JSON.parse(localStorage.getItem(allIcKey) || '[]'); } catch(e) {}
                    let modified = false;
                    allIcData.forEach(item => {
                        if (selectedSet.has(item.id) && item.status === 'Full Counter') {
                            item.status = 'Full-time';
                            modified = true;
                        }
                    });
                    if (modified) localStorage.setItem(allIcKey, JSON.stringify(allIcData));

                    let data = getAttendanceData();
                    data = data.filter(item => !selectedSet.has(item.id));
                    saveAttendanceData(data);
                    renderAttendanceTable();
                    renderCountersTable();
                    renderTimestamps(); // Refresh analytics
                    updateAttendanceActionButtons();
                    showToast(`${selectedIds.length} attendance records deleted`);
                });
            });
        }

        if (deleteSelectedCountersBtn) {
            deleteSelectedCountersBtn.addEventListener('click', () => {
                const selectedDates = Array.from(document.querySelectorAll('.counter-row-checkbox:checked')).map(cb => cb.dataset.date);
                if (selectedDates.length === 0) return;

                showSupervisorDeleteModal(selectedDates.length, () => {
                    const selectedSet = new Set(selectedDates);
                    let data = getCountersData();
                    data = data.filter(item => !selectedSet.has(item.date));
                    saveCountersData(data);
                    renderCountersTable();
                    deleteSelectedCountersBtn.style.display = 'none';
                    if(selectAllCounters) selectAllCounters.checked = false;
                    showToast(`${selectedDates.length} counter records deleted`);
                });
            });
        }

        function showSupervisorDeleteModal(count, callback) {
            if (!supervisorDeleteModal) return;
            document.getElementById('supervisor-delete-count').textContent = count;
            document.getElementById('supervisor-code').value = '';
            supervisorDeleteCallback = callback;
            supervisorDeleteModal.classList.remove('hidden');
        }

        if (confirmSupervisorDeleteBtn) {
            confirmSupervisorDeleteBtn.addEventListener('click', () => {
                const code = document.getElementById('supervisor-code').value;
                if (code !== '12345' && code !== 'admin') { alert('Invalid Supervisor Code.'); return; }
                if (typeof supervisorDeleteCallback === 'function') supervisorDeleteCallback();
                supervisorDeleteModal.classList.add('hidden');
            });
        }

        if (attSearchInput) {
            attSearchInput.addEventListener('input', () => {
                attCurrentPage = 1;
                renderAttendanceTable();
            });
        }

        // Attendance Sorting Listeners
        document.querySelectorAll('#attendance-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (attSortField === field) {
                    attSortDirection = attSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    attSortField = field;
                    attSortDirection = 'asc';
                }
                renderAttendanceTable();
            });
        });

        // Attendance Shift Tabs Logic
        const attShiftTabs = document.querySelectorAll('.att-shift-tab');
        attShiftTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                attShiftTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                attCurrentPage = 1;
                renderAttendanceTable();
            });
        });

        if (attFilterRole) attFilterRole.addEventListener('change', () => { attCurrentPage = 1; renderAttendanceTable(); });
        if (attFilterArea) attFilterArea.addEventListener('change', () => { attCurrentPage = 1; renderAttendanceTable(); });

        const attPaginationControls = document.getElementById('att-pagination-controls');
        if (attPaginationControls) {
            attPaginationControls.addEventListener('click', (e) => {
                if (e.target.id === 'att-prev-page' && !e.target.disabled) {
                    attCurrentPage--;
                    renderAttendanceTable();
                } else if (e.target.id === 'att-next-page' && !e.target.disabled) {
                    attCurrentPage++;
                    renderAttendanceTable();
                }
            });
            const attRowsPerPageSelect = document.getElementById('att-rows-per-page');
            if (attRowsPerPageSelect) {
                attRowsPerPageSelect.addEventListener('change', () => {
                    attCurrentPage = 1;
                    renderAttendanceTable();
                });
            }
        }

        if (countersForm) {
            countersForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('counter-edit-id').value;
                const newEntry = {
                    id: editId || Date.now().toString(),
                    date: document.getElementById('counter-date').value,
                    shift: document.getElementById('counter-shift').value,
                    required: Number(document.getElementById('counter-required').value),
                    standardRate: Number(document.getElementById('counter-rate').value) || 0,
                    targetOutput: Number(document.getElementById('counter-target').value) || 0,
                    note: document.getElementById('counter-note').value.trim()
                    // active is now derived
                };

                let data = getCountersData();
                if (editId) {
                    const index = data.findIndex(item => item.id === editId);
                    if (index > -1) data[index] = { ...data[index], ...newEntry }; // Merge to preserve hourly data
                } else {
                    data.push(newEntry);
                }
                saveCountersData(data);
                showToast('Counter saved successfully!');
                renderCountersTable();
                
                // Reset form but keep date
                const currentDate = document.getElementById('counter-date').value;
                countersForm.reset();
                document.getElementById('counter-date').value = currentDate;
                
                document.getElementById('counter-edit-id').value = '';
                saveCounterBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save';
                cancelCounterEditBtn.style.display = 'none';
            });
        }

        if (countersTableBody) {
            countersTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;

                if (btn.classList.contains('delete-counter-btn')) {
                    if(confirm('Delete this record?')) {
                        let data = getCountersData();
                        data = data.filter(item => item.id !== id);
                        saveCountersData(data);
                        renderCountersTable();
                        showToast('Counter deleted successfully');
                    }
                } else if (btn.classList.contains('edit-counter-btn')) {
                    const data = getCountersData();
                    const item = data.find(i => i.id === id);
                    if (item) {
                        document.getElementById('counter-edit-id').value = item.id;
                        document.getElementById('counter-date').value = item.date;
                        document.getElementById('counter-shift').value = item.shift;
                        document.getElementById('counter-required').value = item.required;
                        document.getElementById('counter-rate').value = item.standardRate || '';
                        document.getElementById('counter-target').value = item.targetOutput || '';
                        document.getElementById('counter-note').value = item.note || '';
                        
                        saveCounterBtn.innerHTML = 'Update';
                        cancelCounterEditBtn.style.display = 'inline-flex';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                } else if (btn.classList.contains('duplicate-counter-btn')) {
                    const data = getCountersData();
                    const item = data.find(i => i.id === id);
                    if (item) {
                        const d = new Date(item.date);
                        d.setDate(d.getDate() + 1);
                        const nextDate = d.toISOString().split('T')[0];
                        
                        const exists = data.find(x => x.date === nextDate && x.shift === item.shift);
                        if (exists) {
                            alert(`An entry for ${nextDate} - ${item.shift} already exists. Duplicate skipped.`);
                            return;
                        }
                        
                        const newItem = { ...item, id: Date.now().toString(), date: nextDate, hourlyActuals: {} };
                        // Keep hourlyTargets if they exist as part of the plan
                        data.push(newItem);
                        saveCountersData(data);
                        renderCountersTable();
                        alert(`Duplicated entry to ${nextDate}`);
                    }
                }
            });
        }

        if (cancelCounterEditBtn) {
            cancelCounterEditBtn.addEventListener('click', () => {
                countersForm.reset();
                document.getElementById('counter-edit-id').value = '';
                saveCounterBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save';
                cancelCounterEditBtn.style.display = 'none';
                document.getElementById('counter-rate').value = '';
                document.getElementById('counter-note').value = '';
                setLocalDate(document.getElementById('counter-date'));
            });
        }

        // Auto-fill User ID based on Name selection
        const attNameInput = document.getElementById('att-name');
        if (attNameInput) {
            attNameInput.addEventListener('input', () => {
                const val = attNameInput.value.trim();
                if (!val) return;
                const data = getAttendanceData();
                // Find most recent entry for this name to get User ID and Role
                const user = data.slice().reverse().find(d => d.name && d.name.toLowerCase() === val.toLowerCase());
                if (user) {
                    if (user.userId) document.getElementById('att-user-id').value = user.userId;
                    if (user.role) document.getElementById('att-role').value = user.role;
                }
            });
        }

        // Auto-fill Name and Role based on User ID
        const attUserIdInput = document.getElementById('att-user-id');
        if (attUserIdInput) {
            attUserIdInput.addEventListener('input', () => {
                const val = attUserIdInput.value.trim();
                if (!val) return;

                // First, try to find the user in the master data
                const masterUsers = getMasterUsers();
                const masterUser = masterUsers.find(u => u.userId && u.userId.toLowerCase() === val.toLowerCase());

                if (masterUser) {
                    if (masterUser.name) document.getElementById('att-name').value = masterUser.name;
                    if (masterUser.role) {
                        const roleSelect = document.getElementById('att-role');
                        const optionExists = Array.from(roleSelect.options).some(opt => opt.value === masterUser.role);
                        if (optionExists) roleSelect.value = masterUser.role;
                    }
                    // Auto-set Job Description to Cycle Counter for Master Users
                    const jobDescSelect = document.getElementById('att-job-desc');
                    if (jobDescSelect) jobDescSelect.value = 'Cycle Counter';
                } else {
                    // Fallback to searching in existing attendance data if not in master
                    const data = getAttendanceData();
                    const user = data.slice().reverse().find(d => d.userId && d.userId.toLowerCase() === val.toLowerCase());
                    if (user) {
                        if (user.name) document.getElementById('att-name').value = user.name;
                        if (user.role) document.getElementById('att-role').value = user.role;
                    }
                }
            });
        }

        function updateAttNameDatalist() {
            const list = document.getElementById('att-name-list');
            if (!list) return;
            list.innerHTML = '';
            const data = getAttendanceData();
            const uniqueNames = [...new Set(data.map(d => d.name).filter(n => n))].sort();
            uniqueNames.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                list.appendChild(opt);
            });
        }

        // Attendance Modal Logic
        if (addAttBtn) {
            addAttBtn.addEventListener('click', () => {
                document.getElementById('att-modal-title').textContent = 'Add Attendance';
                attForm.reset();
                document.getElementById('att-edit-id').value = '';
                document.getElementById('att-date').valueAsDate = new Date();
                
                // Auto-fill Shift based on current time
                const now = new Date();
                const h = now.getHours();
                let shiftVal = '3rd Shift-(10pm-6am)';
                if (h >= 6 && h < 14) shiftVal = '1st Shift-(6am-2pm)';
                else if (h >= 14 && h < 22) shiftVal = '2nd Shift-(2pm-10pm)';
                document.getElementById('att-shift').value = shiftVal;

                // Set Job Description to Cycle Counter
                document.getElementById('att-job-desc').value = 'Cycle Counter';

                // Random 3-char User ID (1 Letter + 2 Digits)
                const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                const letter = letters.charAt(Math.floor(Math.random() * letters.length));
                const num = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                document.getElementById('att-user-id').value = letter + num;

                updateAttNameDatalist();
                attModal.classList.remove('hidden');
            });
        }

        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                if (modal) {
                    modal.classList.add('hidden');
                    if (modal.id === 'timestamp-modal') {
                        sessionStorage.removeItem('ims_timestamp_modal_open');
                    }
                }
            });
        });

    if (attModal) {
        attModal.addEventListener('click', (e) => {
            const btn = e.target.closest('.set-current-time');
            if (btn) {
                const targetId = btn.dataset.target;
                const targetInput = document.getElementById(targetId);
                if (targetInput) {
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    targetInput.value = `${hours}:${minutes}`;
                }
            }
        });
    }

        if (attForm) {
            attForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('att-edit-id').value;
                const newEntry = {
                    id: editId || Date.now().toString(),
                    date: document.getElementById('att-date').value,
                    shift: document.getElementById('att-shift').value,
                    userId: document.getElementById('att-user-id').value.trim(),
                    name: document.getElementById('att-name').value.trim().toUpperCase(),
                    role: document.getElementById('att-role').value,
                    jobDescription: document.getElementById('att-job-desc').value,
                    area: '',
                    timeIn: document.getElementById('att-time-in').value,
                    breakIn: document.getElementById('att-break-in').value,
                    breakOut: document.getElementById('att-break-out').value,
                    timeOut: document.getElementById('att-time-out').value,
                    status: document.getElementById('att-status').value
                };
                if(!newEntry.name) return;

                // Duplicate check: User ID and Name must be unique for the same shift
                const attendanceData = getAttendanceData();
                const existingId = attendanceData.find(a => 
                    a.date === newEntry.date && 
                    a.shift === newEntry.shift &&
                    a.userId === newEntry.userId &&
                    a.id !== newEntry.id
                );
                if (existingId) {
                    alert(`User ID ${newEntry.userId} is already assigned to this shift on ${newEntry.date}.`);
                    return;
                }
                const existingName = attendanceData.find(a => 
                    a.date === newEntry.date && 
                    a.shift === newEntry.shift &&
                    a.name === newEntry.name &&
                    a.id !== newEntry.id
                );
                if (existingName) {
                    alert(`Name "${newEntry.name}" is already assigned to this shift on ${newEntry.date}.`);
                    return;
                }

                let data = attendanceData;
                if (editId) {
                    const idx = data.findIndex(x => x.id === editId);
                    if (idx > -1) data[idx] = newEntry;
                } else {
                    data.push(newEntry);
                }
                saveAttendanceData(data);

                // Sync to All IC Attendance (Cycle Counters only)
                try {
                    const allIcKey = 'ims_daily_attendance_v1';
                    let allIcData = JSON.parse(localStorage.getItem(allIcKey) || '[]');
                    let allIcIdx = allIcData.findIndex(a => a.id === newEntry.id);
                    if (allIcIdx === -1) {
                        allIcIdx = allIcData.findIndex(a => a.userId === newEntry.userId && a.date === newEntry.date && a.shift === newEntry.shift);
                    }
                    if (allIcIdx > -1 && (allIcData[allIcIdx].area === 'Cycle Counter' || allIcData[allIcIdx].jobDescription === 'Cycle Counter')) {
                        allIcData[allIcIdx].breakOut = newEntry.breakOut;
                        allIcData[allIcIdx].breakIn = newEntry.breakIn;
                        allIcData[allIcIdx].timeOut = newEntry.timeOut;
                        localStorage.setItem(allIcKey, JSON.stringify(allIcData));
                    }
                } catch(e) { console.error("Sync error", e); }

                showToast('Attendance saved successfully!');
                
                attModal.classList.add('hidden');
                renderAttendanceTable();
                renderCountersTable(); // Update counts

                // Update analytics date to match entry and refresh
                if(tsAnalyticsDateFilter) tsAnalyticsDateFilter.value = newEntry.date;
                renderTimestamps();
            });
        }

        if (exportAttBtn) {
            exportAttBtn.addEventListener('click', () => {
                exportAttendanceCSV(getFilteredAttendanceData());
            });
        }

        function exportAttendanceCSV(data) {
            if (data.length === 0) { alert('No attendance records to export.'); return; }
            const headers = ['Date', 'User ID', 'Shift', 'Name', 'Role', 'Job Description', 'Assigned Area', 'Time In', 'Break Out', 'Break In', 'Time Out', 'Duration', 'Status', 'Notes'];
            const rows = [headers.join(',')];
            
            data.forEach(item => {
                const dur = getDuration(item.breakOut, item.breakIn);
                const row = [
                    item.date, `"${item.userId||''}"`, `"${item.shift}"`, `"${item.name}"`, item.role || '', item.jobDescription || '', item.area || '', item.timeIn || '', item.breakOut || '', item.breakIn || '', item.timeOut || '', dur, `"${item.status||''}"`, `"${item.notes||''}"`
                ];
                rows.push(row.join(','));
            });
            
            const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'attendance_sheet.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        if (attendanceTableBody) {
            attendanceTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;

                if (btn.classList.contains('delete-att-btn')) {
                    if(confirm('Remove this person?')) {
                        // Revert status in All IC Attendance (restore forward button)
                        const allIcKey = 'ims_daily_attendance_v1';
                        let allIcData = [];
                        try { allIcData = JSON.parse(localStorage.getItem(allIcKey) || '[]'); } catch(e) {}
                        const idx = allIcData.findIndex(item => item.id === id);
                        if (idx > -1 && allIcData[idx].status === 'Full Counter') {
                            allIcData[idx].status = 'Full-time';
                            localStorage.setItem(allIcKey, JSON.stringify(allIcData));
                        }

                        let data = getAttendanceData();
                        data = data.filter(item => item.id !== id);
                        saveAttendanceData(data);
                        renderAttendanceTable();
                        renderCountersTable(); // Update counts
                        renderTimestamps(); // Refresh analytics
                        showToast('Attendance entry deleted');
                    }
                } else if (btn.classList.contains('edit-att-btn')) {
                    const data = getAttendanceData();
                    const item = data.find(x => x.id === id);
                    if (item) {
                        document.getElementById('att-modal-title').textContent = 'Edit Attendance';
                        document.getElementById('att-edit-id').value = item.id;
                        document.getElementById('att-date').value = item.date;
                        document.getElementById('att-user-id').value = item.userId || '';
                        document.getElementById('att-shift').value = item.shift;
                        document.getElementById('att-name').value = item.name;
                        document.getElementById('att-role').value = item.role;
                        document.getElementById('att-job-desc').value = item.jobDescription || '';
                        document.getElementById('att-time-in').value = item.timeIn || '';
                        document.getElementById('att-break-out').value = item.breakOut;
                        document.getElementById('att-break-in').value = item.breakIn;
                        document.getElementById('att-time-out').value = item.timeOut || '';
                        let statusVal = item.status || 'Full counter';
                        if (statusVal.toLowerCase() === 'full counter') statusVal = 'Full counter';
                        document.getElementById('att-status').value = statusVal;
                        attModal.classList.remove('hidden');
                    }
                }
            });
        }

        // Expand/Collapse Card Logic
        document.querySelectorAll('.expand-toggle-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const card = e.target.closest('.card');
                const content = card.querySelector('.card-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.title = isHidden ? 'Expand' : 'Collapse';
                    btn.innerHTML = isHidden ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>' : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>';
                }
            });
        });

        // Automatic Shift End Check (runs every minute)
        setInterval(() => {
            const now = new Date();
            const m = now.getMinutes();
            const h = now.getHours();
            // Check 5 mins before shift ends: 13:55 (1st), 21:55 (2nd), 05:55 (3rd)
            if (m === 55 && (h === 13 || h === 21 || h === 5)) {
                if (!sessionStorage.getItem(`shift_alert_${h}`)) {
                    sessionStorage.setItem(`shift_alert_${h}`, 'true');
                    // Alert removed as chart is removed
                }
            }
        }, 60000);

        // Global Filter Logic
        const applyGlobalFilterBtn = document.getElementById('apply-global-filter');
        const clearGlobalFilterBtn = document.getElementById('clear-global-filter');
        if (applyGlobalFilterBtn) {
            applyGlobalFilterBtn.addEventListener('click', () => {
                renderCountersTable(); renderAttendanceTable();
            });
        }
        if (clearGlobalFilterBtn) {
            clearGlobalFilterBtn.addEventListener('click', () => {
                globalStartDate.value = ''; globalEndDate.value = '';
                renderCountersTable(); renderAttendanceTable();
            });
        }

        // Sub Area Filter Logic
        if (subAreaFilterBtn) {
            // Populate modal
            subAreaList.innerHTML = '';
            subAreaOptions.forEach(area => {
                const div = document.createElement('div');
                div.innerHTML = `<label style="display:flex; align-items:center; gap:5px; cursor:pointer;"><input type="checkbox" value="${area}" class="sub-area-checkbox"> ${area}</label>`;
                subAreaList.appendChild(div);
            });
            
            subAreaFilterBtn.addEventListener('click', () => {
                // Sync checkboxes
                document.querySelectorAll('.sub-area-checkbox').forEach(cb => {
                    cb.checked = globalSubAreas.includes(cb.value);
                });
                subAreaModal.classList.remove('hidden');
            });
        }
        
        if (applySubAreaFilterBtn) {
            applySubAreaFilterBtn.addEventListener('click', () => {
                globalSubAreas = Array.from(document.querySelectorAll('.sub-area-checkbox:checked')).map(cb => cb.value);
                subAreaModal.classList.add('hidden');
                
                // Visual feedback on button
                if (globalSubAreas.length > 0) {
                    subAreaFilterBtn.style.background = '#e74c3c';
                    subAreaFilterBtn.style.color = 'white';
                    subAreaFilterBtn.title = `Filtered: ${globalSubAreas.join(', ')}`;
                } else {
                    subAreaFilterBtn.style.background = '';
                    subAreaFilterBtn.style.color = '';
                    subAreaFilterBtn.title = 'Sub Area Filter';
                }
                
                renderCountersTable();
                renderAttendanceTable();
            });
        }
        
        // Monitor Sub Area Logic
        if (monitorSubAreaBtn) {
            // Populate select
            monitorSubAreaSelect.innerHTML = '<option value="">Dashboard</option>';
            subAreaOptions.forEach(area => {
                monitorSubAreaSelect.innerHTML += `<option value="${area}">${area}</option>`;
            });
            
            monitorSubAreaBtn.addEventListener('click', () => {
                subAreaMonitorModal.classList.remove('hidden');
                renderMonitorGrid();
            });
            
            monitorSubAreaSelect.addEventListener('change', () => {
                monitorSelectedCells.clear();
                // Reset filter
                if(monitorFilterStatus) monitorFilterStatus.value = 'all';
                updateMonitorControls();
                renderMonitorGrid();
            });
        }
        
        function renderMonitorGrid() {
            const area = monitorSubAreaSelect.value;
            const rackingGrid = document.getElementById('racking-grid');
            const statsDiv = document.getElementById('monitor-stats');
            const capacityInfo = document.getElementById('monitor-capacity-info');
            const filterStatus = monitorFilterStatus ? monitorFilterStatus.value : 'all';
            const searchTerm = monitorSearchInput ? monitorSearchInput.value.toLowerCase() : '';
            
            // Get Data
            let cycleCounts = [];
            const customLabels = JSON.parse(localStorage.getItem('ims_rack_labels_v1') || '{}');
            const customStatuses = JSON.parse(localStorage.getItem('ims_rack_status_v1') || '{}');
            const CELL_SIZE = 70; // Larger grid cells
            
            try { cycleCounts = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]'); } catch(e){}
            
            // Filter by date (Global Filter)
            const start = (globalStartDate && globalStartDate.value) ? new Date(globalStartDate.value) : null;
            if (start) start.setHours(0,0,0,0);
            const end = (globalEndDate && globalEndDate.value) ? new Date(globalEndDate.value) : null;
            if (end) end.setHours(23,59,59,999);
            
            // Helper to check if a cell is counted
            const isCellCounted = (label, isAuto) => {
                const manualStatus = customStatuses[label];
                if (manualStatus === 'counted') return true;
                if (manualStatus === 'ongoing') return false; // ongoing is not counted yet
                if (manualStatus === 'uncounted') return false;
                return isAuto;
            };

            if (!area) {
                // Dashboard View
                rackingGrid.innerHTML = '';
                rackingGrid.style.display = 'block';
                rackingGrid.style.maxWidth = '100%';
                rackingGrid.style.width = '100%';
                
                capacityInfo.textContent = 'Dashboard View';
                if(monitorFileActions) monitorFileActions.style.display = 'flex';
                statsDiv.textContent = '';

                let grandTotalCapacity = 0;
                let grandTotalCounted = 0;
                const cards = [];

                subAreaOptions.forEach(subArea => {
                    const config = subAreaConfigs[subArea];
                    if(!config) return;

                    // Calculate stats for this area
                    let areaTotal = 0;
                    let areaCounted = 0;
                    
                    // Filter counts for this area
                    const areaCounts = cycleCounts.filter(item => {
                        const d = new Date(item.createdDate || item.date);
                        const dateMatch = (!start || d >= start) && (!end || d <= end);
                        const locMatch = (item.location || '').toUpperCase().startsWith(subArea);
                        return dateMatch && locMatch;
                    });
                    const countedCount = areaCounts.length;
                    let globalCellIndex = 0;

                    // Blocks
                    if (config.type === 'multi') {
                        config.blocks.forEach(block => {
                            const blockCells = block.width * block.levels;
                            for(let i=0; i<blockCells; i++) {
                                const isAuto = globalCellIndex < countedCount;
                                globalCellIndex++;
                                
                                const rowIdx = Math.floor(i / block.width);
                                const colIdx = (i % block.width) + 1;
                                const rowNum = (block.rowBase || 0) + (rowIdx * (block.rowStep || 10));
                                const label = `${block.prefix}${rowNum}-C${colIdx}`;
                                
                                const status = customStatuses[label];
                                if (status === 'empty' || status === 'not-part') continue;

                                if(isCellCounted(label, isAuto)) areaCounted++;
                                areaTotal++;
                            }
                        });
                        
                        // Floor
                        if (config.floor) {
                            const floorCells = config.floor.width * config.floor.levels;
                            for(let i=0; i<floorCells; i++) {
                                const isAuto = globalCellIndex < countedCount;
                                globalCellIndex++;
                                
                                const label = `${config.floor.prefix}-${i+1}`;
                                const status = customStatuses[label];
                                if (status === 'empty' || status === 'not-part') continue;

                                if(isCellCounted(label, isAuto)) areaCounted++;
                                areaTotal++;
                            }
                        }
                    }

                    grandTotalCapacity += areaTotal;
                    grandTotalCounted += areaCounted;

                    const pct = areaTotal > 0 ? Math.round((areaCounted / areaTotal) * 100) : 0;
                    let color = '#e74c3c';
                    if(pct >= 100) color = '#2ecc71';
                    else if(pct >= 50) color = '#f1c40f';

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.padding = '20px';
                    card.style.textAlign = 'center';
                    card.style.cursor = 'pointer';
                    card.style.transition = 'transform 0.2s';
                    card.onmouseover = () => card.style.transform = 'translateY(-5px)';
                    card.onmouseout = () => card.style.transform = 'none';
                    card.onclick = () => {
                        monitorSubAreaSelect.value = subArea;
                        renderMonitorGrid();
                    };

                    card.innerHTML = `
                        <h3 style="margin:0 0 10px 0; color:#2752a7;">${subArea}</h3>
                        <div style="font-size:36px; font-weight:bold; color:${color};">${pct}%</div>
                        <div style="color:#666; font-size:14px; margin-top:5px;">${areaCounted} / ${areaTotal} Counted</div>
                        <div style="margin-top:10px; height:10px; background:#eee; border-radius:5px; overflow:hidden;">
                            <div style="width:${pct}%; height:100%; background:${color};"></div>
                        </div>
                    `;
                    cards.push(card);
                });

                // Render Chart
                const chartContainer = document.createElement('div');
                chartContainer.style.width = '100%';
                chartContainer.style.height = '250px';
                chartContainer.style.marginBottom = '20px';
                chartContainer.style.display = 'flex';
                chartContainer.style.justifyContent = 'center';
                
                const canvas = document.createElement('canvas');
                canvas.id = 'monitor-dashboard-chart';
                chartContainer.appendChild(canvas);
                rackingGrid.appendChild(chartContainer);

                if (typeof Chart !== 'undefined') {
                if (monitorDashboardChart) {
                    monitorDashboardChart.destroy();
                    monitorDashboardChart = null;
                }

                monitorDashboardChart = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Counted', 'Remaining'],
                        datasets: [{
                            data: [grandTotalCounted, grandTotalCapacity - grandTotalCounted],
                            backgroundColor: ['#2ecc71', '#e74c3c'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Total: ${grandTotalCounted} / ${grandTotalCapacity} (${grandTotalCapacity > 0 ? Math.round((grandTotalCounted/grandTotalCapacity)*100) : 0}%)`,
                                font: { size: 16 }
                            },
                            legend: { position: 'bottom' }
                        }
                    }
                });
                }

                // Render Cards Grid
                const cardsGrid = document.createElement('div');
                cardsGrid.style.display = 'grid';
                cardsGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(250px, 1fr))';
                cardsGrid.style.gap = '20px';
                cardsGrid.style.width = '100%';
                cards.forEach(c => cardsGrid.appendChild(c));
                rackingGrid.appendChild(cardsGrid);

                return;
            }
            
            if(monitorFileActions) monitorFileActions.style.display = 'flex';
            // Config
            const config = subAreaConfigs[area] || { width: 20, levels: 5, total: 100 }; // Default if not defined
            
            // Filter counts for this area
            const areaCounts = cycleCounts.filter(item => {
                const d = new Date(item.createdDate || item.date);
                const dateMatch = (!start || d >= start) && (!end || d <= end);
                // Match location starting with area name
                const locMatch = (item.location || '').toUpperCase().startsWith(area);
                return dateMatch && locMatch;
            });
            
            const countedCount = areaCounts.length;
            let globalCellIndex = 0;
            let totalCapacity = 0;
            let totalEffectiveCounted = 0;
            
            // Render Grid
            rackingGrid.innerHTML = '';
            rackingGrid.style.maxWidth = 'none';
            
            if (config.type === 'multi') {
                rackingGrid.style.display = 'flex';
                rackingGrid.style.flexDirection = 'column';
                rackingGrid.style.gap = '40px'; // Space between blocks
                rackingGrid.style.alignItems = 'center';
                
                config.blocks.forEach((block, blockIndex) => {
                    const blockWrapper = document.createElement('div');
                    blockWrapper.style.display = 'flex';
                    blockWrapper.style.flexDirection = 'column';
                    blockWrapper.style.alignItems = 'flex-start';
                    blockWrapper.style.width = '100%';
                    blockWrapper.style.maxWidth = `${block.width * CELL_SIZE}px`;

                    const headerDiv = document.createElement('div');
                    headerDiv.style.marginBottom = '5px';
                    headerDiv.innerHTML = `<label style="font-size:12px; font-weight:bold; cursor:pointer; display:flex; align-items:center;"><input type="checkbox" class="block-select-all" data-block="${blockIndex}" style="margin-right:5px;"> Select All</label>`;
                    headerDiv.querySelector('input').onclick = (e) => toggleBlockSelection(blockIndex, e.target.checked);
                    blockWrapper.appendChild(headerDiv);

                    const blockDiv = document.createElement('div');
                    blockDiv.style.display = 'flex';
                    blockDiv.style.flexDirection = 'column';
                    blockDiv.style.gap = '2px';
                    blockDiv.style.width = '100%';
                    
                    // Loop rows (levels)
                    for (let r = 0; r < block.levels; r++) {
                        const rowDiv = document.createElement('div');
                        rowDiv.style.display = 'grid';
                        rowDiv.style.gridTemplateColumns = `30px repeat(${block.width}, 1fr)`; // Add column for row checkbox
                        rowDiv.style.gap = '2px';
                        rowDiv.style.width = '100%';

                        // Row Checkbox
                        const rowCheckDiv = document.createElement('div');
                        rowCheckDiv.className = 'row-select-label';
                        rowCheckDiv.style.display = 'flex';
                        rowCheckDiv.style.alignItems = 'center';
                        rowCheckDiv.style.justifyContent = 'center';
                        rowCheckDiv.style.cursor = 'pointer';
                        rowCheckDiv.innerHTML = `<input type="checkbox" class="row-checkbox-monitor" title="Select Row">`;
                        rowCheckDiv.querySelector('input').onclick = (e) => toggleRowSelection(blockIndex, r, e.target.checked, block.width, block.prefix, block.rowBase, block.rowStep);
                        rowDiv.appendChild(rowCheckDiv);

                        for (let c = 0; c < block.width; c++) {
                        const isAutoCounted = globalCellIndex < countedCount;
                        globalCellIndex++;
                        
                        // Generate Label: Prefix + RowNum + Col
                        const rowIdx = r;
                        const colIdx = c + 1;
                        const rowNum = (block.rowBase || 0) + (rowIdx * (block.rowStep || 10));
                        const label = `${block.prefix}${rowNum}-C${colIdx}`;
                        
                        const customName = customLabels[label];
                        const manualStatus = customStatuses[label];
                        
                        const isPartOfStats = (manualStatus !== 'empty' && manualStatus !== 'not-part');
                        let statusClass = '';
                        let isCounted = false;
                        if (manualStatus === 'counted') {
                            isCounted = true;
                            statusClass = 'counted';
                        } else if (manualStatus === 'ongoing') {
                            isCounted = false;
                            statusClass = 'ongoing';
                        } else if (manualStatus === 'uncounted') {
                            isCounted = false;
                            statusClass = 'uncounted';
                        } else if (manualStatus === 'empty') {
                            isCounted = false;
                            statusClass = 'empty';
                        } else if (manualStatus === 'not-part') {
                            isCounted = false;
                            statusClass = 'not-part';
                        } else { // auto
                            isCounted = isAutoCounted;
                            if (isCounted) statusClass = 'counted';
                        }
                        
                        if (isPartOfStats) {
                            totalCapacity++;
                            if(isCounted) totalEffectiveCounted++;
                        }
                        
                        // Filter Logic
                        let showCell = true;
                        if (filterStatus !== 'all') {
                            if (filterStatus === 'counted' && !isCounted) showCell = false;
                            if (filterStatus === 'uncounted' && (isCounted || manualStatus === 'empty' || manualStatus === 'not-part' || manualStatus === 'ongoing')) showCell = false;
                            if (filterStatus === 'ongoing' && manualStatus !== 'ongoing') showCell = false;
                            if (filterStatus === 'empty' && manualStatus !== 'empty') showCell = false;
                        }
                        
                        if (searchTerm) {
                            const match = label.toLowerCase().includes(searchTerm) || (customName && customName.toLowerCase().includes(searchTerm));
                            if (!match) showCell = false;
                        }

                        const cell = document.createElement('div');
                        cell.className = `rack-cell ${statusClass}`;
                        if (!showCell) cell.style.opacity = '0.1';
                        
                        // Drag & Drop Attributes
                        cell.draggable = true;
                        cell.addEventListener('dragstart', handleDragStart);
                        cell.addEventListener('dragover', handleDragOver);
                        cell.addEventListener('dragenter', handleDragEnter);
                        cell.addEventListener('dragleave', handleDragLeave);
                        cell.addEventListener('drop', handleDrop);
                        cell.addEventListener('dragend', handleDragEnd);
                        
                        cell.dataset.id = label;
                        cell.dataset.block = blockIndex;
                        if (monitorSelectedCells.has(label)) cell.classList.add('selected');
                        
                        cell.title = `${customName || 'Grid'} - ${isCounted ? 'Counted' : 'Not Counted'}`;
                        cell.onclick = (e) => {
                            if(e.target.type !== 'checkbox') openCellEditModal(label, customName, manualStatus);
                        };
                        
                        if (manualStatus !== 'not-part' && manualStatus !== 'empty') {
                            cell.innerHTML = `<svg class="pallet-icon" viewBox="0 0 24 24"><path d="M19 13H5c-1.1 0-2 .9-2 2v4h2v2h14v-2h2v-4c0-1.1-.9-2-2-2zM7 19v-2h2v2H7zm4 0v-2h2v2h-2zm4 0v-2h2v2h-2zM4 9h16v2H4V9zm0-4h16v2H4V5z"/></svg>`;
                        }
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'cell-checkbox';
                        checkbox.checked = monitorSelectedCells.has(label);
                        checkbox.onclick = (e) => { 
                            e.stopPropagation(); 
                            const checked = e.target.checked;
                            if(checked) cell.classList.add('selected'); else cell.classList.remove('selected');
                            toggleCellSelection(label, checked); 
                        };
                        
                        cell.appendChild(checkbox);
                        
                        if(customName) {
                            const nameSpan = document.createElement('span');
                            nameSpan.className = 'cell-name';
                            nameSpan.textContent = customName;
                            cell.appendChild(nameSpan);
                        }
                        
                        rowDiv.appendChild(cell);
                    }
                    blockDiv.appendChild(rowDiv);
                    }
                    blockWrapper.appendChild(blockDiv);
                    rackingGrid.appendChild(blockWrapper);
                });
                
                // Render Floor
                if (config.floor) {
                    const floorCells = config.floor.width * config.floor.levels;
                    let floorCounted = 0;
                    
                    const floorHeader = document.createElement('h4');
                    floorHeader.textContent = 'FLOOR';
                    floorHeader.classList.add('floor-element');
                    floorHeader.style.width = '100%';
                    floorHeader.style.textAlign = 'center';
                    floorHeader.style.margin = '30px 0 10px 0';
                    floorHeader.style.color = '#2752a7';
                    floorHeader.style.borderTop = '2px dashed #ccc';
                    floorHeader.style.paddingTop = '10px';
                    rackingGrid.appendChild(floorHeader);

                    const floorDiv = document.createElement('div');
                    floorDiv.classList.add('floor-element');
                    floorDiv.style.display = 'grid';
                    floorDiv.style.gridTemplateColumns = `repeat(${config.floor.width}, 1fr)`;
                    floorDiv.style.gap = '2px';
                    floorDiv.style.width = '100%';
                    floorDiv.style.maxWidth = `${config.floor.width * CELL_SIZE}px`;
                    
                    for (let i = 0; i < floorCells; i++) {
                        const isAutoCounted = globalCellIndex < countedCount;
                        globalCellIndex++;
                        
                        const label = `${config.floor.prefix}-${i+1}`;
                        const customName = customLabels[label];
                        const manualStatus = customStatuses[label];
                        
                        let statusClass = '';
                        let isCounted = false;
                        if (manualStatus === 'counted') { isCounted = true; statusClass = 'counted'; }
                        else if (manualStatus === 'ongoing') { isCounted = false; statusClass = 'ongoing'; }
                        else if (manualStatus === 'uncounted') { isCounted = false; statusClass = 'uncounted'; }
                        else if (manualStatus === 'empty') { isCounted = true; statusClass = 'empty'; }
                        else if (manualStatus === 'not-part') { isCounted = false; statusClass = 'not-part'; }
                        else { isCounted = isAutoCounted; if (isCounted) statusClass = 'counted'; }
                        
                        if(isCounted) {
                            floorCounted++;
                        }
                        
                        // Filter Logic
                        let showCell = true;
                        if (filterStatus !== 'all') {
                            if (filterStatus === 'counted' && !isCounted) showCell = false;
                            if (filterStatus === 'uncounted' && (isCounted || manualStatus === 'empty' || manualStatus === 'not-part' || manualStatus === 'ongoing')) showCell = false;
                            if (filterStatus === 'ongoing' && manualStatus !== 'ongoing') showCell = false;
                            if (filterStatus === 'empty' && manualStatus !== 'empty') showCell = false;
                        }
                        
                        if (searchTerm) {
                            const match = label.toLowerCase().includes(searchTerm) || (customName && customName.toLowerCase().includes(searchTerm));
                            if (!match) showCell = false;
                        }

                        const cell = document.createElement('div');
                        cell.className = `rack-cell ${statusClass}`;
                        if (!showCell) cell.style.opacity = '0.1';
                        cell.draggable = true;
                        cell.addEventListener('dragstart', handleDragStart);
                        cell.addEventListener('dragover', handleDragOver);
                        cell.addEventListener('dragenter', handleDragEnter);
                        cell.addEventListener('dragleave', handleDragLeave);
                        cell.addEventListener('drop', handleDrop);
                        cell.addEventListener('dragend', handleDragEnd);
                        
                        cell.dataset.id = label;
                        cell.dataset.block = 'floor';
                        if (monitorSelectedCells.has(label)) cell.classList.add('selected');
                        cell.title = `${customName || 'Floor'} - ${isCounted ? 'Counted' : 'Not Counted'}`;
                        cell.onclick = (e) => { if(e.target.type !== 'checkbox') openCellEditModal(label, customName, manualStatus); };
                        if (manualStatus !== 'not-part' && manualStatus !== 'empty') {
                            cell.innerHTML = `<svg class="pallet-icon" viewBox="0 0 24 24"><path d="M19 13H5c-1.1 0-2 .9-2 2v4h2v2h14v-2h2v-4c0-1.1-.9-2-2-2zM7 19v-2h2v2H7zm4 0v-2h2v2h-2zm4 0v-2h2v2h-2zM4 9h16v2H4V9zm0-4h16v2H4V5z"/></svg>`;
                        }
                        const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.className = 'cell-checkbox'; checkbox.checked = monitorSelectedCells.has(label);
                        checkbox.onclick = (e) => { e.stopPropagation(); const checked = e.target.checked; if(checked) cell.classList.add('selected'); else cell.classList.remove('selected'); toggleCellSelection(label, checked); };
                        cell.appendChild(checkbox);
                        if(customName) { const nameSpan = document.createElement('span'); nameSpan.className = 'cell-name'; nameSpan.textContent = customName; cell.appendChild(nameSpan); }
                        floorDiv.appendChild(cell);
                    }
                    rackingGrid.appendChild(floorDiv);
                    floorHeader.textContent = `FLOOR (${floorCounted} / ${floorCells})`;
                }
            } else {
                rackingGrid.style.display = 'grid';
                rackingGrid.style.gridTemplateColumns = `repeat(${config.width}, 1fr)`;
                rackingGrid.style.maxWidth = `${config.width * CELL_SIZE}px`;
                rackingGrid.style.width = '100%';
                const totalCells = (config.total || (config.width * config.levels)) || 0;
                for (let i = 0; i < totalCells; i++) {
                    const cell = document.createElement('div');
                    cell.className = `rack-cell ${i < countedCount ? 'counted' : ''}`;
                    cell.title = i < countedCount ? 'Counted' : 'Empty';
                    rackingGrid.appendChild(cell);
                }
            }
            
            // Update capacity info after loop (since 'not-part' and 'empty' reduce it)
            document.getElementById('monitor-capacity-info').textContent = `Capacity: ${totalCapacity} positions`;
            const pct = totalCapacity > 0 ? Math.round((totalEffectiveCounted / totalCapacity) * 100) : 0;
            document.getElementById('monitor-stats').innerHTML = `Counted: ${totalEffectiveCounted} / ${totalCapacity} (${pct}%)`;
        }

        if(monitorFilterStatus) monitorFilterStatus.addEventListener('change', renderMonitorGrid);
        if(monitorSearchInput) monitorSearchInput.addEventListener('input', renderMonitorGrid);

        if(monitorPrintBtn) {
            monitorPrintBtn.addEventListener('click', () => {
                const content = document.getElementById('racking-grid');
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Sub Area Monitor</title>');
                printWindow.document.write('<style>.rack-cell { border: 1px solid #ccc; width: 40px; height: 25px; display: inline-block; margin: 1px; text-align: center; font-size: 8px; vertical-align: top; position: relative; } .counted { background: #e8f5e9; } .ongoing { background: #fff9c4; } .uncounted { background: #ffebee; } .empty { background: #e1f5fe; } .not-part { background: #cfd8dc; } .selected { border-color: #2752a7; } .pallet-icon { display: none; } .floor-element { display: none; } .cell-checkbox, .block-select-all, .row-select-label, input[type=checkbox], label { display: none !important; } .cell-name { display: block; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; overflow: hidden; text-overflow: ellipsis; background: transparent; box-shadow: none; font-size: 8px; font-weight: bold; }</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write(`<h2>${monitorSubAreaSelect.value} Monitor - Status: ${monitorFilterStatus.value}</h2>`);
                printWindow.document.write(content.innerHTML);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 500);
            });
        }

        if(monitorExportBtn) {
            monitorExportBtn.addEventListener('click', () => {
                const currentArea = monitorSubAreaSelect.value;
                const areasToExport = currentArea ? [currentArea] : subAreaOptions;
                const filterStatus = monitorFilterStatus ? monitorFilterStatus.value : 'all';
                
                const rows = [['Area', 'CellID', 'Name', 'Status', 'Manual Override']];
                const labels = JSON.parse(localStorage.getItem('ims_rack_labels_v1') || '{}');
                const statuses = JSON.parse(localStorage.getItem('ims_rack_status_v1') || '{}');
                let cycleCounts = [];
                try { cycleCounts = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]'); } catch(e){}

                // Date filter for auto-count calculation
                const start = (globalStartDate && globalStartDate.value) ? new Date(globalStartDate.value) : null;
                if (start) start.setHours(0,0,0,0);
                const end = (globalEndDate && globalEndDate.value) ? new Date(globalEndDate.value) : null;
                if (end) end.setHours(23,59,59,999);

                areasToExport.forEach(area => {
                    const config = subAreaConfigs[area];
                    if (!config) return;

                    // Calculate countedCount for this area (for Auto status)
                    const areaCounts = cycleCounts.filter(item => {
                        const d = new Date(item.createdDate || item.date);
                        const dateMatch = (!start || d >= start) && (!end || d <= end);
                        const locMatch = (item.location || '').toUpperCase().startsWith(area);
                        return dateMatch && locMatch;
                    });
                    const countedCount = areaCounts.length;
                    let globalCellIndex = 0;

                    const processCell = (label, isAutoCounted) => {
                        const manualStatus = statuses[label];
                        let status = 'Uncounted';
                        if (manualStatus === 'counted') status = 'Counted';
                        else if (manualStatus === 'ongoing') status = 'On-going';
                        else if (manualStatus === 'empty') status = 'Empty';
                        else if (manualStatus === 'not-part') status = 'Not Part';
                        else if (manualStatus === 'uncounted') status = 'Uncounted';
                        else if (isAutoCounted) status = 'Counted';

                        // Apply Filter
                        if (filterStatus !== 'all') {
                            if (filterStatus === 'counted' && status !== 'Counted') return;
                            if (filterStatus === 'uncounted' && status !== 'Uncounted') return;
                            if (filterStatus === 'ongoing' && status !== 'On-going') return;
                            if (filterStatus === 'empty' && status !== 'Empty') return;
                        }
                        rows.push([area, label, `"${labels[label] || ''}"`, status, manualStatus || '']);
                    };

                    if (config.type === 'multi') {
                        config.blocks.forEach(block => {
                            const blockCells = block.width * block.levels;
                            for(let i=0; i<blockCells; i++) {
                                const isAutoCounted = globalCellIndex < countedCount;
                                globalCellIndex++;
                                const rowIdx = Math.floor(i / block.width);
                                const colIdx = (i % block.width) + 1;
                                const rowNum = (block.rowBase || 0) + (rowIdx * (block.rowStep || 10));
                                const label = `${block.prefix}${rowNum}-C${colIdx}`;
                                processCell(label, isAutoCounted);
                            }
                        });
                        if (config.floor) {
                            const floorCells = config.floor.width * config.floor.levels;
                            for (let i = 0; i < floorCells; i++) {
                                const isAutoCounted = globalCellIndex < countedCount;
                                globalCellIndex++;
                                const label = `${config.floor.prefix}-${i+1}`;
                                processCell(label, isAutoCounted);
                            }
                        }
                    }
                });
                
                const csvContent = rows.map(e => e.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `${currentArea || 'All_Areas'}_monitor_export.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        if (monitorTemplateBtn) {
            monitorTemplateBtn.addEventListener('click', () => {
                const currentArea = monitorSubAreaSelect.value;
                const areasToProcess = currentArea ? [currentArea] : subAreaOptions;
                
                const rows = [['CellID', 'Name', 'Status']];
                const labels = JSON.parse(localStorage.getItem('ims_rack_labels_v1') || '{}');
                const statuses = JSON.parse(localStorage.getItem('ims_rack_status_v1') || '{}');
                
                const addRow = (id) => {
                    rows.push([id, `"${labels[id] || ''}"`, statuses[id] || '']);
                };

                areasToProcess.forEach(area => {
                    const config = subAreaConfigs[area];
                    if (!config) return;

                    if (config.type === 'multi') {
                        config.blocks.forEach(block => {
                            const blockCells = block.width * block.levels;
                            for(let i=0; i<blockCells; i++) {
                                const rowIdx = Math.floor(i / block.width);
                                const colIdx = (i % block.width) + 1;
                                const rowNum = (block.rowBase || 0) + (rowIdx * (block.rowStep || 10));
                                const label = `${block.prefix}${rowNum}-C${colIdx}`;
                                addRow(label);
                            }
                        });
                        if (config.floor) {
                            const floorCells = config.floor.width * config.floor.levels;
                            for (let i = 0; i < floorCells; i++) {
                                const label = `${config.floor.prefix}-${i+1}`;
                                addRow(label);
                            }
                        }
                    }
                });
                
                const csvContent = rows.map(e => e.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `${currentArea || 'All_Areas'}_monitor_template.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        if (monitorUploadBtn) {
            monitorUploadBtn.addEventListener('click', () => monitorFileInput.click());
        }

        if (monitorFileInput) {
            monitorFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!confirm(`Are you sure you want to upload "${file.name}"? This will overwrite existing cell data.`)) {
                    monitorFileInput.value = '';
                    return;
                }

                const progressBar = document.getElementById('upload-progress-bar');
                const progressContainer = document.getElementById('upload-progress-container');
                if (progressContainer) progressContainer.style.display = 'block';
                if (progressBar) { progressBar.style.width = '0%'; progressBar.textContent = '0%'; }

                const reader = new FileReader();
                reader.onprogress = (event) => {
                    if (event.lengthComputable && progressBar) {
                        const percent = Math.round((event.loaded / event.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressBar.textContent = percent + '%';
                    }
                };
                reader.onload = (event) => {
                    if (progressContainer) setTimeout(() => { progressContainer.style.display = 'none'; }, 500);
                    try {
                        const text = event.target.result;
                        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
                        if (lines.length < 2) { showToast('Invalid CSV format or empty file.', 'error'); return; }
                        
                        const labels = JSON.parse(localStorage.getItem('ims_rack_labels_v1') || '{}');
                        const statuses = JSON.parse(localStorage.getItem('ims_rack_status_v1') || '{}');
                        let updatedCount = 0;
                        
                        for (let i = 1; i < lines.length; i++) {
                            // Simple CSV parse handling quotes
                            let row = [];
                            let inQuote = false;
                            let current = '';
                            for(let char of lines[i]) {
                                if(char === '"') { inQuote = !inQuote; continue; }
                                if(char === ',' && !inQuote) { row.push(current); current = ''; }
                                else current += char;
                            }
                            row.push(current);

                            if (row.length >= 1) {
                                const id = row[0].trim();
                                const name = row.length > 1 ? row[1].trim() : '';
                                const status = row.length > 2 ? row[2].trim() : '';
                                
                                if (id) {
                                    if (name) labels[id] = name;
                                    if (status) {
                                        if (status === 'auto') delete statuses[id];
                                        else statuses[id] = status;
                                    }
                                    updatedCount++;
                                }
                            }
                        }
                        
                        localStorage.setItem('ims_rack_labels_v1', JSON.stringify(labels));
                        localStorage.setItem('ims_rack_status_v1', JSON.stringify(statuses));
                        showToast(`Updated ${updatedCount} cells.`);
                        renderMonitorGrid();
                        monitorFileInput.value = '';
                    } catch (err) {
                        showToast('Failed to process CSV file.', 'error');
                    }
                };
                reader.onerror = () => {
                    if (progressContainer) progressContainer.style.display = 'none';
                    showToast('Error reading file', 'error');
                    monitorFileInput.value = '';
                };
                reader.readAsText(file);
            });
        }
        
        // Drag and Drop Handlers
        let dragSrcEl = null;
        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
            this.classList.add('dragging');
        }
        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        function handleDragEnter(e) { this.classList.add('over'); }
        function handleDragLeave(e) { this.classList.remove('over'); }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            const srcId = e.dataTransfer.getData('text/plain');
            const destId = this.dataset.id;
            if (srcId !== destId) moveCellData(srcId, destId);
            return false;
        }
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.rack-cell').forEach(col => col.classList.remove('over'));
        }
        function moveCellData(srcId, destId) {
            const labels = JSON.parse(localStorage.getItem('ims_rack_labels_v1') || '{}');
            const statuses = JSON.parse(localStorage.getItem('ims_rack_status_v1') || '{}');
            // Move Name
            if (labels[srcId]) {
                labels[destId] = labels[srcId];
                delete labels[srcId];
            }
            // Move Status
            if (statuses[srcId]) {
                statuses[destId] = statuses[srcId];
                delete statuses[srcId];
            }
            localStorage.setItem('ims_rack_labels_v1', JSON.stringify(labels));
            localStorage.setItem('ims_rack_status_v1', JSON.stringify(statuses));
            renderMonitorGrid();
        }
        
        function toggleCellSelection(id, isChecked) {
            if (!isChecked) {
                monitorSelectedCells.delete(id);
            } else {
                monitorSelectedCells.add(id);
            }
            updateMonitorControls();
        }

        function toggleBlockSelection(blockIndex, isChecked) {
            const cells = document.querySelectorAll(`.rack-cell[data-block="${blockIndex}"]`);
            cells.forEach(cell => {
                const id = cell.dataset.id;
                const cb = cell.querySelector('.cell-checkbox');
                if (cb) {
                    cb.checked = isChecked;
                    if (isChecked) {
                        monitorSelectedCells.add(id);
                        cell.classList.add('selected');
                    } else {
                        monitorSelectedCells.delete(id);
                        cell.classList.remove('selected');
                    }
                }
            });
            updateMonitorControls();
        }

        function toggleRowSelection(blockIndex, rowIdx, isChecked, width, prefix, rowBase, rowStep) {
            const rowNum = (rowBase || 0) + (rowIdx * (rowStep || 10));
            for (let c = 1; c <= width; c++) {
                const label = `${prefix}${rowNum}-C${c}`;
                const cell = document.querySelector(`.rack-cell[data-id="${label}"]`);
                if (cell) {
                    const cb = cell.querySelector('.cell-checkbox');
                    if (cb) {
                        cb.checked = isChecked;
                        if (isChecked) {
                            monitorSelectedCells.add(label);
                            cell.classList.add('selected');
                        } else {
                            monitorSelectedCells.delete(label);
                            cell.classList.remove('selected');
                        }
                    }
                }
            }
            updateMonitorControls();
        }

        function updateMonitorControls() {
            if (monitorSelectedCells.size > 0) {
                monitorBulkActions.style.display = 'flex';
            } else {
                monitorBulkActions.style.display = 'none';
            }
        }
        
        function bulkUpdateStatus(status) {
            const statuses = JSON.parse(localStorage.getItem('ims_rack_status_v1') || '{}');
            monitorSelectedCells.forEach(cellId => {
                if (status !== 'auto') statuses[cellId] = status; else delete statuses[cellId];
            });
            localStorage.setItem('ims_rack_status_v1', JSON.stringify(statuses));
            monitorSelectedCells.clear();
            updateMonitorControls();
            showToast('Bulk status updated successfully!');
            renderMonitorGrid();
        }
        
        if (bulkCountedBtn) bulkCountedBtn.addEventListener('click', () => bulkUpdateStatus('counted'));
        if (bulkUncountedBtn) bulkUncountedBtn.addEventListener('click', () => bulkUpdateStatus('uncounted'));
        if (bulkEmptyBtn) bulkEmptyBtn.addEventListener('click', () => bulkUpdateStatus('empty'));
        
        if (bulkEditBtn) {
            bulkEditBtn.addEventListener('click', () => {
                document.getElementById('cell-edit-id').value = 'BULK';
                document.getElementById('cell-name-group').style.display = 'none';
                document.getElementById('cell-status').value = 'auto';
                document.querySelector('#cell-edit-modal h3').textContent = `Update ${monitorSelectedCells.size} Cells`;
                document.getElementById('cell-edit-modal').classList.remove('hidden');
            });
        }
        
        if (bulkCopyNamesBtn) {
            bulkCopyNamesBtn.addEventListener('click', () => {
                if (monitorSelectedCells.size === 0) {
                    alert('No cells selected to copy.');
                    return;
                }

                const customLabels = JSON.parse(localStorage.getItem('ims_rack_labels_v1') || '{}');
                const namesToCopy = [];

                monitorSelectedCells.forEach(cellId => {
                    const name = customLabels[cellId] || cellId;
                    namesToCopy.push(name);
                });

                const textToCopy = namesToCopy.join('\n');
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    alert(`${namesToCopy.length} pallet name(s) copied to clipboard.`);
                }).catch(err => {
                    console.error('Failed to copy names: ', err);
                    alert('Failed to copy names to clipboard.');
                });
            });
        }
        
        if (bulkPasteNamesBtn) {
            bulkPasteNamesBtn.addEventListener('click', async () => {
                if (monitorSelectedCells.size === 0) {
                    alert('No cells selected to paste into.');
                    return;
                }
                
                try {
                    const text = await navigator.clipboard.readText();
                    if (!text) {
                        alert('Clipboard is empty.');
                        return;
                    }
                    
                    const sourceNames = text.split(/\r?\n/).filter(line => line.trim() !== '');
                    if (sourceNames.length === 0) return;

                    const targetCells = Array.from(document.querySelectorAll('.rack-cell.selected'));
                    const currentArea = document.getElementById('monitor-sub-area-select').value;
                    const customLabels = JSON.parse(localStorage.getItem('ims_rack_labels_v1') || '{}');
                    
                    targetCells.forEach((cell, index) => {
                        const cellId = cell.dataset.id;
                        const sourceName = sourceNames[index % sourceNames.length].trim();
                        let newName = sourceName;
                        if (currentArea && currentArea.length === 3 && /^[A-Z]{3}/.test(sourceName)) {
                            newName = currentArea + sourceName.substring(3);
                        }
                        customLabels[cellId] = newName;
                    });

                    localStorage.setItem('ims_rack_labels_v1', JSON.stringify(customLabels));
                    renderMonitorGrid();
                    alert(`Pasted and updated ${targetCells.length} cells.`);
                } catch (err) {
                    console.error('Failed to read clipboard:', err);
                    alert('Failed to read from clipboard. Please ensure you have granted permission.');
                }
            });
        }
        
        function openCellEditModal(id, currentName, currentStatus) {
            document.getElementById('cell-edit-id').value = id;
            document.getElementById('cell-name-group').style.display = '';
            document.querySelector('#cell-edit-modal h3').textContent = 'Edit Grid Name';
            document.getElementById('cell-custom-name').value = currentName || '';
            document.getElementById('cell-status').value = currentStatus || 'auto';
            document.getElementById('cell-edit-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('cell-custom-name').focus(), 100);
        }
        
        document.getElementById('save-cell-btn').addEventListener('click', () => {
            const id = document.getElementById('cell-edit-id').value;
            const status = document.getElementById('cell-status').value;
            
            if (id === 'BULK') {
                const statuses = JSON.parse(localStorage.getItem('ims_rack_status_v1') || '{}');
                monitorSelectedCells.forEach(cellId => {
                    if (status !== 'auto') statuses[cellId] = status; else delete statuses[cellId];
                });
                localStorage.setItem('ims_rack_status_v1', JSON.stringify(statuses));
                monitorSelectedCells.clear();
                updateMonitorControls();
            } else {
                const name = document.getElementById('cell-custom-name').value.trim();
                const labels = JSON.parse(localStorage.getItem('ims_rack_labels_v1') || '{}');
                if (name) labels[id] = name; else delete labels[id];
                localStorage.setItem('ims_rack_labels_v1', JSON.stringify(labels));
                
                const statuses = JSON.parse(localStorage.getItem('ims_rack_status_v1') || '{}');
                if (status !== 'auto') statuses[id] = status; else delete statuses[id];
                localStorage.setItem('ims_rack_status_v1', JSON.stringify(statuses));
            }
             showToast('Cell updated successfully!');
            
            document.getElementById('cell-edit-modal').classList.add('hidden');
            renderMonitorGrid();
        });

        // Fix tooltips globally to use native title (avoids clipping/z-index issues)
        function fixTooltips() {
            document.querySelectorAll('.icon-btn[data-tooltip]').forEach(btn => {
                btn.setAttribute('title', btn.getAttribute('data-tooltip'));
                btn.removeAttribute('data-tooltip');
            });
        }
        setInterval(fixTooltips, 1000);

        function getShiftFromTimestamp(ts) {
            const d = new Date(ts);
            if (isNaN(d.getTime())) return { date: '', shift: '' };
            const h = d.getHours();
            // Use local date components
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            let dateStr = `${year}-${month}-${day}`;
            let shift = '';
            
            if (h >= 6 && h < 14) {
                shift = '1st Shift-(6am-2pm)';
            } else if (h >= 14 && h < 22) {
                shift = '2nd Shift-(2pm-10pm)';
            } else {
                shift = '3rd Shift-(10pm-6am)';
                if (h < 6) {
                    const prev = new Date(d);
                    prev.setDate(d.getDate() - 1);
                    const pYear = prev.getFullYear();
                    const pMonth = String(prev.getMonth() + 1).padStart(2, '0');
                    const pDay = String(prev.getDate()).padStart(2, '0');
                    dateStr = `${pYear}-${pMonth}-${pDay}`;
                }
            }
            return { date: dateStr, shift };
        }

        // Quick Time In Logic
        const quickTimeInBtn = document.getElementById('quick-time-in-btn');
        const quickUserIdInput = document.getElementById('quick-user-id');
        const quickUserNameInput = document.getElementById('quick-user-name');
        const quickUserRoleInput = document.getElementById('quick-user-role');
        const quickClearBtn = document.getElementById('quick-clear-btn');

        if (quickTimeInBtn && quickUserIdInput) {
            quickUserIdInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') quickTimeInBtn.click();
            });

            if(quickClearBtn) {
                quickClearBtn.addEventListener('click', () => {
                    quickUserIdInput.value = '';
                    if(quickUserNameInput) quickUserNameInput.value = '';
                    if(quickUserRoleInput) quickUserRoleInput.value = '';
                    quickUserIdInput.focus();
                });
            }

            // Update Clock
            function updateQuickClock() {
                const el = document.getElementById('quick-widget-clock');
                if(el) el.textContent = new Date().toLocaleString();
            }
            setInterval(updateQuickClock, 1000);
            updateQuickClock();

            // Auto-populate Name/Role
            quickUserIdInput.addEventListener('input', () => {
                const val = quickUserIdInput.value.trim().toUpperCase();
                if (val) {
                    const masterUsers = getMasterUsers();
                    const user = masterUsers.find(u => u.userId === val);
                    if (user) {
                        if(quickUserNameInput) quickUserNameInput.value = user.name || '';
                        if(quickUserRoleInput) quickUserRoleInput.value = user.role || '';
                    } else {
                        if(quickUserNameInput) quickUserNameInput.value = '';
                        if(quickUserRoleInput) quickUserRoleInput.value = '';
                    }
                } else {
                    if(quickUserNameInput) quickUserNameInput.value = '';
                    if(quickUserRoleInput) quickUserRoleInput.value = '';
                }
            });

            quickTimeInBtn.addEventListener('click', () => {
                const userId = quickUserIdInput.value.trim().toUpperCase();
                if (!userId) { showToast('Please enter User ID'); return; }

                const masterUsers = getMasterUsers();
                const user = masterUsers.find(u => u.userId === userId);

                if (!user) {
                    alert(`User ID ${userId} not found in Master List.`);
                    return;
                }

                const now = new Date();
                const shiftInfo = getShiftFromTimestamp(now.toISOString());
                const date = shiftInfo.date;
                const shift = shiftInfo.shift;
                const timeIn = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});

                const attendance = getAttendanceData();
                const exists = attendance.find(a => a.date === date && a.shift === shift && a.userId === userId);

                if (exists) {
                    alert(`User ${user.name} is already timed in for ${shift} on ${date}.`);
                    quickUserIdInput.value = '';
                    return;
                }

                const newEntry = {
                    id: Date.now().toString(),
                    date: date,
                    shift: shift,
                    userId: user.userId,
                    name: user.name,
                    role: user.role || 'IC Support',
                    jobDescription: 'Cycle Counter',
                    timeIn: timeIn,
                    breakOut: '',
                    breakIn: '',
                    timeOut: '',
                    status: 'Full counter',
                    notes: 'Quick Time In'
                };

                attendance.push(newEntry);
                saveAttendanceData(attendance);
                
                showToast(`Timed in: ${user.name}`);
                quickUserIdInput.value = '';
                if(quickUserNameInput) quickUserNameInput.value = '';
                if(quickUserRoleInput) quickUserRoleInput.value = '';
                
                renderAttendanceTable();
                renderCountersTable();
            });
        }

        // Update Attendance Modal Area Options
        const attAreaSelect = document.getElementById('att-area');
        if (attAreaSelect) {
            attAreaSelect.innerHTML = `
                <option value="Pick Bin">Pick Bin</option>
                <optgroup label="Reserved Bin">
                    ${subAreaOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                </optgroup>
            `;
        }
        // Also update filter dropdown in attendance card
        if (attFilterArea) {
             attFilterArea.innerHTML = `<option value="">All Areas</option><option value="Pick Bin">Pick Bin</option>` + 
             subAreaOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        renderCountersTable();
        renderAttendanceTable();

        // Auto Refresh
        setInterval(() => {
            const check = document.getElementById('auto-refresh-check');
            if(check && check.checked) {
                if(document.querySelector('.modal:not(.hidden)')) return; // Don't refresh if modal open
                renderCountersTable();
                renderAttendanceTable();
            }
        }, 3000);

        // Auto Refresh Timestamp Modal (3s)
        setInterval(() => {
            const modal = document.getElementById('timestamp-modal');
            if (modal && !modal.classList.contains('hidden')) {
                renderTimestamps();
            }
        }, 3000);

        // Sidebar Timestamp Button Logic
        const sidebarTimestampBtn = document.getElementById('sidebar-timestamp-btn');
        if (sidebarTimestampBtn) {
            sidebarTimestampBtn.addEventListener('click', () => {
                sessionStorage.setItem('ims_timestamp_modal_open', 'true');
                const tm = document.getElementById('timestamp-modal');
                if (tm) {
                    tm.classList.remove('hidden');
                    renderTimestamps();
                }
            });
        }

        // Counter Timestamp Logic
        function getTimestamps() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_TIMESTAMPS) || '[]'); } catch(e) { return []; }
        }
        function saveTimestamps(data) {
            localStorage.setItem(STORAGE_KEY_TIMESTAMPS, JSON.stringify(data));
        }

        window.filterTsByArea = function(area) {
            tsFilterArea = area;
            // Switch to Active Sessions tab
            const tabBtn = document.querySelector('button[onclick*="tab-active"]');
            if(tabBtn) tabBtn.click();
            renderTimestamps();
        };

        window.resetTsFilters = function() {
            tsFilterArea = null;
            tsBreakFilterLong = false;
            const chk = document.getElementById('ts-show-long-active');
            if(chk) chk.checked = false;
        };

        function renderAreaDashboard(activeSessions) {
            const container = document.getElementById('area-dashboard-grid');
            if (!container) return;
            
            // Initialize data structure with arrays for user names
            const data = {
                'Pick Bin': {
                    'Coldroom': [], 'Ecom 2': [], 'Storage': [], 'Pallet Picking': []
                },
                'Reserved': {
                    'Coldroom': [], 'Ecom 2': [], 'Storage': []
                }
            };
            
            activeSessions.forEach(s => {
                const parts = (s.resolvedArea || '').split(' - ');
                if (parts.length === 2) {
                    const type = parts[0]; // Pick Bin or Reserved
                    const sub = parts[1];
                    // Map 'Reserved Bin' to 'Reserved' if needed, or handle exact match
                    const key = type.includes('Reserved') ? 'Reserved' : type;
                    
                    if (data[key] && data[key][sub]) {
                        data[key][sub].push(s.resolvedName || s.userId);
                    }
                }
            });
            
            let html = '';
            
            // Total Active Card
            const totalActive = activeSessions.length;
            html += `<div class="card" onclick="filterTsByArea(null)" style="padding:15px; text-align:center; background:#e8f5e9; border:1px solid #c8e6c9; margin-bottom:5px; cursor:pointer; display:flex; flex-direction:column; justify-content:center; min-height:100px; box-shadow:none;" title="Click to Show All">
                <div style="font-size:12px; color:#2e7d32; margin-bottom:5px; font-weight:600;">Total Active Users</div>
                <div style="font-size:32px; font-weight:bold; color:#2ecc71;">${totalActive}</div>
            </div>`;

            const renderSection = (title, items) => {
                let sectionHtml = `<div style="margin-bottom:5px;"><h5 style="margin:0; color:#2752a7; border-bottom:1px solid #eee; padding-bottom:5px;">${title}</h5></div>`;
                sectionHtml += `<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap:10px;">`;
                
                Object.entries(items).forEach(([subArea, users]) => {
                    const count = users.length;
                    const isZero = count === 0;
                    const bg = isZero ? '#f9f9f9' : '#e3f2fd';
                    const border = isZero ? '#eee' : '#90caf9';
                    const text = isZero ? '#999' : '#1565c0';
                    const valColor = isZero ? '#ccc' : '#1e88e5';
                    const userList = users.length > 0 ? users.join('<br>') : 'No active users';
                    const filterKey = `${title} - ${subArea}`;
                    
                    sectionHtml += `<div class="card area-dash-card" onclick="filterTsByArea('${filterKey}')" style="padding:15px; text-align:center; background:${bg}; border:1px solid ${border}; margin:0; display:flex; flex-direction:column; justify-content:center; min-height:100px; box-shadow:none; position:relative; cursor:pointer;">
                        <div style="font-size:12px; color:${text}; margin-bottom:5px; font-weight:600;">${subArea}</div>
                        <div style="font-size:28px; font-weight:bold; color:${valColor};">${count}</div>
                        <div class="hover-tooltip" style="display:none; position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:8px; border-radius:4px; font-size:11px; width:160px; z-index:100; pointer-events:none; white-space:normal; box-shadow:0 4px 8px rgba(0,0,0,0.2); line-height:1.4;">
                            <div style="font-weight:bold; border-bottom:1px solid #555; margin-bottom:4px; padding-bottom:2px; color:#eee;">Active Users</div>
                            ${userList}
                            <div style="position:absolute; top:100%; left:50%; margin-left:-5px; border-width:5px; border-style:solid; border-color:#333 transparent transparent transparent;"></div>
                        </div>
                    </div>`;
                });
                sectionHtml += `</div>`;
                return sectionHtml;
            };
            
            html += renderSection('Pick Bin', data['Pick Bin']);
            html += renderSection('Reserved Bin', data['Reserved']);
            
            container.innerHTML = html;
            
            // Add hover listeners
            container.querySelectorAll('.area-dash-card').forEach(card => {
                const tooltip = card.querySelector('.hover-tooltip');
                if(tooltip){
                    card.addEventListener('mouseenter', () => tooltip.style.display = 'block');
                    card.addEventListener('mouseleave', () => tooltip.style.display = 'none');
                }
            });
        }

        function renderUserDashboard(sessions) {
            const container = document.getElementById('user-dashboard-content');
            if (!container) return;

            const shiftStats = {
                '1st Shift-(6am-2pm)': {},
                '2nd Shift-(2pm-10pm)': {},
                '3rd Shift-(10pm-6am)': {}
            };

            sessions.forEach(s => {
                if (s.endLog && s.endLog.skus) {
                    const shift = s.resolvedShift;
                    const name = s.resolvedName || s.userId;
                    const count = parseInt(s.endLog.skus) || 0;
                    
                    if (shiftStats[shift]) {
                        if (!shiftStats[shift][name]) shiftStats[shift][name] = 0;
                        shiftStats[shift][name] += count;
                    }
                }
            });

            let html = '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:15px;">';

            Object.keys(shiftStats).forEach(shift => {
                const users = shiftStats[shift];
                const sortedUsers = Object.entries(users).sort((a, b) => b[1] - a[1]);
                const totalSkus = sortedUsers.reduce((sum, [_, count]) => sum + count, 0);
                const shortShiftName = shift.split('-')[0];

                html += `<div class="card" style="padding:0; border:1px solid #eee; overflow:hidden; box-shadow:none;">
                    <div style="background:#f5f5f5; padding:10px; border-bottom:1px solid #eee; font-weight:bold; color:#2752a7; display:flex; justify-content:space-between; align-items:center;">
                        <span>${shortShiftName}</span>
                        <span style="font-size:12px; background:#e3f2fd; color:#1565c0; padding:2px 6px; border-radius:4px;">Total: ${totalSkus}</span>
                    </div>
                    <div style="max-height:300px; overflow-y:auto;"><table style="width:100%; border-collapse:collapse; font-size:12px;"><thead style="background:#fff; position:sticky; top:0;"><tr><th style="text-align:left; padding:8px; border-bottom:1px solid #eee; color:#666;">User</th><th style="text-align:right; padding:8px; border-bottom:1px solid #eee; color:#666;">SKUs</th></tr></thead><tbody>`;
                
                if (sortedUsers.length === 0) {
                    html += `<tr><td colspan="2" style="padding:10px; text-align:center; color:#999;">No data</td></tr>`;
                } else {
                    sortedUsers.forEach(([user, count]) => {
                        html += `<tr><td style="padding:6px 8px; border-bottom:1px solid #f0f0f0;">${user}</td><td style="padding:6px 8px; border-bottom:1px solid #f0f0f0; text-align:right; font-weight:bold;">${count}</td></tr>`;
                    });
                }
                html += `</tbody></table></div></div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function renderTimestamps() {
            const data = getTimestamps();
            const attendance = getAttendanceData();
            const filterShift = tsShiftFilter ? tsShiftFilter.value : '';
            const filterUser = tsFilterUser ? tsFilterUser.value.toLowerCase() : '';
            const showLongActive = tsShowLongActive ? tsShowLongActive.checked : false;
            
            // Analytics Date
            let analyticsDate = tsAnalyticsDateFilter ? tsAnalyticsDateFilter.value : '';
            if (!analyticsDate) {
                analyticsDate = new Date().toISOString().split('T')[0];
                if(tsAnalyticsDateFilter) tsAnalyticsDateFilter.value = analyticsDate;
            }

            // Filter logs
            let logsToProcess = data;
            
            // Sort ascending to calculate sessions
            logsToProcess.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            const sessions = [];
            const openSessions = {};
            
            logsToProcess.forEach(log => {
                if (log.deleted) return;
                
                if (log.action === 'Start') {
                    if (openSessions[log.userId]) {
                        sessions.push(openSessions[log.userId]); // Push incomplete previous session
                    }
                    openSessions[log.userId] = { userId: log.userId, startLog: log, endLog: null, breaks: [], currentBreakStart: null };
                } else if (log.action === 'Start Break') {
                    if (openSessions[log.userId]) {
                        openSessions[log.userId].currentBreakStart = log;
                    }
                } else if (log.action === 'End Break') {
                    if (openSessions[log.userId] && openSessions[log.userId].currentBreakStart) {
                        const bStart = new Date(openSessions[log.userId].currentBreakStart.timestamp);
                        const bEnd = new Date(log.timestamp);
                        const bDur = (bEnd - bStart) / 60000; // minutes
                        openSessions[log.userId].breaks.push({ start: openSessions[log.userId].currentBreakStart, end: log, duration: bDur });
                        openSessions[log.userId].currentBreakStart = null;
                    }
                } else if (log.action === 'End') {
                    if (openSessions[log.userId]) {
                        const session = openSessions[log.userId];
                        session.endLog = log;
                        sessions.push(session);
                        delete openSessions[log.userId];
                    } else {
                        // Orphaned end
                        sessions.push({ userId: log.userId, startLog: null, endLog: log, breaks: [] });
                    }
                }
            });
            
            // Add remaining open sessions
            Object.values(openSessions).forEach(s => sessions.push(s));

            // Filter sessions by user input
            let filteredSessions = sessions;
            
            // Shift Filter
            if (filterShift) {
                filteredSessions = filteredSessions.filter(s => {
                    let shiftToCheck = '';
                    let sessionDate = '';
                    if (s.startLog) {
                        const info = getShiftFromTimestamp(s.startLog.timestamp);
                        sessionDate = info.date;
                        shiftToCheck = info.shift;
                    } else if (s.endLog) {
                        const info = getShiftFromTimestamp(s.endLog.timestamp);
                        sessionDate = info.date;
                        shiftToCheck = info.shift;
                    }
                    const attRecord = attendance.find(a => a.userId === s.userId && a.date === sessionDate);
                    if (attRecord && attRecord.shift) shiftToCheck = attRecord.shift;
                    return shiftToCheck.includes(filterShift);
                });
            }

            if (filterUser) {
                const terms = filterUser.split(' ').filter(t => t);
                filteredSessions = sessions.filter(s => {
                    const attRecord = attendance.find(a => a.userId === s.userId);
                    const name = attRecord ? attRecord.name : '';
                    const shiftInfo = s.startLog ? getShiftFromTimestamp(s.startLog.timestamp) : { shift: '' };
                    const searchStr = (s.userId + ' ' + name + ' ' + shiftInfo.shift).toLowerCase();
                    return terms.every(term => searchStr.includes(term));
                });
            }

            if (showLongActive) {
                const now = new Date();
                filteredSessions = filteredSessions.filter(s => {
                    if (s.endLog) return false; // Must be active
                    const diff = now - new Date(s.startLog.timestamp);
                    return (diff / 60000) > 60; // Greater than 60 mins
                });
            }

            // Pre-calculate fields for all sessions to support dashboard and filtering
            const now = new Date();
            filteredSessions.forEach(s => {
                const ts = s.startLog ? s.startLog.timestamp : (s.endLog ? s.endLog.timestamp : null);
                let sessionDate = '';
                if (ts) {
                    const d = new Date(ts);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    sessionDate = `${year}-${month}-${day}`;
                }
                let attRecord = attendance.find(a => a.userId === s.userId && a.date === sessionDate);
                if (!attRecord) attRecord = attendance.find(a => a.userId === s.userId);
                
                s.resolvedName = attRecord ? attRecord.name : '-';
                s.resolvedShift = attRecord && attRecord.shift ? attRecord.shift : (s.startLog ? getShiftFromTimestamp(s.startLog.timestamp).shift : '-');
                s.resolvedArea = s.startLog ? (s.startLog.areaType || '-') : '-';
                s.startTime = s.startLog ? s.startLog.timestamp : (s.endLog ? s.endLog.timestamp : '');
                s.endTime = s.endLog ? s.endLog.timestamp : '';
                
                // Duration calculation
                let durationMins = 0;
                const totalBreakMins = s.breaks ? s.breaks.reduce((acc, b) => acc + b.duration, 0) : 0;
                if (s.startLog && s.endLog) {
                    const diff = new Date(s.endLog.timestamp) - new Date(s.startLog.timestamp);
                    durationMins = Math.round((diff / 60000) - totalBreakMins);
                } else if (s.startLog) {
                    const diff = now - new Date(s.startLog.timestamp);
                    durationMins = Math.floor(diff / 60000);
                }
                s.durationVal = durationMins;
            });

            // Capture active sessions for dashboard BEFORE applying area filter
            const dashboardActiveSessions = filteredSessions.filter(s => !s.endLog);

            // Apply Area Filter (if selected from dashboard)
            if (tsFilterArea) {
                filteredSessions = filteredSessions.filter(s => s.resolvedArea === tsFilterArea);
            }

            // Sort
            filteredSessions.sort((a,b) => {
                let valA = a[tsSortField];
                let valB = b[tsSortField];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return tsSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return tsSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Split into Active and History
            const activeSessions = filteredSessions.filter(s => !s.endLog);
            const historySessions = filteredSessions.filter(s => s.endLog);

            // Update Header Cards (Active Sessions)
            let statsActiveSessions = sessions.filter(s => !s.endLog);
            if (filterShift) {
                statsActiveSessions = statsActiveSessions.filter(s => s.resolvedShift.includes(filterShift));
            }
            const statsActiveCount = statsActiveSessions.length;
            const statsLongActiveCount = statsActiveSessions.filter(s => {
                const diff = new Date() - new Date(s.startLog.timestamp);
                return (diff / 60000) > 60;
            }).length;

            const cardActive = document.getElementById('card-active-sessions');
            if(cardActive) cardActive.textContent = statsActiveCount;
            
            const cardLong = document.getElementById('card-long-sessions');
            if(cardLong) {
                cardLong.textContent = statsLongActiveCount;
                if (statsLongActiveCount > 0) {
                    cardLong.parentElement.classList.add('blink-red-card');
                } else {
                    cardLong.parentElement.classList.remove('blink-red-card');
                }
            }

            // Pagination Logic
            const totalItems = historySessions.length;
            const totalPages = Math.ceil(totalItems / tsItemsPerPage) || 1;
            if (tsCurrentPage > totalPages) tsCurrentPage = totalPages;
            if (tsCurrentPage < 1) tsCurrentPage = 1;
            
            const paginatedHistory = historySessions.slice((tsCurrentPage - 1) * tsItemsPerPage, tsCurrentPage * tsItemsPerPage);
            
            // Update Controls
            const tsPageInfo = document.getElementById('ts-page-info');
            if(tsPageInfo) {
                tsPageInfo.textContent = `Page ${tsCurrentPage} of ${totalPages} (${totalItems})`;
                document.getElementById('ts-prev-page').disabled = tsCurrentPage <= 1;
                document.getElementById('ts-next-page').disabled = tsCurrentPage >= totalPages;
            }
            
            // Update sort icons
            document.querySelectorAll('.report-table th.sortable .sort-icon').forEach(icon => icon.textContent = '');
            const activeHeader = document.querySelector(`.report-table th[data-sort="${tsSortField}"]`);
            if(activeHeader) activeHeader.querySelector('.sort-icon').textContent = tsSortDirection === 'asc' ? '↑' : '↓';

            // Render Active Table
            if (activeTableBody) {
                activeTableBody.innerHTML = '';
                if (activeSessions.length === 0) {
                    activeTableBody.innerHTML = '<tr><td colspan="7" style="padding:10px; text-align:center; color:#999;">No active sessions.</td></tr>';
                } else {
                    activeSessions.forEach(session => {
                        const tr = createSessionRow(session, false);
                        activeTableBody.appendChild(tr);
                    });
                }
            }

            // Render History Table
            if (historyTableBody) {
                historyTableBody.innerHTML = '';
                if (paginatedHistory.length === 0) {
                    historyTableBody.innerHTML = '<tr><td colspan="9" style="padding:10px; text-align:center; color:#999;">No history logs.</td></tr>';
                if(tsSelectAll) tsSelectAll.checked = false;
            } else {
                paginatedHistory.forEach(session => {
                    const tr = createSessionRow(session, true);
                    historyTableBody.appendChild(tr);
                });
            }
            }
            updateTsDeleteButton();
            
            renderAreaDashboard(dashboardActiveSessions);
            renderUserDashboard(sessions);

            // Calculate Total Duration
            const totalMinutes = sessions.reduce((sum, s) => sum + (s.duration || 0), 0);
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            const totalStr = (h > 0 ? h + 'h ' : '') + m + 'm';
            const totalEl = document.getElementById('ts-total-duration');
            if(totalEl) totalEl.textContent = `Total: ${totalStr}`;

            // Prepare chart data (completed sessions only)
            const chartSessions = sessions.filter(s => s.endLog && s.durationVal > 0).map(s => ({
                user: s.userId,
                shift: s.resolvedShift,
                duration: s.durationVal,
                end: s.endLog.timestamp
            }));
            renderTimestampChart(chartSessions);
            renderTsAnalytics(sessions, analyticsDate, logsToProcess);
            renderTsHourlyChart(analyticsDate);
            renderBreakLogTable(logsToProcess, attendance);
            cachedInactiveArgs = [sessions, attendance, logsToProcess];
            renderInactiveUsersTable(sessions, attendance, logsToProcess);
            renderEmbeddedHourly(analyticsDate, filterShift);
        }

        function createSessionRow(session, isHistory) {
            const userId = session.userId;
            const name = session.resolvedName;
            const areaTypeDisplay = session.resolvedArea;
            const shiftDisplay = session.resolvedShift.split('-')[0];
            const datePrefix = (session.startLog) ? new Date(session.startLog.timestamp).toLocaleDateString() + ' ' : '';
            const startStr = session.startLog ? `<span class="editable-time" data-log-id="${session.startLog.id}">${datePrefix + new Date(session.startLog.timestamp).toLocaleTimeString()}</span>` : '-';
            const endStr = session.endLog ? `<span class="editable-time" data-log-id="${session.endLog.id}">${new Date(session.endLog.timestamp).toLocaleTimeString()}</span>` : '-';
            
            let duration = '-';
            let isHigh = false;
            const durationMins = session.durationVal;
            
            if (session.endLog) {
                duration = `${durationMins} min`;
                if (durationMins >= 30) isHigh = true;
            } else if (session.startLog) {
                duration = `Active (${durationMins}m)`;
                if (durationMins > 60) {
                    duration += ' ⚠️ > 1hr';
                    isHigh = true; 
                }
            }
            session.duration = durationMins;
            session.shift = session.resolvedShift;
            
            const tr = document.createElement('tr');
            if ((session.startLog && session.startLog.deleted) || (session.endLog && session.endLog.deleted)) {
                tr.style.opacity = '0.5';
                tr.style.background = '#f9f9f9';
            }
            
            const idsToDelete = [session.startLog?.id, session.endLog?.id, ...(session.breaks || []).flatMap(b => [b.start.id, b.end.id])].filter(x=>x).join(',');
            const deleteAction = `<button class="icon-btn delete-action-btn" onclick="deleteSession('${idsToDelete}')" title="Permanently Delete Session" style="color:#d9534f; opacity:0; transition:opacity 0.2s;">&times;</button>`;
            const rowIds = idsToDelete;
            
            let quickAction = '';
            if (!session.endLog) {
                if (session.currentBreakStart) {
                    quickAction = `<button class="icon-btn quick-action-btn" onclick="logTimestamp('End Break', null, '${userId}')" title="End Break" style="color:#f39c12; margin-right:4px; opacity:0; transition:opacity 0.2s;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button>`;
                } else {
                    quickAction = `<button class="icon-btn quick-action-btn" onclick="logTimestamp('End', null, '${userId}')" title="End Counting" style="color:#e74c3c; margin-right:4px; opacity:0; transition:opacity 0.2s;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg></button>`;
                }
            }

            let checkboxHtml = isHistory ? `<td><input type="checkbox" class="ts-row-checkbox" data-ids="${rowIds}"></td>` : '';
            
            tr.innerHTML = `${checkboxHtml}<td>${userId}</td><td>${name}</td><td>${areaTypeDisplay}</td><td>${shiftDisplay}</td><td style="color:#2ecc71; font-weight:bold;">${startStr}</td>${isHistory ? `<td style="color:#e74c3c; font-weight:bold;">${endStr}</td>` : ''}<td style="${isHigh ? 'color:#e74c3c; font-weight:bold;' : (duration.includes('Active')?'color:#2ecc71;font-weight:bold':'')}">${duration}</td><td>${quickAction}${deleteAction}</td>`;
            
            tr.onmouseenter = () => { tr.querySelectorAll('.quick-action-btn').forEach(b => b.style.opacity = '1'); tr.querySelectorAll('.delete-action-btn').forEach(b => b.style.opacity = '1'); };
            tr.onmouseleave = () => { tr.querySelectorAll('.quick-action-btn').forEach(b => b.style.opacity = '0'); tr.querySelectorAll('.delete-action-btn').forEach(b => b.style.opacity = '0'); };
            return tr;
        }
        
        function updateTsDeleteButton() {
            const count = document.querySelectorAll('.ts-row-checkbox:checked').length;
            if(tsDeleteSelectedBtn) tsDeleteSelectedBtn.style.display = count > 0 ? 'inline-block' : 'none';
        }
        
        if(tsSelectAll) {
            tsSelectAll.addEventListener('change', (e) => {
                document.querySelectorAll('.ts-row-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateTsDeleteButton();
            });
        }
        
        if(historyTableBody) {
            historyTableBody.addEventListener('change', (e) => { if(e.target.classList.contains('ts-row-checkbox')) updateTsDeleteButton(); });
        }

        // Timestamp Sorting Listeners
        document.querySelectorAll('#timestamp-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (tsSortField === field) {
                    tsSortDirection = tsSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    tsSortField = field;
                    tsSortDirection = 'asc';
                }
                renderTimestamps();
            });
        });

        function renderTsAnalytics(sessions, date, logs) {
            const container = document.getElementById('ts-analytics-content');
            if(!container) return;
            container.innerHTML = '';
            
            // 1. Attendance Stats (Full vs Temp)
            const attendance = getAttendanceData().filter(a => a.date === date);
            
            // Identify active users (no end log) from the sessions passed
            const activeUserIds = new Set(sessions.filter(s => !s.endLog).map(s => s.userId));
            
            const shiftData = {
                '1st Shift-(6am-2pm)': { full: 0, fullActive: 0, temp: 0, timedOut: 0 },
                '2nd Shift-(2pm-10pm)': { full: 0, fullActive: 0, temp: 0, timedOut: 0 },
                '3rd Shift-(10pm-6am)': { full: 0, fullActive: 0, temp: 0, timedOut: 0 }
            };
            
            let totalTemp = 0;

            attendance.forEach(a => {
                if (shiftData[a.shift]) {
                    if (a.status && a.status.toLowerCase() === 'full counter') {
                        shiftData[a.shift].full++;
                        if (activeUserIds.has(a.userId)) shiftData[a.shift].fullActive++;
                        if (a.timeOut) shiftData[a.shift].timedOut++;
                    }
                    if (a.status === 'Temporary slide to Other task') {
                        shiftData[a.shift].temp++;
                        totalTemp++;
                    }
                }
            });

            // Calculate On-Break Users
            const onBreakUserIds = new Set();
            const userLastAction = {};
            logs.forEach(l => {
                if (!l.deleted) userLastAction[l.userId] = l.action;
            });
            Object.entries(userLastAction).forEach(([uid, action]) => {
                if (action === 'Start Break') onBreakUserIds.add(uid);
            });

            // Calculate Inactive Users (Full counters only, not active, not on break)
            let inactiveCount = 0;
            const filterShift = tsShiftFilter ? tsShiftFilter.value : '';
            attendance.forEach(a => {
                if (a.status && a.status.toLowerCase() === 'full counter') {
                    if (filterShift && !a.shift.includes(filterShift)) return;
                    if (a.timeOut) return; // Already timed out
                    if (!activeUserIds.has(a.userId) && !onBreakUserIds.has(a.userId)) {
                        inactiveCount++;
                    }
                }
            });

            const cardInactive = document.getElementById('card-inactive-users');
            if(cardInactive) cardInactive.textContent = inactiveCount;

            // 2. Session Stats
            const userStarts = {};
            let totalDuration = 0;
            let completedSessions = 0;
            let activeSessions = 0;
            let totalBreaks = 0;

            sessions.forEach(s => {
                userStarts[s.userId] = (userStarts[s.userId] || 0) + 1;
                if (s.duration > 0) {
                    totalDuration += s.duration;
                    completedSessions++;
                } else if (!s.endLog) {
                    activeSessions++;
                }
                if (s.breaks) totalBreaks += s.breaks.length;
            });

            // Calculate Unique Users with Breaks (from logs directly to catch all)
            const usersWithBreaks = new Set();
            logs.forEach(l => {
                if (l.action === 'Start Break') usersWithBreaks.add(l.userId);
            });
            const uniqueBreakUsers = usersWithBreaks.size;
            
            // Find Most/Least Frequent
            let mostFreqUser = '-'; let mostFreqCount = 0;
            let mostFreqName = '-';
            let leastFreqUser = '-'; let leastFreqCount = Infinity;
            let leastFreqName = '-';
            
            Object.entries(userStarts).forEach(([user, count]) => {
                if (count > mostFreqCount) { 
                    mostFreqCount = count; mostFreqUser = user; 
                    const att = attendance.find(a => a.userId === user);
                    if(att) mostFreqName = att.name;
                }
                if (count < leastFreqCount) { 
                    leastFreqCount = count; leastFreqUser = user; 
                    const att = attendance.find(a => a.userId === user);
                    if(att) leastFreqName = att.name;
                }
            });
            if (leastFreqCount === Infinity) leastFreqCount = 0;

            // Build User List Table
            let userListHtml = '<div style="margin-top:10px; max-height:150px; overflow-y:auto; border:1px solid #eee;"><table style="width:100%; font-size:12px; border-collapse:collapse;"><thead><tr style="background:#f9f9f9;"><th style="padding:4px; text-align:left;">User</th><th style="padding:4px; text-align:left;">Name</th><th style="padding:4px; text-align:right;">Starts</th></tr></thead><tbody>';
            const sortedUsers = Object.entries(userStarts).sort((a,b) => b[1] - a[1]);
            sortedUsers.forEach(([u, c]) => {
                const att = attendance.find(a => a.userId === u);
                const name = att ? att.name : '-';
                userListHtml += `<tr><td style="padding:4px; border-bottom:1px solid #eee;">${u}</td><td style="padding:4px; border-bottom:1px solid #eee;">${name}</td><td style="padding:4px; border-bottom:1px solid #eee; text-align:right;">${c}</td></tr>`;
            });
            userListHtml += '</tbody></table></div>';

            const avgDuration = completedSessions > 0 ? Math.round(totalDuration / completedSessions) : 0;
            const totalH = Math.floor(totalDuration / 60);
            const totalM = totalDuration % 60;

            // Render HTML
            let html = `
                <div style="margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <h5 style="margin:0; color:#2752a7;">Full Counters (Active / Total)</h5>
                        <span style="font-size:11px; color:#f57c00; font-weight:bold;">Temp Slide: ${totalTemp}</span>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                        <div class="card" style="padding:15px; text-align:center; background:#e8f5e9; border:1px solid #c8e6c9; margin:0;">
                            <div style="font-size:12px; color:#2e7d32; margin-bottom:5px;">1st Shift</div>
                            <div style="font-weight:bold; color:#2ecc71; font-size:28px; margin-bottom:5px;">${shiftData['1st Shift-(6am-2pm)'].fullActive} <span style="color:#2e7d32; font-size:16px;">/ ${shiftData['1st Shift-(6am-2pm)'].full}</span></div>
                            <div style="font-size:11px; color:#666; margin-bottom:5px;">Timed Out: <strong>${shiftData['1st Shift-(6am-2pm)'].timedOut}</strong></div>
                            <button class="icon-btn hourly-shortcut-btn" onclick="window.openHourlyModal('${date}', '1st Shift-(6am-2pm)')" style="font-size:11px; padding:4px 8px; background:#fff; border:1px solid #c8e6c9; color:#2e7d32; border-radius:4px; cursor:pointer; width:100%;">Hourly View</button>
                        </div>
                        <div class="card" style="padding:15px; text-align:center; background:#e8f5e9; border:1px solid #c8e6c9; margin:0;">
                            <div style="font-size:12px; color:#2e7d32; margin-bottom:5px;">2nd Shift</div>
                            <div style="font-weight:bold; color:#2ecc71; font-size:28px; margin-bottom:5px;">${shiftData['2nd Shift-(2pm-10pm)'].fullActive} <span style="color:#2e7d32; font-size:16px;">/ ${shiftData['2nd Shift-(2pm-10pm)'].full}</span></div>
                            <div style="font-size:11px; color:#666; margin-bottom:5px;">Timed Out: <strong>${shiftData['2nd Shift-(2pm-10pm)'].timedOut}</strong></div>
                            <button class="icon-btn hourly-shortcut-btn" onclick="window.openHourlyModal('${date}', '2nd Shift-(2pm-10pm)')" style="font-size:11px; padding:4px 8px; background:#fff; border:1px solid #c8e6c9; color:#2e7d32; border-radius:4px; cursor:pointer; width:100%;">Hourly View</button>
                        </div>
                        <div class="card" style="padding:15px; text-align:center; background:#e8f5e9; border:1px solid #c8e6c9; margin:0;">
                            <div style="font-size:12px; color:#2e7d32; margin-bottom:5px;">3rd Shift</div>
                            <div style="font-weight:bold; color:#2ecc71; font-size:28px; margin-bottom:5px;">${shiftData['3rd Shift-(10pm-6am)'].fullActive} <span style="color:#2e7d32; font-size:16px;">/ ${shiftData['3rd Shift-(10pm-6am)'].full}</span></div>
                            <div style="font-size:11px; color:#666; margin-bottom:5px;">Timed Out: <strong>${shiftData['3rd Shift-(10pm-6am)'].timedOut}</strong></div>
                            <button class="icon-btn hourly-shortcut-btn" onclick="window.openHourlyModal('${date}', '3rd Shift-(10pm-6am)')" style="font-size:11px; padding:4px 8px; background:#fff; border:1px solid #c8e6c9; color:#2e7d32; border-radius:4px; cursor:pointer; width:100%;">Hourly View</button>
                        </div>
                    </div>
                </div>

                <div style="background:#f8f9fa; border-radius:6px; padding:12px; margin-bottom:10px; border:1px solid #eee;">
                    <h5 style="margin:0 0 8px 0; color:#2752a7;">Session Insights</h5>
                    <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:13px;">
                        <span>Most Frequent Start:</span>
                        <strong>${mostFreqUser} | ${mostFreqName} (${mostFreqCount})</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:13px;">
                        <span>Least Frequent Start:</span>
                        <strong>${leastFreqUser} | ${leastFreqName} (${leastFreqCount})</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:13px;">
                        <span>Avg. Duration:</span>
                        <strong>${avgDuration} min</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:13px;">
                        <span>Active Sessions:</span>
                        <strong style="color:${activeSessions > 0 ? '#2ecc71' : '#666'}">${activeSessions}</strong>
                    </div>
                    <div style="margin-top:8px;">
                        <h6 style="margin:0 0 4px 0; color:#666;">Starts per User</h6>
                        ${userListHtml}
                    </div>
                </div>

                <div style="background:#fff; border-radius:6px; padding:12px; border:1px solid #eee;">
                    <h5 style="margin:0 0 8px 0; color:#666;">Suggestions & Stats</h5>
                    <ul style="margin:0; padding-left:20px; font-size:12px; color:#555;">
                        <li>Total Users Tracked: <strong>${Object.keys(userStarts).length}</strong></li>
                        <li>Total Breaks Taken: <strong>${totalBreaks}</strong></li>
                        <li>Completed Sessions: <strong>${completedSessions}</strong></li>
                        <li>Total Hours Logged: <strong>${Math.round(totalDuration/60)}h</strong></li>
                        <li>Total Inactive Users: <strong style="color:${inactiveCount > 0 ? '#e74c3c' : '#2ecc71'}">${inactiveCount}</strong></li>
                        <li>Unique Users w/ Breaks: <strong>${uniqueBreakUsers}</strong></li>
                    </ul>
                </div>
                <div style="text-align:center; margin-top:20px;">
                    <div class="sand-timer" title="Shift Countdown">
                        <div class="sand-timer-top"><div class="sand-timer-sand-top"></div></div>
                        <div class="sand-timer-bottom"><div class="sand-timer-sand-bottom"></div></div>
                        <div class="sand-timer-stream"></div>
                    </div>
                    <div id="shift-countdown-display" style="margin-top:8px; font-weight:bold; color:#e74c3c; font-size:18px; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">--h --m --s</div>
                    <div id="shift-countdown-label" style="font-size:11px; color:#888; text-transform:uppercase; letter-spacing:1px;">Shift Remaining</div>
                </div>
            `;
            container.innerHTML = html;
            
            if (!window.shiftTimerInterval) {
                const updateTimer = () => {
                    const el = document.getElementById('shift-countdown-display');
                    const labelEl = document.getElementById('shift-countdown-label');
                    if (!el) return;
                    
                    const now = new Date();
                    const h = now.getHours();
                    let end = new Date(now);
                    let shiftName = '';
                    
                    if (h >= 6 && h < 14) {
                        shiftName = '1st Shift';
                        end.setHours(14, 0, 0, 0);
                    } else if (h >= 14 && h < 22) {
                        shiftName = '2nd Shift';
                        end.setHours(22, 0, 0, 0);
                    } else {
                        shiftName = '3rd Shift';
                        if (h >= 22) {
                            end.setDate(end.getDate() + 1);
                            end.setHours(6, 0, 0, 0);
                        } else {
                            end.setHours(6, 0, 0, 0);
                        }
                    }
                    
                    let diff = end - now;
                    if (diff < 0) diff = 0;
                    
                    const hh = Math.floor(diff / 3600000);
                    const mm = Math.floor((diff % 3600000) / 60000);
                    const ss = Math.floor((diff % 60000) / 1000);
                    
                    el.textContent = `${hh}h ${mm}m ${ss}s`;
                    if(labelEl) labelEl.textContent = `${shiftName} Ends`;
                };
                window.shiftTimerInterval = setInterval(updateTimer, 1000);
                updateTimer();
            }
        }
        
        function openEditTimeModal(logId) {
            const data = getTimestamps();
            const log = data.find(d => d.id === logId);
            if (log) {
                const editTimeModal = document.getElementById('edit-time-modal');
                document.getElementById('edit-time-log-id').value = logId;
                // Format for datetime-local input (YYYY-MM-DDTHH:mm)
                const d = new Date(log.timestamp);
                const localISO = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                document.getElementById('edit-time-input').value = localISO;
                editTimeModal.classList.remove('hidden');
            }
        }

        function renderBreakLogTable(logs, attendanceData) {
            const activeTbody = document.querySelector('#active-break-table tbody');
            const historyTbody = document.querySelector('#history-break-table tbody');
            
            if(activeTbody) activeTbody.innerHTML = '';
            if(historyTbody) historyTbody.innerHTML = '';
            
            const breaks = [];
            const openBreaks = {};
            const now = new Date();
            
            // Sort logs by time ascending
            const sortedLogs = [...logs].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            sortedLogs.forEach(log => {
                if (log.userId && !log.deleted) {
                    if (log.action === 'Start Break') openBreaks[log.userId] = log;
                    else if (log.action === 'End Break' && openBreaks[log.userId]) {
                        breaks.push({ userId: log.userId, start: openBreaks[log.userId].timestamp, end: log.timestamp, startId: openBreaks[log.userId].id, endId: log.id });
                        delete openBreaks[log.userId];
                    }
                }
            });
            
            // Add open breaks
            Object.keys(openBreaks).forEach(uid => {
                 breaks.push({ userId: uid, start: openBreaks[uid].timestamp, end: null, startId: openBreaks[uid].id, endId: null });
            });
            
            // Filters
            const filterShift = breakShiftFilter ? breakShiftFilter.value : '';
            
            let filteredBreaks = breaks.filter(b => {
                if (filterShift) {
                    const att = attendanceData.find(a => a.userId === b.userId) || {};
                    const shift = att.shift || '';
                    if (!shift.includes(filterShift)) return false;
                }
                return true;
            });

            if (tsBreakFilterLong) {
                filteredBreaks = filteredBreaks.filter(b => {
                    const start = new Date(b.start);
                    const end = b.end ? new Date(b.end) : now;
                    return ((end - start) / 60000) > 40;
                });
            }

            filteredBreaks.sort((a,b) => new Date(b.start) - new Date(a.start));
            
            const activeBreaks = filteredBreaks.filter(b => !b.end);
            const historyBreaks = filteredBreaks.filter(b => b.end);

            // Update Header Cards (Breaks)
            let longBreakCount = 0;
            activeBreaks.forEach(b => {
                const start = new Date(b.start);
                const durationMs = new Date() - start;
                if (durationMs / 60000 > 40) longBreakCount++;
            });
            
            const cardBreaks = document.getElementById('card-active-breaks');
            if(cardBreaks) cardBreaks.textContent = activeBreaks.length;
            
            const cardLongBreaks = document.getElementById('card-long-breaks');
            if(cardLongBreaks) {
                cardLongBreaks.textContent = longBreakCount;
                if (longBreakCount > 0) {
                    cardLongBreaks.parentElement.classList.add('blink-orange-card');
                } else {
                    cardLongBreaks.parentElement.classList.remove('blink-orange-card');
                }
            }

            // Render Active
            if(activeTbody) {
                if(activeBreaks.length === 0) {
                    activeTbody.innerHTML = '<tr><td colspan="7" style="padding:10px; text-align:center; color:#999;">No active breaks.</td></tr>';
                } else {
                    activeBreaks.forEach(b => {
                        const att = attendanceData.find(a => a.userId === b.userId) || {};
                        const name = att.name || '-';
                        const shift = att.shift ? att.shift.split('-')[0] : '-';
                        const role = att.role || '-';
                        const start = new Date(b.start);
                        const durationMs = now - start;
                        const durationMins = Math.floor(durationMs / 60000);
                        
                        let durationDisplay = `Running (${durationMins} min)`;
                        let rowStyle = '';
                        if (durationMins > 40) {
                            rowStyle = 'background-color: #ffebee; color: #c0392b; font-weight: bold;';
                            durationDisplay += ' ⚠️ > 40m';
                        } else {
                            durationDisplay = `<span style="color:orange">${durationDisplay}</span>`;
                        }
                        
                        const startStr = `<span class="editable-time" data-log-id="${b.startId}">${start.toLocaleTimeString()}</span>`;
                        
                        const endBreakBtn = `<button class="icon-btn end-break-btn" onclick="logTimestamp('End Break', null, '${b.userId}')" title="End Break" style="color:#f39c12; padding:2px 6px; font-size:10px; margin-right:4px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        </button>`;
                        const deleteBtn = `<button class="icon-btn delete-break-btn" onclick="deleteBreak('${b.startId}', null)" title="Delete Break" style="color:#d9534f; padding:2px 6px; font-size:10px;">&times;</button>`;

                        const tr = document.createElement('tr');
                        if (rowStyle) tr.style.cssText = rowStyle;
                        tr.innerHTML = `<td>${b.userId}</td><td>${name}</td><td>${shift}</td><td>${role}</td><td>${startStr}</td><td>${durationDisplay}</td><td>${endBreakBtn}${deleteBtn}</td>`;
                        activeTbody.appendChild(tr);
                    });
                }
            }

            // Render History
            if(historyTbody) {
                if(historyBreaks.length === 0) {
                    historyTbody.innerHTML = '<tr><td colspan="9" style="padding:10px; text-align:center; color:#999;">No break history.</td></tr>';
                    if(breakSelectAll) breakSelectAll.checked = false;
                } else {
                    historyBreaks.forEach(b => {
                        const att = attendanceData.find(a => a.userId === b.userId) || {};
                        const name = att.name || '-';
                        const shift = att.shift ? att.shift.split('-')[0] : '-';
                        const role = att.role || '-';
                        const start = new Date(b.start);
                        const end = new Date(b.end);
                        const durationMs = end - start;
                        const durationMins = Math.floor(durationMs / 60000);
                        const durationDisplay = `${durationMins} min`;
                        
                        const startStr = `<span class="editable-time" data-log-id="${b.startId}">${start.toLocaleTimeString()}</span>`;
                        const endStr = `<span class="editable-time" data-log-id="${b.endId}">${end.toLocaleTimeString()}</span>`;
                        
                        const deleteBtn = `<button class="icon-btn delete-break-btn" onclick="deleteBreak('${b.startId}', '${b.endId}')" title="Delete Break" style="color:#d9534f; padding:2px 6px; font-size:10px; opacity:0; transition:opacity 0.2s;">&times;</button>`;
                        const rowIds = [b.startId, b.endId].filter(x=>x).join(',');

                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td><input type="checkbox" class="break-row-checkbox" data-ids="${rowIds}"></td><td>${b.userId}</td><td>${name}</td><td>${shift}</td><td>${role}</td><td>${startStr}</td><td>${endStr}</td><td>${durationDisplay}</td><td>${deleteBtn}</td>`;
                        
                        tr.onmouseenter = () => { tr.querySelectorAll('.delete-break-btn').forEach(b => b.style.opacity = '1'); };
                        tr.onmouseleave = () => { tr.querySelectorAll('.delete-break-btn').forEach(b => b.style.opacity = '0'); };
                        
                        historyTbody.appendChild(tr);
                    });
                }
            }
            updateBreakDeleteButton();
        }
        
        function updateBreakDeleteButton() {
            const count = document.querySelectorAll('.break-row-checkbox:checked').length;
            if(breakDeleteSelectedBtn) breakDeleteSelectedBtn.style.display = count > 0 ? 'inline-block' : 'none';
        }
        
        if(breakSelectAll) {
            breakSelectAll.addEventListener('change', (e) => {
                document.querySelectorAll('.break-row-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateBreakDeleteButton();
            });
        }
        
        if(document.getElementById('history-break-table')) {
            document.getElementById('history-break-table').addEventListener('change', (e) => { if(e.target.classList.contains('break-row-checkbox')) updateBreakDeleteButton(); });
        }

        let tsHourlyChartViewMode = 'hourly'; // 'hourly' or 'cumulative'

        function renderTsHourlyChart(date) {
            const ctx = document.getElementById('ts-hourly-chart');
            if (!ctx || typeof Chart === 'undefined') return;
            
            const counters = getCountersData();
            const attendance = getAttendanceData();
            
            // Filter by shift if selected in the timestamp modal
            const shiftFilter = document.getElementById('ts-shift-filter') ? document.getElementById('ts-shift-filter').value : '';
            let todayCounters = counters.filter(c => c.date === date);
            if (shiftFilter) {
                todayCounters = todayCounters.filter(c => c.shift.includes(shiftFilter));
            }
            
            if (todayCounters.length === 0) {
                if(ctx.parentElement) {
                    ctx.parentElement.innerHTML = '<div style="text-align:center; padding:40px; color:#999; font-size:13px;">No data for ' + date + '</div>';
                }
                return;
            }
            
            const hourlyData = {}, hourlyTargets = {};
            const hoursOrder = [];
            const backgroundColors = [];
            const borderColors = [];
            
            // Initialize hours 6am to 6am (24h)
            for (let i = 0; i < 24; i++) {
                const h = (6 + i) % 24;
                const label = `${h}:00 - ${h+1}:00`;
                hourlyData[label] = 0;
                hourlyTargets[label] = 0;
                hoursOrder.push(label);
                
                // Set colors based on shift
                if (h >= 6 && h < 14) { // 1st Shift
                    backgroundColors.push('rgba(54, 185, 204, 0.8)'); // Cyan
                    borderColors.push('#36b9cc');
                } else if (h >= 14 && h < 22) { // 2nd Shift
                    backgroundColors.push('rgba(246, 194, 62, 0.8)'); // Yellow
                    borderColors.push('#f6c23e');
                } else { // 3rd Shift
                    backgroundColors.push('rgba(78, 115, 223, 0.8)'); // Blue
                    borderColors.push('#4e73df');
                }
            }
            
            // Aggregate data from all shifts
            todayCounters.forEach(counter => {
                if (counter.hourlyActuals) {
                    Object.keys(counter.hourlyActuals).forEach(label => {
                        if (hourlyData.hasOwnProperty(label)) {
                            hourlyData[label] += Number(counter.hourlyActuals[label]) || 0;
                        }
                    });
                }
                
                if (counter.hourlyTargets) {
                    Object.keys(counter.hourlyTargets).forEach(label => {
                        if (hourlyTargets.hasOwnProperty(label)) {
                            hourlyTargets[label] += Number(counter.hourlyTargets[label]) || 0;
                        }
                    });
                } else {
                    const shiftAtt = attendance.filter(a => a.date === date && a.shift === counter.shift);
                    const headcount = shiftAtt.length;
                    const rate = Number(counter.standardRate) || 0;
                    const activeTarget = rate > 0 ? (headcount * rate) : (Number(counter.targetOutput) || 0);
                    const defaultHourlyTarget = activeTarget > 0 ? Math.round(activeTarget / 8) : 0;
                    
                    if (counter.shift === "1st Shift-(6am-2pm)") {
                        for (let h = 6; h < 14; h++) {
                            hourlyTargets[`${h}:00 - ${h+1}:00`] += defaultHourlyTarget;
                        }
                    } else if (counter.shift === "2nd Shift-(2pm-10pm)") {
                        for (let h = 14; h < 22; h++) {
                            hourlyTargets[`${h}:00 - ${h+1}:00`] += defaultHourlyTarget;
                        }
                    } else if (counter.shift === "3rd Shift-(10pm-6am)") {
                        const hours = [22, 23, 0, 1, 2, 3, 4, 5];
                        hours.forEach(h => {
                            hourlyTargets[`${h}:00 - ${h+1}:00`] += defaultHourlyTarget;
                        });
                    }
                }
            });
            
            const labels = hoursOrder;
            const values = labels.map(l => hourlyData[l]);
            const targetValues = labels.map(l => hourlyTargets[l]);
            
            // Calculate cumulative
            const cumulativeData = [];
            let sum = 0;
            for (const val of values) {
                sum += val;
                cumulativeData.push(sum);
            }

            // Calculate Glide Path (Cumulative Target)
            const glidePathData = [];
            let targetSum = 0;
            for (const val of targetValues) {
                targetSum += val;
                glidePathData.push(targetSum);
            }
            
            if (window.tsHourlyChart) window.tsHourlyChart.destroy();
            
            let datasets = [];
            if (tsHourlyChartViewMode === 'hourly') {
                datasets = [
                    { 
                        label: 'Hourly Output', 
                        data: values, 
                        backgroundColor: backgroundColors, 
                        borderColor: borderColors,
                        borderWidth: 1,
                        order: 2 
                    },
                    { 
                        label: 'Hourly Target', 
                        data: targetValues, 
                        type: 'line',
                        borderColor: '#3498db', 
                        backgroundColor: 'transparent', 
                        tension: 0.2,
                        borderDash: [2, 2],
                        borderWidth: 1,
                        order: 1 
                    }
                ];
            } else {
                datasets = [
                    { 
                        label: 'Total Output', 
                        data: cumulativeData, 
                        type: 'line',
                        borderColor: '#e74c3c', 
                        backgroundColor: 'transparent', 
                        tension: 0.2,
                        borderWidth: 2,
                        order: 1 
                    },
                    { 
                        label: 'Glide Path', 
                        data: glidePathData, 
                        type: 'line',
                        borderColor: '#27ae60', 
                        backgroundColor: 'transparent', 
                        tension: 0.2,
                        borderDash: [5, 5],
                        borderWidth: 2,
                        order: 2 
                    }
                ];
            }

            try {
                window.tsHourlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top', labels: { font: { size: 10 }, padding: 8 } },
                            tooltip: { enabled: true }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch(e) {
                console.error('Chart error:', e);
            }
        }

                function renderInactiveUsersTable(sessions, attendanceData, logs) {
            const tbody = document.querySelector('#inactive-users-table tbody');
            if(!tbody) return;
            tbody.innerHTML = '';
            const filterShift = tsShiftFilter ? tsShiftFilter.value : '';
            
            const dateInput = document.getElementById('ts-analytics-date-filter');
            const filterDate = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().split('T')[0];
            
            // Get all Full Counters for the date
            const fullCounters = attendanceData.filter(a => a.date === filterDate && a.status && a.status.toLowerCase() === 'full counter');
            
            // Map of userId -> last end timestamp (from sessions)
            const userLastEnd = {};
            const activeUserIds = new Set();
            
            sessions.forEach(s => {
                if (!s.endLog) {
                    activeUserIds.add(s.userId);
                } else {
                    const t = new Date(s.endLog.timestamp).getTime();
                    if (!userLastEnd[s.userId] || t > userLastEnd[s.userId]) {
                        userLastEnd[s.userId] = t;
                    }
                }
            });

            // Determine users currently on break
            const onBreakUserIds = new Set();
            const userLastAction = {};
            logs.forEach(l => { if (!l.deleted) userLastAction[l.userId] = l.action; });
            Object.entries(userLastAction).forEach(([uid, action]) => {
                if (action === 'Start Break') onBreakUserIds.add(uid);
            });
            
            const inactiveList = [];
            
            fullCounters.forEach(att => {
                if (filterShift && !att.shift.includes(filterShift)) return;
                if (att.timeOut) return; // Skip if already timed out
                if (!activeUserIds.has(att.userId)) {
                    // Not currently active session
                    let lastEnd = '-';
                    let status = 'Not Started';
                    
                    if (userLastEnd[att.userId]) {
                        lastEnd = new Date(userLastEnd[att.userId]).toLocaleTimeString();
                        status = 'Inactive';
                    }

                    // If on break, do not add to inactive list
                    if (onBreakUserIds.has(att.userId)) return;
                    
                    inactiveList.push({
                        userId: att.userId,
                        name: att.name,
                        shift: att.shift,
                        role: att.role,
                        lastEnd: lastEnd,
                        status: status
                    });
                }
            });
            
            if(inactiveList.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="padding:10px; text-align:center; color:#999;">No inactive users found.</td></tr>'; return; }
            
            // Sort: Not Started first
            if (inactiveSort.field) {
                inactiveList.sort((a,b) => {
                    const valA = (a[inactiveSort.field] || '').toString().toLowerCase();
                    const valB = (b[inactiveSort.field] || '').toString().toLowerCase();
                    return inactiveSort.dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                });
            }
            inactiveList.sort((a,b) => {
                if (a.status === 'Not Started' && b.status !== 'Not Started') return -1;
                if (a.status !== 'Not Started' && b.status === 'Not Started') return 1;
                return 0;
            });
            
            inactiveList.forEach(u => {
                const tr = document.createElement('tr');
                const color = u.status === 'Not Started' ? '#e74c3c' : '#333';
                
                const startBtn = `<button class="icon-btn quick-start-btn" 
                    onclick="document.getElementById('ts-user-id').value = '${u.userId}'; document.getElementById('ts-user-id').dispatchEvent(new Event('input')); logTimestamp('Start', null, '${u.userId}')" 
                    title="Quick Start Count" 
                    style="color:#2ecc71; padding:2px; opacity:0; transition:opacity 0.2s; margin-right:4px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                </button>`;

                const breakBtn = `<button class="icon-btn quick-start-btn" 
                    onclick="document.getElementById('ts-user-id').value = '${u.userId}'; document.getElementById('ts-user-id').dispatchEvent(new Event('input')); logTimestamp('Start Break', null, '${u.userId}')" 
                    title="Quick Break" 
                    style="color:#3498db; padding:2px; opacity:0; transition:opacity 0.2s;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
                </button>`;

                tr.innerHTML = `<td style="color:${color}">${u.userId}</td><td style="color:${color}">${u.name}</td><td style="color:${color}">${u.shift || '-'}</td><td style="color:${color}">${u.role || '-'}</td><td style="color:${color}">${u.lastEnd}</td><td style="text-align:center; white-space:nowrap;">${startBtn}${breakBtn}</td>`;
                
                tr.onmouseenter = () => { tr.querySelectorAll('.quick-start-btn').forEach(b => b.style.opacity = '1'); };
                tr.onmouseleave = () => { tr.querySelectorAll('.quick-start-btn').forEach(b => b.style.opacity = '0'); };
                
                tbody.appendChild(tr);
            });
            
            // Update sort icons
            document.querySelectorAll('#inactive-users-table th .sort-icon').forEach(el => el.textContent = '');
            const activeTh = document.querySelector(`#inactive-users-table th[onclick*="'${inactiveSort.field}'"] .sort-icon`);
            if(activeTh) activeTh.textContent = inactiveSort.dir === 'asc' ? '↑' : '↓';
        }

        function renderCountersSummary() {
            const container = document.getElementById('counters-summary-content');
            if(!container) return;
            
            const attendance = getAttendanceData();
            let data = getCountersData();
            // Apply same filters as table if desired, or just show all active
            if (showArchiveOnly) {
                const today = new Date().toISOString().split('T')[0];
                data = data.filter(d => d.archived === true || d.date < today);
            } else {
                data = data.filter(d => !d.archived);
            }
            
            // Load actuals
            let cycleCounts = [];
            try { cycleCounts = JSON.parse(localStorage.getItem(STORAGE_KEY_CC) || '[]'); } catch(e){}
            const actualsMap = {};
            cycleCounts.forEach(c => {
                const ts = c.createdDate || c.date;
                if(ts) {
                    const info = getShiftFromTimestamp(ts);
                    if (!info.date || !info.shift) return;
                    const key = `${info.date}|${info.shift}`;
                    actualsMap[key] = (actualsMap[key] || 0) + 1;
                }
            });

            const shiftOutput = {
                '1st Shift-(6am-2pm)': 0,
                '2nd Shift-(2pm-10pm)': 0,
                '3rd Shift-(10pm-6am)': 0
            };
            const shiftCounters = {
                '1st Shift-(6am-2pm)': 0,
                '2nd Shift-(2pm-10pm)': 0,
                '3rd Shift-(10pm-6am)': 0
            };
            let total24Output = 0;
            let total24Counters = 0;
            let total24Target = 0;

            data.forEach(item => {
                let act = 0;
                if (item.hourlyActuals) {
                    act = Object.values(item.hourlyActuals).reduce((a, b) => a + (Number(b)||0), 0);
                } else {
                    act = actualsMap[`${item.date}|${item.shift}`] || 0;
                }
                
                // Calculate active counters for this shift item
                let shiftAtt = attendance.filter(a => a.date === item.date && a.shift === item.shift);
                if (typeof globalSubAreas !== 'undefined' && globalSubAreas.length > 0) {
                    shiftAtt = shiftAtt.filter(a => globalSubAreas.includes(a.area));
                }

                // Exclude 'Temporary slide to Other task' from Actual count
                shiftAtt = shiftAtt.filter(a => a.status !== 'Temporary slide to Other task');

                const actCounters = shiftAtt.length;

                if (shiftOutput[item.shift] !== undefined) {
                    shiftOutput[item.shift] += act;
                    shiftCounters[item.shift] += actCounters;
                }
                total24Output += act;
                total24Counters += actCounters;
                
                // Calculate Target for stats
                const rate = Number(item.standardRate) || 0;
                let target = 0;
                if (item.hourlyTargets && Object.keys(item.hourlyTargets).length > 0) {
                    target = Object.values(item.hourlyTargets).reduce((a, b) => a + (Number(b)||0), 0);
                } else {
                    target = rate > 0 ? (actCounters * rate) : (Number(item.targetOutput) || 0);
                }
                total24Target += target;
            });

            let html = `<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
                <div class="stat-card">
                    <div class="stat-value">${shiftOutput['1st Shift-(6am-2pm)']} <span style="font-size:14px; color:#666; font-weight:normal;">items</span></div>
                    <div class="stat-label">1st Shift (${shiftCounters['1st Shift-(6am-2pm)']} counters)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${shiftOutput['2nd Shift-(2pm-10pm)']} <span style="font-size:14px; color:#666; font-weight:normal;">items</span></div>
                    <div class="stat-label">2nd Shift (${shiftCounters['2nd Shift-(2pm-10pm)']} counters)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${shiftOutput['3rd Shift-(10pm-6am)']} <span style="font-size:14px; color:#666; font-weight:normal;">items</span></div>
                    <div class="stat-label">3rd Shift (${shiftCounters['3rd Shift-(10pm-6am)']} counters)</div>
                </div>
                <div class="stat-card" style="border-color:#2752a7;">
                    <div class="stat-value" style="color:#2752a7;">${total24Output} <span style="font-size:14px; color:#666; font-weight:normal;">items</span></div>
                    <div class="stat-label">Total 24hrs (${total24Counters} counters)</div>
                </div>
            </div>`;
            
            // Additional Stats
            const avgProductivity = total24Counters > 0 ? Math.round(total24Output / total24Counters) : 0;
            const targetPct = total24Target > 0 ? Math.round((total24Output / total24Target) * 100) : 0;
            const variance = total24Output - total24Target;
            
            let topShift = '-';
            let topShiftVal = -1;
            Object.entries(shiftOutput).forEach(([k,v]) => {
                if(v > topShiftVal) { topShiftVal = v; topShift = k.split('-')[0]; }
            });
            
            html += `
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px; display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
                <div class="stat-card">
                    <div class="stat-value" style="color:#2ecc71;">${avgProductivity}</div>
                    <div class="stat-label">Avg Items / Person</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color:${targetPct >= 100 ? '#2ecc71' : '#f1c40f'};">${targetPct}%</div>
                    <div class="stat-label">Target Achievement</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color:${variance >= 0 ? '#2ecc71' : '#e74c3c'};">${variance > 0 ? '+' : ''}${variance}</div>
                    <div class="stat-label">Total Variance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color:#3498db;">${topShift}</div>
                    <div class="stat-label">Top Performing Shift</div>
                </div>
            </div>`;
            
            container.innerHTML = html;
        }

        function renderTimestampChart(sessions) {
            const ctx = document.getElementById('timestamp-chart');
            if (!ctx || typeof Chart === 'undefined') return;
            
            if (timestampChart) timestampChart.destroy();
            
            // Group by user for chart? Or just list sessions?
            // Let's list sessions chronologically
            const labels = sessions.map(s => {
                const time = new Date(s.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return `${s.user} (${time})`;
            });
            const data = sessions.map(s => s.duration);
            
            timestampChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Duration (Minutes)',
                        data: data,
                        backgroundColor: '#3498db',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Minutes' } },
                        x: { ticks: { maxRotation: 45, minRotation: 45 } }
                    }
                }
            });
        }
        function logTimestamp(action, areaType, customUserId) {
            let userId = customUserId;
            if (!userId) userId = tsUserIdInput.value.trim();
            
            if(!userId) { alert('Please enter User ID.'); return; }
            const data = getTimestamps();
            const userLogs = data.filter(d => d.userId === userId && !d.deleted).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            const lastLog = userLogs[userLogs.length - 1];
            
            let now = new Date();
            // Check for manual break time (also used for Time Out if needed, though label says break)
            const manualBreakInput = document.getElementById('manual-break-time');
            if (manualBreakInput && manualBreakInput.value && (action === 'Start Break' || action === 'End Break')) {
                now = new Date(manualBreakInput.value);
            }
            
            // --- VALIDATIONS ---
            if (action === 'Start' || action === 'Start Break') {
                // Check if user is in attendance list
                const attData = getAttendanceData();
                
                // Validate against current shift attendance
                const shiftInfo = getShiftFromTimestamp(now.toISOString());
                const userRecord = attData.find(a => a.userId === userId && a.date === shiftInfo.date && a.shift === shiftInfo.shift);

                if (!userRecord) {
                    alert(`User ID ${userId} not found in attendance for ${shiftInfo.date} (${shiftInfo.shift}). Please add to attendance first.`);
                    return;
                }

                const status = (userRecord.status || 'Full counter').toLowerCase();
                if (action === 'Start' && status !== 'full counter') {
                    alert(`User ${userId} is marked as '${status}'. Only 'Full counter' can start counting.`);
                    return;
                }

                if (lastLog && lastLog.action !== 'End' && lastLog.action !== 'End Break') {
                    if (lastLog.action === 'Start Break') {
                        alert(`User ${userId} is currently on break. Please end the break first.`);
                        return;
                    }
                    const dateStr = new Date(lastLog.timestamp).toLocaleString();
                    alert(`User ${userId} already has an active session started at ${dateStr}. Please end it first.`);
                    return;
                }
            } else if (action === 'Start Break') {
                if (lastLog && lastLog.action === 'Start Break') {
                    alert(`User ${userId} is already on break. Please end the break first.`);
                    return;
                }
                if (lastLog && lastLog.action === 'Start') {
                    alert(`User ${userId} has an active counting session. Please End Counting before starting a break.`);
                    return;
                }
            } else if (action === 'End Break') {
                if (!lastLog || lastLog.action !== 'Start Break') {
                    alert(`User ${userId} is not on break. Cannot End Break.`);
                    return;
                }
            } else if (action === 'End') {
                if (!lastLog || (lastLog.action === 'End')) {
                    const actName = action === 'End' ? 'End Counting' : action;
                    alert(`Cannot ${actName}: No active 'Start' found for User ID ${userId}.`);
                    return;
                }
            } else if (action === 'Time Out') {
                // Allow Time Out even if active session? Probably should end session first.
                if (lastLog && lastLog.action === 'Start') {
                    alert(`User ${userId} has an active counting session. Please End Counting before Time Out.`);
                    return;
                }
            }
            // --- END VALIDATIONS ---

            // Show Area Selection Modal if not provided
            if (action === 'Start' && !areaType) {
                document.getElementById('start-area-modal').classList.remove('hidden');
                return;
            }

            // Intercept End for Details
            if (action === 'End') {
                // Find the start log to get areaType
                const userLogs = data.filter(d => d.userId === userId && !d.deleted).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                let startLog = null;
                for (let i = userLogs.length - 1; i >= 0; i--) {
                    if (userLogs[i].action === 'Start') {
                        startLog = userLogs[i];
                        break;
                    }
                    if (userLogs[i].action === 'End') break;
                }
                const area = startLog ? (startLog.areaType || 'Reserved') : 'Reserved';

                // Open Modal
                document.getElementById('ec-pallets').value = '';
                document.getElementById('ec-skus').value = '';
                
                const areaInput = document.getElementById('ec-area-type');
                areaInput.value = area;
                
                if (area && area.startsWith('Pick Bin')) {
                    ecPalletGroup.style.display = 'none';
                    document.getElementById('ec-pallets').value = 0;
                } else {
                    ecPalletGroup.style.display = 'block';
                }
                
                endCountModal.dataset.userId = userId;
                endCountModal.classList.remove('hidden');
                return;
            }

            const newLog = {
                id: Date.now().toString(),
                userId: userId,
                action: action,
                timestamp: now.toISOString()
            };
            if (areaType) newLog.areaType = areaType;
            
            data.push(newLog);
            saveTimestamps(data);

            // Auto-dump break/timeout to attendance
            if (action === 'Start Break' || action === 'End Break' || action === 'Time Out') {
                const attData = getAttendanceData();
                const todayStr = now.toISOString().split('T')[0];
                
                // Find record for today
                let attIdx = attData.findIndex(a => a.userId === userId && a.date === todayStr);
                
                // If not found, try yesterday (handles shifts spanning midnight like 3rd shift)
                if (attIdx === -1) {
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    attIdx = attData.findIndex(a => a.userId === userId && a.date === yesterdayStr);
                }

                if (attIdx > -1) {
                    const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                    if (action === 'Start Break') attData[attIdx].breakOut = timeStr;
                    else if (action === 'End Break') attData[attIdx].breakIn = timeStr;
                    else if (action === 'Time Out') attData[attIdx].timeOut = timeStr;
                    saveAttendanceData(attData);
                    renderAttendanceTable();

                    // Sync to All IC Attendance (for Cycle Counters)
                    try {
                        const allIcKey = 'ims_daily_attendance_v1';
                        let allIcData = JSON.parse(localStorage.getItem(allIcKey) || '[]');
                        const targetDate = attData[attIdx].date;
                        const allIcIdx = allIcData.findIndex(a => a.userId === userId && a.date === targetDate);
                        if (allIcIdx > -1 && allIcData[allIcIdx].area === 'Cycle Counter') {
                            if (action === 'Start Break') allIcData[allIcIdx].breakOut = timeStr;
                            else if (action === 'End Break') allIcData[allIcIdx].breakIn = timeStr;
                            else if (action === 'Time Out') allIcData[allIcIdx].timeOut = timeStr;
                            localStorage.setItem(allIcKey, JSON.stringify(allIcData));
                        }
                    } catch(e) { console.error(e); }
                }
            }

            renderTimestamps();
            showToast(`${action} recorded for ${userId}`);
            let toastMessage = `${action} recorded for ${userId}`;
            if (action === 'Start' && areaType) {
                toastMessage += ` in ${areaType}`;
            }
            showToast(toastMessage);
            
            if (customUserId) {
            } else {
                tsUserIdInput.value = '';
                const nameDisplay = document.getElementById('ts-user-name-display');
                if(nameDisplay) nameDisplay.value = '';
                tsUserIdInput.focus();
            }
            if(manualBreakInput) manualBreakInput.value = ''; // Clear manual input
        }
        window.logTimestamp = logTimestamp;

        // End Count Modal Logic
        if (ecCancelBtn) {
            ecCancelBtn.addEventListener('click', () => {
                endCountModal.classList.add('hidden');
            });
        }

        if (ecSaveBtn) {
            ecSaveBtn.addEventListener('click', () => {
                const userId = endCountModal.dataset.userId;
                const pallets = parseInt(document.getElementById('ec-pallets').value) || 0;
                const skus = parseInt(document.getElementById('ec-skus').value) || 0;
                const areaType = document.getElementById('ec-area-type').value;
                const now = new Date();

                // 1. Log Timestamp
                const data = getTimestamps();
                data.push({
                    id: Date.now().toString(),
                    userId: userId,
                    action: 'End',
                    timestamp: now.toISOString(),
                    areaType: areaType,
                    pallets: pallets,
                    skus: skus
                });
                saveTimestamps(data);
                renderTimestamps();

                // 2. Dump to Hourly Monitoring
                const shiftInfo = getShiftFromTimestamp(now);
                if (shiftInfo.date && shiftInfo.shift) {
                    const counters = getCountersData();
                    // Find or create entry? Usually we expect an entry to exist for the shift plan.
                    // If not, we can try to find one or just skip. Let's try to find.
                    const entryIndex = counters.findIndex(c => c.date === shiftInfo.date && c.shift === shiftInfo.shift);
                    
                    if (entryIndex > -1) {
                        const entry = counters[entryIndex];
                        const h = now.getHours();
                        const label = `${h}:00 - ${h+1}:00`;
                        
                        // Initialize objects if missing
                        if (!entry.hourlyActuals) entry.hourlyActuals = {};
                        if (!entry.hourlyPallets) entry.hourlyPallets = {};
                        
                        // Always add SKUs to Actuals (Items) and Pallets to Pallets
                        entry.hourlyActuals[label] = (entry.hourlyActuals[label] || 0) + skus;
                        entry.hourlyPallets[label] = (entry.hourlyPallets[label] || 0) + pallets;
                        
                        saveCountersData(counters);
                    }
                }

                showToast(`End Count recorded for ${userId}. Data saved.`);
                endCountModal.classList.add('hidden');
                tsUserIdInput.value = '';
                const nameDisplay = document.getElementById('ts-user-name-display');
                if(nameDisplay) nameDisplay.value = '';
                tsUserIdInput.focus();
            });
        }

        window.deleteSession = function(ids) {
            if(!confirm('Permanently delete this session?')) return;
            const idArray = ids.split(',');
            let data = getTimestamps();
            // Permanent delete
            data = data.filter(d => !idArray.includes(d.id));
            saveTimestamps(data);
            renderTimestamps();
            showToast('Session permanently deleted');
        };
        
        window.purgeSession = function(ids) {
            if(!confirm('Permanently delete this session? This cannot be undone.')) return;
            const idArray = ids.split(',');
            let data = getTimestamps();
            data = data.filter(d => !idArray.includes(d.id));
            saveTimestamps(data);
            renderTimestamps();
            showToast('Session permanently deleted');
        };

        window.deleteBreak = function(startId, endId) {
            if(!confirm('Delete this break entry?')) return;
            let data = getTimestamps();
            const ids = [startId, endId].filter(x => x && x !== 'null' && x !== 'undefined');
            data = data.filter(d => !ids.includes(d.id));
            saveTimestamps(data);
            renderTimestamps();
            showToast('Break permanently deleted');
        };
        
        if(tsDeleteSelectedBtn) {
            tsDeleteSelectedBtn.addEventListener('click', () => {
                if(!confirm('Permanently delete selected sessions?')) return;
                const checkboxes = document.querySelectorAll('.ts-row-checkbox:checked');
                let idsToDelete = [];
                checkboxes.forEach(cb => idsToDelete.push(...cb.dataset.ids.split(',')));
                let data = getTimestamps();
                data = data.filter(d => !idsToDelete.includes(d.id));
                saveTimestamps(data);
                renderTimestamps();
                showToast(`${checkboxes.length} sessions deleted`);
            });
        }
        
        if(breakDeleteSelectedBtn) {
            breakDeleteSelectedBtn.addEventListener('click', () => {
                if(!confirm('Permanently delete selected breaks?')) return;
                const checkboxes = document.querySelectorAll('.break-row-checkbox:checked');
                let idsToDelete = [];
                checkboxes.forEach(cb => idsToDelete.push(...cb.dataset.ids.split(',')));
                let data = getTimestamps();
                data = data.filter(d => !idsToDelete.includes(d.id));
                saveTimestamps(data);
                renderTimestamps();
                showToast(`${checkboxes.length} breaks deleted`);
            });
        }
        
        if(breakExportBtn) {
            breakExportBtn.addEventListener('click', () => {
                const tbody = document.querySelector('#break-log-table tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                if(rows.length === 0 || rows[0].textContent.includes('No breaks')) { alert('No breaks to export'); return; }
                
                const csvRows = [['User', 'Name', 'Shift', 'Role', 'Break Out', 'Break In', 'Duration']];
                rows.forEach(tr => {
                    const cols = tr.querySelectorAll('td');
                    if(cols.length > 7) {
                        csvRows.push([
                            `"${cols[1].textContent}"`,
                            `"${cols[2].textContent}"`,
                            `"${cols[3].textContent}"`,
                            `"${cols[4].textContent}"`,
                            `"${cols[5].textContent}"`,
                            `"${cols[6].textContent}"`,
                            `"${cols[7].textContent}"`
                        ].join(','));
                    }
                });
                
                const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `break_log.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        if(document.getElementById('btn-break-delete-all')) {
            document.getElementById('btn-break-delete-all').addEventListener('click', () => {
                if(!confirm('Permanently delete ALL displayed break logs?')) return;
                let data = getTimestamps();
                const filterUser = document.getElementById('ts-filter-user').value.toLowerCase();
                const filterShift = tsShiftFilter ? tsShiftFilter.value : '';

                // Filter out breaks that match criteria
                data = data.filter(d => {
                    if (d.action !== 'Start Break' && d.action !== 'End Break') return true; // Keep non-breaks
                    
                    let matchesUser = true;
                    if (filterUser && !d.userId.toLowerCase().includes(filterUser)) matchesUser = false;
                    
                    let matchesShift = true;
                    if (filterShift) {
                        const info = getShiftFromTimestamp(d.timestamp);
                        if (!info.shift.includes(filterShift)) matchesShift = false;
                    }
                    
                    if (matchesUser && matchesShift) return false; // Delete
                    return false; // Delete (filter out)
                });
                saveTimestamps(data);
                renderTimestamps();
                showToast('All displayed breaks permanently deleted');
            });
        }

        if(tsPurgeAllBtn) {
            tsPurgeAllBtn.addEventListener('click', () => {
                if(!confirm('PERMANENTLY delete all currently shown logs? This cannot be undone.')) return;
                
                // Re-calculate filtered logs to ensure we delete exactly what is shown
                const allLogs = getTimestamps();
                const filterUser = tsFilterUser ? tsFilterUser.value.toLowerCase() : '';
                const attendance = getAttendanceData();
                const filterShift = tsShiftFilter ? tsShiftFilter.value : '';

                // 1. Filter by date
                let todaysLogs = allLogs; // Assuming all logs or filtered by shift logic below
                todaysLogs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // 2. Group into sessions to apply user/shift filters correctly
                const sessions = [];
                const openSessions = {};
                todaysLogs.forEach(log => {
                    if (log.action === 'Start') {
                        if (openSessions[log.userId]) sessions.push(openSessions[log.userId]);
                        openSessions[log.userId] = { userId: log.userId, startLog: log, endLog: null, breaks: [], currentBreakStart: null };
                    } else if (log.action === 'Start Break') {
                        if (openSessions[log.userId]) openSessions[log.userId].currentBreakStart = log;
                    } else if (log.action === 'End Break') {
                        if (openSessions[log.userId] && openSessions[log.userId].currentBreakStart) {
                            openSessions[log.userId].breaks.push({ start: openSessions[log.userId].currentBreakStart, end: log });
                            openSessions[log.userId].currentBreakStart = null;
                        }
                    } else if (log.action === 'End') {
                        if (openSessions[log.userId]) {
                            const session = openSessions[log.userId];
                            session.endLog = log;
                            sessions.push(session);
                            delete openSessions[log.userId];
                        } else {
                            sessions.push({ userId: log.userId, startLog: null, endLog: log, breaks: [] });
                        }
                    }
                });
                Object.values(openSessions).forEach(s => sessions.push(s));
                
                let filteredSessions = sessions;
                if (filterUser) {
                    const terms = filterUser.split(' ').filter(t => t);
                    filteredSessions = sessions.filter(s => {
                    let attRecord = attendance.find(a => a.userId === s.userId && a.date === sessionDate);
                    if (!attRecord) attRecord = attendance.find(a => a.userId === s.userId);
                    const name = attRecord ? attRecord.name : '';
                        const shiftInfo = s.startLog ? getShiftFromTimestamp(s.startLog.timestamp) : { shift: '' };
                        const searchStr = (s.userId + ' ' + name + ' ' + shiftInfo.shift).toLowerCase();
                        return terms.every(term => searchStr.includes(term));
                    });
                }
                
                // Filter by Shift
                if (filterShift) {
                    filteredSessions = filteredSessions.filter(s => {
                        const shiftInfo = s.startLog ? getShiftFromTimestamp(s.startLog.timestamp) : { shift: '' };
                        return shiftInfo.shift.includes(filterShift);
                    });
                }

                // Collect IDs to remove
                const idsToRemove = new Set();
                filteredSessions.forEach(s => {
                    if(s.startLog) idsToRemove.add(s.startLog.id);
                    if(s.endLog) idsToRemove.add(s.endLog.id);
                    if(s.breaks) s.breaks.forEach(b => {
                        if(b.start) idsToRemove.add(b.start.id);
                        if(b.end) idsToRemove.add(b.end.id);
                    });
                });
                
                // Filter out the IDs
                const newData = allLogs.filter(d => !idsToRemove.has(d.id));
                saveTimestamps(newData);
                renderTimestamps();
                showToast('Permanently deleted shown logs');
            });
        }

        if(tsExportBtn) {
            tsExportBtn.addEventListener('click', () => {
                let data = getTimestamps();
                const attendance = getAttendanceData();
                const filterUser = tsFilterUser ? tsFilterUser.value.toLowerCase() : '';
                const filterShift = tsShiftFilter ? tsShiftFilter.value : '';

                // Reconstruct sessions to match table view
                data.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                const sessions = [];
                const openSessions = {};
                
                data.forEach(log => {
                    if (log.deleted) return;
                    if (log.action === 'Start') {
                        if (openSessions[log.userId]) sessions.push(openSessions[log.userId]);
                        openSessions[log.userId] = { userId: log.userId, startLog: log, endLog: null, breaks: [] };
                    } else if (log.action === 'Start Break') {
                        if (openSessions[log.userId]) openSessions[log.userId].currentBreakStart = log;
                    } else if (log.action === 'End Break') {
                        if (openSessions[log.userId] && openSessions[log.userId].currentBreakStart) {
                            const bStart = new Date(openSessions[log.userId].currentBreakStart.timestamp);
                            const bEnd = new Date(log.timestamp);
                            openSessions[log.userId].breaks.push({ duration: (bEnd - bStart)/60000 });
                            openSessions[log.userId].currentBreakStart = null;
                        }
                    } else if (log.action === 'End') {
                        if (openSessions[log.userId]) {
                            const session = openSessions[log.userId];
                            session.endLog = log;
                            sessions.push(session);
                            delete openSessions[log.userId];
                        } else {
                            sessions.push({ userId: log.userId, startLog: null, endLog: log, breaks: [] });
                        }
                    }
                });
                Object.values(openSessions).forEach(s => sessions.push(s));

                // Filter sessions
                let filteredSessions = sessions.filter(s => {
                    // Resolve details
                    const ts = s.startLog ? s.startLog.timestamp : (s.endLog ? s.endLog.timestamp : null);
                    let sessionDate = '';
                    if(ts) sessionDate = new Date(ts).toISOString().split('T')[0];
                    
                    let attRecord = attendance.find(a => a.userId === s.userId && a.date === sessionDate);
                    if (!attRecord) attRecord = attendance.find(a => a.userId === s.userId);
                    
                    const name = attRecord ? attRecord.name : '';
                    let shift = attRecord ? attRecord.shift : (s.startLog ? getShiftFromTimestamp(s.startLog.timestamp).shift : '');
                    
                    if (filterShift && !shift.includes(filterShift)) return false;
                    if (filterUser) {
                        const searchStr = (s.userId + ' ' + name + ' ' + shift).toLowerCase();
                        const terms = filterUser.split(' ').filter(t => t);
                        if (!terms.every(term => searchStr.includes(term))) return false;
                    }
                    
                    // Attach resolved data for export
                    s.resolvedName = name;
                    s.resolvedShift = shift;
                    s.resolvedArea = s.startLog ? (s.startLog.areaType || '-') : '-';
                    return true;
                });

                // Sort descending
                filteredSessions.sort((a,b) => {
                    const tA = a.startLog ? a.startLog.timestamp : (a.endLog ? a.endLog.timestamp : '');
                    const tB = b.startLog ? b.startLog.timestamp : (b.endLog ? b.endLog.timestamp : '');
                    return new Date(tB) - new Date(tA);
                });

                if(filteredSessions.length === 0) { alert('No logs to export.'); return; }
                
                const headers = ['User ID', 'Name', 'Area Type', 'Shift', 'Start Time', 'End Time', 'Duration', 'Status', 'Pallets', 'SKUs'];
                const rows = [headers.join(',')];
                
                filteredSessions.forEach(s => {
                    const startStr = s.startLog ? new Date(s.startLog.timestamp).toLocaleString() : '-';
                    const endStr = s.endLog ? new Date(s.endLog.timestamp).toLocaleString() : '-';
                    
                    const pallets = s.endLog ? (s.endLog.pallets || 0) : 0;
                    const skus = s.endLog ? (s.endLog.skus || 0) : 0;
                    let duration = '-';
                    const totalBreakMins = s.breaks ? s.breaks.reduce((acc, b) => acc + b.duration, 0) : 0;
                    if (s.startLog && s.endLog) {
                        const diff = new Date(s.endLog.timestamp) - new Date(s.startLog.timestamp);
                        const mins = Math.round((diff / 60000) - totalBreakMins);
                        duration = `${mins} min`;
                    } else if (s.startLog) {
                        const diff = new Date() - new Date(s.startLog.timestamp);
                        duration = `Active (${Math.floor(diff/60000)}m)`;
                    }

                    rows.push([
                        `"${s.userId}"`,
                        `"${s.resolvedName}"`,
                        `"${s.resolvedArea}"`,
                        `"${s.resolvedShift}"`,
                        `"${startStr}"`,
                        `"${endStr}"`,
                        `"${duration}"`,
                        s.endLog ? 'Completed' : 'Active',
                        pallets,
                        skus
                    ].join(','));
                });
                
                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `counter_sessions.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        if(tsExportInactiveBtn) {
            tsExportInactiveBtn.addEventListener('click', () => {
                const attendanceData = getAttendanceData();
                const sessions = []; // Rebuild sessions for last end time check
                const allLogs = getTimestamps().sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                const openSessions = {};
                allLogs.forEach(log => {
                    if(log.deleted) return;
                    if (log.action === 'Start') {
                        openSessions[log.userId] = { userId: log.userId, startLog: log, endLog: null };
                    } else if (log.action === 'End') {
                        if (openSessions[log.userId]) {
                            const s = openSessions[log.userId];
                            s.endLog = log;
                            sessions.push(s);
                            delete openSessions[log.userId];
                        } else {
                            sessions.push({ userId: log.userId, startLog: null, endLog: log });
                        }
                    }
                });
                Object.values(openSessions).forEach(s => sessions.push(s));

                const dateInput = document.getElementById('ts-analytics-date-filter');
                const filterDate = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().split('T')[0];
                const filterShift = tsShiftFilter ? tsShiftFilter.value : '';
                
                const fullCounters = attendanceData.filter(a => a.date === filterDate && a.status === 'Full counter');
                const activeUserIds = new Set(Object.keys(openSessions));
                const userLastEnd = {};
                sessions.forEach(s => {
                    if (s.endLog) {
                        const t = new Date(s.endLog.timestamp).getTime();
                        if (!userLastEnd[s.userId] || t > userLastEnd[s.userId]) userLastEnd[s.userId] = t;
                    }
                });

                const inactiveList = [];
                fullCounters.forEach(att => {
                    if (filterShift && !att.shift.includes(filterShift)) return;
                    if (!activeUserIds.has(att.userId)) {
                        let lastEnd = '-';
                        let status = 'Not Started';
                        if (userLastEnd[att.userId]) {
                            lastEnd = new Date(userLastEnd[att.userId]).toLocaleTimeString();
                            status = 'Inactive';
                        }
                        inactiveList.push({
                            userId: att.userId,
                            name: att.name,
                            shift: att.shift,
                            role: att.role,
                            lastEnd: lastEnd,
                            status: status
                        });
                    }
                });

                if(inactiveList.length === 0) { alert('No inactive users to export.'); return; }

                const headers = ['User ID', 'Name', 'Shift', 'Role', 'Last End Time', 'Status'];
                const rows = [headers.join(',')];
                inactiveList.forEach(u => {
                    rows.push([
                        `"${u.userId}"`,
                        `"${u.name}"`,
                        `"${u.shift}"`,
                        `"${u.role}"`,
                        `"${u.lastEnd}"`,
                        `"${u.status}"`
                    ].join(','));
                });

                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `inactive_users.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        if(timestampBtn) {
            timestampBtn.addEventListener('click', () => {
                timestampModal.classList.remove('hidden');
                sessionStorage.setItem('ims_timestamp_modal_open', 'true');
                renderTimestamps();
                setTimeout(() => tsUserIdInput.focus(), 100);
            });
        }
        if(btnStartCount) btnStartCount.addEventListener('click', () => logTimestamp('Start'));
        if(btnBreakStart) btnBreakStart.addEventListener('click', () => {
            const uid = tsUserIdInput.value.trim();
            logTimestamp('Start Break', null, uid);
        });
        if(btnBreakEnd) btnBreakEnd.addEventListener('click', () => {
            const uid = tsUserIdInput.value.trim();
            logTimestamp('End Break', null, uid);
        });
        if(btnEndCount) btnEndCount.addEventListener('click', () => logTimestamp('End'));
        if(btnTimeOut) btnTimeOut.addEventListener('click', () => logTimestamp('Time Out'));
        if(tsFilterUser) tsFilterUser.addEventListener('input', () => { tsCurrentPage = 1; renderTimestamps(); });
        if(tsShiftFilter) tsShiftFilter.addEventListener('change', () => { tsCurrentPage = 1; renderTimestamps(); });
        if(tsShowLongActive) tsShowLongActive.addEventListener('change', () => { tsCurrentPage = 1; renderTimestamps(); });
        if(tsAnalyticsDateFilter) tsAnalyticsDateFilter.addEventListener('change', () => { tsCurrentPage = 1; renderTimestamps(); });
        
        // Pagination Listeners for Timestamp Table
        const tsPaginationControls = document.getElementById('ts-pagination-controls');
        if (tsPaginationControls) {
            tsPaginationControls.addEventListener('click', (e) => {
                if (e.target.closest('#ts-prev-page') && !e.target.closest('#ts-prev-page').disabled) {
                    tsCurrentPage--;
                    renderTimestamps();
                } else if (e.target.closest('#ts-next-page') && !e.target.closest('#ts-next-page').disabled) {
                    tsCurrentPage++;
                    renderTimestamps();
                }
            });
            document.getElementById('ts-rows-per-page').addEventListener('change', (e) => {
                tsItemsPerPage = parseInt(e.target.value);
                tsCurrentPage = 1;
                renderTimestamps();
            });
        }
        
        const activeBreakTable = document.getElementById('active-break-table');
        const historyBreakTable = document.getElementById('history-break-table');
        
        if (activeBreakTable) {
            activeBreakTable.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('editable-time')) {
                    openEditTimeModal(target.dataset.logId);
                }
            });
        }
        if (historyBreakTable) {
            historyBreakTable.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('editable-time')) {
                    openEditTimeModal(target.dataset.logId);
                }
            });
        }

    // Tab Switching Logic (Global Scope)
    window.openTsTab = function(evt, tabId) {
        const card = evt.target.closest('.card');
        const tabContents = card.querySelectorAll('.tab-content');
        tabContents.forEach(tc => tc.style.display = 'none');

        const tabBtns = card.querySelectorAll('.tab-btn');
        tabBtns.forEach(btn => btn.classList.remove('active'));

        const target = document.getElementById(tabId);
        if(target) target.style.display = 'flex';
        evt.target.classList.add('active');
    };

    // Helper to switch tabs from header cards
    window.activateTsTab = function(tabId) {
        const target = document.getElementById(tabId);
        if(!target) return;
        const card = target.parentElement;
        if(card) {
            const tabContents = card.querySelectorAll('.tab-content');
            tabContents.forEach(tc => tc.style.display = 'none');
            target.style.display = 'flex';
            
            const tabBtns = card.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
                if(btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tabId)) {
                    btn.classList.add('active');
                }
            });
        }
    };

    let embeddedHourlyChart = null;
    function renderEmbeddedHourly(dateStr, shift) {
        const container = document.getElementById('embedded-hourly-view');
        if (!container) return;
        
        if (!shift || shift === 'All Shifts' || shift === '') {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'flex';
        document.getElementById('embedded-hourly-title').textContent = `Hourly Output: ${shift.split('-')[0]}`;

        // Logic adapted from openHourlyModal
        const counters = getCountersData();
        const counterEntry = counters.find(c => c.date === dateStr && c.shift === shift);
        
        const start = new Date(dateStr);
        const end = new Date(dateStr);
        if (shift.includes('1st Shift')) { start.setHours(6,0,0,0); end.setHours(14,0,0,0); }
        else if (shift.includes('2nd Shift')) { start.setHours(14,0,0,0); end.setHours(22,0,0,0); }
        else { start.setHours(22,0,0,0); end.setDate(end.getDate() + 1); end.setHours(6,0,0,0); }

        let cycleCounts = [];
        try { cycleCounts = JSON.parse(localStorage.getItem('ims_cycle_count_v1') || '[]'); } catch(e){}
        
        const hourlyData = {};
        const hourlyTargets = {};
        const attendance = getAttendanceData();
        const shiftAtt = attendance.filter(a => a.date === dateStr && a.shift === shift);
        const act = shiftAtt.length;
        const rate = (counterEntry && counterEntry.standardRate) || 0;
        const activeTarget = rate > 0 ? (act * rate) : ((counterEntry && counterEntry.targetOutput) || 0);
        const defaultHourlyTarget = activeTarget > 0 ? Math.round(activeTarget / 8) : 0;
        
        const savedActuals = counterEntry && counterEntry.hourlyActuals ? counterEntry.hourlyActuals : null;
        const savedPallets = counterEntry && counterEntry.hourlyPallets ? counterEntry.hourlyPallets : {};
        const savedNotes = counterEntry && counterEntry.hourlyNotes ? counterEntry.hourlyNotes : {};

        for (let d = new Date(start); d < end; d.setHours(d.getHours() + 1)) {
            const h = d.getHours();
            const label = `${h}:00 - ${h+1}:00`;
            hourlyData[label] = (savedActuals && savedActuals[label] !== undefined) ? savedActuals[label] : 0;
            
            const savedTarget = counterEntry && counterEntry.hourlyTargets && counterEntry.hourlyTargets[label];
            let activeCount = 0;
            if (savedTarget !== undefined) {
                hourlyTargets[label] = savedTarget;
            } else if (rate > 0) {
                shiftAtt.forEach(p => {
                    if (!p.timeIn) { activeCount++; } 
                    else {
                        const [ph, pm] = p.timeIn.split(':').map(Number);
                        let pDate = new Date(start);
                        if (shift.includes('3rd') && ph < 12) pDate.setDate(pDate.getDate() + 1);
                        pDate.setHours(ph, pm, 0, 0);
                        const nextHour = new Date(d); nextHour.setHours(d.getHours() + 1);
                        if (pDate < nextHour) activeCount++;
                    }
                });
                hourlyTargets[label] = activeCount * rate;
            } else {
                hourlyTargets[label] = defaultHourlyTarget;
            }
        }

        if (!savedActuals) {
            cycleCounts.forEach(c => {
                const ts = c.createdDate || c.date;
                if (ts) {
                    const d = new Date(ts);
                    if (d >= start && d < end) {
                        const h = d.getHours();
                        const label = `${h}:00 - ${h+1}:00`;
                        if (hourlyData.hasOwnProperty(label)) hourlyData[label]++;
                    }
                }
            });
        }

        let html = `<table class="excel-table" style="width:100%; font-size:11px;"><thead><tr><th style="text-align:left;">Hour</th><th>Pallet</th><th>Act</th><th>Tgt</th><th>Var</th><th>Notes</th></tr></thead><tbody>`;
        
        Object.keys(hourlyData).forEach(label => {
            const act = hourlyData[label] || 0;
            const tgt = hourlyTargets[label] || 0;
            const pallet = savedPallets[label] || 0;
            const note = savedNotes[label] || '';
            const variance = act - tgt;
            const varColor = variance >= 0 ? '#2ecc71' : '#e74c3c';
            
            html += `<tr>
                <td style="text-align:left;">${label}</td>
                <td><input type="number" class="emb-pallet" data-hour="${label}" value="${pallet}" style="width:40px;"></td>
                <td><input type="number" class="emb-actual" data-hour="${label}" value="${act}" style="width:40px;"></td>
                <td><input type="number" class="emb-target" data-hour="${label}" value="${tgt}" style="width:40px;"></td>
                <td style="color:${varColor}; font-weight:bold;">${(variance > 0 ? '+' : '') + variance}</td>
                <td><input type="text" class="emb-note" data-hour="${label}" value="${note}" style="width:100%;"></td>
            </tr>`;
        });
        html += `</tbody></table>`;
        document.getElementById('embedded-hourly-details').innerHTML = html;

        // Chart
        const ctx = document.getElementById('embedded-hourly-chart');
        if (embeddedHourlyChart) embeddedHourlyChart.destroy();
        
        const labels = Object.keys(hourlyData);
        const dataAct = Object.values(hourlyData);
        const dataTgt = Object.values(hourlyTargets);
        
        let barColor = '#36b9cc'; // 1st Shift default
        if (shift.includes('2nd Shift')) barColor = '#f6c23e';
        else if (shift.includes('3rd Shift')) barColor = '#4e73df';
        
        embeddedHourlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Actual', data: dataAct, backgroundColor: barColor },
                    { label: 'Target', data: dataTgt, type: 'line', borderColor: '#27ae60', borderDash: [5,5], tension: 0.1 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });

        // Save Handler
        const saveBtn = document.getElementById('embedded-save-btn');
        saveBtn.onclick = () => {
            const counters = getCountersData();
            const idx = counters.findIndex(c => c.date === dateStr && c.shift === shift);
            if (idx > -1) {
                if (!counters[idx].hourlyTargets) counters[idx].hourlyTargets = {};
                if (!counters[idx].hourlyActuals) counters[idx].hourlyActuals = {};
                if (!counters[idx].hourlyPallets) counters[idx].hourlyPallets = {};
                if (!counters[idx].hourlyNotes) counters[idx].hourlyNotes = {};
                
                const container = document.getElementById('embedded-hourly-details');
                container.querySelectorAll('.emb-target').forEach(i => counters[idx].hourlyTargets[i.dataset.hour] = parseInt(i.value)||0);
                container.querySelectorAll('.emb-actual').forEach(i => counters[idx].hourlyActuals[i.dataset.hour] = parseInt(i.value)||0);
                container.querySelectorAll('.emb-pallet').forEach(i => counters[idx].hourlyPallets[i.dataset.hour] = parseInt(i.value)||0);
                container.querySelectorAll('.emb-note').forEach(i => counters[idx].hourlyNotes[i.dataset.hour] = i.value);
                
                saveCountersData(counters);
                showToast('Hourly data saved!');
                renderEmbeddedHourly(dateStr, shift); // Refresh
            }
        };
    }

    function renderTimestampChart(sessions) {
        const ctx = document.getElementById('timestamp-chart');
        if (!ctx || typeof Chart === 'undefined') return;
        
        if (timestampChart) timestampChart.destroy();
        
        const labels = sessions.map(s => {
            const time = new Date(s.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            return `${s.user} (${time})`;
        });
        const data = sessions.map(s => s.duration);
        
        timestampChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Duration (Minutes)',
                    data: data,
                    backgroundColor: '#3498db',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Minutes' } },
                    x: { ticks: { maxRotation: 45, minRotation: 45 } }
                }
            }
        });
    }
        
        if(breakShiftFilter) breakShiftFilter.addEventListener('change', () => renderTimestamps());

        if(tsUserIdInput) {
            tsUserIdInput.addEventListener('input', () => {
                const uid = tsUserIdInput.value.trim();
                const nameDisplay = document.getElementById('ts-user-name-display');
                if(nameDisplay) {
                    if(uid) {
                        const attData = getAttendanceData();
                        const userRecord = attData.find(a => a.userId === uid);
                        if (userRecord) {
                            nameDisplay.value = `Name: ${userRecord.name} | Role: ${userRecord.role || '-'}`;
                        } else {
                            // Check Master Data
                            const masterUsers = getMasterUsers();
                            const masterUser = masterUsers.find(u => u.userId === uid);
                            if (masterUser) {
                                nameDisplay.value = `Name: ${masterUser.name} | Role: ${masterUser.role || '-'}`;
                            } else {
                                nameDisplay.value = '';
                            }
                        }
                    } else {
                        nameDisplay.value = '';
                    }
                }
            });
        }

        // Toggle Section Logic for Timestamp Modal Tables
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.toggle-section-btn');
            if (btn) {
                const card = btn.closest('.card');
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }

        // Shortcut to Validators
        const goToValidatorsBtn = document.getElementById('go-to-validators-btn');
        if(goToValidatorsBtn) {
            goToValidatorsBtn.addEventListener('click', () => {
                sessionStorage.setItem('ims_open_validators_modal', 'true');
                window.location.href = 'all_ic_attendance.html';
            });
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }

        // Shortcut to Validators
        const goToValidatorsBtn = document.getElementById('go-to-validators-btn');
        if(goToValidatorsBtn) {
            goToValidatorsBtn.addEventListener('click', () => {
                sessionStorage.setItem('ims_open_validators_modal', 'true');
                window.location.href = 'all_ic_attendance.html';
            });
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });
    });
  </script>
</body>
</html>             
                const content = card.querySelector('.section-content');
                if (content) {
                    content.classList.toggle('hidden');
                    const isHidden = content.classList.contains('hidden');
                    btn.innerHTML = isHidden 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>' 
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    
                    // Adjust card flex/height when collapsed
                    card.style.flex = isHidden ? '0 0 auto' : '';
                    card.style.minHeight = isHidden ? 'auto' : '';
                }
            }
        });

        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
        // Restore Timestamp Modal State
        if (sessionStorage.getItem('ims_timestamp_modal_open') === 'true') {
            const tm = document.getElementById('timestamp-modal');
            if (tm) {
                tm.classList.remove('hidden');
                renderTimestamps();
            }
        }
    });
  </script>
</body>
</html>             
