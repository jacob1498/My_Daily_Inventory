<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Dashboard - IMS</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Dark Mode Header */
    body.dark-mode header { background: #1a252f; border-bottom: 1px solid #2c3e50; }
    body.dark-mode header h1 { color: #ecf0f1; }
    body { padding-top: 0 !important; }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .chart-card {
      background: var(--card);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border: 1px solid #eef2f6;
      min-height: 300px;
      display: flex;
      flex-direction: column;
    }
    .chart-container {
      flex: 1;
      position: relative;
      width: 100%;
      min-height: 0;
    }
    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #eef2f6;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .stat-info { flex: 1; min-width: 0; }
    .stat-value { font-size: 28px; font-weight: bold; color: var(--accent); line-height: 1.2; }
    .stat-label { font-size: 13px; color: var(--muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .top-list { list-style: none; padding: 0; margin: 0; }
    .top-list li {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid #eee; font-size: 14px;
    }
    .top-list li:last-child { border-bottom: none; }
    .rank-badge {
      background: #eee; color: #555; width: 24px; height: 24px;
      border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: bold; margin-right: 10px;
    }
    .top-list li:nth-child(1) .rank-badge { background: #f1c40f; color: #fff; }
    .top-list li:nth-child(2) .rank-badge { background: #bdc3c7; color: #fff; }
    .top-list li:nth-child(3) .rank-badge { background: #e67e22; color: #fff; }

    body.dark-mode .chart-card, body.dark-mode .stat-card { background: #1e1e1e; border-color: #333; }
    body.dark-mode .top-list li { border-bottom-color: #333; color: #e0e0e0; }
  </style>
</head>
<body class="inventory-mode">
  <script>
    if(localStorage.getItem('ims_sidebar_collapsed') === '1') document.body.classList.add('sidebar-collapsed');
  </script>

  <nav id="app-sidebar">
    <div class="sidebar-brand">
      <img src="Logo.jpg" alt="Logo" class="sidebar-logo" style="height:32px;width:auto;margin-right:8px">
      <span class="brand-text">IMS</span>
      <button id="main-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button onclick="window.location.href='homepage.html'" data-tooltip="Homepage">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span class="menu-text">Homepage</span>
        </button>
      </li>
      <li>
        <button onclick="window.location.href='daily_cycle_count.html'" data-tooltip="Daily Cycle Count">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <span class="menu-text">Daily Cycle Count</span>
        </button>
      </li>
      <li>
        <button onclick="window.location.href='all_ic_attendance.html'" data-tooltip="All IC Attendance">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          <span class="menu-text">All IC Attendance</span>
        </button>
      </li>
      <li>
        <button class="active" onclick="window.location.href='dashboard_analytics.html'" data-tooltip="Analytics & Reports">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
          <span class="menu-text">Analytics & Reports</span>
        </button>
      </li>
      <li>
        <button onclick="window.location.href='settings.html'" data-tooltip="Settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          <span class="menu-text">Settings</span>
        </button>
      </li>
    </ul>
  </nav>

  <header>
    <div style="display: flex; align-items: center; gap: 15px;">
        <button onclick="window.location.href='homepage.html'" class="icon-btn" title="Back to Dashboard" style="border:none; background:transparent; font-size:16px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </button>
        <div style="display: flex; align-items: center; gap: 10px;">
            
            <h1>Analytics & Reports</h1>
        </div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button onclick="toggleTheme()" class="icon-btn" title="Toggle Theme" style="background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); border:none; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
        <button onclick="signOut()" class="icon-btn" title="Logout" style="background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); border:none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #e74c3c;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        </button>
    </div>
  </header>

  <main>
    <div class="card" style="margin-bottom: 20px; padding: 15px; display: flex; align-items: center; gap: 10px;">
        <strong style="color: var(--accent);">Date Range:</strong>
        <input type="date" id="analytics-start" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
        <span>to</span>
        <input type="date" id="analytics-end" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
        <button id="apply-filter" class="icon-btn" style="background: #2752a7; color: white; padding: 6px 12px;">Apply</button>
        <button id="clear-filter" class="icon-btn" style="border: 1px solid #ccc; padding: 6px 12px;">Clear</button>
        <button id="export-dashboard" class="icon-btn" style="background: #27ae60; color: white; padding: 6px 12px; margin-left: auto;">Export Excel</button>
        <button id="export-pdf" class="icon-btn" style="background: #e74c3c; color: white; padding: 6px 12px; margin-left: 10px;">Export PDF</button>
    </div>

    <!-- Attendance Section -->
    <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin: 20px 0 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
        <h2 style="margin: 0; color: var(--accent); font-size: 18px;">Attendance Analytics</h2>
        <button class="icon-btn toggle-section" title="Collapse" style="background:transparent; border:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
    </div>
    <div class="section-content">
    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(52, 152, 219, 0.1); color: #3498db;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            </div>
            <div class="stat-info">
                <div class="stat-value" id="stat-total-attendance">0</div>
                <div class="stat-label">Attendance Rate</div>
                <div id="stat-attendance-breakdown" style="margin-top:8px; border-top:1px solid #eee; padding-top:4px;"></div>
            </div>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #2752a7;">Top Attendance Users</h3>
                <button class="icon-btn" onclick="showFullList('attendance', 'desc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="top-attendance-list" class="top-list"></ul>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #e74c3c;">Bottom Attendance Users</h3>
                <button class="icon-btn" onclick="showFullList('attendance', 'asc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="bottom-attendance-list" class="top-list"></ul>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #e67e22;">Top Long Breaks (>40m)</h3>
                <button class="icon-btn" onclick="showFullList('long-breaks', 'desc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="top-long-breaks-list" class="top-list"></ul>
        </div>
    </div>
    <div class="dashboard-grid">
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #3498db;">Daily Attendance Trend</h3>
                <button class="icon-btn" onclick="openFullChart('attendance')" title="Full View">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="attendance-trend-chart"></canvas>
            </div>
        </div>
    </div>
    </div>

    <!-- Validation Section -->
    <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin: 30px 0 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
        <h2 style="margin: 0; color: var(--accent); font-size: 18px;">Validation & Task Analytics</h2>
        <button class="icon-btn toggle-section" title="Collapse" style="background:transparent; border:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
    </div>
    <div class="section-content">
    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(241, 196, 15, 0.1); color: #f1c40f;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
            </div>
            <div class="stat-info">
                <div class="stat-value" id="stat-total-tasks">0</div>
                <div class="stat-label">Validation Tasks</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(46, 204, 113, 0.1); color: #2ecc71;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            </div>
            <div class="stat-info">
                <div class="stat-value" id="stat-completion-rate">0%</div>
                <div class="stat-label">Resolved Completion Rate</div>
            </div>
        </div>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #3498db;">Validator Performance</h3>
                <button class="icon-btn" onclick="openFullChart('validator')" title="Full View">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="validator-performance-chart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #9b59b6;">Ops Validator Performance</h3>
                <button class="icon-btn" onclick="openFullChart('ops-validator')" title="Full View">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="ops-validator-performance-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #2752a7;">Daily Task Trend</h3>
                <button class="icon-btn" onclick="openFullChart('task-trend')" title="Full View">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="daily-task-trend-chart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #e67e22;">Findings Distribution</h3>
                <button class="icon-btn" onclick="openFullChart('findings')" title="Full View">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="findings-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #2752a7;">Top Validators (Resolved)</h3>
                <button class="icon-btn" onclick="showFullList('validators', 'desc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="top-validators-list" class="top-list"></ul>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #e74c3c;">Bottom Validators (Resolved)</h3>
                <button class="icon-btn" onclick="showFullList('validators', 'asc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="bottom-validators-list" class="top-list"></ul>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #2752a7;">Top Items (Most Tasks)</h3>
                <button class="icon-btn" onclick="showFullList('items-total', 'desc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="top-items-total-list" class="top-list"></ul>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #27ae60;">Top Items (Most Resolved)</h3>
                <button class="icon-btn" onclick="showFullList('items-resolved', 'desc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="top-items-resolved-list" class="top-list"></ul>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #e74c3c;">Top Items (Most Unresolved)</h3>
                <button class="icon-btn" onclick="showFullList('items-unresolved', 'desc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="top-items-unresolved-list" class="top-list"></ul>
        </div>
    </div>
    </div>

    <!-- Cycle Counting Section -->
    <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin: 30px 0 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
        <h2 style="margin: 0; color: var(--accent); font-size: 18px;">Cycle Counting Analytics</h2>
        <button class="icon-btn toggle-section" title="Collapse" style="background:transparent; border:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
    </div>
    <div class="section-content">
    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
        <div class="stat-card" onclick="showBreakdown('items')" style="cursor:pointer;" title="Click for Breakdown">
            <div class="stat-icon" style="background: rgba(155, 89, 182, 0.1); color: #9b59b6;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
            </div>
            <div class="stat-info">
                <div class="stat-value" id="stat-total-output">0</div>
                <div class="stat-label">Total Items Counted</div>
            </div>
        </div>
        <div class="stat-card" onclick="showBreakdown('locations')" style="cursor:pointer;" title="Click for Breakdown">
            <div class="stat-icon" style="background: rgba(230, 126, 34, 0.1); color: #e67e22;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            </div>
            <div class="stat-info">
                <div class="stat-value" id="stat-total-locations">0</div>
                <div class="stat-label">Total Locations Counted</div>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin-top: 0; color: #2752a7;">Daily Output Trend</h3>
                <button class="icon-btn" onclick="openFullChart('output-trend')" title="Full View">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="output-trend-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #2752a7;">Top Cycle Counters (SKUs)</h3>
                <button class="icon-btn" onclick="showFullList('counters', 'desc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="top-counters-list" class="top-list"></ul>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #e74c3c;">Bottom Cycle Counters (SKUs)</h3>
                <button class="icon-btn" onclick="showFullList('counters', 'asc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="bottom-counters-list" class="top-list"></ul>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #2752a7;">Top Counters (Duration)</h3>
                <button class="icon-btn" onclick="showFullList('duration', 'desc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="top-duration-list" class="top-list"></ul>
        </div>
        <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color: #e74c3c;">Bottom Counters (Duration)</h3>
                <button class="icon-btn" onclick="showFullList('duration', 'asc')" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff;">View All</button>
            </div>
            <ul id="bottom-duration-list" class="top-list"></ul>
        </div>
    </div>
    </div>

    <!-- Full List Modal -->
    <div id="full-list-modal" class="modal hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; display:none; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:#fff; padding:20px; border-radius:8px; width:90%; max-width:500px; max-height:80vh; display:flex; flex-direction:column; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="full-list-title" style="margin:0; color:#2c3e50;">Full List</h3>
                <button onclick="document.getElementById('full-list-modal').style.display='none'" style="background:none; border:none; font-size:20px; cursor:pointer; color:#666;">&times;</button>
            </div>
            <div style="flex:1; overflow-y:auto;">
                <table id="full-list-table" style="width:100%; border-collapse:collapse; font-size:14px;">
                    <thead>
                        <tr style="background:#f9f9f9; text-align:left; position:sticky; top:0;">
                            <th style="padding:8px; border-bottom:1px solid #eee;">Rank</th>
                            <th style="padding:8px; border-bottom:1px solid #eee;">Name</th>
                            <th style="padding:8px; border-bottom:1px solid #eee; text-align:right;">Count</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Full Chart Modal -->
    <div id="full-chart-modal" class="modal hidden">
        <div class="modal-overlay" onclick="this.parentElement.classList.add('hidden')"></div>
        <div class="modal-content" style="background:var(--card); padding:20px; border-radius:8px; width:90%; max-width:1200px; height:80vh; display:flex; flex-direction:column; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="full-chart-title" style="margin:0;">Full Chart View</h3>
                <button class="icon-btn" onclick="document.getElementById('full-chart-modal').classList.add('hidden')">&times;</button>
            </div>
            <div style="flex:1; position:relative; min-height:0;">
                <canvas id="full-chart-canvas"></canvas>
            </div>
        </div>
    </div>
  </main>

  <script src="app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const startInput = document.getElementById('analytics-start');
        const endInput = document.getElementById('analytics-end');
        
        // Default to current month
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        startInput.value = firstDay.toISOString().split('T')[0];
        endInput.value = now.toISOString().split('T')[0];

        function getData() {
            return {
                attendance: [
                    ...JSON.parse(localStorage.getItem('ims_daily_attendance_v1') || '[]'),
                    ...JSON.parse(localStorage.getItem('ims_daily_counters_attendance_v1') || '[]')
                ],
                tasks: JSON.parse(localStorage.getItem('ims_validation_tasks_v1') || '[]'),
                counters: JSON.parse(localStorage.getItem('ims_daily_counters_v1') || '[]'),
                cycleCounts: JSON.parse(localStorage.getItem('ims_cycle_count_v1') || '[]'),
                timestamps: JSON.parse(localStorage.getItem('ims_counter_timestamps_v1') || '[]')
            };
        }
        
        // Global variable for full chart instance
        let fullChartInstance = null;

        function renderDashboard() {
            const { attendance, tasks, counters, cycleCounts, timestamps } = getData();
            const start = startInput.value;
            const end = endInput.value;

            // Filter Data
            const filteredAtt = attendance.filter(a => (!start || a.date >= start) && (!end || a.date <= end));
            const filteredTasks = tasks.filter(t => {
                const d = t.timestamp.split('T')[0];
                return (!start || d >= start) && (!end || d <= end);
            });
            const filteredCounters = counters.filter(c => (!start || c.date >= start) && (!end || c.date <= end));

            // Stats
            // Calculate Attendance Percentage
            // Calculate Attendance Percentage & Breakdown
            const reqs = JSON.parse(localStorage.getItem('ims_att_requirements_v1') || '{}');
            const shifts = ["1st Shift-(6am-2pm)", "2nd Shift-(2pm-10pm)", "3rd Shift-(10pm-6am)"];
            const shiftStats = {
                "1st Shift-(6am-2pm)": { req: 0, act: 0 },
                "2nd Shift-(2pm-10pm)": { req: 0, act: 0 },
                "3rd Shift-(10pm-6am)": { req: 0, act: 0 }
            };

            Object.entries(reqs).forEach(([key, val]) => {
                const parts = key.split('|');
                if (parts.length === 2) {
                    const shift = parts[1];
                    if (shiftStats[shift]) shiftStats[shift].req += (parseInt(val) || 0);
                }
            });

            filteredAtt.forEach(a => {
                if (shiftStats[a.shift]) shiftStats[a.shift].act++;
            });

            let days = 1;
            if (start && end) {
                const s = new Date(start);
                const e = new Date(end);
                days = Math.floor((e - s) / (1000 * 60 * 60 * 24)) + 1;
                if (days < 1) days = 1;
            }

            const dailyReq = Object.values(shiftStats).reduce((a, b) => a + b.req, 0);
            const totalReq = dailyReq * days;
            const totalAct = filteredAtt.length;
            const attPct = totalReq > 0 ? Math.round((totalAct / totalReq) * 100) : 0;
            
            document.getElementById('stat-total-attendance').textContent = attPct + '%';

            let breakdownHtml = '';
            shifts.forEach(shift => {
                const shortName = shift.split(' ')[0];
                const sReq = shiftStats[shift].req * days;
                const sAct = shiftStats[shift].act;
                const sPctVal = sReq > 0 ? Math.round((sAct / sReq) * 100) : 0;
                const sPctDisplay = sReq > 0 ? sPctVal + '%' : '-';
                let color = '#e74c3c';
                if (sReq > 0) {
                    if (sPctVal >= 100) color = '#2ecc71';
                    else if (sPctVal >= 80) color = '#f1c40f';
                } else { color = '#999'; }
                
                breakdownHtml += `<div style="font-size:11px; color:var(--muted); display:flex; justify-content:space-between; width:100%; margin-top:2px;">
                    <span>${shortName}:</span>
                    <span title="Actual / Target"><span style="color:#999; font-weight:normal; margin-right:4px;">${sAct}/${sReq}</span><span style="font-weight:bold; color:${color}">${sPctDisplay}</span></span>
                </div>`;
            });
            
            const breakdownEl = document.getElementById('stat-attendance-breakdown');
            if(breakdownEl) breakdownEl.innerHTML = breakdownHtml;

            document.getElementById('stat-total-tasks').textContent = filteredTasks.length;
            
            const resolvedTasks = filteredTasks.filter(t => t.status === 'Completed').length;
            const rate = filteredTasks.length > 0 ? Math.round((resolvedTasks / filteredTasks.length) * 100) : 0;
            document.getElementById('stat-completion-rate').textContent = rate + '%';

            // Calculate Total Output from Daily Counters (Actuals)
            let totalOutput = 0;
            let uniqueLocations = 0;
            const locationSet = new Set();

            // Use actuals map from cycle counts if available, else hourlyActuals
            cycleCounts.forEach(c => {
                const d = (c.createdDate || c.date || '').split('T')[0];
                if ((!start || d >= start) && (!end || d <= end)) {
                    // Simple count of records in cycle count DB
                    totalOutput++;
                    if(c.location) locationSet.add(c.location);
                }
            });
            
            // Fallback to aggregated daily counters if cycle counts DB is empty/not used fully
            if (totalOutput === 0) {
                filteredCounters.forEach(c => {
                    if (c.hourlyActuals) {
                        totalOutput += Object.values(c.hourlyActuals).reduce((a,b) => a + (Number(b)||0), 0);
                    }
                });
            }
            document.getElementById('stat-total-output').textContent = totalOutput;
            document.getElementById('stat-total-locations').textContent = locationSet.size;

            // Top Attendance
            const attCounts = {};
            filteredAtt.forEach(a => {
                if(a.name) attCounts[a.name] = (attCounts[a.name] || 0) + 1;
            });
            renderTopList('top-attendance-list', attCounts, 'Shifts');

            // Top Long Breaks (>40m)
            const longBreakCounts = {};
            filteredAtt.forEach(a => {
                if (a.breakOut && a.breakIn && a.name) {
                    const [h1, m1] = a.breakOut.split(':').map(Number);
                    const [h2, m2] = a.breakIn.split(':').map(Number);
                    if (!isNaN(h1) && !isNaN(m1) && !isNaN(h2) && !isNaN(m2)) {
                        let minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
                        if (minutes < 0) minutes += 24 * 60;
                        if (minutes > 40) longBreakCounts[a.name] = (longBreakCounts[a.name] || 0) + 1;
                    }
                }
            });
            renderTopList('top-long-breaks-list', longBreakCounts, 'Times');

            // Top Validators
            const valCounts = {};
            filteredTasks.forEach(t => {
                if(t.status === 'Completed' && t.validator && t.validator !== 'Unassigned') {
                    valCounts[t.validator] = (valCounts[t.validator] || 0) + 1;
                }
            });
            renderTopList('top-validators-list', valCounts, 'Resolved');

            // Top Cycle Counters (by SKU Count)
            const ccCounts = {};
            const userNames = {};
            attendance.forEach(a => { if(a.userId && a.name) userNames[a.userId] = a.name; });

            const filteredTimestamps = timestamps.filter(t => {
                const d = t.timestamp.split('T')[0];
                return (!start || d >= start) && (!end || d <= end);
            });

            filteredTimestamps.forEach(t => {
                if (t.action === 'End' && t.skus) {
                    const name = userNames[t.userId] || t.userId || 'Unknown';
                    ccCounts[name] = (ccCounts[name] || 0) + (parseInt(t.skus) || 0);
                }
            });
            renderTopList('top-counters-list', ccCounts, 'SKUs');

            // Top Counters (by Duration)
            const durationCounts = calculateDurations(filteredTimestamps, attendance);
            renderTopList('top-duration-list', durationCounts, 'mins');

            // Top Items (SKU)
            const itemStats = {};
            filteredTasks.forEach(t => {
                const sku = t.sku || 'Unknown';
                if (!itemStats[sku]) itemStats[sku] = { desc: t.desc || '', total: 0, resolved: 0, unresolved: 0 };
                itemStats[sku].total++;
                if (t.status === 'Completed') itemStats[sku].resolved++;
                if (t.status === 'Unresolved') itemStats[sku].unresolved++;
            });
            renderTopItemList('top-items-total-list', itemStats, 'total');
            renderTopItemList('top-items-resolved-list', itemStats, 'resolved');
            renderTopItemList('top-items-unresolved-list', itemStats, 'unresolved');
            renderFindingsChart(filteredTasks);
            renderValidatorPerformanceChart(filteredTasks);
            renderOpsValidatorPerformanceChart(filteredTasks);

            // Bottom Lists
            renderBottomList('bottom-attendance-list', attCounts, 'Shifts');
            renderBottomList('bottom-validators-list', valCounts, 'Resolved');
            renderBottomList('bottom-counters-list', ccCounts, 'SKUs');
            renderBottomList('bottom-duration-list', durationCounts, 'mins');

            // Charts
            renderOutputTrend(filteredCounters, attendance);
            renderDailyTaskTrend(filteredTasks);
            renderAttendanceTrend(filteredAtt);
        }

        window.openFullChart = function(type) {
            const modal = document.getElementById('full-chart-modal');
            const titleEl = document.getElementById('full-chart-title');
            const canvas = document.getElementById('full-chart-canvas');
            
            if (!modal || !canvas) return;
            
            // Get current filtered data
            const { attendance, tasks, counters, cycleCounts } = getData();
            const start = startInput.value;
            const end = endInput.value;

            const filteredAtt = attendance.filter(a => (!start || a.date >= start) && (!end || a.date <= end));
            const filteredTasks = tasks.filter(t => {
                const d = t.timestamp.split('T')[0];
                return (!start || d >= start) && (!end || d <= end);
            });
            const filteredCounters = counters.filter(c => (!start || c.date >= start) && (!end || c.date <= end));
            
            modal.classList.remove('hidden');
            
            // Destroy previous instance
            if (fullChartInstance) {
                fullChartInstance.destroy();
                fullChartInstance = null;
            }
            
            // Render based on type
            const ctx = canvas.getContext('2d');
            let config = null;
            
            if (type === 'attendance') {
                titleEl.textContent = 'Daily Attendance Trend';
                const reqs = JSON.parse(localStorage.getItem('ims_att_requirements_v1') || '{}');
                let dailyReq = 0;
                Object.values(reqs).forEach(val => dailyReq += (parseInt(val) || 0));
                const dailyCounts = {};
                filteredAtt.forEach(a => { if (a.date) dailyCounts[a.date] = (dailyCounts[a.date] || 0) + 1; });
                const labels = Object.keys(dailyCounts).sort();
                const actualData = labels.map(d => dailyCounts[d]);
                const reqData = labels.map(d => dailyReq);
                
                config = {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Actual Attendance', data: actualData, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', fill: true, tension: 0.3 },
                            { label: 'Required Attendance', data: reqData, borderColor: '#e74c3c', backgroundColor: 'transparent', borderDash: [5, 5], tension: 0.3, pointRadius: 0 }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { y: { beginAtZero: true, title: { display: true, text: 'Headcount' } } },
                        plugins: { tooltip: { mode: 'index', intersect: false } }
                    }
                };
            } else if (type === 'validator') {
                titleEl.textContent = 'Validator Performance';
                const stats = {};
                filteredTasks.forEach(t => {
                    if (t.validator && t.validator !== 'Unassigned') {
                        if (!stats[t.validator]) stats[t.validator] = { total: 0, resolved: 0, unresolved: 0 };
                        stats[t.validator].total++;
                        if (t.status === 'Completed') stats[t.validator].resolved++;
                        if (t.status === 'Unresolved') stats[t.validator].unresolved++;
                    }
                });
                const labels = Object.keys(stats).sort();
                config = {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Total Tasks', data: labels.map(v => stats[v].total), type: 'line', borderColor: '#3498db', backgroundColor: 'transparent', tension: 0.3, borderWidth: 2, order: 1 },
                            { label: 'Resolved', data: labels.map(v => stats[v].resolved), backgroundColor: '#2ecc71', order: 2 },
                            { label: 'Unresolved', data: labels.map(v => stats[v].unresolved), backgroundColor: '#e74c3c', order: 3 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                };
            } else if (type === 'ops-validator') {
                titleEl.textContent = 'Ops Validator Performance';
                const stats = {};
                filteredTasks.forEach(t => {
                    if (t.opsValidator) {
                        if (!stats[t.opsValidator]) stats[t.opsValidator] = { total: 0, resolved: 0, unresolved: 0 };
                        stats[t.opsValidator].total++;
                        if (t.status === 'Completed') stats[t.opsValidator].resolved++;
                        if (t.status === 'Unresolved') stats[t.opsValidator].unresolved++;
                    }
                });
                const labels = Object.keys(stats).sort();
                config = {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Total Tasks', data: labels.map(v => stats[v].total), type: 'line', borderColor: '#3498db', backgroundColor: 'transparent', tension: 0.3, borderWidth: 2, order: 1 },
                            { label: 'Resolved', data: labels.map(v => stats[v].resolved), backgroundColor: '#2ecc71', order: 2 },
                            { label: 'Unresolved', data: labels.map(v => stats[v].unresolved), backgroundColor: '#e74c3c', order: 3 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                };
            } else if (type === 'task-trend') {
                titleEl.textContent = 'Daily Task Trend';
                const dailyData = {};
                filteredTasks.forEach(t => {
                    const d = t.timestamp.split('T')[0];
                    if (!dailyData[d]) dailyData[d] = { total: 0, resolved: 0, unresolved: 0 };
                    dailyData[d].total++;
                    if (t.status === 'Completed') dailyData[d].resolved++;
                    if (t.status === 'Unresolved') dailyData[d].unresolved++;
                });
                const labels = Object.keys(dailyData).sort();
                config = {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Total Tasks', data: labels.map(d => dailyData[d].total), type: 'line', borderColor: '#3498db', backgroundColor: 'transparent', tension: 0.3, borderWidth: 2, order: 1 },
                            { label: 'Resolved', data: labels.map(d => dailyData[d].resolved), backgroundColor: '#2ecc71', order: 2 },
                            { label: 'Unresolved', data: labels.map(d => dailyData[d].unresolved), backgroundColor: '#e74c3c', order: 3 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                };
            } else if (type === 'findings') {
                titleEl.textContent = 'Findings Distribution';
                const findingsCounts = {};
                filteredTasks.forEach(t => {
                    if (t.status === 'Completed' && t.findings) {
                        const list = t.findings.split(';').map(s => s.trim()).filter(s => s);
                        list.forEach(f => { findingsCounts[f] = (findingsCounts[f] || 0) + 1; });
                    }
                });
                const sorted = Object.entries(findingsCounts).sort((a, b) => b[1] - a[1]);
                config = {
                    type: 'bar',
                    data: {
                        labels: sorted.map(s => s[0]),
                        datasets: [{ label: 'Count', data: sorted.map(s => s[1]), backgroundColor: '#e67e22', borderRadius: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true } } }
                };
            } else if (type === 'output-trend') {
                titleEl.textContent = 'Daily Output Trend';
                const dailyData = {};
                const dailyTargets = {};
                filteredCounters.forEach(c => {
                    if (!dailyData[c.date]) { dailyData[c.date] = 0; dailyTargets[c.date] = 0; }
                    if (c.hourlyActuals) dailyData[c.date] += Object.values(c.hourlyActuals).reduce((a,b) => a + (Number(b)||0), 0);
                    let target = 0;
                    if (c.hourlyTargets && Object.keys(c.hourlyTargets).length > 0) target = Object.values(c.hourlyTargets).reduce((a, b) => a + (Number(b)||0), 0);
                    else {
                        const rate = Number(c.standardRate) || 0;
                        if (rate > 0) {
                            const shiftAtt = attendance.filter(a => a.date === c.date && a.shift === c.shift && a.status !== 'Temporary slide to Other task');
                            target = shiftAtt.length * rate;
                        } else target = Number(c.targetOutput) || 0;
                    }
                    dailyTargets[c.date] += target;
                });
                const labels = Object.keys(dailyData).sort();
                config = {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Total Output', data: labels.map(d => dailyData[d]), borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', fill: true, tension: 0.3 },
                            { label: 'Total Target', data: labels.map(d => dailyTargets[d]), borderColor: '#e74c3c', backgroundColor: 'transparent', borderDash: [5, 5], tension: 0.3 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                };
            } else if (type === 'output-trend') {
                titleEl.textContent = 'Daily Output Trend';
                const dailyData = {};
                const dailyTargets = {};
                filteredCounters.forEach(c => {
                    if (!dailyData[c.date]) { dailyData[c.date] = 0; dailyTargets[c.date] = 0; }
                    if (c.hourlyActuals) dailyData[c.date] += Object.values(c.hourlyActuals).reduce((a,b) => a + (Number(b)||0), 0);
                    let target = 0;
                    if (c.hourlyTargets && Object.keys(c.hourlyTargets).length > 0) target = Object.values(c.hourlyTargets).reduce((a, b) => a + (Number(b)||0), 0);
                    else {
                        const rate = Number(c.standardRate) || 0;
                        if (rate > 0) {
                            const shiftAtt = attendance.filter(a => a.date === c.date && a.shift === c.shift && a.status !== 'Temporary slide to Other task');
                            target = shiftAtt.length * rate;
                        } else target = Number(c.targetOutput) || 0;
                    }
                    dailyTargets[c.date] += target;
                });
                const labels = Object.keys(dailyData).sort();
                config = {
                    type: 'line',
                    data: { labels: labels, datasets: [ { label: 'Total Output', data: labels.map(d => dailyData[d]), borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', fill: true, tension: 0.3 }, { label: 'Total Target', data: labels.map(d => dailyTargets[d]), borderColor: '#e74c3c', backgroundColor: 'transparent', borderDash: [5, 5], tension: 0.3 } ] },
                    options: { responsive: true, maintainAspectRatio: false }
                };
            }
            
            if (config) {
                fullChartInstance = new Chart(ctx, config);
            }
        };

        function renderTopList(elementId, counts, suffix) {
            const list = document.getElementById(elementId);
            list.innerHTML = '';
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            
            if (sorted.length === 0) {
                list.innerHTML = '<li style="justify-content:center; color:#999;">No data available</li>';
                return;
            }

            sorted.forEach(([name, count], index) => {
                const li = document.createElement('li');
                li.innerHTML = `<div><span class="rank-badge">${index + 1}</span> ${name}</div> <strong>${count} ${suffix}</strong>`;
                list.appendChild(li);
            });
        }

        function calculateDurations(timestamps, attendance) {
            const userNames = {};
            attendance.forEach(a => { if(a.userId && a.name) userNames[a.userId] = a.name; });
            
            const logsByUser = {};
            timestamps.forEach(t => {
                if(!logsByUser[t.userId]) logsByUser[t.userId] = [];
                logsByUser[t.userId].push(t);
            });
            
            const durations = {};
            Object.keys(logsByUser).forEach(uid => {
                const logs = logsByUser[uid].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                let totalMs = 0;
                let sessionStart = null;
                let breakStart = null;
                let breakDed = 0;
                
                logs.forEach(l => {
                    if(l.action === 'Start') { sessionStart = new Date(l.timestamp); breakDed = 0; }
                    else if(l.action === 'Start Break') { breakStart = new Date(l.timestamp); }
                    else if(l.action === 'End Break') { 
                        if(breakStart) { breakDed += (new Date(l.timestamp) - breakStart); breakStart = null; }
                    }
                    else if(l.action === 'End') {
                        if(sessionStart) {
                            totalMs += (new Date(l.timestamp) - sessionStart) - breakDed;
                            sessionStart = null;
                        }
                    }
                });
                if(totalMs > 0) {
                    const name = userNames[uid] || uid;
                    durations[name] = (durations[name] || 0) + Math.round(totalMs / 60000);
                }
            });
            return durations;
        }

        function renderTopItemList(elementId, stats, metric) {
            const list = document.getElementById(elementId);
            list.innerHTML = '';
            const sorted = Object.entries(stats).sort((a,b) => b[1][metric] - a[1][metric]).slice(0, 5);
            
            if (sorted.length === 0 || sorted[0][1][metric] === 0) {
                list.innerHTML = '<li style="justify-content:center; color:#999;">No data available</li>';
                return;
            }

            sorted.forEach(([sku, data], index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div style="display:flex; align-items:center; overflow:hidden; padding-right:10px;">
                        <span class="rank-badge">${index + 1}</span>
                        <div style="display:flex; flex-direction:column; overflow:hidden;">
                            <span style="font-weight:bold; font-size:13px;">${sku}</span>
                            <span style="font-size:11px; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${data.desc}">${data.desc || '-'}</span>
                        </div>
                    </div>
                    <strong>${data[metric]}</strong>`;
                list.appendChild(li);
            });
        }

        function renderBottomList(elementId, counts, suffix) {
            const list = document.getElementById(elementId);
            list.innerHTML = '';
            const sorted = Object.entries(counts).sort((a,b) => a[1] - b[1]).slice(0, 5);
            
            if (sorted.length === 0) {
                list.innerHTML = '<li style="justify-content:center; color:#999;">No data available</li>';
                return;
            }

            sorted.forEach(([name, count], index) => {
                const li = document.createElement('li');
                li.innerHTML = `<div><span class="rank-badge" style="background:#eee; color:#555;">${index + 1}</span> ${name}</div> <strong>${count} ${suffix}</strong>`;
                list.appendChild(li);
            });
        }

        let validatorPerformanceChart = null;
        function renderValidatorPerformanceChart(tasks) {
            const ctx = document.getElementById('validator-performance-chart');
            if (!ctx) return;

            const stats = {};
            tasks.forEach(t => {
                if (t.validator && t.validator !== 'Unassigned') {
                    if (!stats[t.validator]) stats[t.validator] = { total: 0, resolved: 0, unresolved: 0 };
                    stats[t.validator].total++;
                    if (t.status === 'Completed') stats[t.validator].resolved++;
                    if (t.status === 'Unresolved') stats[t.validator].unresolved++;
                }
            });

            const labels = Object.keys(stats).sort();
            const totalData = labels.map(v => stats[v].total);
            const resolvedData = labels.map(v => stats[v].resolved);
            const unresolvedData = labels.map(v => stats[v].unresolved);

            if (validatorPerformanceChart) validatorPerformanceChart.destroy();

            validatorPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Tasks',
                            data: totalData,
                            type: 'line',
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            borderWidth: 2,
                            order: 1
                        },
                        {
                            label: 'Resolved',
                            data: resolvedData,
                            backgroundColor: '#2ecc71',
                            order: 2
                        },
                        {
                            label: 'Unresolved',
                            data: unresolvedData,
                            backgroundColor: '#e74c3c',
                            order: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            });
        }

        let opsValidatorPerformanceChart = null;
        function renderOpsValidatorPerformanceChart(tasks) {
            const ctx = document.getElementById('ops-validator-performance-chart');
            if (!ctx) return;

            const stats = {};
            tasks.forEach(t => {
                if (t.opsValidator) {
                    if (!stats[t.opsValidator]) stats[t.opsValidator] = { total: 0, resolved: 0, unresolved: 0 };
                    stats[t.opsValidator].total++;
                    if (t.status === 'Completed') stats[t.opsValidator].resolved++;
                    if (t.status === 'Unresolved') stats[t.opsValidator].unresolved++;
                }
            });

            const labels = Object.keys(stats).sort();
            const totalData = labels.map(v => stats[v].total);
            const resolvedData = labels.map(v => stats[v].resolved);
            const unresolvedData = labels.map(v => stats[v].unresolved);

            if (opsValidatorPerformanceChart) opsValidatorPerformanceChart.destroy();

            opsValidatorPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Tasks',
                            data: totalData,
                            type: 'line',
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            borderWidth: 2,
                            order: 1
                        },
                        {
                            label: 'Resolved',
                            data: resolvedData,
                            backgroundColor: '#2ecc71',
                            order: 2
                        },
                        {
                            label: 'Unresolved',
                            data: unresolvedData,
                            backgroundColor: '#e74c3c',
                            order: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            });
        }

        let findingsChart = null;
        function renderFindingsChart(tasks) {
            const ctx = document.getElementById('findings-chart');
            if (!ctx) return;

            const findingsCounts = {};
            tasks.forEach(t => {
                if (t.status === 'Completed' && t.findings) {
                    // Split by semicolon in case of multiple findings
                    const list = t.findings.split(';').map(s => s.trim()).filter(s => s);
                    list.forEach(f => {
                        findingsCounts[f] = (findingsCounts[f] || 0) + 1;
                    });
                }
            });

            const sorted = Object.entries(findingsCounts).sort((a, b) => b[1] - a[1]);
            const labels = sorted.map(s => s[0]);
            const data = sorted.map(s => s[1]);

            if (findingsChart) findingsChart.destroy();

            findingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Count',
                        data: data,
                        backgroundColor: '#e67e22',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            });
        }

        window.showFullList = function(type, order) {
            const start = startInput.value;
            const end = endInput.value;
            const { attendance, tasks, timestamps } = getData();
            
            let counts = {};
            let title = '';
            let suffix = '';

            if (type === 'attendance') {
                title = order === 'desc' ? 'Top Attendance Users (All)' : 'Bottom Attendance Users (All)';
                suffix = 'Shifts';
                const filteredAtt = attendance.filter(a => (!start || a.date >= start) && (!end || a.date <= end));
                filteredAtt.forEach(a => {
                    if(a.name) counts[a.name] = (counts[a.name] || 0) + 1;
                });
            } else if (type === 'long-breaks') {
                title = 'Top Users with Long Breaks (>40m)';
                suffix = 'Times';
                const filteredAtt = attendance.filter(a => (!start || a.date >= start) && (!end || a.date <= end));
                filteredAtt.forEach(a => {
                    if (a.breakOut && a.breakIn && a.name) {
                        const [h1, m1] = a.breakOut.split(':').map(Number);
                        const [h2, m2] = a.breakIn.split(':').map(Number);
                        if (!isNaN(h1) && !isNaN(m1) && !isNaN(h2) && !isNaN(m2)) {
                            let minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
                            if (minutes < 0) minutes += 24 * 60;
                            if (minutes > 40) counts[a.name] = (counts[a.name] || 0) + 1;
                        }
                    }
                });
            } else if (type === 'validators') {
                title = order === 'desc' ? 'Top Validators (All)' : 'Bottom Validators (All)';
                suffix = 'Resolved';
                const filteredTasks = tasks.filter(t => {
                    const d = t.timestamp.split('T')[0];
                    return (!start || d >= start) && (!end || d <= end);
                });
                filteredTasks.forEach(t => {
                    if(t.status === 'Completed' && t.validator && t.validator !== 'Unassigned') {
                        counts[t.validator] = (counts[t.validator] || 0) + 1;
                    }
                });
            } else if (type === 'counters') {
                title = order === 'desc' ? 'Top Cycle Counters (All)' : 'Bottom Cycle Counters (All)';
                suffix = 'SKUs';
                const userNames = {};
                attendance.forEach(a => { if(a.userId && a.name) userNames[a.userId] = a.name; });
                const filteredTimestamps = timestamps.filter(t => {
                    const d = t.timestamp.split('T')[0];
                    return (!start || d >= start) && (!end || d <= end);
                });
                filteredTimestamps.forEach(t => {
                    if (t.action === 'End' && t.skus) {
                        const name = userNames[t.userId] || t.userId || 'Unknown';
                        counts[name] = (counts[name] || 0) + (parseInt(t.skus) || 0);
                    }
                });
            } else if (type === 'duration') {
                title = order === 'desc' ? 'Top Counters by Duration (All)' : 'Bottom Counters by Duration (All)';
                suffix = 'mins';
                const filteredTimestamps = timestamps.filter(t => {
                    const d = t.timestamp.split('T')[0];
                    return (!start || d >= start) && (!end || d <= end);
                });
                counts = calculateDurations(filteredTimestamps, attendance);
            } else if (type.startsWith('items-')) {
                const filteredTasks = tasks.filter(t => {
                    const d = t.timestamp.split('T')[0];
                    return (!start || d >= start) && (!end || d <= end);
                });
                const itemStats = {};
                filteredTasks.forEach(t => {
                    const sku = t.sku || 'Unknown';
                    if (!itemStats[sku]) itemStats[sku] = { total: 0, resolved: 0, unresolved: 0 };
                    itemStats[sku].total++;
                    if (t.status === 'Completed') itemStats[sku].resolved++;
                    if (t.status === 'Unresolved') itemStats[sku].unresolved++;
                });
                if (type === 'items-total') {
                    title = 'Top Items (Most Tasks)'; suffix = 'Tasks';
                    Object.entries(itemStats).forEach(([sku, stats]) => counts[sku] = stats.total);
                } else if (type === 'items-resolved') {
                    title = 'Top Items (Most Resolved)'; suffix = 'Resolved';
                    Object.entries(itemStats).forEach(([sku, stats]) => counts[sku] = stats.resolved);
                } else if (type === 'items-unresolved') {
                    title = 'Top Items (Most Unresolved)'; suffix = 'Unresolved';
                    Object.entries(itemStats).forEach(([sku, stats]) => counts[sku] = stats.unresolved);
                }
            }

            const sorted = Object.entries(counts).sort((a,b) => order === 'desc' ? b[1] - a[1] : a[1] - b[1]);
            
            const modal = document.getElementById('full-list-modal');
            document.getElementById('full-list-title').textContent = title;
            const tbody = document.querySelector('#full-list-table tbody');
            tbody.innerHTML = '';
            
            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:10px; color:#999;">No data available</td></tr>';
            } else {
                sorted.forEach(([name, count], index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td style="padding:8px; border-bottom:1px solid #eee;">${index + 1}</td><td style="padding:8px; border-bottom:1px solid #eee;">${name}</td><td style="padding:8px; border-bottom:1px solid #eee; text-align:right;"><strong>${count}</strong> ${suffix}</td>`;
                    tbody.appendChild(tr);
                });
            }
            modal.style.display = 'flex';
        };

        window.showBreakdown = function(type) {
            const { timestamps, cycleCounts } = getData();
            const start = document.getElementById('analytics-start').value;
            const end = document.getElementById('analytics-end').value;

            // Filter timestamps (sessions)
            const filteredSessions = timestamps.filter(t => {
                if (t.action !== 'End') return false;
                const d = t.timestamp.split('T')[0];
                return (!start || d >= start) && (!end || d <= end);
            });

            const breakdown = { 'Pick Bin': 0, 'Reserved Bin': 0 };

            if (type === 'items') {
                filteredSessions.forEach(s => {
                    const area = s.areaType || 'Unknown';
                    const count = parseInt(s.skus) || 0;
                    if (area.includes('Pick Bin')) breakdown['Pick Bin'] += count;
                    else if (area.includes('Reserved')) breakdown['Reserved Bin'] += count;
                    else {
                        if(!breakdown[area]) breakdown[area] = 0;
                        breakdown[area] += count;
                    }
                });
            } else if (type === 'locations') {
                // Use pallets from sessions as a proxy for Reserved locations
                filteredSessions.forEach(s => {
                    const area = s.areaType || 'Unknown';
                    const count = parseInt(s.pallets) || 0;
                    if (area.includes('Reserved')) breakdown['Reserved Bin'] += count;
                });

                // For Pick Bin, count unique locations from cycleCounts if available
                const filteredCC = cycleCounts.filter(c => {
                    const d = (c.createdDate || c.date || '').split('T')[0];
                    return (!start || d >= start) && (!end || d <= end);
                });
                
                const pickBinSet = new Set();
                filteredCC.forEach(c => {
                    if(c.location) pickBinSet.add(c.location);
                });
                breakdown['Pick Bin'] = pickBinSet.size;
            }

            const modal = document.getElementById('full-list-modal');
            document.getElementById('full-list-title').textContent = type === 'items' ? 'Items Breakdown' : 'Locations Breakdown';
            const tbody = document.querySelector('#full-list-table tbody');
            tbody.innerHTML = '';
            
            Object.entries(breakdown).forEach(([name, count], index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="padding:8px; border-bottom:1px solid #eee;">${index + 1}</td><td style="padding:8px; border-bottom:1px solid #eee;">${name}</td><td style="padding:8px; border-bottom:1px solid #eee; text-align:right;"><strong>${count}</strong></td>`;
                tbody.appendChild(tr);
            });
            modal.style.display = 'flex';
        };

        let attendanceTrendChart = null;
        function renderAttendanceTrend(attendance) {
            const ctx = document.getElementById('attendance-trend-chart');
            if (!ctx) return;

            // Calculate Daily Requirement
            const reqs = JSON.parse(localStorage.getItem('ims_att_requirements_v1') || '{}');
            let dailyReq = 0;
            Object.values(reqs).forEach(val => dailyReq += (parseInt(val) || 0));

            const dailyCounts = {};
            attendance.forEach(a => {
                if (a.date) {
                    dailyCounts[a.date] = (dailyCounts[a.date] || 0) + 1;
                }
            });

            const labels = Object.keys(dailyCounts).sort();
            const actualData = labels.map(d => dailyCounts[d]);
            const reqData = labels.map(d => dailyReq);

            if (attendanceTrendChart) attendanceTrendChart.destroy();

            attendanceTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Actual Attendance',
                        data: actualData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Required Attendance',
                        data: reqData,
                        borderColor: '#e74c3c',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: 'Headcount' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        let outputChart = null;
        function renderOutputTrend(counters, attendance) {
            const ctx = document.getElementById('output-trend-chart');
            const dailyData = {};
            const dailyTargets = {};
            
            counters.forEach(c => {
                if (!dailyData[c.date]) { dailyData[c.date] = 0; dailyTargets[c.date] = 0; }
                if (c.hourlyActuals) {
                    dailyData[c.date] += Object.values(c.hourlyActuals).reduce((a,b) => a + (Number(b)||0), 0);
                }

                // Calculate Target
                let target = 0;
                if (c.hourlyTargets && Object.keys(c.hourlyTargets).length > 0) {
                    target = Object.values(c.hourlyTargets).reduce((a, b) => a + (Number(b)||0), 0);
                } else {
                    const rate = Number(c.standardRate) || 0;
                    if (rate > 0) {
                        const shiftAtt = attendance.filter(a => a.date === c.date && a.shift === c.shift && a.status !== 'Temporary slide to Other task');
                        target = shiftAtt.length * rate;
                    } else {
                        target = Number(c.targetOutput) || 0;
                    }
                }
                dailyTargets[c.date] += target;
            });

            const labels = Object.keys(dailyData).sort();
            const data = labels.map(d => dailyData[d]);
            const targetData = labels.map(d => dailyTargets[d]);

            if (outputChart) outputChart.destroy();
            outputChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Output',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Total Target',
                        data: targetData,
                        borderColor: '#e74c3c',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        let taskTrendChart = null;
        function renderDailyTaskTrend(tasks) {
            const ctx = document.getElementById('daily-task-trend-chart');
            const dailyData = {};
            
            tasks.forEach(t => {
                const d = t.timestamp.split('T')[0];
                if (!dailyData[d]) dailyData[d] = { total: 0, resolved: 0, unresolved: 0 };
                dailyData[d].total++;
                if (t.status === 'Completed') dailyData[d].resolved++;
                if (t.status === 'Unresolved') dailyData[d].unresolved++;
            });

            const labels = Object.keys(dailyData).sort();
            const totalData = labels.map(d => dailyData[d].total);
            const resolvedData = labels.map(d => dailyData[d].resolved);
            const unresolvedData = labels.map(d => dailyData[d].unresolved);

            if (taskTrendChart) taskTrendChart.destroy();
            taskTrendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Tasks',
                            data: totalData,
                            type: 'line',
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            borderWidth: 2,
                            order: 1
                        },
                        {
                            label: 'Resolved',
                            data: resolvedData,
                            backgroundColor: '#2ecc71',
                            order: 2
                        },
                        {
                            label: 'Unresolved',
                            data: unresolvedData,
                            backgroundColor: '#e74c3c',
                            order: 3
                        }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });
        }

        function exportDashboard() {
            const { attendance, tasks, counters, cycleCounts } = getData();
            const start = startInput.value;
            const end = endInput.value;

            // Filter Data
            const filteredAtt = attendance.filter(a => (!start || a.date >= start) && (!end || a.date <= end));
            const filteredTasks = tasks.filter(t => {
                const d = t.timestamp.split('T')[0];
                return (!start || d >= start) && (!end || d <= end);
            });
            const filteredCounters = counters.filter(c => (!start || c.date >= start) && (!end || c.date <= end));

            const wb = XLSX.utils.book_new();

            // 1. Summary Sheet
            const summaryData = [
                ['Metric', 'Value'],
                ['Total Attendance Shifts', document.getElementById('stat-total-attendance').textContent],
                ['Validation Tasks', document.getElementById('stat-total-tasks').textContent],
                ['Task Completion Rate', document.getElementById('stat-completion-rate').textContent],
                ['Total Items Counted', document.getElementById('stat-total-output').textContent]
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

            // 2. Attendance Ranking
            const attCounts = {};
            filteredAtt.forEach(a => { if(a.name) attCounts[a.name] = (attCounts[a.name] || 0) + 1; });
            const attRows = [['Rank', 'Name', 'Shifts']];
            Object.entries(attCounts)
                .sort((a,b) => b[1] - a[1])
                .forEach(([name, count], index) => attRows.push([index + 1, name, count]));
            const wsAtt = XLSX.utils.aoa_to_sheet(attRows);
            XLSX.utils.book_append_sheet(wb, wsAtt, "Attendance Ranking");

            // 3. Validator Ranking
            const valCounts = {};
            filteredTasks.forEach(t => {
                if(t.status === 'Completed' && t.validator && t.validator !== 'Unassigned') {
                    valCounts[t.validator] = (valCounts[t.validator] || 0) + 1;
                }
            });
            const valRows = [['Rank', 'Validator', 'Resolved Tasks']];
            Object.entries(valCounts)
                .sort((a,b) => b[1] - a[1])
                .forEach(([name, count], index) => valRows.push([index + 1, name, count]));
            const wsVal = XLSX.utils.aoa_to_sheet(valRows);
            XLSX.utils.book_append_sheet(wb, wsVal, "Validator Ranking");

            // 4. Cycle Counter Ranking
            const ccCounts = {};
            filteredAtt.forEach(a => {
                if(a.name && (a.area === 'Cycle Counter' || a.jobDescription === 'Cycle Counter')) {
                    ccCounts[a.name] = (ccCounts[a.name] || 0) + 1;
                }
            });
            const ccRows = [['Rank', 'Name', 'Shifts']];
            Object.entries(ccCounts)
                .sort((a,b) => b[1] - a[1])
                .forEach(([name, count], index) => ccRows.push([index + 1, name, count]));
            const wsCC = XLSX.utils.aoa_to_sheet(ccRows);
            XLSX.utils.book_append_sheet(wb, wsCC, "Cycle Counter Ranking");

            // 5. Daily Output Data
            const outputData = {};
            filteredCounters.forEach(c => {
                if (!outputData[c.date]) outputData[c.date] = 0;
                if (c.hourlyActuals) {
                    outputData[c.date] += Object.values(c.hourlyActuals).reduce((a,b) => a + (Number(b)||0), 0);
                }
            });
            const outputRows = [['Date', 'Total Output']];
            Object.keys(outputData).sort().forEach(d => outputRows.push([d, outputData[d]]));
            const wsOutput = XLSX.utils.aoa_to_sheet(outputRows);
            XLSX.utils.book_append_sheet(wb, wsOutput, "Daily Output Trend");

            // 6. Daily Task Data
            const taskData = {};
            filteredTasks.forEach(t => {
                const d = t.timestamp.split('T')[0];
                if (!taskData[d]) taskData[d] = { total: 0, resolved: 0 };
                taskData[d].total++;
                if (t.status === 'Completed') taskData[d].resolved++;
            });
            const taskRows = [['Date', 'Total Tasks', 'Resolved Tasks']];
            Object.keys(taskData).sort().forEach(d => taskRows.push([d, taskData[d].total, taskData[d].resolved]));
            const wsTask = XLSX.utils.aoa_to_sheet(taskRows);
            XLSX.utils.book_append_sheet(wb, wsTask, "Daily Task Trend");

            XLSX.writeFile(wb, `Dashboard_Analytics_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.querySelector('main');
            
            // Show loading state
            const originalCursor = document.body.style.cursor;
            document.body.style.cursor = 'wait';
            
            try {
                const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg') || '#f4f6f8' });
                const imgData = canvas.toDataURL('image/png');
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Analytics_Dashboard_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (err) {
                console.error(err);
                alert('Failed to export PDF.');
            } finally {
                document.body.style.cursor = originalCursor;
            }
        }

        document.getElementById('apply-filter').addEventListener('click', renderDashboard);
        document.getElementById('clear-filter').addEventListener('click', () => {
            startInput.value = ''; endInput.value = ''; renderDashboard();
        });
        document.getElementById('export-dashboard').addEventListener('click', exportDashboard);
        document.getElementById('export-pdf').addEventListener('click', exportToPDF);

        // Section Toggle Logic
        document.querySelectorAll('.toggle-section').forEach(btn => {
            btn.addEventListener('click', () => {
                const content = btn.closest('.section-header').nextElementSibling;
                content.classList.toggle('hidden');
                const isHidden = content.classList.contains('hidden');
                btn.innerHTML = isHidden 
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;"><polyline points="6 9 12 15 18 9"></polyline></svg>' 
                    : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;"><polyline points="18 15 12 9 6 15"></polyline></svg>';
                btn.title = isHidden ? 'Expand' : 'Collapse';
            });
        });

        renderDashboard();
    });
  </script>
</body>
</html>
